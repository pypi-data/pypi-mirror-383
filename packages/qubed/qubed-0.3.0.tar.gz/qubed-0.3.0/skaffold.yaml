apiVersion: skaffold/v4beta13
kind: Config
metadata:
  name: qubed-stac-server
build:
  tagPolicy:
    customTemplate:
      template: '{{.GIT}}{{if .POSTFIX}}-{{.POSTFIX}}{{end}}'
      components:
        - name: GIT
          gitCommit:
            ignoreChanges: true
        - name: POSTFIX
          envTemplate:
            template: '{{default "" .TAG_POSTFIX}}'
  artifacts:
    - image: eccr.ecmwf.int/qubed/stac_server
      docker:
        dockerfile: dockerfile
        target: stac_server
        # cliFlags:
        #   - --no-cache # for debug purposes
    - image: eccr.ecmwf.int/qubed/fdb_scanner
      docker:
        dockerfile: dockerfile
        target: fdb_scanner

deploy:
  helm:
    releases:
      - name: qubed-dev
        namespace: qubed-dev
        chartPath: chart
        setValueTemplates:
          stacServer.image.repository: '{{.IMAGE_REPO_eccr_ecmwf_int_qubed_stac_server}}'
          stacServer.image.tag: '{{.IMAGE_TAG_eccr_ecmwf_int_qubed_stac_server}}@{{.IMAGE_DIGEST_eccr_ecmwf_int_qubed_stac_server}}'
          scanJobs.image: '{{.IMAGE_FULLY_QUALIFIED_eccr_ecmwf_int_qubed_fdb_scanner}}'
        valuesFiles:
          - chart/values.yaml
        wait: false

profiles:
  - name: test
    deploy:
      helm:
        releases:
          - name: qubed-test
            chartPath: chart
            setValueTemplates:
              stacServer.image.repository: '{{.IMAGE_REPO_eccr_ecmwf_int_qubed_stac_server}}'
              stacServer.image.tag: '{{.IMAGE_TAG_eccr_ecmwf_int_qubed_stac_server}}@{{.IMAGE_DIGEST_eccr_ecmwf_int_qubed_stac_server}}'
            namespace: qubed-test
            valuesFiles:
              - chart/values.yaml
            overrides:
              ingress:
                hostnames:
                  - "qubed-test.lumi.apps.dte.destination-earth.eu"
                  - "catalogue-test.lumi.apps.dte.destination-earth.eu"
            wait: true
  - name: prod
    deploy:
      helm:
        releases:
          - name: qubed
            chartPath: chart
            setValueTemplates:
              stacServer.image.repository: '{{.IMAGE_REPO_eccr_ecmwf_int_qubed_stac_server}}'
              stacServer.image.tag: '{{.IMAGE_TAG_eccr_ecmwf_int_qubed_stac_server}}@{{.IMAGE_DIGEST_eccr_ecmwf_int_qubed_stac_server}}'
            namespace: qubed
            valuesFiles:
              - chart/values.yaml
            overrides:
              ingress:
                hostnames:
                  - "qubed.lumi.apps.dte.destination-earth.eu"
                  - "catalogue.lumi.apps.dte.destination-earth.eu"
            wait: true
