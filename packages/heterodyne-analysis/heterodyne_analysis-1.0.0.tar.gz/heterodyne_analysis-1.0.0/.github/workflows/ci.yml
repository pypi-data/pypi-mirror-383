# Modern CI/CD Pipeline for Heterodyne Analysis Package
# ===================================================
# Revolutionary test automation with matrix testing, performance monitoring,
# security scanning, and containerized environments

name: "ğŸš€ CI/CD Pipeline"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run nightly builds at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      test_level:
        description: "Test execution level"
        required: false
        default: "standard"
        type: choice
        options:
          - "smoke"
          - "standard"
          - "comprehensive"
          - "performance"

env:
  PYTHONUNBUFFERED: "1"
  FORCE_COLOR: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Pre-flight Checks
  # ==========================================================================

  pre-flight:
    name: "ğŸ” Pre-flight Checks"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      test-level: ${{ steps.config.outputs.test-level }}
      cache-key: ${{ steps.config.outputs.cache-key }}

    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ”§ Configure Test Parameters"
        id: config
        run: |
          # Determine test level based on event and inputs
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            TEST_LEVEL="comprehensive"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TEST_LEVEL="${{ github.event.inputs.test_level }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TEST_LEVEL="standard"
          else
            TEST_LEVEL="standard"
          fi

          echo "test-level=${TEST_LEVEL}" >> $GITHUB_OUTPUT
          echo "cache-key=ci-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('pyproject.toml') }}" >> $GITHUB_OUTPUT

          echo "::notice::Test Level: ${TEST_LEVEL}"

  # ==========================================================================
  # Code Quality and Security Scanning
  # ==========================================================================

  quality:
    name: "âœ¨ Code Quality"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: pre-flight

    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: "ğŸ“¦ Install Dependencies"
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .[quality]

      - name: "ğŸ” Ruff Linting"
        run: ruff check heterodyne --output-format=github

      - name: "ğŸ¨ Black Formatting Check"
        run: black --check --diff --exclude '_version\.py' heterodyne

      - name: "ğŸ“„ Import Sorting Check"
        run: isort --check-only --diff heterodyne

      - name: "ğŸ”’ Security Scan (Bandit)"
        run: bandit -r heterodyne -f json -o reports/bandit-report.json || true

      - name: "ğŸ›¡ï¸ Dependency Security Scan"
        run: |
          safety check --json --output reports/safety-report.json || true
          pip-audit --format=json --output=reports/pip-audit-report.json || true

      - name: "ğŸ’€ Dead Code Detection"
        run: vulture heterodyne --min-confidence 60 || true

      - name: "ğŸ“ Documentation Coverage"
        run: interrogate heterodyne --generate-badge reports/

      - name: "ğŸ“Š Upload Quality Reports"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports
          path: reports/
          retention-days: 30

  # ==========================================================================
  # Matrix Testing Across Platforms and Python Versions
  # ==========================================================================

  test-matrix:
    name: "ğŸ§ª Test Matrix"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    needs: [pre-flight, quality]

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.12", "3.13"]
        test-category: [unit, integration]
        exclude:
          # Reduce matrix size for efficiency - no exclusions needed for 3.12+
          []

    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python ${{ matrix.python-version }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: "ğŸ”§ System Dependencies (Ubuntu)"
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: "ğŸ”§ System Dependencies (macOS)"
        if: matrix.os == 'macos-latest'
        run: |
          brew install gcc

      - name: "ğŸ“¦ Install Package and Dependencies"
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .[test,performance]

      - name: "ğŸ§ª Run Tests - ${{ matrix.test-category }}"
        shell: bash
        env:
          PYTHONUTF8: "1" # Enable UTF-8 encoding on Windows
        run: |
          # Exit code 5 means "no tests collected" - treat as success for missing markers
          pytest heterodyne/tests \
            -m "${{ matrix.test-category }}" \
            --cov=heterodyne \
            --cov-report=xml:coverage-${{ matrix.os }}-py${{ matrix.python-version }}-${{ matrix.test-category }}.xml \
            --cov-report=json:coverage-${{ matrix.os }}-py${{ matrix.python-version }}-${{ matrix.test-category }}.json \
            --junit-xml=junit-${{ matrix.os }}-py${{ matrix.python-version }}-${{ matrix.test-category }}.xml \
            --maxfail=5 \
            -n auto || test $? -eq 5 || exit $?

      - name: "ğŸ“Š Upload Coverage"
        uses: codecov/codecov-action@v4
        with:
          files: coverage-${{ matrix.os }}-py${{ matrix.python-version }}-${{ matrix.test-category }}.xml
          flags: ${{ matrix.test-category }},${{ matrix.os }},py${{ matrix.python-version }}
          name: codecov-${{ matrix.os }}-py${{ matrix.python-version }}-${{ matrix.test-category }}

      - name: "ğŸ“ˆ Upload Test Results"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}-${{ matrix.test-category }}
          path: |
            coverage-*.xml
            coverage-*.json
            junit-*.xml
          retention-days: 30

  # ==========================================================================
  # Performance and Benchmark Testing
  # ==========================================================================

  performance:
    name: "âš¡ Performance Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [pre-flight, quality]
    if: needs.pre-flight.outputs.test-level == 'comprehensive' || needs.pre-flight.outputs.test-level == 'performance'

    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need history for performance comparison

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: "ğŸ“¦ Install Dependencies"
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .[test,performance]

      - name: "âš¡ Run Performance Tests"
        run: |
          pytest heterodyne/tests \
            -m "performance or benchmark" \
            --benchmark-only \
            --benchmark-json=benchmark-results.json \
            --benchmark-save=benchmark-baseline \
            --benchmark-autosave

      - name: "ğŸ“Š Performance Regression Check"
        run: |
          pytest heterodyne/tests \
            -m "performance" \
            --benchmark-compare=benchmark-baseline \
            --benchmark-compare-fail=mean:10% \
            || echo "::warning::Performance regression detected"

      - name: "ğŸ“ˆ Upload Benchmark Results"
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmark-results.json
            .benchmarks/
          retention-days: 90

  # ==========================================================================
  # Scientific Computing Validation
  # ==========================================================================

  scientific:
    name: "ğŸ”¬ Scientific Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [pre-flight, quality]
    if: needs.pre-flight.outputs.test-level == 'comprehensive'

    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: "ğŸ“¦ Install Scientific Dependencies"
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .[test,performance,robust]

      - name: "ğŸ”¬ Run Scientific Validation Tests"
        run: |
          pytest heterodyne/tests \
            -m "scientific" \
            --cov=heterodyne \
            --cov-report=xml:scientific-coverage.xml \
            --junit-xml=scientific-junit.xml \
            -v

      - name: "ğŸ“Š Upload Scientific Test Results"
        uses: actions/upload-artifact@v4
        with:
          name: scientific-validation-results
          path: |
            scientific-coverage.xml
            scientific-junit.xml
          retention-days: 30

  # ==========================================================================
  # Security and Vulnerability Testing
  # ==========================================================================

  security:
    name: "ğŸ”’ Security Testing"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: pre-flight

    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: "ğŸ“¦ Install Dependencies"
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .[test,quality]

      - name: "ğŸ”’ Run Security Tests"
        run: |
          # Run security-marked tests, skip if none exist (exit code 5)
          pytest heterodyne/tests \
            -m "security" \
            --junit-xml=security-junit.xml \
            -v || test $? -eq 5 || exit $?

      - name: "ğŸ›¡ï¸ Advanced Security Scanning"
        run: |
          # Static security analysis (continue on findings, don't fail workflow)
          bandit -r heterodyne -f json -o security-bandit.json || true

          # Dependency vulnerability scanning
          safety check --json --output security-safety.json || true
          pip-audit --format=json --output=security-pip-audit.json || true

      - name: "ğŸ“Š Upload Security Reports"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            security-*.json
            security-junit.xml
          retention-days: 90

  # ==========================================================================
  # Container Testing
  # ==========================================================================

  container:
    name: "ğŸ³ Container Testing"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [pre-flight, quality]
    if: needs.pre-flight.outputs.test-level == 'comprehensive'

    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ğŸ³ Build Test Container"
        run: |
          docker build -t heterodyne-test -f docker/Dockerfile.test .

      - name: "ğŸ§ª Run Tests in Container"
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/reports:/workspace/reports \
            heterodyne-test \
            pytest heterodyne/tests \
            --cov=heterodyne \
            --cov-report=xml:/workspace/reports/container-coverage.xml \
            --junit-xml=/workspace/reports/container-junit.xml \
            -m "not gpu" \
            -n auto

      - name: "ğŸ“Š Upload Container Test Results"
        uses: actions/upload-artifact@v4
        with:
          name: container-test-results
          path: reports/
          retention-days: 30

  # ==========================================================================
  # Documentation Building and Testing
  # ==========================================================================

  docs:
    name: "ğŸ“š Documentation"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: pre-flight

    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: "ğŸ“¦ Install Documentation Dependencies"
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .[docs]

      - name: "ğŸ“š Build Documentation"
        run: |
          sphinx-build -W -b html docs docs/_build/html

      - name: "ğŸ“ Test Documentation Examples"
        run: |
          sphinx-build -W -b doctest docs docs/_build/doctest

      - name: "ğŸ“Š Upload Documentation"
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/_build/html/
          retention-days: 30

  # ==========================================================================
  # Integration and Summary
  # ==========================================================================

  integration:
    name: "ğŸ¯ Integration Summary"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [test-matrix, quality]
    if: always()

    steps:
      - name: "ğŸ“¥ Download All Artifacts"
        uses: actions/download-artifact@v4

      - name: "ğŸ“Š Generate Test Summary"
        run: |
          echo "# ğŸš€ CI/CD Pipeline Summary" > summary.md
          echo "## Test Results" >> summary.md

          # Check test results
          if [[ "${{ needs.test-matrix.result }}" == "success" ]]; then
            echo "âœ… **Matrix Tests**: All tests passed across platforms and Python versions" >> summary.md
          else
            echo "âŒ **Matrix Tests**: Some tests failed" >> summary.md
          fi

          if [[ "${{ needs.quality.result }}" == "success" ]]; then
            echo "âœ… **Code Quality**: All quality checks passed" >> summary.md
          else
            echo "âŒ **Code Quality**: Quality issues detected" >> summary.md
          fi

          echo "## Coverage Summary" >> summary.md
          # Process coverage reports here

          cat summary.md

      - name: "ğŸ“ Update PR Comment"
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # ==========================================================================
  # Release Preparation (on main branch only)
  # ==========================================================================

  release-check:
    name: "ğŸš¢ Release Preparation"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [test-matrix, quality, performance, scientific, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: "ğŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: "ğŸ“¦ Install Build Dependencies"
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install build twine

      - name: "ğŸ”¨ Build Package"
        run: |
          python -m build
          twine check dist/*

      - name: "ğŸ“Š Upload Build Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: distribution
          path: dist/
          retention-days: 90

      - name: "ğŸ·ï¸ Tag Release"
        if: startsWith(github.event.head_commit.message, 'bump:')
        run: |
          # Extract version from setup
          VERSION=$(python -c "import heterodyne; print(heterodyne.__version__)")
          git tag "v${VERSION}"
          git push origin "v${VERSION}"
