[project]
authors = ["Chen Zhang <zhangc@ornl.gov>"]
channels = ["conda-forge"]
name = "sophiread"
platforms = ["osx-arm64", "linux-64"]
version = "0.1.0"

[tasks]
# Core build tasks
configure = "cmake -G Ninja -S . -B build -DBUILD_PYTHON_BINDINGS=ON -DCMAKE_BUILD_TYPE=Release"
build = { cmd = "ninja -C build", depends-on = ["configure"] }
test = { cmd = "cd build && ctest -V --output-on-failure", depends-on = [
    "build",
] }

# Python development
dev-install = { cmd = "pip install -e . --no-build-isolation", depends-on = [
    "build",
] }
python-test = { cmd = "python -c 'import tdcsophiread; print(tdcsophiread.__version__)'" }

# Data setup
setup-data = "git submodule update --init resources/sophiread_data"
notebooks = "jupyter lab notebooks/"

# Publishing
sync-version = "python scripts/sync-version.py"
build-wheel = { cmd = "bash scripts/build-wheel.sh", depends-on = [
    "sync-version",
    "build",
] }
build-sdist = { cmd = "python -m build --sdist --outdir dist", depends-on = [
    "sync-version",
] }
test-wheel = { cmd = "pip install dist/*.whl --force-reinstall && python -c 'import tdcsophiread'", depends-on = [
    "build-wheel",
] }
publish-pypi = { cmd = "python -m twine upload dist/*", depends-on = [
    "build-wheel",
    "build-sdist",
] }

# C++ package for DAQ
package = { cmd = "ninja -C build package", depends-on = ["build"] }

# Utilities
clean = "rm -rf build build-debug build-legacy dist Testing .pytest_cache .coverage htmlcov .mypy_cache .ruff_cache coverage.xml && find . -type d -name '__pycache__' -o -name '*.egg-info' | xargs rm -rf 2>/dev/null || true"
docs = { cmd = "ninja -C build docs", depends-on = ["build"] }

[dependencies]
# Core build dependencies (required for all environments)
python = ">=3.10,<3.15"
cmake = ">=3.31.5,<4"
ninja = ">=1.12.1,<2"
hdf5 = ">=1.14.4,<2"
gtest = ">=1.16.0,<2"
eigen = ">=3.4.0,<4"
tbb-devel = ">=2022.0.0,<2023"
spdlog = ">=1.15.1,<2"
nlohmann_json = ">=3.11.3,<4"
pybind11 = ">=2.13.6,<3"
# Runtime dependencies (go into the wheel)
numpy = ">=2.1.0,<3"
h5py = ">=3.12.0,<4"
pydantic = ">=2.11.7,<3"
matplotlib = ">=3.10.3,<4"
# Build tools
libgfortran = ">=5.0.0,<16"
scikit-build-core = ">=0.11.4,<0.12"
pip = ">=25.1.1,<26"
python-build = ">=1.2.2.post1,<2"

# Development dependencies (optional, for full dev environment)
[feature.dev.dependencies]
clang-format = ">=19.1.7,<20"
doxygen = ">=1.13.2,<2"
graphviz = ">=12.2.1,<13"
pre-commit = ">=4.2.0,<5"
jupyterlab = ">=4.4.3,<5"
scipy = ">=1.16.0,<2"
pandas = ">=2.3.1,<3"
cibuildwheel = ">=3.0.1,<4"
delocate = ">=0.13.0,<1"
ipywidgets = ">=8.1.7,<9"
ipympl = ">=0.9.7,<0.10"
tqdm = ">=4.67.1,<5"
twine = ">=6.0.1,<7"

[target.linux-64.dependencies]
gxx_linux-64 = "11.2.*"   # Works with modern TBB, requires newer glibc
libglu = ">=9.0.3,<10"
auditwheel = ">=6.0.0,<7"
patchelf = ">=0.17.0,<1"

# Multi-environment configuration for building wheels with different Python versions
[feature.py310.dependencies]
python = "3.10.*"

[feature.py311.dependencies]
python = "3.11.*"

[feature.py312.dependencies]
python = "3.12.*"

[feature.py313.dependencies]
python = "3.13.*"

[feature.py314.dependencies]
python = "3.14.*"

[environments]
default = ["dev"]  # For normal development work with all dev tools
py310 = ["py310"]  # For building Python 3.10 wheel
py311 = ["py311"]  # For building Python 3.11 wheel
py312 = ["py312"]  # For building Python 3.12 wheel
py313 = ["py313"]  # For building Python 3.13 wheel
py314 = ["py314"]  # For building Python 3.14 wheel
