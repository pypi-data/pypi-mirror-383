name: Release and Publish WaterQSVG

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write  # ç”¨äºŽPyPIå¯ä¿¡å‘å¸ƒ

jobs:
  release-and-publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install uv and dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install uv twine
        uv --version
        
    - name: Get version info
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
        
    - name: Build package
      run: |
        echo "Building WaterQSVG package..."
        uv build
        echo "Build completed. Contents:"
        ls -la dist/
        
    - name: Verify package
      run: |
        echo "Verifying package integrity..."
        python -m twine check dist/*
        
    - name: Test installation
      run: |
        echo "Testing package installation..."
        python -m pip install dist/*.whl
        python -c "
        import waterqsvg
        print(f'Successfully installed waterqsvg {waterqsvg.__version__}')
        print('Package import test passed!')
        "
        waterqsvg --help
        echo "CLI test passed!"
        
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true
        # ä½¿ç”¨API tokenå‘å¸ƒ
        password: ${{ secrets.PYPI_API_TOKEN }}
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: WaterQSVG ${{ steps.version.outputs.version }}
        body: |
          ## ðŸŽ‰ WaterQSVG ${{ steps.version.outputs.version }} å‘å¸ƒ
          
          ### ðŸ“¦ å®‰è£…æ–¹å¼
          
          ```bash
          # ä»ŽPyPIå®‰è£…
          pip install waterqsvg
          
          # ä½¿ç”¨uvå®‰è£…
          uv add waterqsvg
          ```
          
          ### ðŸš€ å¿«é€Ÿå¼€å§‹
          
          ```bash
          # å‘½ä»¤è¡Œä½¿ç”¨
          waterqsvg --zip-url "https://example.com/data.zip"
          
          # ä½¿ç”¨JSONé…ç½®
          waterqsvg --zip-url "/path/to/config.json"
          
          # æ ‡å‡†è¾“å…¥
          echo "https://example.com/data.zip" | waterqsvg
          ```
          
          ### ðŸ“‹ ä¸»è¦åŠŸèƒ½
          - ðŸŒŠ ä¸“ä¸šæ°´è´¨æ•°æ®SVGçƒ­åŠ›å›¾ç”Ÿæˆ
          - ðŸ”— æ”¯æŒOSSç›´è¿žä¸‹è½½å’Œæœ¬åœ°æ–‡ä»¶
          - ðŸ“Š 15+ç§æ°´è´¨æŒ‡æ ‡è‡ªåŠ¨è¯†åˆ«
          - ðŸŽ¨ å¤šç§é¢œè‰²æ˜ å°„æ–¹æ¡ˆ
          - ðŸ—ºï¸ é«˜ç²¾åº¦åœ°ç†è¾¹ç•Œä¿¡æ¯è¾“å‡º
          - ðŸ§® Alpha Shapeè¾¹ç•Œæ£€æµ‹ç®—æ³•
          - ðŸ“± è·¨å¹³å°å…¼å®¹ (Windows/Linux/macOS)
          
          ### ðŸ”— ç›¸å…³é“¾æŽ¥
          - ðŸ“– [æ–‡æ¡£](https://github.com/1034378361/waterqsvg#readme)
          - ðŸ› [é—®é¢˜åé¦ˆ](https://github.com/1034378361/waterqsvg/issues)
          
          ---
          
          **å®Œæ•´æ›´æ–°æ—¥å¿—**: [CHANGELOG.md](https://github.com/1034378361/waterqsvg/blob/${{ steps.version.outputs.version }}/CHANGELOG.md)
        files: |
          dist/*
        draft: false
        prerelease: false
        
    - name: Post-release summary
      run: |
        echo "## ðŸŽ‰ å‘å¸ƒå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "WaterQSVG ${{ steps.version.outputs.version }} å·²æˆåŠŸå‘å¸ƒåˆ°:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… PyPI: https://pypi.org/project/waterqsvg/" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… GitHub Releases: https://github.com/1034378361/waterqsvg/releases" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### å®‰è£…æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "pip install waterqsvg" >> $GITHUB_STEP_SUMMARY
        echo "waterqsvg --help" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY