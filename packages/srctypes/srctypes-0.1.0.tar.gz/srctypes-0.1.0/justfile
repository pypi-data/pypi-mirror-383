# srctypes Justfile
# Run commands with: just <command>

# Load environment variables from .env file
set dotenv-load := true

# Default recipe
default:
    @just --list

# Build the package
build *BUILD_FLAGS="":
    uv build {{ BUILD_FLAGS }}

# Clean build artifacts
clean:
    rm -rf dist/

# Test package installation locally
test:
    uv run --with . --no-project -- python -c "import srctypes; print('âœ… Import successful')"
    uv run --with . --no-project -- python -c "import srctypes; print('ğŸ“¦ Available types:', len([attr for attr in dir(srctypes) if not attr.startswith('_')])); print('Sample types:', srctypes.js, srctypes.py, srctypes.sql)"

# Set package version
version version_arg="patch":
    uv version {{ version_arg }}

# Publish to PyPI
publish:
    #!/usr/bin/env bash
    set -e
    
    echo "ğŸ” Checking .env file..."
    if [ ! -f .env ]; then
        echo "âŒ .env file not found. Please copy .env.example to .env and configure your PyPI token."
        exit 1
    fi
    
    echo "ğŸ” Checking PyPI token..."
    if [ -z "$UV_PUBLISH_TOKEN" ]; then
        echo "âŒ UV_PUBLISH_TOKEN not set in .env file"
        exit 1
    fi
    
    echo "ğŸ§¹ Cleaning previous builds..."
    just clean
    
    echo "ğŸ“¦ Building package..."
    just build
    
    echo "ğŸ§ª Testing package..."
    just test
    
    echo "ğŸš€ Publishing to PyPI..."
    uv publish
    
    echo "âœ… Package published successfully!"

# Publish to Test PyPI
publish-test:
    #!/usr/bin/env bash
    set -e
    
    echo "ğŸ” Checking .env file..."
    if [ ! -f .env ]; then
        echo "âŒ .env file not found. Please copy .env.example to .env and configure your test PyPI token."
        exit 1
    fi
    
    echo "ğŸ” Checking Test PyPI token..."
    if [ -z "$UV_PUBLISH_TEST_TOKEN" ]; then
        echo "âŒ UV_PUBLISH_TEST_TOKEN not set in .env file"
        exit 1
    fi
    
    echo "ğŸ§¹ Cleaning previous builds..."
    just clean
    
    echo "ğŸ“¦ Building package..."
    just build
    
    echo "ğŸ§ª Testing package..."
    just test
    
    echo "ğŸš€ Publishing to Test PyPI..."
    UV_PUBLISH_TOKEN="$UV_PUBLISH_TEST_TOKEN" uv publish --index testpypi
    
    echo "âœ… Package published to Test PyPI successfully!"
    echo "ğŸ”— View at: https://test.pypi.org/project/srctypes/"

# Complete release workflow (bump version + publish)
release type="patch":
    #!/usr/bin/env bash
    set -e
    
    echo "ğŸš€ Starting release workflow ({{ type }})..."
    
    echo "ğŸ“¦ Bumping version..."
    just version {{ type }}
    
    echo "ğŸš€ Publishing..."
    just publish
    
    echo "âœ… Release completed successfully!"

# Show package info
info:
    @echo "ğŸ“¦ Package: srctypes"
    @echo "ğŸ“‹ Version: $(uv version --no-sync 2>/dev/null | awk '{print $2}' || echo 'unknown')"
    @echo "ğŸ”§ Python: $(python --version)"
    @echo "ğŸ“¦ UV: $(uv --version)"

# Install development dependencies
dev-setup:
    uv pip install -e .
    echo "âœ… Development setup complete"

# Format code (if you add formatting tools)
fmt:
    @echo "No formatting tools configured"

# Run linting (if you add linters)
lint:
    @echo "No linters configured"

# Check if everything is ready for release
check-release:
    #!/usr/bin/env bash
    set -e
    
    echo "ğŸ” Checking release readiness..."
    
    # Check .env file
    if [ ! -f .env ]; then
        echo "âŒ .env file missing"
        exit 1
    fi
    
    # Check PyPI token
    if [ -z "$UV_PUBLISH_TOKEN" ]; then
        echo "âŒ UV_PUBLISH_TOKEN not configured"
        exit 1
    fi
    
    # Check if package builds
    just clean
    just build
    
    # Check if package works
    just test
    
    echo "âœ… All checks passed! Ready for release"