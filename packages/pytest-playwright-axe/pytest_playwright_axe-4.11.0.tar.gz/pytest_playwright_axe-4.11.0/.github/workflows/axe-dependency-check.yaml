name: Build New Axe Version

on: 
  workflow_dispatch:
    inputs:
      old_version:
        description: 'The old axe-core version to be replaced'
        required: true
        type: string
      current_version:
        description: 'The new axe-core version to use'
        required: true
        type: string

jobs:
  axe-dependency-check:
    name: "Axe Version Check"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - run: |
          git checkout ${{ github.head_ref }}
      - name: Install Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 'latest'
      - name: Install axe-core in temp dir
        run: |
          cd src/pytest_playwright_axe/resources
          mkdir temp
          cd temp
          npm install axe-core
      - name: Retrieve axe.js file
        run: |
          cd src/pytest_playwright_axe/resources/temp/node_modules/axe-core
          mv axe.js ../../../
          mv axe.min.js ../../../
      - name: Remove temp directory
        run: |
          cd src/pytest_playwright_axe/resources
          rm -rf temp
      - name: Find and Replace
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          find: "${{ inputs.old_version }}"
          replace: "${{ inputs.current_version }}"
          regex: false
          exclude: "**/*.js"
      - name: Commit to axe-dependency-check branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b axe-dependency-check-${{ inputs.current_version }}
          git add src/pytest_playwright_axe/resources/axe.js
          git add src/pytest_playwright_axe/resources/axe.min.js
          git add src/pytest_playwright_axe/__init__.py
          git add pyproject.toml
          git commit -m "axe-core automated update for version ${{ inputs.current_version }}"
          git push --set-upstream origin axe-dependency-check-${{ inputs.current_version }}
      - name: Create Pull Request
        uses: actions/github-script@v8
        with:
          script: |
            const { repo, owner } = context.repo;
            const result = await github.rest.pulls.create({
              title: 'Update axe-core files to ${{ inputs.current_version }}',
              owner,
              repo,
              head: 'axe-dependency-check-${{ inputs.current_version }}',
              base: 'main',
              body: [
                'This PR is auto-generated by [actions/github-script](https://github.com/actions/github-script).',
                'It updates the axe-core dependency in the project from ${{ inputs.old_version }} to ${{ inputs.current_version }}.',
              ].join('\n')
            });
            github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: result.data.number,
              labels: ['feature', 'automated pr']
            });
            github.rest.pulls.requestReviewers({
              owner,
              repo,
              pull_number: result.data.number,
              reviewers: ['davethepunkyone']
            });