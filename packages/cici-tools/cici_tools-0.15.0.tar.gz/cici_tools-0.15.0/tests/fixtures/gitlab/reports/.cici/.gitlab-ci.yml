# SPDX-FileCopyrightText: UL Research Institutes
# SPDX-License-Identifier: Apache-2.0

stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always


.reports-base:
  image: "${CONTAINER_PROXY}alpine"
  variables:
    GIT_DEPTH: "1"
  script:
    - echo "{}" > ${CI_JOB_NAME_SLUG}.json
    - echo "html report" > "${CI_JOB_NAME_SLUG}.html"
    - echo "{}" > "${CI_JOB_NAME_SLUG}-gitlab.json"
    - mkdir -p coverage
    - echo "<root></root>" > coverage/cobertura-coverage.xml
    - echo "<root></root> " > rspec.xml

reports-coverage:
  extends: .reports-base
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

reports-junit:
  extends: .reports-base
  artifacts:
    reports:
      junit: rspec.xml

reports-terraform:
  extends: .reports-base
  artifacts:
    reports:
      terraform: ${CI_JOB_NAME_SLUG}.json
    paths:
      - ${CI_JOB_NAME_SLUG}.json
      - ${CI_JOB_NAME_SLUG}-gitlab.json

reports-container_scanning:
  extends: .reports-base
  artifacts:
    reports:
      container_scanning: ${CI_JOB_NAME_SLUG}.json
    paths:
      - ${CI_JOB_NAME_SLUG}.json
