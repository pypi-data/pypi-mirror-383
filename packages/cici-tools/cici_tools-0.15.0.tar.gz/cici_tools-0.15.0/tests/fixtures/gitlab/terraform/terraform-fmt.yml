#
# This file is generated by cici-tools with the following command:
#
#     cici bundle
#
stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always

variables:
  TERRAFORM_ROOT: "${CI_PROJECT_DIR}/deploy/${TERRAFORM_STATE_NAME}"

terraform-fmt:
  stage: test
  image: "registry.gitlab.com/gitlab-org/terraform-images/stable:latest"
  variables:
    GIT_DEPTH: "1"
    TF_STATE_NAME: "$TERRAFORM_STATE_NAME"
    TF_ROOT: "$TERRAFORM_ROOT"
    TF_ADDRESS: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${TERRAFORM_STATE_NAME}"
  before_script:
    - gitlab-terraform -version
  script:
    - gitlab-terraform fmt -recursive -check -diff
  cache:
    key: $TERRAFORM_STATE_NAME
    paths:
      - ${TERRAFORM_ROOT}/.terraform
