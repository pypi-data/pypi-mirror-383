#
# This file is generated by cici-tools with the following command:
#
#     cici bundle
#
stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always

variables:
  OPENTOFU_MODULE_VERSION:
    description: |-
      Opentofu module version.
    value: "${CI_COMMIT_TAG}"
  OPENTOFU_MODULE_NAME:
    description: |-
      Opentofu module project name.
    value: "${CI_PROJECT_NAME}"
  OPENTOFU_MODULE_DIR:
    description: |-
      Opentofu module project directory.
    value: "${CI_PROJECT_DIR}"

opentofu-module-build:
  stage: deploy
  image: "registry.gitlab.com/components/opentofu/gitlab-opentofu:latest"
  variables:
    GIT_DEPTH: "1"
    OPENTOFU_MODULE_DIR: "${CI_PROJECT_DIR}"
    OPENTOFU_MODULE_NAME: "${CI_PROJECT_NAME}"
    OPENTOFU_MODULE_VERSION: "${CI_COMMIT_TAG}"
  before_script:
    - tofu -version
  script:
    - OPENTOFU_MODULE_NAME=$(echo "${OPENTOFU_MODULE_NAME}" | tr " _" -)
    - >-
      tar -vczf /tmp/${OPENTOFU_MODULE_NAME}-${OPENTOFU_MODULE_SYSTEM}-${OPENTOFU_MODULE_VERSION}.tgz -C

      ${OPENTOFU_MODULE_DIR} --exclude=./.git .
    - >-
      curl --fail-with-body --location --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file

      /tmp/${OPENTOFU_MODULE_NAME}-${OPENTOFU_MODULE_SYSTEM}-${OPENTOFU_MODULE_VERSION}.tgz

      ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/terraform/modules/${OPENTOFU_MODULE_NAME}/${OPENTOFU_MODULE_SYSTEM}/

      ${OPENTOFU_MODULE_VERSION}/file
  cache: {}
  dependencies: []
  rules:
    - if: $CI_COMMIT_TAG
