#
# This file is generated by cici-tools with the following command:
#
#     cici bundle
#
stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always

variables:
  OPENTOFU_MODULE_VERSION:
    description: |-
      Opentofu module version.
    value: "${CI_COMMIT_TAG}"
  OPENTOFU_MODULE_NAME:
    description: |-
      Opentofu module project name.
    value: "${CI_PROJECT_NAME}"
  OPENTOFU_MODULE_DIR:
    description: |-
      Opentofu module project directory.
    value: "${CI_PROJECT_DIR}"

opentofu-trivy:
  stage: test
  image: "registry.gitlab.com/components/opentofu/gitlab-opentofu:latest"
  variables:
    GIT_DEPTH: "1"
    TF_STATE_NAME: "$OPENTOFU_STATE_NAME"
    TF_ROOT: "$OPENTOFU_ROOT"
    TF_ADDRESS: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${OPENTOFU_STATE_NAME}"
    OPENTOFU_ROOT: "."
  before_script:
    - tofu -version
    - echo "TF_ROOT = $TF_ROOT"
    - echo "TF_STATE_NAME = $TF_STATE_NAME"
    - echo "TF_ADDRESS = $TF_ADDRESS"
    - echo "Entering path '$OPENTOFU_ROOT' for state '$OPENTOFU_STATE_NAME'"
    - cd "${OPENTOFU_ROOT}"
  script:
    - >-
      curl -sSL https://github.com/aquasecurity/trivy/releases/download/v0.49.1/trivy_0.49.1_Linux-64bit.tar.gz | tar -C

      /usr/local/bin/ -xzf - trivy
    - trivy config .
  cache:
    key: $OPENTOFU_STATE_NAME
    paths:
      - ${OPENTOFU_ROOT}/.terraform
  dependencies: []
