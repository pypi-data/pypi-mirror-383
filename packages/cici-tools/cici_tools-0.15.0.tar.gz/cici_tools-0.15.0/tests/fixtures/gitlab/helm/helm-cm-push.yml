#
# This file is generated by cici-tools with the following command:
#
#     cici bundle
#
stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always

variables:
  HELM_CHART_PATH: "."
  HELM_CHART_VERSION: "$CI_COMMIT_TAG"
  HELM_REPOSITORY_USERNAME: "gitlab-ci-token"
  HELM_REPOSITORY_PASSWORD: "$CI_JOB_TOKEN"
  HELM_REPOSITORY_URL: "$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/helm/production"

helm-cm-push:
  stage: deploy
  image: "${CONTAINER_PROXY}alpine"
  variables:
    HELM_REPO_USERNAME: "$HELM_REPOSITORY_USERNAME"
    HELM_REPO_PASSWORD: "$HELM_REPOSITORY_PASSWORD"
  before_script:
    - apk add --no-cache curl
    - >-
      curl -sS -o - https://get.helm.sh/helm-v3.8.0-linux-amd64.tar.gz | tar --strip-components 1 -xzf - linux-amd64/helm
    - install helm /usr/local/bin/
    - rm -f helm
    - >-
      helm version
  script:
    - apk add --no-cache git
    - >-
      helm plugin install https://github.com/chartmuseum/helm-push
    - >-
      helm cm-push --version "$HELM_CHART_VERSION" --app-version "$HELM_CHART_VERSION" "$HELM_CHART_PATH"

      "$HELM_REPOSITORY_URL"
  rules:
    - if: $CI_COMMIT_TAG
