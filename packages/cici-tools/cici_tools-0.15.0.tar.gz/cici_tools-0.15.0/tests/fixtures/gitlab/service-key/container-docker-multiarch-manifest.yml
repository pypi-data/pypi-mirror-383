#
# This file is generated by cici-tools with the following command:
#
#     cici bundle
#
stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always

variables:
  CONTAINER_BUILD_OPTS:
    description: |-
      Extra options to pass to container build command.
    value: ""
  CONTAINER_COMMIT_SHA:
    description: |-
      Commit SHA for the container release.
    value: "${CI_COMMIT_SHA}"
  CONTAINER_COMMIT_SHORT_SHA:
    description: |-
      First 8 characters of the commit SHA.
    value: "${CI_COMMIT_SHORT_SHA}"
  CONTAINER_CONTEXT:
    description: |-
      Directory to use as container context.
    value: "${CI_PROJECT_DIR}"
  CONTAINER_DOCKERFILE:
    description: |-
      Full path to the target Dockerfile.
    value: "${CONTAINER_CONTEXT}/Dockerfile"
  CONTAINER_IMAGE:
    description: |-
      Fully qualified container image URL.
    value: "${CONTAINER_NAME}:${CONTAINER_VERSION}"
  CONTAINER_NAME:
    description: |-
      Name component of the image URL.
    value: "${CONTAINER_REGISTRY}${CONTAINER_NAME_SUFFIX}"
  CONTAINER_NAME_SUFFIX:
    description: |-
      Suffix to add to container name.
    value: ""
  CONTAINER_PROXY:
    description: |-
      URL prefix for pull-through registry cache.
    value: "${CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX}/"
  CONTAINER_REGISTRY:
    description: |-
      Container registry URL.
    value: "${CI_REGISTRY_IMAGE}"
  CONTAINER_REGISTRY_USER:
    description: |-
      Container registry username.
    value: "${CI_REGISTRY_USER}"
  CONTAINER_REGISTRY_PASSWORD:
    description: |-
      Container registry password.
    value: "${CI_REGISTRY_PASSWORD}"
  CONTAINER_VERSION:
    description: |-
      Container image version.
    value: "${CONTAINER_VERSION_PREFIX}${CI_COMMIT_REF_NAME}${CONTAINER_VERSION_SUFFIX}"
  CONTAINER_VERSION_PREFIX:
    description: |-
      Prefix to add to the container image version.
    value: ""
  CONTAINER_VERSION_SUFFIX:
    description: |-
      Suffix to add to the container image version.
    value: ""

container-docker-multiarch-manifest:
  stage: deploy
  image: "${CONTAINER_PROXY}docker:28-cli"
  services:
    - name: "${CONTAINER_PROXY}docker:28-dind"
      alias: docker
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - >-
      docker --version
    - >-
      echo "$CONTAINER_REGISTRY_PASSWORD" | docker login "$CONTAINER_REGISTRY" -u "$CONTAINER_REGISTRY_USER" --password-stdin
    - >-
      echo "$CI_DEPENDENCY_PROXY_PASSWORD" | docker login "$CI_DEPENDENCY_PROXY_SERVER" -u "$CI_DEPENDENCY_PROXY_USER"

      --password-stdin
    - >-
      echo "$CI_DEPENDENCY_PROXY_PASSWORD" | docker login "$CI_SERVER_HOST" -u "$CI_DEPENDENCY_PROXY_USER" --password-stdin
    - apk add --no-cache cosign
    - amend_list=""
    - |-
      cd dist/container/arch
      for platform in * ; do
        echo "adding architecture: ${platform}"
        docker pull "${CONTAINER_IMAGE}-${platform}"
        amend_list="$amend_list --amend ${CONTAINER_IMAGE}-${platform}"
      done
      cd -
    - >-
      docker manifest create "${CONTAINER_IMAGE}" ${amend_list}
    - >-
      docker manifest inspect "${CONTAINER_IMAGE}"
    - >-
      docker manifest push "${CONTAINER_IMAGE}"
    - |-
      if [ -z "$CI_COMMIT_TAG" ] ; then
        docker manifest create "${CONTAINER_IMAGE}-${CONTAINER_COMMIT_SHORT_SHA}" ${amend_list}
        docker manifest inspect "${CONTAINER_IMAGE}-${CONTAINER_COMMIT_SHORT_SHA}"
        docker manifest push "${CONTAINER_IMAGE}-${CONTAINER_COMMIT_SHORT_SHA}"
      fi
    - |-
      if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ] ; then
        docker manifest create "${CONTAINER_NAME}:latest" ${amend_list}
        docker manifest inspect "${CONTAINER_NAME}:latest"
        docker manifest push "${CONTAINER_NAME}:latest"
      fi
  id_tokens:
    SIGSTORE_ID_TOKEN:
      aud: "sigstore"
