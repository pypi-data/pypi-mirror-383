#
# This file is generated by cici-tools with the following command:
#
#     cici bundle
#
stages:
  - test
  - build
  - deploy

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_OPEN_MERGE_REQUESTS
      when: never
    - when: always

variables:
  CONTAINER_BUILD_OPTS:
    description: |-
      Extra options to pass to container build command.
    value: ""
  CONTAINER_COMMIT_SHA:
    description: |-
      Commit SHA for the container release.
    value: "${CI_COMMIT_SHA}"
  CONTAINER_COMMIT_SHORT_SHA:
    description: |-
      First 8 characters of the commit SHA.
    value: "${CI_COMMIT_SHORT_SHA}"
  CONTAINER_CONTEXT:
    description: |-
      Directory to use as container context.
    value: "${CI_PROJECT_DIR}"
  CONTAINER_DOCKERFILE:
    description: |-
      Full path to the target Dockerfile.
    value: "${CONTAINER_CONTEXT}/Dockerfile"
  CONTAINER_IMAGE:
    description: |-
      Fully qualified container image URL.
    value: "${CONTAINER_NAME}:${CONTAINER_VERSION}"
  CONTAINER_NAME:
    description: |-
      Name component of the image URL.
    value: "${CONTAINER_REGISTRY}${CONTAINER_NAME_SUFFIX}"
  CONTAINER_NAME_SUFFIX:
    description: |-
      Suffix to add to container name.
    value: ""
  CONTAINER_PROXY:
    description: |-
      URL prefix for pull-through registry cache.
    value: "${CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX}/"
  CONTAINER_REGISTRY:
    description: |-
      Container registry URL.
    value: "${CI_REGISTRY_IMAGE}"
  CONTAINER_REGISTRY_USER:
    description: |-
      Container registry username.
    value: "${CI_REGISTRY_USER}"
  CONTAINER_REGISTRY_PASSWORD:
    description: |-
      Container registry password.
    value: "${CI_REGISTRY_PASSWORD}"
  CONTAINER_VERSION:
    description: |-
      Container image version.
    value: "${CONTAINER_VERSION_PREFIX}${CI_COMMIT_REF_NAME}${CONTAINER_VERSION_SUFFIX}"
  CONTAINER_VERSION_PREFIX:
    description: |-
      Prefix to add to the container image version.
    value: ""
  CONTAINER_VERSION_SUFFIX:
    description: |-
      Suffix to add to the container image version.
    value: ""

container-docker:
  stage: build
  image: "${CONTAINER_PROXY}docker:28-cli"
  services:
    - name: "${CONTAINER_PROXY}docker:28-dind"
      alias: docker
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - >-
      docker --version
    - >-
      echo "$CONTAINER_REGISTRY_PASSWORD" | docker login "$CONTAINER_REGISTRY" -u "$CONTAINER_REGISTRY_USER" --password-stdin
    - >-
      echo "$CI_DEPENDENCY_PROXY_PASSWORD" | docker login "$CI_DEPENDENCY_PROXY_SERVER" -u "$CI_DEPENDENCY_PROXY_USER"

      --password-stdin
    - >-
      echo "$CI_DEPENDENCY_PROXY_PASSWORD" | docker login "$CI_SERVER_HOST" -u "$CI_DEPENDENCY_PROXY_USER" --password-stdin
    - apk add --no-cache cosign
    - _CONTAINER_OPTS="$CONTAINER_BUILD_OPTS"
    - _CONTAINER_OPTS="$_CONTAINER_OPTS --tag ${CONTAINER_IMAGE}-${CONTAINER_COMMIT_SHORT_SHA}"
    - |-
      if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ] ; then
        _CONTAINER_OPTS="$_CONTAINER_OPTS --tag ${CONTAINER_NAME}:latest"
      fi
    - >-
      docker buildx build --build-arg "CONTAINER_NAME=$CONTAINER_NAME" --build-arg "CONTAINER_PROXY=$CONTAINER_PROXY"

      --build-arg "CONTAINER_VERSION=$CONTAINER_VERSION" --file "${CONTAINER_DOCKERFILE}" --progress plain --push --tag

      "${CONTAINER_IMAGE}" $_CONTAINER_OPTS "${CONTAINER_CONTEXT}"
    - COSIGN_IMAGE_DIGEST="$(docker inspect --format='{{index .RepoDigests 0}}' "$CONTAINER_IMAGE")"
    - cosign sign --yes "$COSIGN_IMAGE_DIGEST"
  id_tokens:
    SIGSTORE_ID_TOKEN:
      aud: "sigstore"
