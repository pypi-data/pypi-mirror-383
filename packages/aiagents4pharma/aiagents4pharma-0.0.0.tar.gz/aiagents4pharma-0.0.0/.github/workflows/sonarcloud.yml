# SonarCloud code quality analysis workflow
name: SonarCloud Analysis

on:
  workflow_run:
    workflows:
      - "TESTS Talk2Scholars"
      - "TESTS Talk2AIAgents4Pharma"
      - "TESTS Talk2BioModels"
      - "TESTS Talk2KnowledgeGraphs"
      - "TESTS Talk2Cells"
    types:
      - completed
  workflow_dispatch:

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Shallow clones should be disabled for better analysis
          repository: ${{ github.event.workflow_run.head_repository.full_name || github.repository }}
          ref: ${{ github.event.workflow_run.head_sha || github.event.workflow_run.head_branch || github.ref }}

      - name: Download test artifacts
        uses: actions/download-artifact@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          pattern: "*-reports-*"
          path: ./reports/
          merge-multiple: true
          if-no-artifact-found: warn

      - name: Check for coverage reports
        id: reports
        run: |
          set -euo pipefail
          FOUND=false
          if [ -d "./reports" ]; then
            if find ./reports -type f \( -name "*.xml" -o -name "*.json" -o -name "*.lcov" \) | grep -q .; then
              FOUND=true
            fi
          fi

          if [ "$FOUND" = "true" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "Coverage reports detected."
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "No coverage reports found; SonarCloud scan will be skipped."
          fi

      - name: Move reports to root for SonarCloud
        if: steps.reports.outputs.found == 'true'
        run: |
          if [ -d ./reports ]; then
            cp ./reports/*.xml . 2>/dev/null || true
            cp ./reports/*.json . 2>/dev/null || true
          fi

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.3.1
        if: steps.reports.outputs.found == 'true' || github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
