---

name: ♲ manylinux containers

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
  schedule:
  # Run once a week on Mondays
  - cron: 0 0 * * MON
  pull_request:
    paths:
    - .github/workflows/build-manylinux-container-images.yml
    - build-scripts/manylinux-container-image/**
  push:
    branches:
    - devel
    paths:
    - .github/workflows/build-manylinux-container-images.yml
    - build-scripts/manylinux-container-image/**

jobs:
  build:
    runs-on: ${{ matrix.IMAGE.HOST_OS || 'ubuntu-latest' }}

    timeout-minutes: 50

    strategy:
      matrix:
        # All cached images we prebuild now target PEP 600 tags only
        IMAGE:
        # Build containers for x86_64
        - ARCH: x86_64
          QEMU_ARCH: amd64
        # Build containers for aarch64 (ARM 64)
        - ARCH: aarch64
          HOST_OS: ubuntu-24.04-arm
        # Build containers for ppc64le
        - ARCH: ppc64le
        # Build containers for s390x
        - ARCH: s390x
        YEAR:
        - _2_24
        - _2_28
        - _2_34
        include:
        - IMAGE:
            ARCH: armv7l
            HOST_OS: ubuntu-24.04-arm
          YEAR: _2_31  # There are no base images prior to 2.31 for this arch

    env:
      LIBSSH_VERSION: 0.11.3
      PYPA_MANYLINUX_TAG: >-
        manylinux${{ matrix.YEAR }}_${{ matrix.IMAGE.ARCH }}
      FULL_IMAGE_NAME: >-
        ${{
          github.repository
        }}-manylinux${{
          matrix.YEAR
        }}_${{
          matrix.IMAGE.ARCH
        }}
      QEMU_ARCH: ${{ matrix.IMAGE.QEMU_ARCH || matrix.IMAGE.ARCH }}

    defaults:
      run:
        working-directory: build-scripts/manylinux-container-image/

    name: >-  # can't use `env` in this context:
      🐳
      manylinux${{ matrix.YEAR }}_${{ matrix.IMAGE.ARCH }}
    steps:
    - name: Fetch the repo src
      uses: actions/checkout@v4.1.6
    - name: >-
        Set up QEMU ${{ env.QEMU_ARCH }} arch emulation
        with Podman
      if: >-
        !contains(fromJSON('["aarch64", "amd64", "armv7l"]'), env.QEMU_ARCH)
      run: >
        sudo podman run
        --rm --privileged
        tonistiigi/binfmt
        --uninstall 'qemu-*'


        sudo podman run
        --rm --privileged
        tonistiigi/binfmt
        --install all
    - name: Build the image with Buildah
      id: build-image
      uses: redhat-actions/buildah-build@v2.13
      with:
        arch: ${{ env.QEMU_ARCH }}
        image: ${{ env.FULL_IMAGE_NAME }}
        tags: >-
          ${{ github.sha }}
          libssh-v${{ env.LIBSSH_VERSION }}_gh-${{ github.sha }}
          libssh-v${{ env.LIBSSH_VERSION }}
          latest
        dockerfiles: build-scripts/manylinux-container-image/Dockerfile
        context: build-scripts/manylinux-container-image/
        oci: true  # Should be alright because we don't publish to Docker Hub
        build-args: |
          LIBSSH_VERSION=${{ env.LIBSSH_VERSION }}
          RELEASE=${{ env.PYPA_MANYLINUX_TAG }}
    - name: Push to GitHub Container Registry
      if: >-
        (github.event_name == 'push' || github.event_name == 'schedule')
        && github.ref == format(
            'refs/heads/{0}', github.event.repository.default_branch
        )
      id: push-to-ghcr
      uses: redhat-actions/push-to-registry@v2.8
      with:
        image: ${{ steps.build-image.outputs.image }}
        tags: ${{ steps.build-image.outputs.tags }}
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Log the upload result
      if: >-
        (github.event_name == 'push' || github.event_name == 'schedule')
        && github.ref == format(
            'refs/heads/{0}', github.event.repository.default_branch
        )
      run: >-
        echo
        'New image has been pushed to
        ${{ steps.push-to-ghcr.outputs.registry-paths }}'

...
