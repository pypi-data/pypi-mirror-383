<!-- enap_designsystem/blocks/suap/suap_courses_block.html -->
{% load wagtailcore_tags wagtailimages_tags %}
{% load static %}

<section class="container suap-courses-section">
    <div class="suap-wrapper-texts">
        {% if bloco_suap.title %}
            <h2 style="color: {{value.cor_title}}" class="suap-h2-title">{{ bloco_suap.title }}</h2>
        {% endif %}
        
        {% if bloco_suap.description %}
            <h3 style="color: {{value.cor_description}}" class="suap-sub-title">{{ bloco_suap.description }}</h3>
        {% endif %}
    </div>
    
    {% if cursos_suap %}
        <div class="suap-wrapper">
            <div class="suap-courses-carousel-container" id="suap-courses-carousel-container">
                <div class="suap-courses-carousel-items" id="suap-courses-carousel-items">
                    {% for curso in cursos_suap %}
                    <div class="suap-courses-carousel-item">
                        <a href="{{ curso.url}}" class="suap-courses-item-link" target="_blank" rel="noopener noreferrer">
                            <div class="suap-courses-carousel-item-content">
                                <div class="suap-courses-carousel-datetime">
                                    {% if curso.data_inicio_aula %}
                                        <div class="suap-course-date">
                                            <span class="suap-course-day">
                                                {{ curso.data_inicio_aula|date:"d" }}
                                            </span>
                                            <div class="suap-course-month-year">
                                                <span class="suap-text-date">
                                                    {{ curso.data_inicio_aula|date:"F" }}
                                                </span>
                                                <span class="suap-text-date">
                                                    {{ curso.data_inicio_aula|date:"Y" }}
                                                </span>
                                            </div>
                                            <span class="suap-text-date">
                                                {{ curso.data_inicio_aula|date:"l" }}
                                            </span>
                                        </div>
                                        {% if curso.carga_horaria %}
                                            <p class="suap-course-time">{{ curso.carga_horaria }}h de duração</p>
                                        {% endif %}
                                    {% elif curso.data_inicio %}
                                        <div class="suap-course-date">
                                            <span class="suap-course-day">
                                                {{ curso.data_inicio|date:"d" }}
                                            </span>
                                            <div class="suap-course-month-year">
                                                <span class="suap-text-date">
                                                    {{ curso.data_inicio|date:"F" }}
                                                </span>
                                                <span class="suap-text-date">
                                                    {{ curso.data_inicio|date:"Y" }}
                                                </span>
                                            </div>
                                            <span class="suap-text-date">
                                                {{ curso.data_inicio|date:"l" }}
                                            </span>
                                        </div>
                                        {% if curso.carga_horaria %}
                                            <p class="suap-course-time">{{ curso.carga_horaria }}h de duração</p>
                                        {% endif %}
                                    {% else %}
                                        <div class="suap-course-icon">
                                            <i class="fa-solid fa-graduation-cap" style="font-size: 44px; color: #007D7A;"></i>
                                        </div>
                                        {% if curso.carga_horaria %}
                                            <div class="suap-course-duration">
                                                <span class="suap-text-date">{{ curso.carga_horaria }}h</span>
                                            </div>
                                        {% endif %}
                                        {% if curso.modalidade %}
                                            <p class="suap-course-modality">{{ curso.modalidade }}</p>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <div class="suap-courses-carousel-content">
                                    <div class="suap-course-tag">
                                        Curso
                                    </div>
                                    {% if curso.descricao %}
                                        <h3 class="suap-courses-title">{{ curso.descricao }}</h3>
                                    {% endif %}
                                    {% if curso.breve_descricao %}
                                        <p class="card-text">{{ curso.breve_descricao|truncatewords:10 }}</p>
                                    {% endif %}
                                    
                                    <!-- Status de inscrições -->
                                    {% if curso.incricoes %}
                                        <div class="suap-course-inscricoes">
                                            <i class="fa-solid fa-calendar-check"></i> {{ curso.incricoes }}
                                        </div>
                                    {% endif %}
                                    
                                    <div class="suap-course-location">
                                        {% if curso.modalidade %}
                                            {% if "distância" in curso.modalidade or "remot" in curso.modalidade|lower %}
                                                <i class="fa-solid fa-laptop"></i> {{ curso.modalidade }}
                                            {% elif "presencial" in curso.modalidade|lower %}
                                                <i class="fa-solid fa-location-dot"></i> {{ curso.modalidade }}
                                            {% else %}
                                                <i class="fa-solid fa-graduation-cap"></i> {{ curso.modalidade }}
                                            {% endif %}
                                        {% else %}
                                            <i class="fa-solid fa-laptop"></i> Online
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                <button class="suap-courses-carousel-control suap-courses-carousel-control-prev">
                    <img style="width: 40px; height: 40px;" src="{% static 'enap_designsystem/icons/iconleft.svg' %}" alt="Passar pro lado esquerdo">
                </button>
                <button class="suap-courses-carousel-control suap-courses-carousel-control-next">
                    <img style="width: 40px; height: 40px;" src="{% static 'enap_designsystem/icons/iconrig.svg' %}" alt="Passar pro lado direito">
                </button>
            </div>
        </div>
        {% if bloco_suap.url_button %}
        <a class="suap-btn-todos" href="{{ bloco_suap.url_button }}">{{ bloco_suap.button }}</a>
        {% endif %}
    {% else %}
        <div class="suap-courses-empty">
            <p>Nenhum curso disponível no momento.</p>
        </div>
        {% if bloco_suap.url_button %}
        <a class="suap-btn-todos" href="{{ bloco_suap.url_button }}">{{ bloco_suap.button }}</a>
        {% endif %}
    {% endif %}
</section>

<style>
    .suap-course-inscricoes {
        margin: 8px 0;
        font-size: 14px;
        color: #6c757d;
    }
    
    .suap-course-inscricoes i {
        margin-right: 4px;
    }

    .suap-btn-todos{
        display: flex;
        align-items: center;
        justify-content: center;
        height: 40px;
        text-decoration: none;
        color: #007D7A;
        border: 1px solid #007D7A;
        padding: 8px 24px;
        border-radius: 40px;
        margin: auto;
        background-color: white;
        font-weight: 600;
    }
    .suap-btn-todos:hover{
        background-color: #006969;
        color: #ffffff;
        border: 1px solid #006969;
    }

    .suap-btn-todos:active{
        background-color: #025257;
        color: #ffffff;
        border: 1px solid #025257;
    }
    .suap-courses-section {
        max-width: 1142px;
        margin: auto;
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 40px;
        overflow: hidden;
        padding: 45px 0;
    }
    
    .suap-wrapper-texts {
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        align-items: {{value.posicao_title}};
    }
    
    .suap-h2-title {
        margin: 0;
        font-size: 40px;
        font-weight: 600;
        color: #434A54;
    }
    
    .suap-sub-title {
        font-size: 20px;
        font-weight: 400;
        margin: 10px 0 0 0;
        color: #434A54;
    }
    
    .suap-wrapper {
        position: relative;
        width: 1142px;
        margin: auto;
    }
    
    .suap-courses-carousel-container {
        position: relative;
        max-width: 1142px;
        margin: auto;
    }
    
    .suap-courses-carousel-items {
        display: flex;
        transition: transform 0.3s ease-in-out;
        gap: 25px;
        cursor: grab;
        width: calc(100% + 25px);
        margin-right: -25px;
    }
    
    .suap-courses-carousel-items:active {
        cursor: grabbing;
    }
    
    .suap-courses-carousel-item {
        flex-shrink: 0;
        width: 364px;
        margin-right: 0;
    }
    
    .suap-courses-item-link {
        text-decoration: none;
        color: inherit;
        display: block;
    }
    
    .suap-courses-carousel-item-content {
        display: flex;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #C8D1E0;
        height: 300px;
    }
    
    .suap-courses-carousel-datetime {
        width: 35%;
        border-radius: 8px 0 0 8px;
        overflow: hidden;
        text-align: center;
        background-color: #EBEFF5;
        padding: 20px 10px;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    .suap-course-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .suap-course-date {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .suap-course-day {
        font-size: 44px;
        color: #007D7A;
        font-weight: 700;
        line-height: 1;
    }
    
    .suap-course-month-year {
        margin: 5px 0;
    }
    
    .suap-course-time {
        font-size: 14px;
        color: #58606E;
        margin-top: 10px;
        margin-bottom: 0;
    }
    
    .suap-text-date {
        font-size: 16px;
        color: #58606E;
        font-weight: 600;
        text-align: center;
    }
    
    .suap-course-modality {
        font-size: 14px;
        color: #58606E;
        margin-top: 10px;
        margin-bottom: 0;
    }
    
    .suap-courses-carousel-content {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: space-between;
        width: 65%;
        background-color: white;
        height: 100%;
        padding: 20px;
        text-align: left;
    }
    
    .suap-course-tag {
        border: 1px solid #FC7D5C;
        font-size: 14px;
        color: #FC7D5C;
        border-radius: 24px;
        padding: 0px 15px;
        display: inline-block;
    }
    
    .suap-courses-title {
        font-size: 20px;
        color: #007D7A;
        text-decoration: none;
        font-weight: 500;
        margin: 10px 0;
    }
    
    .suap-card-text {
        text-align: left;
        margin: 0;
        font-size: 14px;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        flex-grow: 1;
    }
    
    .suap-course-location {
        font-size: 14px;
        color: #58606E;
    }
    
    .suap-courses-carousel-control {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 30px;
        color: #333;
        cursor: pointer;
        border: none;
        background-color: transparent;
        z-index: 10;
    }
    
    .suap-courses-carousel-control-prev {
        left: -5px;
    }
    
    .suap-courses-carousel-control-next {
        right: -5px;
    }
    
    .suap-courses-empty {
        text-align: center;
        padding: 3rem;
        color: #666;
        font-style: italic;
    }
    
    /* Estilos responsivos */
    @media (max-width: 992px) {
        .suap-courses-section {
            gap: 30px;
            padding-left: 10px;
        }
        
        .suap-h2-title {
            font-size: 32px;
        }
        
        .suap-sub-title {
            font-size: 20px;
            text-align: left;
        }

        .suap-wrapper-texts {
            margin-top: 40px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            max-width: 81vw;
        }
    }
    
    @media (max-width: 1142px) {
        .suap-wrapper {
            width: 100%;
            padding: 0 20px;
        }
    }
    
    @media (max-width: 768px) {
        .suap-courses-carousel-item {
            width: 70vw;
            max-width: 400px;
        }

        .suap-wrapper {
            width: 100%;
            padding: 0px;
        }
        
        .suap-courses-carousel-control {
            display: none !important;
        }
        
        .suap-h2-title {
            font-size: 32px;
        }
        
        .suap-sub-title {
            font-size: 20px;
            text-align: left;
        }
    }
    
    @media (max-width: 576px) {
        .suap-courses-carousel-item-content {
            flex-direction: column;
            height: 100%;
        }
        
        .suap-courses-carousel-datetime {
            width: 100%;
            height: auto;
            border-radius: 8px 8px 0 0;
            padding: 15px;
        }
        
        .suap-courses-carousel-content {
            width: 100%;
            height: auto;
            padding: 15px;
            gap: 10px;
        }
        
        .suap-course-icon i {
            font-size: 36px !important;
        }
        
        .suap-courses-title {
            font-size: 18px;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Selecionar elementos do DOM
        const container = document.getElementById('suap-courses-carousel-container');
        const carouselItems = document.getElementById('suap-courses-carousel-items');
        const prevBtn = document.querySelector('.suap-courses-carousel-control-prev');
        const nextBtn = document.querySelector('.suap-courses-carousel-control-next');
        const items = carouselItems.querySelectorAll('.suap-courses-carousel-item');
        
        // Variáveis de controle
        let currentIndex = 0;
        let startX, moveX, initialPosition;
        let isDragging = false;
        
        // Dimensões fixas dos itens - IMPORTANTE para alinhamento correto
        const itemWidth = 364; // Largura do item
        const itemGap = 25;    // Espaçamento entre itens
        const itemTotalWidth = itemWidth + itemGap; // Largura total de cada item + gap
        
        // Adicionar padding ao contêiner para garantir alinhamento correto dos cards
        container.style.paddingLeft = '0px';
        container.style.paddingRight = '0px';
        
        // Verifica se é dispositivo móvel
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        // Determina quantos itens são visíveis na viewport atual
        function getVisibleItems() {
            const containerWidth = container.offsetWidth;
            return Math.max(1, Math.floor(containerWidth / itemTotalWidth));
        }
        
        // Calcula o índice máximo possível
        function getMaxIndex() {
            return Math.max(0, items.length - getVisibleItems());
        }
        
        // Define quantos itens devem ser rolados de cada vez
        function getScrollAmount() {
            return isMobile() ? 1 : 3; // 1 no mobile, 3 no desktop
        }
        
        // Exibe o slide no índice especificado com alinhamento perfeito
        function showSlide(index) {
            // Garante que o índice esteja dentro dos limites válidos
            const maxIndex = getMaxIndex();
            currentIndex = Math.max(0, Math.min(index, maxIndex));
            
            // Calcula o offset preciso baseado no índice atual
            const offset = Math.round(currentIndex * itemTotalWidth);
            
            // Aplica a transformação com valor inteiro para evitar problemas de subpixel
            carouselItems.style.transform = `translateX(-${offset}px)`;
            
            // Atualiza a visibilidade dos botões de navegação
            updateButtons(maxIndex);
        }
        
        // Atualiza a visibilidade dos botões de navegação
        function updateButtons(maxIndex) {
            // Primeiro slide: esconde botão anterior
            if (currentIndex <= 0) {
                prevBtn.style.display = 'none';
                nextBtn.style.display = items.length > getVisibleItems() ? 'block' : 'none';
            } 
            // Último slide: esconde botão próximo
            else if (currentIndex >= maxIndex) {
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'none';
            } 
            // Slides intermediários: mostra ambos os botões
            else {
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'block';
            }
        }
        
        // Configurar eventos de botões de navegação
        prevBtn.addEventListener('click', () => {
            // Número de itens a retroceder depende do dispositivo
            const amount = getScrollAmount();
            const step = Math.min(amount, currentIndex);
            showSlide(currentIndex - step);
        });
        
        nextBtn.addEventListener('click', () => {
            // Número de itens a avançar depende do dispositivo
            const amount = getScrollAmount();
            const maxIndex = getMaxIndex();
            const step = Math.min(amount, maxIndex - currentIndex);
            showSlide(currentIndex + step);
        });
        
        // Eventos de toque para mobile
        carouselItems.addEventListener('touchstart', handleStart, { passive: true });
        carouselItems.addEventListener('touchmove', handleMove, { passive: false });
        carouselItems.addEventListener('touchend', handleEnd, { passive: true });
        
        // Eventos de mouse para desktop
        carouselItems.addEventListener('mousedown', handleStart);
        carouselItems.addEventListener('mousemove', handleMove);
        carouselItems.addEventListener('mouseup', handleEnd);
        carouselItems.addEventListener('mouseleave', handleEnd);
        
        // Inicia o arrasto do carousel
        function handleStart(e) {
            isDragging = true;
            startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            initialPosition = currentIndex * itemTotalWidth;
            
            // Remove transição para resposta imediata
            carouselItems.style.transition = 'none';
        }
        
        // Processa o movimento durante o arrasto
        function handleMove(e) {
            if (!isDragging) return;
            
            moveX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const diff = moveX - startX;
            
            // Aplica o movimento com efeito elástico nos limites
            const maxIndex = getMaxIndex();
            
            if (currentIndex === 0 && diff > 50) {
                // Limite inicial com efeito elástico
                carouselItems.style.transform = `translateX(${diff / 3 - initialPosition}px)`;
            } else if (currentIndex >= maxIndex && diff < -50) {
                // Limite final com efeito elástico
                carouselItems.style.transform = `translateX(${diff / 3 - initialPosition}px)`;
            } else {
                // Movimento normal
                carouselItems.style.transform = `translateX(${diff - initialPosition}px)`;
            }
            
            // Previne o scroll da página durante o arrasto horizontal
            if (Math.abs(diff) > 10 && e.type === 'touchmove') {
                e.preventDefault();
            }
        }
        
        // Finaliza o arrasto do carousel
        function handleEnd() {
            if (!isDragging) return;
            isDragging = false;
            
            // Restaura a transição suave
            carouselItems.style.transition = 'transform 0.3s ease-in-out';
            
            // Determina se o movimento foi significativo para mudar o slide
            const diff = moveX - startX;
            const threshold = itemWidth / 4; // 25% da largura do item
            
            if (diff > threshold) {
                // Swipe para direita (voltar)
                const amount = getScrollAmount();
                const step = Math.min(amount, currentIndex);
                showSlide(currentIndex - step);
            } else if (diff < -threshold) {
                // Swipe para esquerda (avançar)
                const amount = getScrollAmount();
                const maxIndex = getMaxIndex();
                const step = Math.min(amount, maxIndex - currentIndex);
                showSlide(currentIndex + step);
            } else {
                // Movimento pequeno, volta à posição atual
                showSlide(currentIndex);
            }
        }
        
        // Previne cliques em links durante arrasto
        const links = carouselItems.querySelectorAll('a');
        links.forEach(link => {
            link.addEventListener('click', function(e) {
                if (isDragging || (moveX && Math.abs(moveX - startX) > 10)) {
                    e.preventDefault();
                }
            });
        });
        
        // Adapta o carousel quando a janela é redimensionada
        window.addEventListener('resize', function() {
            // Força uma pausa antes de recalcular para garantir medidas corretas
            setTimeout(function() {
                // Recalcula índices e posição
                const maxIndex = getMaxIndex();
                if (currentIndex > maxIndex) {
                    currentIndex = maxIndex;
                }
                
                // Restaura transição para animação suave
                carouselItems.style.transition = 'transform 0.3s ease-in-out';
                
                // Atualiza a exibição
                showSlide(currentIndex);
            }, 100);
        });
        
        // Aguardar que todas as imagens carreguem para inicializar corretamente
        window.addEventListener('load', function() {
            // Inicializa com um pequeno delay para garantir medidas corretas
            setTimeout(function() {
                // Certificar que os estilos estão aplicados antes de inicializar
                carouselItems.style.transition = 'transform 0.3s ease-in-out';
                showSlide(0);
            }, 100);
        });
        
        // Inicializa o carousel (também será inicializado no evento load)
        showSlide(0);
    });
</script>