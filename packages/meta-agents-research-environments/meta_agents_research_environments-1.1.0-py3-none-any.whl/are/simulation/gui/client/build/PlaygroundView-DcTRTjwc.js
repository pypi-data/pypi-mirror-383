import{a as l,u as ee,j as e,T as R,k as X,bd as be,be as je,aN as C,af as ue,ay as F,q as oe,V as ve,d as Y,p as ye,bp as Ie,bq as Me,F as ie,I as le,h as re,M as P,C as we,B as Ae,bj as Ee,bk as Te,L as Q,bm as Ce,br as ke,bs as De,bt as Fe,aU as Pe,bu as Re}from"./mui-core-BlhCn0CU.js";import{L as Ue,g as Le,m as J,A as ce,F as Ne,I as Oe,N as Z,M as _e,h as $e,d as ze,i as Ve,e as Be,C as We,c as Ge}from"./TraceExporter-uEHw2zO8.js";import{r as z,u as q,b as te,d as Ke,c as ne,E as I,h as de,i as Je,j as Xe,k as qe,v as He,l as Ye,m as Qe,n as Ze,e as et,o as tt,p as nt,S as st}from"./index-5gS5V8rY.js";import{u as at}from"./Router-B9tXN2Nb.js";import"./mui-x-data-grid-CyvgF52i.js";import"./mui-x-other-B2m3wUf6.js";const ge=(function(){var u={defaultValue:null,kind:"LocalArgument",name:"attachments"},i={defaultValue:null,kind:"LocalArgument",name:"message"},o={defaultValue:null,kind:"LocalArgument",name:"sessionId"},n=[{alias:null,args:[{kind:"Variable",name:"attachments",variableName:"attachments"},{kind:"Variable",name:"message",variableName:"message"},{kind:"Variable",name:"sessionId",variableName:"sessionId"}],kind:"ScalarField",name:"sendUserMessageToAgent",storageKey:null}];return{fragment:{argumentDefinitions:[u,i,o],kind:"Fragment",metadata:null,name:"SendUserMessageToAgentMutation",selections:n,type:"Mutation",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[i,u,o],kind:"Operation",name:"SendUserMessageToAgentMutation",selections:n},params:{cacheID:"74f0a828c2f82eb75adac17c78ea0db6",id:null,metadata:{},name:"SendUserMessageToAgentMutation",operationKind:"mutation",text:`mutation SendUserMessageToAgentMutation(
  $message: String!
  $attachments: [[String!]!]
  $sessionId: String!
) {
  sendUserMessageToAgent(message: $message, attachments: $attachments, sessionId: $sessionId)
}
`}}})();ge.hash="272774c5b1fccd477554ccc220c6b8f2";const ot=ge;function it(u,i,o,n,b,g,p){const h={message:i,sessionId:n,attachments:o.map(c=>[c.file.name,c.base64])};z.commitMutation(u,{mutation:ot,variables:h,onCompleted:(c,y)=>{if(y)console.log("Errors:",y),b({message:"Errors: "+JSON.stringify(y),type:"error"}),p&&p();else{console.log("Response:",c);const r=c.sendUserMessageToAgent;console.log("Message ID:",r),g&&r&&g(r)}},onError:c=>{console.error(c),b({message:c?.messageFormat??"Error: "+JSON.stringify(c),type:"error"}),p&&p(c)}})}function lt(){const{eventLog:u,envState:i,localEnvState:o,setLocalEnvState:n,isResettingScenario:b,setIsResettingScenario:g}=q(),p=l.useContext(te),[h]=z.useMutation(Ke),[c]=z.useMutation(Ue),{notify:y}=ne(),r=ee(),k=()=>{n(I.STOPPED),h({variables:{sessionId:p},onCompleted:()=>{},onError:A=>{n(i),console.error(`Error stopping scenario: ${A.message}`),y({type:"error",message:"Error stopping scenario"})}})},v=()=>{g(!0),n(I.SETUP),c({variables:{sessionId:p},onCompleted:()=>{g(!1)},onError:A=>{g(!1),n(i),console.error(`Error resetting scenario: ${A.message}`),y({type:"error",message:"Error resetting scenario"})}})};return e.jsx(e.Fragment,{children:["RUNNING","PAUSED","FAILED"].includes(o)?e.jsx(R,{title:"Stop scenario",children:e.jsx("span",{children:e.jsx(X,{size:"small",color:"error",onClick:()=>k(),sx:{bgcolor:`${r.palette.lightgrey.main}`,opacity:1,"&:hover":{bgcolor:`${r.palette.lightgrey.main}`,opacity:.5},transition:"opacity 0.2s"},children:e.jsx(be,{})})})}):e.jsx(R,{title:b?"Resetting scenario...":"Reload scenario",children:e.jsx("span",{children:e.jsx(X,{size:"small",onClick:()=>v(),disabled:b||!o||(o===I.SETUP||i===I.SETUP)&&u.length===0,color:"darkgrey",sx:{bgcolor:`${r.palette.lightgrey.main}`,opacity:1,"&:hover":{bgcolor:`${r.palette.lightgrey.main}`,opacity:.5}},children:e.jsx(je,{})})})})})}const rt=qe.map(u=>`.${u}`).join(",");function ct(){const{appsState:u,scenario:i,eventLog:o,envState:n,localEnvState:b}=q(),g=l.useRef(null),p=l.useRef(null),[h,c]=l.useState(null),[y,r]=l.useState(!1),[k,v]=l.useState(null),[A,U]=l.useState(!1),[V,L]=l.useState(!1),x=n===I.STOPPED,E=n===I.FAILED,N=z.useRelayEnvironment(),O=l.useContext(te),[M,D]=l.useState([]),{notify:T}=ne(),f=ee();let s=rt,w="Attach image";const B=t=>{const a=Ye(t);if(!a.isValid){T({message:a.error||"File validation failed",type:"error"});return}const m=[...M.map(S=>S.file),t],j=Qe(m);if(!j.isValid){T({message:j.error||"Total size validation failed",type:"error"});return}if(M.some(S=>S.file.name===t.name&&S.file.size===t.size))return;v(t);const d=new FileReader;d.onloadend=()=>{const S=d.result?.toString();S!=null&&D(Se=>[...Se,{file:t,base64:S.split(",")[1]}])},d.readAsDataURL(t)},pe=o.filter(t=>t.event_type==="USER"&&t.action!=null&&t.action.app_name===de&&t.action.function_name==="send_message_to_agent").map(t=>t.action.args.content).filter(t=>t!=null),_=Je(i?.scenarioId,pe),{addPendingMessage:H,removePendingMessage:$}=Xe(),[se,W]=l.useState(new Map);l.useEffect(()=>{const t=Array.from(se.entries());for(const[a,m]of t){if(!m)continue;o.some(d=>d.metadata?.return_value===m)&&(W(d=>{const S=new Map(d);return S.delete(a),S}),$(a))}},[o,se,$]);const G=l.useCallback(async(t,a)=>{if(t===null||t.trim()===""||x)return;L(!0);const m=`pending-${Date.now()}-${Math.random().toString(36).substring(2,9)}`;W(j=>{const d=new Map(j);return d.set(m,null),d}),H({id:m,content:t,attachments:a.map(j=>j.file.name),timestamp:Date.now()/1e3,correlationId:null}),c(null),D([]),v(null),n===I.SETUP&&await Le(N,O,T),it(N,t,a,O,T,j=>{$(m),H({id:m,content:t,attachments:a.map(d=>d.file.name),timestamp:Date.now()/1e3,correlationId:j}),W(d=>{const S=new Map(d);return S.set(m,j),S})},()=>{$(m),W(j=>{const d=new Map(j);return d.delete(m),d}),L(!1)})},[D,v,H,$,N,O,T,n,x]),me=t=>{const a=t.target;t.key==="Enter"&&!t.shiftKey&&a.value&&a.value.trim()!==""&&!x&&(G(h,M),t.preventDefault())},he=t=>{c(t.target.value)},ae=l.useMemo(()=>{for(let t=o.length-1;t>=0;t--){const a=o[t];if(a.action!=null&&a.action.app_name===de)return a.event_type==="AGENT"&&a.action.function_name==="send_message_to_user"}return!0},[o]),xe=l.useMemo(()=>_!=null&&Object.keys(_).length>0&&!x&&!V&&ae&&e.jsxs(C,{gap:1,children:[e.jsx(J.div,{children:e.jsx(ue,{variant:"subtitle2",color:"textDisabled",sx:{paddingX:5},children:"Suggested prompts"})},"dialog-options-header"),e.jsx(F,{sx:{display:"flex",flexWrap:"wrap",gap:1,paddingX:5,maxWidth:500},children:Object.keys(_).map((t,a)=>e.jsx(J.div,{initial:{opacity:0},animate:{opacity:1},children:e.jsx(oe,{label:t,onClick:()=>{G(t,[])},sx:{paddingY:1,height:"100%",display:"flex",flexDirection:"row","& .MuiChip-label":{overflowWrap:"break-word",whiteSpace:"normal",textOverflow:"clip"}}})},a))})]}),[_,V,x,G,ae]);l.useEffect(()=>{L(!1)},[_]);const fe=M.length>0&&e.jsx(F,{sx:{display:"flex",alignItems:"center",flexWrap:"wrap",gap:1},children:M.map(t=>e.jsx(J.div,{initial:{opacity:0},animate:{opacity:1},children:e.jsx(oe,{label:t.file.name,variant:"outlined",onDelete:()=>D(a=>a.filter(m=>m!==t))})},t.file.name))}),K=u.find(t=>["Files","SandboxLocalFileSystem"].includes(t.app_name))===void 0;return e.jsxs(F,{sx:{display:"flex",flexDirection:"column",gap:2.5,alignItems:"flex-start",paddingBottom:3,width:"100%"},children:[e.jsx(ce,{children:xe}),e.jsx(ve,{component:"form",elevation:2,sx:{width:"100%",bgcolor:f.palette.background.default,padding:1.5,cursor:"text",borderRadius:4,border:`1px solid ${A?f.palette.primary.main:y?Y(f.palette.action.focus,.2):Y(f.palette.action.disabled,.05)}`,transition:"all 0.2s",backgroundColor:A?Y(f.palette.action.hover,.1):"transparent"},onClick:()=>{g.current?.focus()},onDragOver:t=>{t.preventDefault(),!K&&!x&&!E&&U(!0)},onDragLeave:()=>{U(!1)},onDrop:t=>{if(t.preventDefault(),U(!1),K||x||E)return;const a=t.dataTransfer.files?.[0];if(a){if(!He(a)){T({message:`File type not supported: ${a.name}`,type:"error"});return}B(a)}},children:e.jsxs(C,{spacing:1,children:[e.jsx(ce,{children:fe}),e.jsx(ye,{multiline:!0,value:h??"",placeholder:x?"Agent is stopped":"Message agent",onChange:he,onKeyDown:t=>me(t),onFocus:()=>r(!0),onBlur:()=>r(!1),autoFocus:!0,disabled:x||E,maxRows:12,sx:{width:"100%"},inputRef:g}),e.jsxs(C,{width:"100%",children:[e.jsx(F,{sx:{display:"none"},children:e.jsx(Ne,{ref:p,onFileSelected:t=>{t&&B(t)},accept:s,selectedFile:k})}),e.jsxs(F,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%"},children:[e.jsxs(C,{direction:"row",spacing:.5,alignItems:"center",width:"100%",children:[e.jsx(F,{children:e.jsx(R,{title:K?"Files or SandboxLocalFileSystem app is required for using attachments":w,children:e.jsx("span",{children:e.jsx(X,{size:"small",onClick:()=>{p.current?.openFileDialog()},color:"lightgrey",sx:{border:`1px solid ${f.palette.divider}`},disabled:K||x||E,children:e.jsx(Ie,{})})})})}),e.jsx(Oe,{anchorOrigin:{vertical:"bottom",horizontal:"center"},transformOrigin:{vertical:"bottom",horizontal:"center"}})]}),e.jsx(C,{direction:"row",alignItems:"center",width:"100%",justifyContent:"flex-end",spacing:.5,children:!b||(b===I.SETUP||n===I.SETUP)&&o.length===0||h?e.jsx(R,{title:"Send message",children:e.jsx("span",{children:e.jsx(X,{size:"small",sx:{color:f.palette.primary.contrastText,bgcolor:f.palette.secondary.main,"&:hover":{bgcolor:f.palette.secondary.dark},"&.Mui-disabled":{bgcolor:f.palette.secondary.main,color:f.palette.primary.contrastText,opacity:.3},transition:"opacity 0.2s"},color:"inherit",onClick:()=>G(h,M),disabled:!h||h.trim()===""||x||E,children:e.jsx(Me,{})})})}):e.jsx(lt,{})})]})]})]})})]})}function dt({extraMenuItems:u}){const i=l.useContext(te),o=z.useRelayEnvironment(),{scenarioId:n}=l.useContext(Ze),{envState:b,worldLogs:g,isLoadingScenario:p,loadScenario:h}=q(),[c,y]=l.useState(!1),{notify:r}=ne();I.RUNNING;const[k,v]=l.useState(null),{agent:A,setAgent:U,agents:V,setAgentConfig:L}=et(),x=tt(),E=Object.values(x);let N="Agent change not yet supported",O="Universe change not yet supported",M=!0,D=null;const T=s=>{try{h(st.Code,{scenarioId:s})}catch(w){console.error(w),r({message:"Error: "+JSON.stringify(w),type:"error"})}},f=s=>{const w=s===Z?null:s;U(w),nt(o,w,i,r,B=>L(B))};return e.jsx(J.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{type:"tween",duration:.2},children:e.jsxs(C,{direction:"row",justifyContent:"space-between",paddingX:3,paddingY:2,alignItems:"start",children:[e.jsx(ue,{variant:"h6",children:"Agent chat"}),e.jsxs(C,{direction:"row",spacing:.5,alignItems:"center",children:[D,e.jsx(R,{title:N,children:e.jsxs(ie,{size:"small",sx:{minWidth:100},children:[e.jsx(le,{id:"agent-select-label",children:"Agent"}),e.jsx(re,{labelId:"agent-select-label",id:"agent-select",value:A??Z,label:"Agent",onChange:s=>{f(s.target.value)},disabled:M,autoWidth:!0,children:[Z,...V].map(s=>e.jsx(P,{value:s,children:s},s))})]})}),e.jsx(R,{title:O,children:e.jsxs(ie,{size:"small",sx:{minWidth:100},children:[e.jsx(le,{id:"scenario-select-universe-label",children:"Universe"}),e.jsxs(re,{labelId:"scenario-select-universe-label",id:"scenario-select",value:n??"",label:"Universe",onChange:s=>{T(s.target.value)},disabled:M,autoWidth:!0,startAdornment:p?e.jsx(we,{size:20,sx:{marginRight:1}}):null,children:[n&&!E.some(s=>s.id===n)&&e.jsx(P,{value:n,children:n},n),E.map(({id:s,label:w})=>e.jsx(P,{value:s,children:w},s))]})]})}),e.jsx(Ae,{variant:"outlined",color:"white",size:"large",sx:{minWidth:"36px",height:"36px",padding:1},onClick:s=>{s.target!=null&&v(s.currentTarget)},disabled:p,children:e.jsx(Ee,{})}),c&&e.jsx(ut,{children:e.jsx(_e,{children:$e({logs:g,filename:n??"scenario"})})}),e.jsxs(Te,{anchorEl:k,onClose:()=>{v(null)},open:k!=null,children:[u,e.jsxs(P,{onClick:()=>{v(null),ze({environment:o,sessionId:i,scenarioId:n??"",onSuccess:()=>{r({message:"Successfully downloaded scenario",type:"success"})},onError:s=>{r({message:`Failed to download scenario: ${s}`,type:"error"})}})},children:[e.jsx(Q,{children:e.jsx(Ce,{fontSize:"small"})}),"Save trace as JSON"]}),e.jsxs(P,{onClick:()=>{v(null),Ve({logs:g,filename:n??"scenario",onSuccess:()=>{r({message:"Successfully downloaded scenario",type:"success"})},onError:s=>{r({message:`Failed to download scenario: ${s}`,type:"error"})}})},children:[e.jsx(Q,{children:e.jsx(ke,{fontSize:"small"})}),"Save trace as Markdown"]}),e.jsxs(P,{onClick:()=>{y(!0),v(null),queueMicrotask(()=>{window.print()})},children:[e.jsx(Q,{children:e.jsx(De,{fontSize:"small"})}),"Save trace as PDF"]})]})]})]})},"agent-chat-header")}function ut({children:u}){const i=document.getElementById("printable");return i&&Fe.createPortal(u,i)}function St(){const{worldLogs:u}=q(),{selectedTab:i,setSelectedTab:o}=at(),n=ee(),b={all:[{id:"agent-chat",label:"Agent chat",icon:e.jsx(Pe,{fontSize:"small"})},{id:"agent-logs",label:"Agent logs",icon:e.jsx(Re,{fontSize:"small"})}],selected:i,setSelected:o};let g=null,p=null;if(i==="agent-chat"){let h=e.jsx(dt,{});g=e.jsxs(C,{direction:"row",sx:{flexGrow:1,overflow:"hidden",borderLeft:`1px solid ${n}`},children:[e.jsx(We,{input:e.jsx(ct,{}),header:h}),p]})}else i==="agent-logs"&&(g=e.jsx(Ge,{worldLogs:u},"agent-logs"));return e.jsx(Be,{tabs:b,children:g})}export{St as default};
