variables:
  GIT_SUBMODULE_STRATEGY: recursive

default:
  tags:
    - linux
    - docker

lint:
  stage: .pre
  image: python:3.9-buster
  script:
    - pip install hatch
    - hatch run lint:all
  rules:
    - if: $CI_COMMIT_REF_PROTECTED == "true"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

test:
  stage: .pre
  image: python:3.9-buster
  script:
    - pip install hatch
    - hatch run test:test 
  rules:
    - if: $CI_COMMIT_REF_PROTECTED == "true"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  artifacts:
    paths:
      - "junit.xml"
    reports:
      junit: ["junit.xml"]
    expire_in: 1 day

build:
  stage: build
  image: python:3.9-buster
  needs: []
  artifacts:
    paths:
      - dist
  script:
    - pip install hatch
    - hatch build
  rules:
    - if: $CI_COMMIT_REF_PROTECTED == "true"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: "$CI_COMMIT_REF_NAME =~ /^v[0-9]+.[0-9]+.[0-9]+$/"

docs:
  stage: build
  image: python:3.12-bullseye
  needs: []
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    - key:
      paths:
        - .cache/pip
  script:
    - pip install hatch
    - hatch run docs:build
  artifacts:
    paths:
      - site
  rules:
    - if: $CI_COMMIT_REF_PROTECTED == "true"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

deploy-internal:
  stage: deploy
  image: python:3.9-buster
  dependencies:
    - build
  script:
    - pip install hatch
    - hatch publish -r $ARTIFACTORY_URL/api/pypi/ZIPyPI -u $ARTIFACTORY_USER -a $ARTIFACTORY_TOKEN
  rules:
    - if: "$CI_COMMIT_REF_NAME =~ /^v[0-9]+.[0-9]+.[0-9]+$/"
    - if: $CI_COMMIT_BRANCH =~ /^(release-.*|main$)/
      when: manual
      allow_failure: true

deploy-pypi:
  stage: deploy
  image: python:3.9-buster
  dependencies:
    - build
  script:
    - pip install twine
    - twine upload dist/* -u $TWINE_USERNAME -p $TWINE_TOKEN_COMMS_SCHEMAS 
  rules:
    - if: "$CI_COMMIT_REF_NAME =~ /^v[0-9]+.[0-9]+.[0-9]+$/"