# Demo Mode - Запись и Воспроизведение Сессий

## Обзор

Demo Mode позволяет записывать реальные сессии работы с LLM и затем воспроизводить их для демонстрации, создавая полностью реалистичную имитацию работы приложения.

## Возможности

- ✅ **Запись сессий**: Автоматическая запись всех ответов LLM с чанками
- ✅ **Реалистичное воспроизведение**: Имитация спиннера, потоковой передачи и задержек
- ✅ **Прозрачность**: Пользователь не замечает разницы между реальной и демо-сессией
- ✅ **Управление через конфиг**: Простое переключение режимов
- ✅ **Метаданные**: Сохранение информации о модели, параметрах, времени

## Режимы работы

### `record` - Запись

Записывает все ответы LLM в файл:
- Сохраняет запросы пользователя
- Сохраняет полные ответы LLM
- Сохраняет чанки для реалистичного воспроизведения
- Сохраняет метаданные (модель, температура, время)
- **Автоматически добавляет порядковый номер** к имени файла при каждом запуске

**Важно**: При каждом запуске в режиме записи создаётся новый файл с уникальным номером. Например, `session.json` станет `session_1.json`, `session_2.json`, `session_3.json` и т.д. Это позволяет сохранять все сессии без перезаписи.

### `play` - Воспроизведение

Воспроизводит записанные ответы:
- Показывает спиннер (настраиваемая задержка)
- Выдаёт ответы чанками как настоящий LLM
- Соблюдает настройки отображения (theme, refresh_rate)
- Игнорирует реальные запросы пользователя

### `off` - Выключен

Обычная работа с настоящим LLM API (режим по умолчанию).

## Конфигурация

В `config.yaml` (секция `global`):

```yaml
global:
  # Режим демонстрации
  demo_mode: "off"  # Варианты: "record", "play", "off"

  # Файл для записи/воспроизведения (относительно директории конфига пользователя)
  demo_file: "demo_sessions/session.json"

  # Время спиннера перед выводом (миллисекунды)
  demo_spinner: 1000
```

**Важно**:
- Эти настройки не отображаются в меню - только через файл конфигурации
- **Относительные пути** автоматически разрешаются относительно директории конфига пользователя
- **Абсолютные пути** используются как есть

### Где хранятся файлы

**Windows**: `%LOCALAPPDATA%\penguin-tamer\demo_sessions\session.json`
**Linux**: `~/.config/penguin-tamer/demo_sessions/session.json`
**macOS**: `~/Library/Application Support/penguin-tamer/demo_sessions/session.json`

Директория создаётся автоматически при первой записи.

## Примеры использования

### Сценарий 1: Запись демо-сессии

1. **Подготовка**: Откройте `config.yaml`

2. **Включите запись**:
```yaml
global:
  demo_mode: "record"
  demo_file: "my_demos/presentation.json"  # Будет сохранено в директории конфига
```

3. **Запустите приложение** и проведите сессию как обычно

4. **Результат**: Файл будет создан с порядковым номером, например:
   - Windows: `%LOCALAPPDATA%\penguin-tamer\my_demos\presentation_1.json`
   - Linux: `~/.config/penguin-tamer/my_demos/presentation_1.json`

**Примечание**: При каждом запуске создаётся новый файл (presentation_1, presentation_2, presentation_3, ...), старые не перезаписываются.

### Сценарий 2: Воспроизведение для демонстрации

1. **Настройте воспроизведение** (используйте полное имя с номером):
```yaml
global:
  demo_mode: "play"
  demo_file: "my_demos/presentation_1.json"  # Конкретный файл записи
  demo_spinner: 1500  # 1.5 секунды спиннера
```

2. **Запустите приложение**

3. **Вводите любые запросы** - приложение будет выдавать записанные ответы по порядку

4. **Для зрителя** это выглядит как настоящая работа с LLM!

### Сценарий 3: Демонстрация на конференции

```yaml
global:
  demo_mode: "play"
  demo_file: "conference_demo.json"
  demo_spinner: 2000  # Дольше спиннер для драматического эффекта
  sleep_time: 0.02    # Чуть медленнее вывод текста
  refresh_per_second: 8
```

## Формат файла записи

Файл сохраняется в JSON формате:

```json
[
  {
    "timestamp": "2025-10-11T15:30:45.123456",
    "user_query": "Как проверить использование диска?",
    "response": "Используйте команду `df -h` для проверки...",
    "chunks": [
      "Используйте",
      " команду",
      " `df",
      " -h`",
      " для",
      " проверки",
      "..."
    ],
    "metadata": {
      "model": "qwen/qwen3-coder:free",
      "temperature": 0.8,
      "timestamp": "2025-10-11T15:30:45.123456"
    },
    "user_actions": [
      {
        "type": "command",
        "value": ".ls",
        "timestamp": "2025-10-11T15:30:00.000000"
      },
      {
        "type": "query",
        "value": "Как проверить использование диска?",
        "timestamp": "2025-10-11T15:30:45.123456"
      }
    ]
  },
  ...
]
```

**Новое в последней версии**: Поле `user_actions` записывает все действия пользователя (команды через точку, выбор блоков кода, запросы к LLM). Подробнее: [DEMO_USER_ACTIONS.md](DEMO_USER_ACTIONS.md)

## Архитектура

### Модуль `demo_recorder.py`

#### `DemoResponse`
Dataclass для хранения одного записанного ответа:
- `timestamp`: время записи
- `user_query`: запрос пользователя
- `response`: полный ответ
- `chunks`: список чанков
- `metadata`: дополнительная информация
- `user_actions`: список действий пользователя перед этим ответом (NEW!)

#### `DemoRecorder`
Класс для записи ответов:
- `record_response()` - записать ответ (теперь с user_actions)
- `get_response_count()` - количество записей
- `clear_responses()` - очистить все записи

#### `DemoPlayer`
Класс для воспроизведения:
- `play_next_response()` - получить следующий ответ
- `has_more_responses()` - есть ли ещё ответы
- `create_chunk_generator()` - генератор чанков
- `get_spinner_delay()` - задержка спиннера
- `reset()` - сброс на начало

#### `DemoManager`
Управляющий класс:
- Автоматический выбор режима
- Инициализация Recorder или Player
- Проверки состояния (`is_recording()`, `is_playing()`)

### Интеграция в `llm_client.py`

#### `StreamProcessor`
- Добавлено поле `recorded_chunks` для сбора чанков
- Метод `_stream_with_live_display` записывает каждый чанк

#### `DemoStreamProcessor`
Наследует `StreamProcessor`, переопределяет:
- `process()` - использует демо-данные вместо API
- `_show_demo_spinner()` - показывает спиннер
- `_stream_demo_chunks()` - выдаёт чанки из записи

#### `OpenRouterClient`
- Поле `_demo_manager` - экземпляр DemoManager
- Метод `ask_stream()` выбирает процессор в зависимости от режима
- В режиме записи сохраняет ответы через recorder

## Рекомендации

### Для записи качественных демо

1. **Подготовьте сценарий**: Заранее продумайте, что будете показывать
2. **Проверьте настройки**: Убедитесь что `demo_mode: "record"`
3. **Используйте реалистичные запросы**: Вводите естественные вопросы
4. **Запишите несколько вариантов**: На случай если что-то пойдёт не так

### Для воспроизведения

1. **Протестируйте заранее**: Прогоните демо перед презентацией
2. **Подберите время спиннера**: 1000-2000 мс обычно оптимально
3. **Проверьте количество записей**: Должно хватить на всю демонстрацию
4. **Имейте запасной план**: Файл с большим количеством записей

### Настройка реалистичности

```yaml
# Быстрый вывод (как настоящий быстрый API)
demo_spinner: 500
sleep_time: 0.005

# Медленный вывод (для драматического эффекта)
demo_spinner: 2000
sleep_time: 0.03

# Баланс (рекомендуется)
demo_spinner: 1000
sleep_time: 0.01
```

## Ограничения

1. **Порядок воспроизведения**: Ответы выдаются последовательно, независимо от запросов
2. **Конец записи**: После последнего ответа выдаётся предупреждение
3. **Нет адаптации**: Нельзя изменить ответ на лету
4. **Размер файла**: При большом количестве записей файл может быть большим

## Решение проблем

### Проблема: "Demo playback: No more recorded responses"

**Причина**: Закончились записанные ответы

**Решение**:
- Запишите больше ответов
- Или перезапустите приложение (счётчик сбросится)

### Проблема: Воспроизведение слишком быстрое/медленное

**Решение**: Настройте параметры:
```yaml
demo_spinner: 1500  # Измените время спиннера
sleep_time: 0.02    # Измените скорость вывода текста
```

### Проблема: Файл не создаётся в режиме record

**Проверьте**:
1. Права на запись в директорию
2. Правильность пути в `demo_file`
3. Logs для ошибок

### Проблема: Файл записи повреждён

**Решение**:
1. Проверьте JSON синтаксис
2. Используйте `DemoRecorder.clear_responses()` и запишите заново
3. Или создайте файл вручную по формату выше

## Примеры для разных целей

### Обучающая сессия
```yaml
demo_mode: "record"
demo_file: "tutorial_session.json"
# Медленнее для лучшего понимания
sleep_time: 0.02
```

### Презентация возможностей
```yaml
demo_mode: "play"
demo_file: "showcase_demo.json"
# Быстро и эффектно
demo_spinner: 800
sleep_time: 0.008
```

### Тестирование интерфейса
```yaml
demo_mode: "play"
demo_file: "ui_test.json"
# Максимально быстро
demo_spinner: 100
sleep_time: 0
```

## Заключение

Demo Mode - мощный инструмент для:
- Демонстраций без зависимости от интернета и API
- Создания воспроизводимых презентаций
- Тестирования интерфейса с предсказуемыми данными
- Обучения без расхода API квоты

Все работает прозрачно и реалистично - зрители не заметят разницы!
