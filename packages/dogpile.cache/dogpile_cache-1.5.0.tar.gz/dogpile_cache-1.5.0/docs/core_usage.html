
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>dogpile Core &#8212; dogpile.cache 1.5.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/changelog.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx_paramlinks.css" />
    <link rel="stylesheet" type="text/css" href="_static/site_custom_css.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=40912020"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'core_usage';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API" href="api.html" />
    <link rel="prev" title="Recipes" href="recipes.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">dogpile.cache 1.5.0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="front.html">Front Matter</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Recipes</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">dogpile Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/core_usage.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>dogpile Core</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#do-i-need-to-learn-the-dogpile-core-api-directly">Do I Need to Learn the dogpile Core API Directly?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rudimentary-usage">Rudimentary Usage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-using-dogpile-directly-for-caching">Example: Using dogpile directly for Caching</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-a-file-or-distributed-lock-with-dogpile">Using a File or Distributed Lock with Dogpile</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="dogpile-core">
<h1>dogpile Core<a class="headerlink" href="#dogpile-core" title="Link to this heading">#</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">dogpile</span></code> provides a locking interface around a “value creation” and
“value retrieval” pair of functions.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 0.6.0: </span>The <code class="docutils literal notranslate"><span class="pre">dogpile</span></code> package encapsulates the
functionality that was previously provided by the separate
<code class="docutils literal notranslate"><span class="pre">dogpile.core</span></code> package.</p>
</div>
<p>The primary interface is the <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> object, which provides for
the invocation of the creation function by only one thread and/or process at
a time, deferring all other threads/processes to the “value retrieval” function
until the single creation thread is completed.</p>
<section id="do-i-need-to-learn-the-dogpile-core-api-directly">
<h2>Do I Need to Learn the dogpile Core API Directly?<a class="headerlink" href="#do-i-need-to-learn-the-dogpile-core-api-directly" title="Link to this heading">#</a></h2>
<p>It’s anticipated that most users of <code class="docutils literal notranslate"><span class="pre">dogpile</span></code> will be using it indirectly
via the <code class="docutils literal notranslate"><span class="pre">dogpile.cache</span></code> caching
front-end.  If you fall into this category, then the short answer is no.</p>
<p>Using the core <code class="docutils literal notranslate"><span class="pre">dogpile</span></code> APIs described here directly implies you’re building your own
resource-usage system outside, or in addition to, the one
<code class="docutils literal notranslate"><span class="pre">dogpile.cache</span></code> provides.</p>
</section>
<section id="rudimentary-usage">
<h2>Rudimentary Usage<a class="headerlink" href="#rudimentary-usage" title="Link to this heading">#</a></h2>
<p>The primary API dogpile provides is the <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> object.   This object allows for
functions that provide mutexing, value creation, as well as value retrieval.</p>
<p>An example usage is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dogpile</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">NeedRegenerationException</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># store a reference to a &quot;resource&quot;, some</span>
<span class="c1"># object that is expensive to create.</span>
<span class="n">the_resource</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">some_creation_function</span><span class="p">():</span>
    <span class="c1"># call a value creation function</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">create_some_resource</span><span class="p">()</span>

    <span class="c1"># get creationtime using time.time()</span>
    <span class="n">creationtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># keep track of the value and creation time in the &quot;cache&quot;</span>
    <span class="n">the_resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tup</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">creationtime</span><span class="p">)</span>

    <span class="c1"># return the tuple of (value, creationtime)</span>
    <span class="k">return</span> <span class="n">tup</span>

<span class="k">def</span><span class="w"> </span><span class="nf">retrieve_resource</span><span class="p">():</span>
    <span class="c1"># function that retrieves the resource and</span>
    <span class="c1"># creation time.</span>

    <span class="c1"># if no resource, then raise NeedRegenerationException</span>
    <span class="k">if</span> <span class="n">the_resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NeedRegenerationException</span><span class="p">()</span>

    <span class="c1"># else return the tuple of (value, creationtime)</span>
    <span class="k">return</span> <span class="n">the_resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># a mutex, which needs here to be shared across all invocations</span>
<span class="c1"># of this particular creation function</span>
<span class="n">mutex</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="k">with</span> <span class="n">Lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">,</span> <span class="n">some_creation_function</span><span class="p">,</span> <span class="n">retrieve_resource</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span> <span class="k">as</span> <span class="n">value</span><span class="p">:</span>
      <span class="c1"># some function that uses</span>
      <span class="c1"># the resource.  Won&#39;t reach</span>
      <span class="c1"># here until some_creation_function()</span>
      <span class="c1"># has completed at least once.</span>
      <span class="n">value</span><span class="o">.</span><span class="n">do_something</span><span class="p">()</span>
</pre></div>
</div>
<p>Above, <code class="docutils literal notranslate"><span class="pre">some_creation_function()</span></code> will be called
when <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> is first invoked as a context manager.   The value returned by this
function is then passed into the <code class="docutils literal notranslate"><span class="pre">with</span></code> block, where it can be used
by application code.  Concurrent threads which
call <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> during this initial period
will be blocked until <code class="docutils literal notranslate"><span class="pre">some_creation_function()</span></code> completes.</p>
<p>Once the creation function has completed successfully the first time,
new calls to <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> will call <code class="docutils literal notranslate"><span class="pre">retrieve_resource()</span></code>
in order to get the current cached value as well as its creation
time; if the creation time is older than the current time minus
an expiration time of 3600, then <code class="docutils literal notranslate"><span class="pre">some_creation_function()</span></code>
will be called again, but only by one thread/process, using the given
mutex object as a source of synchronization.  Concurrent threads/processes
which call <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> during this period will fall through,
and not be blocked; instead, the “stale” value just returned by
<code class="docutils literal notranslate"><span class="pre">retrieve_resource()</span></code> will continue to be returned until the creation
function has finished.</p>
<p>The <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> API is designed to work with simple cache backends
like Memcached.   It addresses such issues as:</p>
<ul class="simple">
<li><p>Values can disappear from the cache at any time, before our expiration
time is reached.  The <a class="reference internal" href="api.html#dogpile.NeedRegenerationException" title="dogpile.NeedRegenerationException"><code class="xref py py-class docutils literal notranslate"><span class="pre">NeedRegenerationException</span></code></a> class is used
to alert the <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> object that a value needs regeneration ahead
of the usual expiration time.</p></li>
<li><p>There’s no function in a Memcached-like system to “check” for a key without
actually retrieving it.  The usage of the <code class="docutils literal notranslate"><span class="pre">retrieve_resource()</span></code> function
allows that we check for an existing key and also return the existing value,
if any, at the same time, without the need for two separate round trips.</p></li>
<li><p>The “creation” function used by <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> is expected to store the
newly created value in the cache, as well as to return it.   This is also
more efficient than using two separate round trips to separately store,
and re-retrieve, the object.</p></li>
</ul>
</section>
<section id="example-using-dogpile-directly-for-caching">
<span id="caching-decorator"></span><h2>Example: Using dogpile directly for Caching<a class="headerlink" href="#example-using-dogpile-directly-for-caching" title="Link to this heading">#</a></h2>
<p>The following example approximates Beaker’s “cache decoration” function, to
decorate any function and store the value in Memcached.   Note that
normally, <strong>we’d just use dogpile.cache here</strong>, however for the purposes
of example, we’ll illustrate how the <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> object is used
directly.</p>
<p>We create a Python decorator function called <code class="docutils literal notranslate"><span class="pre">cached()</span></code> which will provide
caching for the output of a single function.  It’s given the “key” which we’d
like to use in Memcached, and internally it makes usage of <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a>,
along with a thread based mutex (we’ll see a distributed mutex in the next
section):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pylibmc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dogpile</span><span class="w"> </span><span class="kn">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">NeedRegenerationException</span>

<span class="n">mc_pool</span> <span class="o">=</span> <span class="n">pylibmc</span><span class="o">.</span><span class="n">ThreadMappedPool</span><span class="p">(</span><span class="n">pylibmc</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cached</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">expiration_time</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A decorator that will cache the return value of a function</span>
<span class="sd">    in memcached given a key.&quot;&quot;&quot;</span>

    <span class="n">mutex</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_value</span><span class="p">():</span>
         <span class="k">with</span> <span class="n">mc_pool</span><span class="o">.</span><span class="n">reserve</span><span class="p">()</span> <span class="k">as</span> <span class="n">mc</span><span class="p">:</span>
            <span class="n">value_plus_time</span> <span class="o">=</span> <span class="n">mc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value_plus_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NeedRegenerationException</span><span class="p">()</span>
            <span class="c1"># return a tuple (value, createdtime)</span>
            <span class="k">return</span> <span class="n">value_plus_time</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decorate</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">gen_cached</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">fn</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">mc_pool</span><span class="o">.</span><span class="n">reserve</span><span class="p">()</span> <span class="k">as</span> <span class="n">mc</span><span class="p">:</span>
                <span class="c1"># create a tuple (value, createdtime)</span>
                <span class="n">value_plus_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                <span class="n">mc</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value_plus_time</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value_plus_time</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">Lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">,</span> <span class="n">gen_cached</span><span class="p">,</span> <span class="n">get_value</span><span class="p">,</span> <span class="n">expiration_time</span><span class="p">)</span> <span class="k">as</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">invoke</span>

    <span class="k">return</span> <span class="n">decorate</span>
</pre></div>
</div>
<p>Using the above, we can decorate any function as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@cached</span><span class="p">(</span><span class="s2">&quot;some key&quot;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_my_expensive_value</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">slow_database</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s2">&quot;stuff&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> object will ensure that only one thread at a time performs
<code class="docutils literal notranslate"><span class="pre">slow_database.lookup()</span></code>, and only every 3600 seconds, unless Memcached has
removed the value, in which case it will be called again as needed.</p>
<p>In particular, dogpile.core’s system allows us to call the memcached get()
function at most once per access, instead of Beaker’s system which calls it
twice, and doesn’t make us call get() when we just created the value.</p>
<p>For the mutex object, we keep a <code class="docutils literal notranslate"><span class="pre">threading.Lock</span></code> object that’s local
to the decorated function, rather than using a global lock.   This localizes
the in-process locking to be local to this one decorated function.   In the next section,
we’ll see the usage of a cross-process lock that accomplishes this differently.</p>
</section>
<section id="using-a-file-or-distributed-lock-with-dogpile">
<h2>Using a File or Distributed Lock with Dogpile<a class="headerlink" href="#using-a-file-or-distributed-lock-with-dogpile" title="Link to this heading">#</a></h2>
<p>The examples thus far use a <code class="docutils literal notranslate"><span class="pre">threading.Lock()</span></code> object for synchronization.
If our application uses multiple processes, we will want to coordinate creation
operations not just on threads, but on some mutex that other processes can access.</p>
<p>In this example we’ll use a file-based lock as provided by the <a class="reference external" href="http://pypi.python.org/pypi/lockfile">lockfile</a> package, which uses a unix-symlink
concept to provide a filesystem-level lock (which also has been made
threadsafe).  Another strategy may base itself directly off the Unix
<code class="docutils literal notranslate"><span class="pre">os.flock()</span></code> call, or use an NFS-safe file lock like <a class="reference external" href="http://pypi.python.org/pypi/flufl.lock">flufl.lock</a>, and still another approach is to
lock against a cache server, using a recipe such as that described at <a class="reference external" href="http://www.regexprn.com/2010/05/using-memcached-as-distributed-locking.html">Using
Memcached as a Distributed Locking Service</a>.</p>
<p>What all of these locking schemes have in common is that unlike the Python
<code class="docutils literal notranslate"><span class="pre">threading.Lock</span></code> object, they all need access to an actual key which acts as
the symbol that all processes will coordinate upon.   So here, we will also
need to create the “mutex” which we pass to <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> using the <code class="docutils literal notranslate"><span class="pre">key</span></code>
argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">lockfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hashlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">sha1</span>

<span class="c1"># ... other imports and setup from the previous example</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cached</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">expiration_time</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A decorator that will cache the return value of a function</span>
<span class="sd">    in memcached given a key.&quot;&quot;&quot;</span>

    <span class="n">lock_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.lock&quot;</span> <span class="o">%</span> <span class="n">sha1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>

    <span class="c1"># ... get_value() from the previous example goes here</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decorate</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="c1"># ... gen_cached() from the previous example goes here</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">():</span>
            <span class="c1"># create an ad-hoc FileLock</span>
            <span class="n">mutex</span> <span class="o">=</span> <span class="n">lockfile</span><span class="o">.</span><span class="n">FileLock</span><span class="p">(</span><span class="n">lock_path</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">Lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">,</span> <span class="n">gen_cached</span><span class="p">,</span> <span class="n">get_value</span><span class="p">,</span> <span class="n">expiration_time</span><span class="p">)</span> <span class="k">as</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">invoke</span>

    <span class="k">return</span> <span class="n">decorate</span>
</pre></div>
</div>
<p>For a given key “some_key”, we generate a hex digest of the key,
then use <code class="docutils literal notranslate"><span class="pre">lockfile.FileLock()</span></code> to create a lock against the file
<code class="docutils literal notranslate"><span class="pre">/tmp/53def077a4264bd3183d4eb21b1f56f883e1b572.lock</span></code>.   Any number of <a class="reference internal" href="api.html#dogpile.Lock" title="dogpile.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a>
objects in various processes will now coordinate with each other, using this common
filename as the “baton” against which creation of a new value proceeds.</p>
<p>Unlike when we used <code class="docutils literal notranslate"><span class="pre">threading.Lock</span></code>, the file lock is ultimately locking
on a file, so multiple instances of <code class="docutils literal notranslate"><span class="pre">FileLock()</span></code> will all coordinate on
that same file - it’s often the case that file locks that rely upon <code class="docutils literal notranslate"><span class="pre">flock()</span></code>
require non-threaded usage, so a unique filesystem lock per thread is often a good
idea in any case.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="recipes.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Recipes</p>
      </div>
    </a>
    <a class="right-next"
       href="api.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">API</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#do-i-need-to-learn-the-dogpile-core-api-directly">Do I Need to Learn the dogpile Core API Directly?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rudimentary-usage">Rudimentary Usage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-using-dogpile-directly-for-caching">Example: Using dogpile directly for Caching</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-a-file-or-distributed-lock-with-dogpile">Using a File or Distributed Lock with Dogpile</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Author name not set
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2011-2025 Mike Bayer.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>