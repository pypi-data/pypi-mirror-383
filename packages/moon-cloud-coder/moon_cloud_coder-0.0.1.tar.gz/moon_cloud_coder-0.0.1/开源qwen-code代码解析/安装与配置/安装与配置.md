# Qwen Code 安装与配置指南

<cite>
**本文档中引用的文件**
- [README.md](file://README.md)
- [packages/cli/src/config/settings.ts](file://packages/cli/src/config/settings.ts)
- [packages/cli/src/config/auth.ts](file://packages/cli/src/config/auth.ts)
- [packages/cli/src/ui/commands/initCommand.ts](file://packages/cli/src/ui/commands/initCommand.ts)
- [packages/cli/src/utils/installationInfo.ts](file://packages/cli/src/utils/installationInfo.ts)
- [packages/cli/src/utils/startupWarnings.ts](file://packages/cli/src/utils/startupWarnings.ts)
</cite>

## 目录
1. [简介](#简介)
2. [系统要求](#系统要求)
3. [全局安装](#全局安装)
4. [源码安装](#源码安装)
5. [配置文件系统](#配置文件系统)
6. [认证机制配置](#认证机制配置)
7. [环境变量配置](#环境变量配置)
8. [操作系统特定配置](#操作系统特定配置)
9. [故障排除](#故障排除)
10. [最佳实践](#最佳实践)

## 简介

Qwen Code 是一个强大的命令行 AI 工作流工具，专为开发者设计。本指南将详细介绍如何从零开始设置 Qwen Code，包括各种安装选项、配置方法以及常见问题的解决方案。

Qwen Code 基于 Qwen3-Coder 模型优化，提供了代码理解、自动化任务和智能辅助功能。它支持多种认证方式，包括免费的 Qwen OAuth 和 OpenAI 兼容 API 密钥。

## 系统要求

### 基础要求
- **Node.js 版本**: 20.0 或更高版本
- **操作系统**: Windows、macOS、Linux
- **内存**: 最低 2GB RAM（推荐 4GB）
- **存储空间**: 至少 500MB 可用空间

### 验证 Node.js 安装
```bash
# 检查 Node.js 版本
node --version

# 检查 npm 版本
npm --version
```

## 全局安装

### 使用 npm 安装

这是最简单的安装方式：

```bash
# 全局安装最新版本
npm install -g @qwen-code/qwen-code@latest

# 验证安装
qwen --version
```

### 安装过程详解

当执行 `npm install -g @qwen-code/qwen-code@latest` 时，以下过程会发生：

1. **依赖解析**: npm 解析包依赖关系
2. **下载包**: 从 npm 注册表下载 @qwen-code/qwen-code 包
3. **安装到全局目录**: 将包安装到系统的全局 npm 目录
4. **创建可执行文件**: 在 PATH 中创建 qwen 可执行文件

### 验证安装状态

```bash
# 检查安装路径
which qwen

# 查看安装信息
npm list -g @qwen-code/qwen-code

# 测试基本功能
qwen --help
```

**章节来源**
- [packages/cli/src/utils/installationInfo.ts](file://packages/cli/src/utils/installationInfo.ts#L1-L50)

## 源码安装

对于开发者或需要自定义构建的用户：

```bash
# 克隆仓库
git clone https://github.com/QwenLM/qwen-code.git
cd qwen-code

# 安装依赖
npm install

# 全局链接本地包
npm install -g .

# 验证安装
qwen --version
```

### 开发模式安装

```bash
# 进入 packages/cli 目录
cd packages/cli

# 安装依赖
npm install

# 启动开发服务器
npm start
```

## 配置文件系统

### 配置文件位置

Qwen Code 使用分层配置系统，按优先级顺序加载配置：

1. **系统默认配置** (`/etc/qwen-code/settings.json`)
2. **用户配置** (`~/.qwen/settings.json`)
3. **工作区配置** (`./.qwen/settings.json`)
4. **系统配置** (`/Library/Application Support/QwenCode/settings.json`)

### 默认配置结构

```json
{
  "general": {
    "preferredEditor": "vscode",
    "vimMode": false,
    "disableAutoUpdate": false,
    "checkpointing": true
  },
  "ui": {
    "theme": "dark",
    "hideTips": false,
    "showMemoryUsage": true
  },
  "model": {
    "name": "qwen3-coder-plus",
    "maxSessionTurns": 10,
    "summarizeToolOutput": true,
    "chatCompression": true
  },
  "context": {
    "fileName": "QWEN.md",
    "discoveryMaxDirs": 10,
    "includeDirectories": [],
    "loadFromIncludeDirectories": true
  },
  "tools": {
    "sandbox": true,
    "usePty": true,
    "allowed": ["read-file", "write-file", "shell"],
    "core": ["memoryTool"]
  },
  "security": {
    "folderTrust": {
      "featureEnabled": true,
      "enabled": true
    }
  }
}
```

### 配置文件生成

首次运行 Qwen Code 时会自动创建配置文件：

```bash
# 启动 Qwen Code
qwen

# 初始化配置文件
qwen --init-config
```

### 配置验证

```bash
# 验证配置文件语法
qwen --validate-config

# 显示当前配置
qwen --show-config
```

**章节来源**
- [packages/cli/src/config/settings.ts](file://packages/cli/src/config/settings.ts#L1-L100)

## 认证机制配置

Qwen Code 支持多种认证方式，每种都有其特定的配置要求。

### Qwen OAuth（推荐）

这是最简单且免费的认证方式：

```bash
# 启动 Qwen Code
qwen

# 系统会自动打开浏览器进行 OAuth 认证
# 或者手动输入 /auth 命令切换到 Qwen OAuth
```

**特点**：
- 无需手动配置 API 密钥
- 自动管理凭据和刷新
- 2,000 请求/天免费配额
- 60 请求/分钟速率限制

### OpenAI 兼容 API

适用于使用 OpenAI 或其他兼容提供商的用户：

#### 环境变量配置

```bash
# 设置 API 密钥
export OPENAI_API_KEY="your_api_key_here"

# 设置基础 URL（可选）
export OPENAI_BASE_URL="https://api.openai.com/v1"

# 设置模型名称（可选）
export OPENAI_MODEL="gpt-4"
```

#### 项目级配置

在项目根目录创建 `.env` 文件：

```env
OPENAI_API_KEY=your_api_key_here
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4
```

### 区域特定配置

#### 主要在中国的用户

**阿里云 Bailian**：

```bash
export OPENAI_API_KEY="your_api_key_here"
export OPENAI_BASE_URL="https://dashscope.aliyuncs.com/compatible-mode/v1"
export OPENAI_MODEL="qwen3-coder-plus"
```

**ModelScope（免费配额）**：

```bash
export OPENAI_API_KEY="your_api_key_here"
export OPENAI_BASE_URL="https://api-inference.modelscope.cn/v1"
export OPENAI_MODEL="Qwen/Qwen3-Coder-480B-A35B-Instruct"
```

#### 国际用户

**阿里云 ModelStudio**：

```bash
export OPENAI_API_KEY="your_api_key_here"
export OPENAI_BASE_URL="https://dashscope-intl.aliyuncs.com/compatible-mode/v1"
export OPENAI_MODEL="qwen3-coder-plus"
```

**OpenRouter（免费配额可用）**：

```bash
export OPENAI_API_KEY="your_api_key_here"
export OPENAI_BASE_URL="https://openrouter.ai/api/v1"
export OPENAI_MODEL="qwen/qwen3-coder:free"
```

### 认证验证

```bash
# 验证认证配置
qwen --verify-auth

# 列出可用的认证方法
qwen --list-auth-methods
```

**章节来源**
- [packages/cli/src/config/auth.ts](file://packages/cli/src/config/auth.ts#L1-L69)

## 环境变量配置

### 核心环境变量

```bash
# API 配置
export OPENAI_API_KEY="your_api_key"
export OPENAI_BASE_URL="https://api.your-provider.com/v1"
export OPENAI_MODEL="your-model-name"

# 调试配置
export DEBUG=true
export DEBUG_MODE=verbose

# 网络配置
export HTTPS_PROXY=http://proxy.company.com:8080
export HTTP_PROXY=http://proxy.company.com:8080
export NO_PROXY=localhost,127.0.0.1

# 存储配置
export QWEN_CODE_SYSTEM_SETTINGS_PATH="/etc/qwen-code/settings.json"
export QWEN_CODE_SYSTEM_DEFAULTS_PATH="/etc/qwen-code/system-defaults.json"
```

### 高级配置选项

```bash
# DNS 解析顺序
export DNS_RESOLUTION_ORDER="ipv4first"

# 排除的环境变量
export EXCLUDED_ENV_VARS="DEBUG,DEBUG_MODE"

# 内存配置
export NODE_OPTIONS="--max-old-space-size=4096"

# 缓存配置
export QWEN_CACHE_DIR="$HOME/.qwen/cache"
```

### 环境变量验证

```bash
# 检查所有 Qwen Code 相关环境变量
env | grep -i qwen

# 验证特定变量
echo $OPENAI_API_KEY

# 测试网络连接
curl -I https://api.openai.com/v1/models
```

## 操作系统特定配置

### macOS 配置

#### Homebrew 安装

```bash
# 使用 Homebrew 安装
brew install qwen-code

# 更新包
brew upgrade qwen-code

# 配置权限
sudo chown -R $(whoami) /usr/local/share/zsh
```

#### 权限配置

```bash
# 添加用户到 sudo 组（如果需要）
sudo dscl . append /Groups/admin GroupMembership $(whoami)

# 配置防火墙规则
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /usr/local/bin/qwen
```

### Windows 配置

#### PowerShell 配置

```powershell
# 设置执行策略
Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned

# 添加 npm 到 PATH
$env:PATH += ";C:\Users\$(whoami)\AppData\Roaming\npm"

# 创建快捷方式
New-Item -ItemType SymbolicLink -Path "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\qwen-code.lnk" -Target "C:\Users\$(whoami)\AppData\Roaming\npm\qwen.cmd"
```

#### 网络代理配置

```powershell
# 设置代理
[System.Net.WebRequest]::DefaultWebProxy.Credentials = [System.Net.CredentialCache]::DefaultCredentials

# 验证代理设置
Test-NetConnection -ComputerName api.openai.com -Port 443
```

### Linux 配置

#### Ubuntu/Debian

```bash
# 安装 Node.js
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 设置 npm 权限
sudo chown -R $(whoami) ~/.npm
sudo chown -R $(whoami) /usr/local/lib/node_modules
```

#### CentOS/RHEL

```bash
# 安装 Node.js
curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
sudo yum install -y nodejs

# 配置 SELinux
sudo setsebool -P httpd_exec_mem 1
sudo semanage fcontext -a -t bin_t "/usr/local/bin/qwen"
```

#### 权限配置

```bash
# 设置正确的文件权限
chmod 755 /usr/local/bin/qwen
chown $(whoami):$(whoami) ~/.qwen/

# 配置 systemd 服务（可选）
sudo tee /etc/systemd/system/qwen-code.service > /dev/null <<EOF
[Unit]
Description=Qwen Code Service
After=network.target

[Service]
Type=simple
User=$(whoami)
ExecStart=/usr/local/bin/qwen
Restart=always

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable qwen-code
sudo systemctl start qwen-code
```

## 故障排除

### 常见安装问题

#### 权限错误

```bash
# 错误：Permission denied
# 解决方案：
sudo npm install -g @qwen-code/qwen-code@latest

# 或修复 npm 权限
sudo chown -R $(whoami) /usr/local/lib/node_modules
sudo chown -R $(whoami) /usr/local/bin
```

#### 网络连接问题

```bash
# 检查网络连接
ping api.openai.com
curl -I https://api.openai.com/v1/models

# 配置代理
export HTTPS_PROXY=http://proxy.company.com:8080
export HTTP_PROXY=http://proxy.company.com:8080
```

#### Node.js 版本不兼容

```bash
# 检查 Node.js 版本
node --version

# 升级 Node.js
# 使用 nvm（推荐）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 20
nvm use 20
```

### 配置问题诊断

#### 配置文件验证

```bash
# 检查配置文件语法
qwen --validate-config

# 显示配置详情
qwen --show-config

# 重置配置
rm ~/.qwen/settings.json
qwen --init-config
```

#### 认证问题

```bash
# 验证认证配置
qwen --verify-auth

# 清除缓存的凭据
rm -rf ~/.qwen/auth-cache/

# 重新认证
qwen --auth-method qwen-oauth
```

### 性能问题

#### 内存不足

```bash
# 增加 Node.js 内存限制
export NODE_OPTIONS="--max-old-space-size=8192"

# 检查系统内存
free -h

# 优化配置
qwen --optimize-config
```

#### 网络超时

```bash
# 增加超时时间
export REQUEST_TIMEOUT=60000

# 使用更快的 DNS 服务器
echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
```

### 日志和调试

```bash
# 启用调试模式
export DEBUG=true
qwen --debug

# 查看日志文件
tail -f ~/.qwen/logs/qwen.log

# 生成诊断信息
qwen --diagnostics
```

**章节来源**
- [packages/cli/src/utils/startupWarnings.ts](file://packages/cli/src/utils/startupWarnings.ts#L1-L41)

## 最佳实践

### 生产环境部署

#### 容器化部署

```dockerfile
FROM node:20-alpine

# 安装 Qwen Code
RUN npm install -g @qwen-code/qwen-code@latest

# 设置工作目录
WORKDIR /app

# 复制配置文件
COPY .qwen/ /app/.qwen/

# 设置环境变量
ENV OPENAI_API_KEY=${OPENAI_API_KEY}
ENV NODE_ENV=production

# 暴露端口
EXPOSE 8080

# 启动命令
CMD ["qwen", "--port", "8080"]
```

#### Kubernetes 部署

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: qwen-code
spec:
  replicas: 1
  selector:
    matchLabels:
      app: qwen-code
  template:
    metadata:
      labels:
        app: qwen-code
    spec:
      containers:
      - name: qwen-code
        image: qwen-code:latest
        ports:
        - containerPort: 8080
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: qwen-secrets
              key: api-key
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
```

### 开发环境配置

#### VS Code 集成

```json
{
  "terminal.integrated.profiles.linux": {
    "qwen-code": {
      "path": "qwen",
      "icon": "terminal"
    }
  },
  "terminal.integrated.defaultProfile.linux": "qwen-code"
}
```

#### IDE 配置

```bash
# 安装 IDE 插件
qwen --install-ide-plugin

# 配置 IDE 集成
qwen --configure-ide
```

### 安全配置

#### 文件夹信任

```json
{
  "security": {
    "folderTrust": {
      "featureEnabled": true,
      "enabled": true
    }
  }
}
```

#### 网络安全

```json
{
  "advanced": {
    "dnsResolutionOrder": "ipv4first",
    "excludedEnvVars": ["DEBUG", "DEBUG_MODE"]
  }
}
```

### 性能优化

#### 内存配置

```json
{
  "advanced": {
    "autoConfigureMemory": true
  }
}
```

#### 缓存配置

```json
{
  "experimental": {
    "cacheEnabled": true,
    "cacheTTL": 3600
  }
}
```

### 监控和维护

#### 定期更新

```bash
# 检查更新
qwen --check-updates

# 自动更新
qwen --auto-update

# 手动更新
npm install -g @qwen-code/qwen-code@latest
```

#### 健康检查

```bash
# 检查服务状态
qwen --health-check

# 监控资源使用
qwen --monitor-resources

# 分析性能
qwen --analyze-performance
```

通过遵循这些安装和配置指南，您应该能够成功设置 Qwen Code 并开始使用其强大的 AI 功能来提升您的开发效率。如果遇到任何问题，请参考故障排除部分或查看官方文档获取更多帮助。