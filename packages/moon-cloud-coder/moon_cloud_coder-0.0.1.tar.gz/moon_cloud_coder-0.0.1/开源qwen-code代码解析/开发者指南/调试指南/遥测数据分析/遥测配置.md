# 遥测配置

<cite>
**本文档中引用的文件**  
- [telemetry.md](file://docs/telemetry.md)
- [config.ts](file://packages/cli/src/config/config.ts)
- [index.ts](file://packages/core/src/telemetry/index.ts)
- [sdk.ts](file://packages/core/src/telemetry/sdk.ts)
- [constants.ts](file://packages/core/src/telemetry/constants.ts)
- [types.ts](file://packages/core/src/telemetry/types.ts)
- [loggers.ts](file://packages/core/src/telemetry/loggers.ts)
- [telemetry.js](file://scripts/telemetry.js)
- [local_telemetry.js](file://scripts/local_telemetry.js)
- [telemetry_gcp.js](file://scripts/telemetry_gcp.js)
- [telemetry_utils.js](file://scripts/telemetry_utils.js)
</cite>

## 目录
1. [简介](#简介)
2. [配置优先级规则](#配置优先级规则)
3. [核心配置项详解](#核心配置项详解)
4. [启用遥测](#启用遥测)
5. [设置遥测目标](#设置遥测目标)
6. [指定OTLP端点](#指定otlp端点)
7. [控制提示日志记录](#控制提示日志记录)
8. [使用npm run telemetry脚本](#使用npm-run-telemetry脚本)
9. [配置参考](#配置参考)

## 简介

Qwen Code的遥测系统基于**OpenTelemetry (OTEL)** 标准构建，用于收集关于系统性能、健康状况和使用情况的数据。通过启用遥测，用户可以监控操作、调试问题，并通过跟踪、指标和结构化日志来优化工具使用。本指南详细说明了如何通过CLI标志、环境变量和配置文件（`.qwen/settings.json`）来启用和配置该系统。

**遥测配置来源**
- **CLI标志**: 在命令行中直接指定，具有最高优先级。
- **环境变量**: 在系统环境中设置，优先级次之。
- **配置文件**: 在项目或用户级别的`.qwen/settings.json`文件中定义，优先级较低。
- **默认值**: 当以上来源均未提供时，使用默认配置。

**遥测数据类型**
- **跟踪 (Traces)**: 记录操作的完整执行路径，如工具调用和API请求。
- **指标 (Metrics)**: 数值化的性能测量，如调用次数和延迟。
- **日志 (Logs)**: 时间戳的事件记录，如用户提示和API错误。

**遥测目标**
- **本地 (local)**: 将数据发送到本地运行的收集器，通常与Jaeger UI结合使用进行可视化。
- **Google Cloud (gcp)**: 将数据转发到Google Cloud项目，可在Google Cloud Console中查看。

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L1-L20)

## 配置优先级规则

Qwen Code的遥测配置遵循严格的优先级规则，确保用户可以在不同层级上灵活控制设置。优先级从高到低如下：

1.  **CLI标志**: 在运行`qwen`命令时通过命令行参数指定。这些标志具有最高优先级，可以覆盖所有其他配置。
2.  **环境变量**: 在系统环境中设置的变量。它们的优先级高于配置文件，但低于CLI标志。
3.  **配置文件**: 包括项目特定的`.qwen/settings.json`和用户全局的`~/.qwen/settings.json`。项目配置文件的优先级高于用户配置文件。
4.  **默认值**: 如果以上所有来源均未提供相应配置，则使用默认值。

这种分层结构允许用户在不同场景下进行配置：
- **临时调试**: 使用CLI标志快速启用或修改遥测设置，不影响持久化配置。
- **项目特定设置**: 在项目根目录的`.qwen/settings.json`中定义，确保团队成员使用一致的遥测配置。
- **全局偏好**: 在用户主目录的`~/.qwen/settings.json`中设置，作为所有项目的默认行为。
- **安全默认**: 系统默认禁用遥测（`telemetry.enabled: false`），保护用户隐私。

**重要提示**: `npm run telemetry -- --target=<gcp|local>`脚本中的`--target`参数仅在脚本执行期间覆盖`telemetry.target`，用于选择要启动的收集器，不会永久更改`settings.json`文件。

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L30-L80)

## 核心配置项详解

以下是Qwen Code遥测系统中的关键配置项及其用途和默认值。

### telemetry.enabled

**用途**: 控制遥测系统是否启用。这是遥测功能的总开关。

**默认值**: `false`

**说明**: 该配置项决定了是否初始化OpenTelemetry SDK并开始收集数据。只有当`telemetry.enabled`为`true`时，其他遥测配置才会生效。默认禁用是为了保护用户隐私。

**配置方式**:
- **CLI**: `--telemetry` (启用) 或 `--no-telemetry` (禁用)
- **环境变量**: 无直接对应，但可通过CLI标志或配置文件设置。
- **配置文件**: `"telemetry": { "enabled": true }`

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L75-L80)
- [config.ts](file://packages/cli/src/config/config.ts#L452-L480)

### telemetry.target

**用途**: 指定遥测数据的目标后端，决定数据是发送到本地收集器还是Google Cloud。

**默认值**: `local`

**说明**: 该配置项决定了遥测数据的最终目的地。`local`目标通常用于开发和调试，与本地Jaeger实例配合使用。`gcp`目标用于生产环境，将数据集成到Google Cloud的监控和日志服务中。

**配置方式**:
- **CLI**: `--telemetry-target local` 或 `--telemetry-target gcp`
- **环境变量**: 无直接对应。
- **配置文件**: `"telemetry": { "target": "gcp" }`

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L75-L80)
- [config.ts](file://packages/cli/src/config/config.ts#L541-L569)

### telemetry.otlpEndpoint

**用途**: 指定OTLP (OpenTelemetry Protocol) 收集器的端点URL。

**默认值**: `http://localhost:4317`

**说明**: 该配置项定义了遥测数据发送到的具体网络地址。对于`local`目标，通常是本地运行的OTEL Collector。对于`gcp`目标，脚本会自动配置一个本地代理，该代理再将数据转发到Google Cloud。

**配置方式**:
- **CLI**: `--telemetry-otlp-endpoint http://my-collector:4317`
- **环境变量**: `OTEL_EXPORTER_OTLP_ENDPOINT=http://my-collector:4317`
- **配置文件**: `"telemetry": { "otlpEndpoint": "http://my-collector:4317" }`

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L75-L80)
- [config.ts](file://packages/cli/src/config/config.ts#L490-L540)

### telemetry.logPrompts

**用途**: 控制是否在遥测日志中记录用户输入的完整提示内容。

**默认值**: `true`

**说明**: 出于隐私考虑，此选项允许用户选择是否将敏感的提示文本包含在日志中。当设置为`false`时，日志中只会记录提示的长度和ID，而不会记录实际内容。

**配置方式**:
- **CLI**: `--telemetry-log-prompts` (启用) 或 `--no-telemetry-log-prompts` (禁用)
- **环境变量**: 无直接对应。
- **配置文件**: `"telemetry": { "logPrompts": false }`

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L75-L80)
- [config.ts](file://packages/cli/src/config/config.ts#L571-L595)

## 启用遥测

要启用Qwen Code的遥测功能，需要将`telemetry.enabled`设置为`true`。以下是几种不同的启用方法。

### 通过CLI标志启用

这是最直接的方法，适用于单次会话。

```bash
# 启用遥测
qwen --telemetry --prompt "Hello, world!"

# 禁用遥测（覆盖配置文件中的设置）
qwen --no-telemetry --prompt "Hello, world!"
```

### 通过配置文件启用

在项目或用户级别的`.qwen/settings.json`文件中添加配置。

**项目配置文件 (`.qwen/settings.json`)**
```json
{
  "telemetry": {
    "enabled": true
  }
}
```

**用户配置文件 (`~/.qwen/settings.json`)**
```json
{
  "telemetry": {
    "enabled": true
  }
}
```

### 验证遥测状态

可以通过检查启动日志来验证遥测是否已成功启用。如果SDK成功启动，控制台会输出`OpenTelemetry SDK started successfully.`。

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L85-L100)
- [sdk.ts](file://packages/core/src/telemetry/sdk.ts#L150-L193)

## 设置遥测目标

遥测目标决定了数据的去向。Qwen Code支持`local`和`gcp`两种目标。

### 设置为本地目标

将目标设置为`local`会将数据发送到本地运行的OTEL Collector。

```bash
# 通过CLI设置
qwen --telemetry --telemetry-target local --prompt "Hello, world!"

# 通过配置文件设置
{
  "telemetry": {
    "enabled": true,
    "target": "local"
  }
}
```

### 设置为Google Cloud目标

将目标设置为`gcp`会将数据发送到Google Cloud项目。

```bash
# 通过CLI设置
qwen --telemetry --telemetry-target gcp --prompt "Hello, world!"

# 通过配置文件设置
{
  "telemetry": {
    "enabled": true,
    "target": "gcp"
  }
}
```

**重要前提**: 使用`gcp`目标前，必须设置`OTLP_GOOGLE_CLOUD_PROJECT`环境变量并完成Google Cloud的身份验证。

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L105-L115)
- [config.ts](file://packages/cli/src/config/config.ts#L541-L569)

## 指定OTLP端点

OTLP端点是遥测数据接收器的网络地址。虽然`npm run telemetry`脚本会自动配置正确的端点，但您也可以手动指定。

### 手动指定端点

```bash
# 指向自定义的本地收集器
qwen --telemetry \
  --telemetry-otlp-endpoint http://my-otel-collector:4317 \
  --prompt "Hello, world!"

# 通过环境变量指定
export OTEL_EXPORTER_OTLP_ENDPOINT=http://my-otel-collector:4317
qwen --telemetry --prompt "Hello, world!"
```

### 使用默认端点

如果不指定`telemetry-otlp-endpoint`，系统将使用默认值`http://localhost:4317`。`npm run telemetry`脚本启动的本地和GCP收集器都监听此端口。

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L120-L130)
- [config.ts](file://packages/cli/src/config/config.ts#L490-L540)

## 控制提示日志记录

为了平衡调试需求和用户隐私，Qwen Code提供了对提示日志记录的精细控制。

### 启用提示日志记录

当`telemetry.logPrompts`为`true`时，完整的用户提示内容将被记录在`qwen-code.user_prompt`日志事件中。

```bash
# 通过CLI启用
qwen --telemetry --telemetry-log-prompts --prompt "分析这段代码"

# 通过配置文件启用
{
  "telemetry": {
    "enabled": true,
    "logPrompts": true
  }
}
```

### 禁用提示日志记录

当`telemetry.logPrompts`为`false`时，日志中只包含提示的长度和ID，不包含实际文本。

```bash
# 通过CLI禁用
qwen --telemetry --no-telemetry-log-prompts --prompt "分析这段代码"

# 通过配置文件禁用
{
  "telemetry": {
    "enabled": true,
    "logPrompts": false
  }
}
```

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L135-L145)
- [config.ts](file://packages/cli/src/config/config.ts#L571-L595)

## 使用npm run telemetry脚本

`npm run telemetry`脚本是一个自动化工具，用于简化本地或Google Cloud遥测收集器的设置。

### 启动本地遥测环境

此命令会自动下载并启动OTEL Collector和Jaeger UI。

```bash
# 启动本地遥测环境
npm run telemetry -- --target=local
```

**脚本执行步骤**:
1.  下载`otelcol-contrib`和`jaeger`二进制文件（如果需要）。
2.  停止任何现有的收集器或Jaeger进程。
3.  在`.qwen/settings.json`中临时启用遥测。
4.  启动OTEL Collector和Jaeger服务。
5.  提供访问Jaeger UI的链接（http://localhost:16686）。

**停止服务**: 按`Ctrl+C`即可停止服务，脚本会尝试恢复原始的遥测设置。

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L150-L170)
- [telemetry.js](file://scripts/telemetry.js#L1-L85)
- [local_telemetry.js](file://scripts/local_telemetry.js#L1-L219)

### 启动Google Cloud遥测环境

此命令会自动下载并启动一个将数据转发到Google Cloud的OTEL Collector。

```bash
# 设置环境变量
export OTLP_GOOGLE_CLOUD_PROJECT="your-project-id"

# 启动GCP遥测环境
npm run telemetry -- --target=gcp
```

**脚本执行步骤**:
1.  下载`otelcol-contrib`二进制文件（如果需要）。
2.  停止任何现有的收集器进程。
3.  在`.qwen/settings.json`中临时启用遥测并禁用沙箱模式。
4.  启动OTEL Collector，配置其将数据导出到指定的Google Cloud项目。
5.  提供访问Google Cloud Console中日志、指标和跟踪的链接。

**前提条件**:
- 设置`OTLP_GOOGLE_CLOUD_PROJECT`环境变量。
- 通过`gcloud auth application-default login`或`GOOGLE_APPLICATION_CREDENTIALS`完成身份验证。
- 账户具有"Cloud Trace Agent"、"Monitoring Metric Writer"和"Logs Writer"角色。

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L175-L200)
- [telemetry.js](file://scripts/telemetry.js#L1-L85)
- [telemetry_gcp.js](file://scripts/telemetry_gcp.js#L1-L188)

## 配置参考

### 完整配置示例

以下是一个完整的`.qwen/settings.json`配置文件示例。

```json
{
  "telemetry": {
    "enabled": true,
    "target": "gcp",
    "otlpEndpoint": "http://localhost:4317",
    "otlpProtocol": "grpc",
    "logPrompts": false,
    "outfile": ".qwen/telemetry.log"
  },
  "sandbox": false,
  "model": {
    "name": "gemini-1.5-pro"
  }
}
```

### 日志事件参考

| 事件名称 | 描述 | 关键属性 |
| :--- | :--- | :--- |
| `qwen-code.config` | CLI配置加载 | `model`, `approval_mode`, `telemetry_enabled` |
| `qwen-code.user_prompt` | 用户提交提示 | `prompt_length`, `prompt_id`, `prompt` (可选) |
| `qwen-code.tool_call` | 工具调用 | `function_name`, `duration_ms`, `success` |
| `qwen-code.api_request` | API请求 | `model`, `request_text` |
| `qwen-code.api_error` | API请求失败 | `error`, `status_code`, `duration_ms` |

### 指标参考

| 指标名称 | 类型 | 描述 | 关键属性 |
| :--- | :--- | :--- | :--- |
| `qwen-code.session.count` | Counter | CLI启动次数 | 无 |
| `qwen-code.tool.call.count` | Counter | 工具调用次数 | `function_name`, `success` |
| `qwen-code.tool.call.latency` | Histogram | 工具调用延迟 | `function_name`, `duration_ms` |
| `qwen-code.api.request.count` | Counter | API请求次数 | `model`, `status_code` |
| `qwen-code.token.usage` | Counter | 令牌使用量 | `model`, `type` (input/output) |

**Section sources**
- [telemetry.md](file://docs/telemetry.md#L205-L281)