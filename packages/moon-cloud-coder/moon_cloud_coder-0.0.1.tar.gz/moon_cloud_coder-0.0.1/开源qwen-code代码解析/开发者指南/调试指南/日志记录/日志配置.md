# 日志配置

<cite>
**本文档中引用的文件**  
- [settings.ts](file://packages/cli/src/config/settings.ts)
- [settingsSchema.ts](file://packages/cli/src/config/settingsSchema.ts)
- [logger.ts](file://packages/core/src/core/logger.ts)
- [config.ts](file://packages/cli/src/config/config.ts)
</cite>

## 目录
1. [简介](#简介)
2. [日志配置项说明](#日志配置项说明)
3. [配置优先级](#配置优先级)
4. [配置验证与默认值处理](#配置验证与默认值处理)
5. [配置加载流程](#配置加载流程)
6. [日志级别使用指南](#日志级别使用指南)
7. [完整配置示例](#完整配置示例)

## 简介
Qwen Code 的日志系统通过配置文件和环境变量进行管理，主要用于记录系统运行时的关键信息、调试信息和错误信息。本文档详细介绍了如何通过 `settings.ts` 文件中的配置项来设置日志系统，包括日志级别、输出路径等参数的定义与作用。同时，文档还解释了配置的优先级规则（命令行 > 环境变量 > 配置文件），并提供了完整的配置示例。

**Section sources**
- [settings.ts](file://packages/cli/src/config/settings.ts)
- [settingsSchema.ts](file://packages/cli/src/config/settingsSchema.ts)

## 日志配置项说明
Qwen Code 的日志配置主要通过 `settings.ts` 和 `settingsSchema.ts` 文件中的相关配置项进行定义。以下是与日志相关的配置项及其作用：

- **`debug`**: 布尔类型，用于启用或禁用调试模式。当设置为 `true` 时，系统会输出详细的调试信息。
- **`DEBUG` 和 `DEBUG_MODE`**: 环境变量，用于控制调试模式的开启。这两个环境变量的值为 `true` 或 `1` 时，系统将进入调试模式。
- **`enableOpenAILogging`**: 布尔类型，用于启用或禁用 OpenAI API 调用的日志记录。当设置为 `true` 时，系统会记录所有 OpenAI API 的调用信息。

这些配置项在 `settingsSchema.ts` 文件中定义，并通过 `settings.ts` 文件进行加载和解析。

**Section sources**
- [settings.ts](file://packages/cli/src/config/settings.ts#L27)
- [settingsSchema.ts](file://packages/cli/src/config/settingsSchema.ts#L709)

## 配置优先级
Qwen Code 的配置系统遵循以下优先级规则（从高到低）：

1. **命令行参数**：通过命令行传递的参数具有最高优先级。
2. **环境变量**：环境变量的优先级次之。
3. **配置文件**：配置文件中的设置优先级最低。

这意味着，如果同一配置项在多个地方被定义，命令行参数将覆盖环境变量，而环境变量将覆盖配置文件中的设置。

**Section sources**
- [config.ts](file://packages/cli/src/config/config.ts#L389)

## 配置验证与默认值处理
Qwen Code 在加载配置时会进行严格的验证和默认值处理。具体流程如下：

1. **配置加载**：系统首先从配置文件中读取配置项。
2. **环境变量解析**：然后解析环境变量，并将其值应用到相应的配置项上。
3. **默认值处理**：对于未设置的配置项，系统会使用预定义的默认值。
4. **类型安全校验**：系统会对配置项的类型进行校验，确保其符合预期的类型。

例如，在 `settings.ts` 文件中，`DEFAULT_EXCLUDED_ENV_VARS` 定义了默认排除的环境变量列表，包括 `DEBUG` 和 `DEBUG_MODE`。这些变量在项目 `.env` 文件中默认被排除，以防止敏感信息泄露。

**Section sources**
- [settings.ts](file://packages/cli/src/config/settings.ts#L27)
- [config.ts](file://packages/cli/src/config/config.ts#L389)

## 配置加载流程
Qwen Code 的配置加载流程如下：

1. **初始化配置对象**：系统首先创建一个空的配置对象。
2. **加载配置文件**：从用户和工作区的配置文件中加载配置项。
3. **解析环境变量**：解析环境变量，并将其值应用到配置对象中。
4. **合并配置**：将不同来源的配置项进行合并，遵循优先级规则。
5. **验证和校验**：对合并后的配置进行验证和类型校验。

在 `config.ts` 文件中，`loadCliConfig` 函数负责加载和合并配置。该函数会根据命令行参数、环境变量和配置文件中的设置，生成最终的配置对象。

**Section sources**
- [config.ts](file://packages/cli/src/config/config.ts#L389)

## 日志级别使用指南
Qwen Code 支持多种日志级别，用户可以根据使用场景选择合适的日志级别：

- **`debug`**：用于输出详细的调试信息，适合开发和调试阶段。
- **`info`**：用于输出一般的信息性消息，适合日常运行。
- **`warn`**：用于输出警告信息，提示潜在的问题。
- **`error`**：用于输出错误信息，记录系统运行中的错误。

在 `ConsolePatcher.ts` 文件中，`patchConsoleMethod` 方法根据 `debugMode` 参数决定是否输出 `debug` 级别的日志。只有当 `debugMode` 为 `true` 时，`debug` 级别的日志才会被输出。

**Section sources**
- [ConsolePatcher.ts](file://packages/cli/src/ui/utils/ConsolePatcher.ts#L44-L70)

## 完整配置示例
以下是一个完整的日志配置示例：

```json
{
  "general": {
    "debugMode": true
  },
  "advanced": {
    "excludedEnvVars": ["DEBUG", "DEBUG_MODE"]
  },
  "enableOpenAILogging": true
}
```

在这个示例中，`debugMode` 被设置为 `true`，启用了调试模式；`excludedEnvVars` 排除了 `DEBUG` 和 `DEBUG_MODE` 环境变量；`enableOpenAILogging` 被设置为 `true`，启用了 OpenAI API 调用的日志记录。

**Section sources**
- [settings.ts](file://packages/cli/src/config/settings.ts#L27)
- [config.ts](file://packages/cli/src/config/config.ts#L389)