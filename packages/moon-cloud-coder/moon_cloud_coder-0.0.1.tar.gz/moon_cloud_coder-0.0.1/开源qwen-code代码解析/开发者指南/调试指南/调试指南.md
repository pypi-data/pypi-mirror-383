# 调试指南

<cite>
**本文档中引用的文件**  
- [settings.ts](file://packages/cli/src/config/settings.ts)
- [errors.ts](file://packages/core/src/utils/errors.ts)
- [errorReporting.ts](file://packages/core/src/utils/errorReporting.ts)
- [loggers.ts](file://packages/core/src/telemetry/loggers.ts)
- [sdk.ts](file://packages/core/src/telemetry/sdk.ts)
- [App.tsx](file://packages/cli/src/ui/App.tsx)
- [start.js](file://scripts/start.js)
</cite>

## 目录
1. [简介](#简介)
2. [日志记录配置](#日志记录配置)
3. [组件日志输出格式](#组件日志输出格式)
4. [断点调试指南](#断点调试指南)
5. [错误处理机制](#错误处理机制)
6. [常见问题排查](#常见问题排查)
7. [遥测日志分析](#遥测日志分析)
8. [调试技巧示例](#调试技巧示例)

## 简介
本文档旨在为开发者提供全面的调试指南，帮助诊断和解决Qwen Code在开发过程中遇到的各种问题。文档涵盖了日志记录配置、组件日志格式、断点调试方法、错误处理机制以及常见问题的排查步骤。通过本指南，开发者可以更好地理解系统行为，快速定位和解决开发中的问题。

## 日志记录配置
Qwen Code的日志记录功能可以通过配置文件中的日志级别进行控制。主要配置文件位于`packages/cli/src/config/settings.ts`，其中定义了遥测相关的配置选项。开发者可以通过设置`telemetry`对象中的`logPrompts`属性来控制是否记录用户提示。

日志级别可以通过命令行参数或配置文件进行设置：
- `--telemetry`：启用遥测日志记录
- `--no-telemetry`：禁用遥测日志记录
- `--telemetry-log-prompts`：启用用户提示日志记录
- `--no-telemetry-log-prompts`：禁用用户提示日志记录

配置优先级遵循以下规则：命令行参数 > 用户设置 > 系统默认设置。例如，如果在命令行中使用`--no-telemetry-log-prompts`，即使配置文件中设置了`telemetry.logPrompts = true`，用户提示日志记录也会被禁用。

**Section sources**
- [settings.ts](file://packages/cli/src/config/settings.ts#L0-L850)
- [config.test.ts](file://packages/cli/src/config/config.test.ts#L482-L621)

## 组件日志输出格式
Qwen Code由多个组件组成，每个组件都有其特定的日志输出格式和关键信息。

### CLI组件
CLI组件的日志主要记录命令执行、配置加载和用户交互信息。日志格式包含时间戳、日志级别和消息内容。关键信息包括命令执行状态、参数解析结果和错误堆栈。

### Core组件
Core组件负责核心业务逻辑，其日志记录了模型调用、工具执行和会话管理等关键操作。日志中包含详细的请求和响应信息，包括输入输出内容、执行时间和状态码。

### 遥测组件
遥测组件使用OpenTelemetry框架记录系统行为。日志事件包含标准化的属性，如会话ID、用户邮箱和事件类型。关键事件类型包括：
- `qwen-code.user_prompt`：用户提示事件
- `qwen-code.tool_call`：工具调用事件
- `qwen-code.api_request`：API请求事件
- `qwen-code.api_response`：API响应事件

日志记录通过`loggers.ts`文件中的函数实现，如`logUserPrompt`、`logToolCall`和`logApiResponse`等。这些函数将事件数据格式化并发送到遥测后端。

**Section sources**
- [loggers.ts](file://packages/core/src/telemetry/loggers.ts#L0-L593)
- [constants.ts](file://packages/core/src/telemetry/constants.ts#L0-L41)

## 断点调试指南
Qwen Code支持使用Node.js调试器进行断点调试，推荐使用VS Code调试器。

### 启动调试会话
要启动调试会话，可以使用以下命令：
```bash
node --inspect-brk scripts/start.js
```
这将在启动时暂停执行，允许调试器附加到进程。如果需要在沙箱环境中调试，可以设置`SANDBOX`环境变量。

### VS Code调试配置
在VS Code中，可以创建`.vscode/launch.json`文件来配置调试会话：
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug Qwen Code",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/scripts/start.js",
      "args": [],
      "env": {
        "DEBUG": "true"
      },
      "console": "integratedTerminal"
    }
  ]
}
```

### 调试技巧
- 使用`console.log`语句输出关键变量的值
- 在关键函数入口处设置断点
- 使用`--inspect-brk`参数在启动时暂停
- 检查`process.argv`以验证命令行参数解析

**Section sources**
- [start.js](file://scripts/start.js#L34-L75)
- [App.tsx](file://packages/cli/src/ui/App.tsx#L0-L1642)

## 错误处理机制
Qwen Code的错误处理机制分为错误分类、捕获和上报三个部分。

### 错误分类
错误在`packages/core/src/utils/errors.ts`中定义，主要分为以下几类：
- `FatalError`：致命错误，导致程序退出
- `FatalAuthenticationError`：认证相关致命错误
- `FatalInputError`：输入相关致命错误
- `ForbiddenError`：权限不足错误
- `UnauthorizedError`：未授权错误
- `BadRequestError`：请求格式错误

### 错误捕获与转换
系统使用`toFriendlyError`函数将底层错误转换为更友好的错误类型。例如，HTTP响应中的403状态码会被转换为`ForbiddenError`，并保留原始错误消息。

### 错误上报
错误上报通过`errorReporting.ts`文件中的`reportError`函数实现。该函数会：
1. 生成错误报告，包含错误消息、堆栈跟踪和上下文信息
2. 将报告写入临时文件
3. 在控制台输出错误信息和报告路径

上报的错误报告包含JSON格式的详细信息，便于后续分析。报告文件名包含时间戳和错误类型，如`gemini-client-error-general-2025-01-01T00-00-00.json`。

**Section sources**
- [errors.ts](file://packages/core/src/utils/errors.ts#L0-L102)
- [errorReporting.ts](file://packages/core/src/utils/errorReporting.ts#L0-L118)

## 常见问题排查
### 认证失败
认证失败通常由以下原因引起：
1. 无效的API密钥
2. OAuth令牌过期
3. 网络连接问题

排查步骤：
1. 检查`security.auth.selectedType`配置是否正确
2. 验证API密钥或OAuth令牌的有效性
3. 检查网络连接和代理设置
4. 查看认证相关的错误日志

### 模型调用超时
模型调用超时可能由以下原因导致：
1. 网络延迟过高
2. 模型服务负载过高
3. 请求内容过大

解决方案：
1. 增加超时时间
2. 优化请求内容，减少token数量
3. 切换到响应更快的模型
4. 检查网络连接质量

### Shell命令执行异常
Shell命令执行异常的常见原因：
1. 命令不存在或路径错误
2. 权限不足
3. 环境变量未正确设置

排查方法：
1. 检查命令是否在系统PATH中
2. 验证执行权限
3. 检查环境变量配置
4. 查看shell执行服务的日志

**Section sources**
- [App.tsx](file://packages/cli/src/ui/App.tsx#L0-L1642)
- [shell.ts](file://packages/core/src/tools/shell.ts#L252-L287)

## 遥测日志分析
遥测日志是分析系统行为的重要工具。Qwen Code使用OpenTelemetry SDK收集和导出遥测数据。

### 遥测初始化
遥测系统在`sdk.ts`中初始化，主要步骤包括：
1. 检查遥测是否已启用
2. 创建资源对象，包含服务名称和版本
3. 配置OTLP导出器，指定协议和端点
4. 启动SDK

### 日志分析技巧
分析遥测日志时，可以关注以下方面：
1. **性能分析**：通过`tool_call.latency`指标识别慢速工具调用
2. **错误模式**：统计`api_error`事件的频率和类型
3. **用户行为**：分析`user_prompt`事件的长度和频率
4. **系统健康**：监控`session.count`和`token.usage`等关键指标

### 自定义分析
开发者可以编写脚本分析遥测日志，例如：
- 统计特定时间段内的API调用次数
- 分析工具调用的成功率
- 识别高频错误类型
- 生成用户活动报告

**Section sources**
- [sdk.ts](file://packages/core/src/telemetry/sdk.ts#L39-L83)
- [loggers.ts](file://packages/core/src/telemetry/loggers.ts#L0-L593)

## 调试技巧示例
### 启用详细日志
要启用详细日志记录，可以在启动时添加`--telemetry-log-prompts`参数：
```bash
qwen-code --telemetry-log-prompts
```
这将记录所有用户提示内容，便于分析用户交互模式。

### 模拟错误场景
可以使用以下代码模拟认证错误：
```typescript
throw new FatalAuthenticationError("Invalid API key");
```
然后观察错误处理流程和上报机制。

### 分析工具调用
通过分析`tool_call`事件，可以了解工具的使用情况：
```typescript
logToolCall(config, {
  function_name: "read-file",
  success: true,
  duration_ms: 45,
  decision: "approved"
});
```
这种日志记录有助于优化工具性能和用户体验。

**Section sources**
- [settings.ts](file://packages/cli/src/config/settings.ts#L0-L850)
- [loggers.ts](file://packages/core/src/telemetry/loggers.ts#L0-L593)