# 构建与测试

<cite>
**本文档中引用的文件**  
- [scripts/build.js](file://scripts/build.js)
- [vitest.config.ts](file://vitest.config.ts)
- [integration-tests/vitest.config.ts](file://integration-tests/vitest.config.ts)
- [integration-tests/globalSetup.ts](file://integration-tests/globalSetup.ts)
- [integration-tests/test-helper.ts](file://integration-tests/test-helper.ts)
- [packages/core/src/test-utils/mockWorkspaceContext.ts](file://packages/core/src/test-utils/mockWorkspaceContext.ts)
- [packages/core/src/test-utils/config.ts](file://packages/core/src/test-utils/config.ts)
- [packages/core/src/test-utils/tools.ts](file://packages/core/src/test-utils/tools.ts)
- [packages/test-utils/src/file-system-test-helpers.ts](file://packages/test-utils/src/file-system-test-helpers.ts)
- [package.json](file://package.json)
</cite>

## 目录
1. [构建系统](#构建系统)
2. [测试策略](#测试策略)
3. [测试辅助工具](#测试辅助工具)
4. [运行测试](#运行测试)
5. [持续集成](#持续集成)

## 构建系统

Qwen Code项目的构建系统由`scripts/build.js`脚本驱动，该脚本负责协调整个项目的编译过程。构建流程首先检查`node_modules`目录是否存在，如果不存在则自动执行`npm install`以安装所有依赖项。随后，脚本会依次执行`npm run generate`和`npm run build --workspaces`命令，生成必要的代码并编译所有工作区包。如果启用了沙箱功能（通过设置`BUILD_SANDBOX`环境变量为`1`或`true`），构建脚本还会调用`scripts/build_sandbox.js`来构建容器镜像，确保沙箱环境的可用性。

**Section sources**
- [scripts/build.js](file://scripts/build.js#L0-L55)

## 测试策略

项目采用多层次的测试策略，包括单元测试、集成测试和端到端测试。单元测试使用Vitest框架，分布在各个包的`src`目录下，例如`packages/cli`和`packages/core`。集成测试位于`integration-tests`目录，通过模拟真实环境来验证组件间的交互。端到端测试则通过`test:terminal-bench`等脚本执行，覆盖更复杂的用户场景。每个测试套件都有独立的配置文件，如`vitest.config.ts`，用于定义测试环境、超时设置和报告器。

**Section sources**
- [vitest.config.ts](file://vitest.config.ts#L0-L13)
- [integration-tests/vitest.config.ts](file://integration-tests/vitest.config.ts#L0-L22)

## 测试辅助工具

### 模拟工作区环境

`test-utils`模块提供了`mockWorkspaceContext`工具，用于在测试中创建模拟的工作区上下文。此工具通过`createMockWorkspaceContext`函数生成一个包含`addDirectory`、`getDirectories`和`isPathWithinWorkspace`等方法的模拟对象，允许测试代码在隔离的环境中验证路径和目录操作。

**Section sources**
- [packages/core/src/test-utils/mockWorkspaceContext.ts](file://packages/core/src/test-utils/mockWorkspaceContext.ts#L0-L33)

### 测试配置管理

`config`工具允许测试代码创建预配置的`Config`实例。`makeFakeConfig`函数基于`DEFAULT_CONFIG_PARAMETERS`提供默认配置，并允许通过参数覆盖特定字段，确保测试环境的一致性和可预测性。

**Section sources**
- [packages/core/src/test-utils/config.ts](file://packages/core/src/test-utils/config.ts#L0-L37)

### 工具层测试

`tools`模块提供了`MockTool`和`MockModifiableTool`类，用于模拟工具调用。这些类允许测试代码定义工具的行为，包括执行函数和确认逻辑，从而验证工具调用的正确性和用户交互流程。

**Section sources**
- [packages/core/src/test-utils/tools.ts](file://packages/core/src/test-utils/tools.ts#L0-L169)

### 文件系统测试辅助

`packages/test-utils`包中的`file-system-test-helpers.ts`提供了`createTmpDir`和`cleanupTmpDir`函数，用于创建和清理临时目录。`FileSystemStructure`类型定义了虚拟文件系统的结构，支持字符串、对象和数组形式的文件和目录定义，便于在测试中快速搭建复杂的文件系统环境。

**Section sources**
- [packages/test-utils/src/file-system-test-helpers.ts](file://packages/test-utils/src/file-system-test-helpers.ts#L0-L98)

## 运行测试

### 运行特定测试套件

可以通过`package.json`中的脚本命令运行特定的测试套件。例如，`npm run test:integration:sandbox:none`用于在无沙箱模式下运行集成测试，而`npm run test:terminal-bench`则用于执行终端基准测试。这些命令通过设置环境变量（如`GEMINI_SANDBOX`）来控制测试环境。

### 生成测试覆盖率报告

测试覆盖率报告由Vitest的`coverage`插件生成。在`vitest.config.ts`中配置了报告格式（如`html`、`json`、`lcov`）和输出目录。运行`npm run test`时，Vitest会自动收集覆盖率数据并生成报告，帮助开发者了解测试覆盖范围。

**Section sources**
- [package.json](file://package.json#L0-L111)

## 持续集成

持续集成（CI）流程通过`test:ci`脚本执行，该脚本会依次运行所有工作区的测试。CI环境中的测试配置与本地测试保持一致，确保测试结果的可重复性。`globalSetup.ts`文件在测试开始前执行，负责设置测试环境变量和清理旧的测试运行目录，确保每次测试都在干净的环境中进行。

**Section sources**
- [integration-tests/globalSetup.ts](file://integration-tests/globalSetup.ts#L0-L100)