# 开发者指南

<cite>
**本文档中引用的文件**  
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [README.md](file://README.md)
- [package.json](file://package.json)
- [scripts/build.js](file://scripts/build.js)
- [scripts/start.js](file://scripts/start.js)
- [packages/cli/vitest.config.ts](file://packages/cli/vitest.config.ts)
- [packages/cli/test-setup.ts](file://packages/cli/test-setup.ts)
- [packages/cli/src/test-utils/customMatchers.ts](file://packages/cli/src/test-utils/customMatchers.ts)
- [packages/cli/src/test-utils/render.tsx](file://packages/cli/src/test-utils/render.tsx)
- [packages/cli/src/test-utils/mockCommandContext.ts](file://packages/cli/src/test-utils/mockCommandContext.ts)
- [packages/core/vitest.config.ts](file://packages/core/vitest.config.ts)
- [packages/core/test-setup.ts](file://packages/core/test-setup.ts)
- [packages/core/src/test-utils/tools.ts](file://packages/core/src/test-utils/tools.ts)
- [packages/core/src/test-utils/config.ts](file://packages/core/src/test-utils/config.ts)
- [packages/core/src/test-utils/mockWorkspaceContext.ts](file://packages/core/src/test-utils/mockWorkspaceContext.ts)
</cite>

## 目录
1. [贡献流程](#贡献流程)
2. [本地开发环境搭建](#本地开发环境搭建)
3. [测试策略](#测试策略)
4. [调试技巧](#调试技巧)
5. [代码质量保证](#代码质量保证)
6. [新功能开发流程与架构最佳实践](#新功能开发流程与架构最佳实践)

## 贡献流程

本项目欢迎来自社区的贡献。所有贡献必须遵循以下流程以确保代码质量和项目一致性。

首先，所有贡献者必须签署[贡献者许可协议](https://cla.developers.google.com/about)（CLA），该协议允许我们使用和重新分发您的贡献，同时您或您的雇主保留版权。如果您或您的雇主已为其他项目签署过Google CLA，则通常无需再次签署。

在提交代码前，请确保您的贡献符合[Google开源社区准则](https://opensource.google/conduct/)。所有代码提交（包括项目成员）都必须通过代码审查，我们使用GitHub Pull Request机制进行此过程。

每个Pull Request都应链接到一个已存在的问题单（issue），以确保变更在编码前已讨论并符合项目目标。对于bug修复，PR应链接到对应的bug报告；对于新功能，则应链接到已由维护者批准的功能请求或提案问题单。如果尚无相关问题单，请先创建一个并等待反馈。

我们鼓励小型、原子化的PR，每个PR只解决一个具体问题或添加一个独立功能。避免将多个不相关的变更（如bug修复、新功能和重构）捆绑在一个PR中。大型变更应分解为一系列逻辑清晰的小型PR，以便独立审查和合并。

对于正在进行的工作，建议使用GitHub的“草稿PR”（Draft Pull Request）功能，这可以向维护者表明PR尚未准备好正式审查，但欢迎进行早期讨论和反馈。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L1-L301)

## 本地开发环境搭建

### 环境准备

在开始开发前，请确保已安装以下依赖：

1. **Node.js**: 开发环境推荐使用Node.js `~20.19.0`版本，这是由于上游开发依赖的问题。生产环境运行CLI时，Node.js `>=20`的任何版本均可。建议使用[nvm](https://github.com/nvm-sh/nvm)等工具管理Node.js版本。
2. **Git**: 用于代码版本控制和仓库克隆。

### 项目克隆与依赖安装

执行以下命令克隆仓库并安装依赖：

```bash
git clone https://github.com/QwenLM/qwen-code.git
cd qwen-code
npm install
```

### 构建项目

项目提供了多种构建脚本，核心构建逻辑位于`scripts/build.js`文件中。该脚本首先检查`node_modules`是否存在，若不存在则自动运行`npm install`。随后执行`npm run generate`生成必要文件，并通过`npm run build --workspaces`命令构建所有工作区包。

若启用了沙箱功能（通过设置`GEMINI_SANDBOX=true`环境变量），脚本还会尝试构建沙箱容器镜像。可通过设置`BUILD_SANDBOX=1`环境变量来强制构建沙箱。

运行完整构建的命令为：

```bash
npm run build
```

或构建所有组件（包括CLI、沙箱和VS Code插件）：

```bash
npm run build:all
```

### 运行开发版本

构建完成后，可通过以下命令启动开发版CLI：

```bash
npm start
```

此命令会先运行`scripts/check-build-status.js`检查构建状态，然后启动`packages/cli`目录下的CLI应用。您也可以通过`npm run debug`命令以调试模式启动，该命令会附加Node.js调试器。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L150-L301)
- [package.json](file://package.json#L20-L30)
- [scripts/build.js](file://scripts/build.js#L1-L55)
- [scripts/start.js](file://scripts/start.js#L1-L76)

## 测试策略

本项目采用分层测试策略，涵盖单元测试和集成测试，确保代码质量和功能完整性。

### 单元测试

单元测试位于各个包的`__tests__`或`*.test.ts`文件中，主要验证单个函数、类或模块的行为。项目使用Vitest作为测试框架，在`packages/cli`和`packages/core`目录下均有独立的`vitest.config.ts`配置文件。

CLI包的测试配置指定了测试文件模式、环境（jsdom）、覆盖率报告格式（v8）以及输出目录。覆盖率报告包含文本摘要、HTML、JSON、lcov和cobertura等多种格式，便于在不同场景下分析。

核心包的测试配置类似，同样启用了覆盖率收集，并设置了Junit格式的测试结果输出，便于CI系统集成。

测试工具模块提供了丰富的模拟工具，如`MockTool`、`MockModifiableTool`等，用于在测试中模拟工具调用行为。`createMockCommandContext`函数可创建包含模拟服务和UI的完整命令上下文，极大简化了UI命令的测试。

运行单元测试的命令为：

```bash
npm run test
```

### 集成测试

集成测试位于`integration-tests`目录下，旨在验证CLI端到端的功能。这些测试不包含在默认的`npm run test`命令中，需单独运行：

```bash
npm run test:e2e
```

集成测试覆盖了文件系统操作、shell命令执行、MCP服务器交互等多种场景。通过设置不同的沙箱环境变量（如`GEMINI_SANDBOX=docker`），可以验证在不同沙箱配置下的行为一致性。

测试辅助工具如`file-system-test-helpers.ts`提供了创建临时文件、设置测试目录结构等实用功能，确保测试环境的隔离性和可重复性。

**Section sources**
- [package.json](file://package.json#L50-L60)
- [packages/cli/vitest.config.ts](file://packages/cli/vitest.config.ts#L1-L37)
- [packages/core/vitest.config.ts](file://packages/core/vitest.config.ts#L1-L32)
- [packages/cli/test-setup.ts](file://packages/cli/test-setup.ts#L1-L12)
- [packages/core/test-setup.ts](file://packages/core/test-setup.ts#L1-L21)
- [packages/cli/src/test-utils/customMatchers.ts](file://packages/cli/src/test-utils/customMatchers.ts#L1-L66)
- [packages/cli/src/test-utils/render.tsx](file://packages/cli/src/test-utils/render.tsx#L1-L18)
- [packages/cli/src/test-utils/mockCommandContext.ts](file://packages/cli/src/test-utils/mockCommandContext.ts#L1-L108)
- [packages/core/src/test-utils/tools.ts](file://packages/core/src/test-utils/tools.ts#L1-L169)
- [packages/core/src/test-utils/config.ts](file://packages/core/src/test-utils/config.ts#L1-L37)
- [packages/core/src/test-utils/mockWorkspaceContext.ts](file://packages/core/src/test-utils/mockWorkspaceContext.ts#L1-L33)

## 调试技巧

### VS Code调试

推荐使用VS Code进行调试。项目根目录下的`.vscode/launch.json`文件已配置了“Attach”和“Launch Program”等调试配置。

最简单的方式是直接按`F5`键启动调试。或者，您可以通过以下命令以调试模式启动CLI：

```bash
npm run debug
```

此命令会运行`node --inspect-brk`，在代码执行前暂停，等待调试器连接。您可以在Chrome浏览器中访问`chrome://inspect`来连接调试器。

### React DevTools

CLI的UI基于React构建，可使用React DevTools进行调试。首先以开发模式启动CLI：

```bash
DEV=true npm start
```

然后安装并运行React DevTools 4.x版本：

```bash
npx react-devtools@4.28.5
```

运行中的CLI应用将自动连接到DevTools，允许您检查组件树、状态和属性。

### 日志与环境变量

通过设置`DEBUG=1`环境变量可启用详细日志输出：

```bash
DEBUG=1 qwen
```

注意，项目会自动排除项目根目录下的`.env`文件中的`DEBUG`设置，如需为qwen-cli设置调试环境，应使用`.gemini/.env`文件。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L250-L301)

## 代码质量保证

项目通过一系列工具和流程确保代码质量与风格一致性。

### ESLint与Prettier

项目使用ESLint进行代码静态分析，规则定义在根目录的`eslint.config.js`中。Prettier用于代码格式化，确保代码风格统一。可通过以下命令分别执行：

```bash
npm run lint
npm run format
```

### 预检检查（Preflight）

`npm run preflight`是核心质量检查命令，它会依次执行清理、依赖安装、格式化、严格linting、构建、类型检查和CI测试。所有Pull Request在合并前必须通过此检查。

```bash
npm run preflight
```

建议开发者在提交前设置git pre-commit钩子，自动运行预检检查，防止不合规的代码被提交。

### 类型检查

项目使用TypeScript，通过`npm run typecheck`命令运行类型检查。该命令会在所有工作区包中执行`tsconfig.json`定义的类型检查，确保类型安全。

### 覆盖率要求

测试覆盖率由Vitest的v8提供者收集，要求关键模块达到较高的覆盖率。覆盖率报告生成在各包的`coverage`目录下，包含多种格式，便于分析和集成到CI/CD流程中。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L220-L250)
- [package.json](file://package.json#L70-L80)

## 新功能开发流程与架构最佳实践

### 开发流程推荐

1. **问题单先行**：在编写任何代码前，先在问题跟踪系统中创建问题单，描述功能需求或bug详情，并等待维护者反馈。
2. **分支创建**：从主分支创建新特性分支，命名应清晰反映功能内容。
3. **小步提交**：保持提交原子化，每个提交只包含一个逻辑变更，并遵循[Conventional Commits](https://www.conventionalcommits.org/)规范。
4. **本地验证**：在提交PR前，运行`npm run preflight`确保所有检查通过。
5. **文档更新**：若功能涉及用户界面变更，需同步更新`docs/`目录下的相关文档。
6. **PR提交**：创建PR并链接到对应的问题单，提供详细的变更描述和“为什么”要进行此变更的理由。

### 架构最佳实践

项目采用多包（monorepo）架构，核心逻辑位于`packages/core`，CLI界面位于`packages/cli`。新功能开发应遵循此分层：

- **业务逻辑**：应实现在`packages/core`中，保持与UI的解耦，便于测试和复用。
- **UI组件**：`packages/cli/src/ui`目录包含所有React组件，应遵循一致的样式和状态管理模式。
- **工具与服务**：`packages/core/src/tools`和`services`目录定义了可复用的工具和服务，新功能应尽可能复用或扩展现有模块，而非重复造轮子。

遵循项目现有的设计模式和编码约定，特别是导入路径的规范，避免包间的相对导入，以维护清晰的依赖关系。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L1-L301)
- [README.md](file://README.md#L1-L420)