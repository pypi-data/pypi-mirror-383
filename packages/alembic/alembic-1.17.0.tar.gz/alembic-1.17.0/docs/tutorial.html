
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Tutorial &#8212; Alembic 1.17.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/changelog.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx_paramlinks.css" />
    <link rel="stylesheet" type="text/css" href="_static/site_custom_css.css?v=54a89d43" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=347c026a"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=046fa432"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorial';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Auto Generating Migrations" href="autogenerate.html" />
    <link rel="prev" title="Front Matter" href="front.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Alembic 1.17.0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/sqlalchemy/alembic" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/alembic/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="https://img.shields.io/pypi/dw/alembic" class="icon-link-image" alt="PyPI"/></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="front.html">Front Matter</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="autogenerate.html">Auto Generating Migrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="offline.html">Generating SQL Scripts (a.k.a. “Offline Mode”)</a></li>
<li class="toctree-l1"><a class="reference internal" href="naming.html">The Importance of Naming Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="batch.html">Running “Batch” Migrations for SQLite and Other Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="branches.html">Working with Branches</a></li>
<li class="toctree-l1"><a class="reference internal" href="ops.html">Operation Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="cookbook.html">Cookbook</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="api/index.html">API Details</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="api/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/runtime.html">Runtime Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/config.html">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/commands.html">Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/operations.html">Operation Directives</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/autogenerate.html">Autogeneration</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/script.html">Script Directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/ddl.html">DDL Internals</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/tutorial.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Tutorial</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-migration-environment">The Migration Environment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-an-environment">Creating an Environment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-the-ini-file">Editing the .ini File</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#escaping-characters-in-ini-files">Escaping Characters in ini files</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-pyproject-toml-for-configuration">Using pyproject.toml for configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-migration-script">Create a Migration Script</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-our-first-migration">Running our First Migration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-our-second-migration">Running our Second Migration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-revision-identifiers">Partial Revision Identifiers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#relative-migration-identifiers">Relative Migration Identifiers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-information">Getting Information</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#viewing-history-ranges">Viewing History Ranges</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downgrading">Downgrading</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Link to this heading">#</a></h1>
<p>Alembic provides for the creation, management, and invocation of <em>change management</em>
scripts for a relational database, using SQLAlchemy as the underlying engine.
This tutorial will provide a full introduction to the theory and usage of this tool.</p>
<p>To begin, make sure Alembic is installed; a common way to install within a
local virtual environment is described at <a class="reference internal" href="front.html#installation"><span class="std std-ref">Installation</span></a>.
As illustrated in that chapter, it is useful to have Alembic
installed in the <strong>same module / Python path as that of the target project</strong>,
usually using a <a class="reference external" href="https://docs.python.org/3/tutorial/venv.html">Python virtual environment</a>, so that when the <code class="docutils literal notranslate"><span class="pre">alembic</span></code>
command is run, the Python script which is invoked by <code class="docutils literal notranslate"><span class="pre">alembic</span></code>,  namely your
project’s <code class="docutils literal notranslate"><span class="pre">env.py</span></code> script, will have access to your application’s models.
This is not strictly necessary, however is usually preferred.</p>
<p>The tutorial below assumes the <code class="docutils literal notranslate"><span class="pre">alembic</span></code> command line utility is present in
the local path and when invoked, will have access to the same Python module
environment as that of the target project.</p>
<section id="the-migration-environment">
<h2>The Migration Environment<a class="headerlink" href="#the-migration-environment" title="Link to this heading">#</a></h2>
<p>Usage of Alembic starts with creation of the <em>Migration Environment</em>.  This is a directory of scripts
that is specific to a particular application.   The migration environment is created just once,
and is then maintained along with the application’s source code itself.   The environment is
created using the <code class="docutils literal notranslate"><span class="pre">init</span></code> command of Alembic, and is then customizable to suit the specific
needs of the application.</p>
<p>The structure of this environment, including some generated migration scripts, looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yourproject</span><span class="o">/</span>
    <span class="n">alembic</span><span class="o">.</span><span class="n">ini</span>
    <span class="n">pyproject</span><span class="o">.</span><span class="n">toml</span>
    <span class="n">alembic</span><span class="o">/</span>
        <span class="n">env</span><span class="o">.</span><span class="n">py</span>
        <span class="n">README</span>
        <span class="n">script</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">mako</span>
        <span class="n">versions</span><span class="o">/</span>
            <span class="mi">3512</span><span class="n">b954651e_add_account</span><span class="o">.</span><span class="n">py</span>
            <span class="mi">2</span><span class="n">b1ae634e5cd_add_order_id</span><span class="o">.</span><span class="n">py</span>
            <span class="mi">3</span><span class="n">adcc9a56557_rename_username_field</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>The directory includes these directories/files:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> - this is Alembic’s main configuration file which is generated by all templates.
A detailed walkthrough of this file is later in the section <a class="reference internal" href="#tutorial-alembic-ini"><span class="std std-ref">Editing the .ini File</span></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> - most modern Python projects have a <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file.  Alembic may
optionally store project related configuration in this file as well; to use a <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>
configuration, see the section <a class="reference internal" href="#using-pep-621"><span class="std std-ref">Using pyproject.toml for configuration</span></a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">yourproject</span></code> - this is the root of your application’s source code, or some directory within it.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alembic</span></code> - this directory lives within your application’s source tree and is the home of the
migration environment.   It can be named anything, and a project that uses multiple databases
may even have more than one.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">env.py</span></code> - This is a Python script that is run whenever the alembic migration tool is invoked.
At the very least, it contains instructions to configure and generate a SQLAlchemy engine,
procure a connection from that engine along with a transaction, and then invoke the migration
engine, using the connection as a source of database connectivity.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">env.py</span></code> script is part of the generated environment so that the way migrations run
is entirely customizable.   The exact specifics of how to connect are here, as well as
the specifics of how the migration environment are invoked.  The script can be modified
so that multiple engines can be operated upon, custom arguments can be passed into the
migration environment, application-specific libraries and models can be loaded in and
made available.</p>
<p>Alembic includes a set of initialization templates which feature different varieties
of <code class="docutils literal notranslate"><span class="pre">env.py</span></code> for different use cases.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">README</span></code> - included with the various environment templates, should have something
informative.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">script.py.mako</span></code> - This is a <a class="reference external" href="http://www.makotemplates.org">Mako</a> template file which
is used to generate new migration scripts.   Whatever is here is used to generate new
files within <code class="docutils literal notranslate"><span class="pre">versions/</span></code>.   This is scriptable so that the structure of each migration
file can be controlled, including standard imports to be within each, as well as
changes to the structure of the <code class="docutils literal notranslate"><span class="pre">upgrade()</span></code> and <code class="docutils literal notranslate"><span class="pre">downgrade()</span></code> functions.  For example,
the <code class="docutils literal notranslate"><span class="pre">multidb</span></code> environment allows for multiple functions to be generated using a
naming scheme <code class="docutils literal notranslate"><span class="pre">upgrade_engine1()</span></code>, <code class="docutils literal notranslate"><span class="pre">upgrade_engine2()</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">versions/</span></code> - This directory holds the individual version scripts.  Users of other migration
tools may notice that the files here don’t use ascending integers, and instead use a
partial GUID approach.   In Alembic, the ordering of version scripts is relative
to directives within the scripts themselves, and it is theoretically possible to “splice” version files
in between others, allowing migration sequences from different branches to be merged,
albeit carefully by hand.</p></li>
</ul>
</section>
<section id="creating-an-environment">
<h2>Creating an Environment<a class="headerlink" href="#creating-an-environment" title="Link to this heading">#</a></h2>
<p>With a basic understanding of what the environment is, we can create one using <code class="docutils literal notranslate"><span class="pre">alembic</span> <span class="pre">init</span></code>.
This will create an environment using the “generic” template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd /path/to/yourproject
$ source /path/to/yourproject/.venv/bin/activate   # assuming a local virtualenv
$ alembic init alembic
</pre></div>
</div>
<p>Where above, the <code class="docutils literal notranslate"><span class="pre">init</span></code> command was called to generate a migrations directory called <code class="docutils literal notranslate"><span class="pre">alembic</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Creating</span> <span class="n">directory</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">alembic</span><span class="o">...</span><span class="n">done</span>
<span class="n">Creating</span> <span class="n">directory</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">alembic</span><span class="o">/</span><span class="n">versions</span><span class="o">...</span><span class="n">done</span>
<span class="n">Generating</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">alembic</span><span class="o">.</span><span class="n">ini</span><span class="o">...</span><span class="n">done</span>
<span class="n">Generating</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">alembic</span><span class="o">/</span><span class="n">env</span><span class="o">.</span><span class="n">py</span><span class="o">...</span><span class="n">done</span>
<span class="n">Generating</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">alembic</span><span class="o">/</span><span class="n">README</span><span class="o">...</span><span class="n">done</span>
<span class="n">Generating</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">alembic</span><span class="o">/</span><span class="n">script</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">mako</span><span class="o">...</span><span class="n">done</span>
<span class="n">Please</span> <span class="n">edit</span> <span class="n">configuration</span><span class="o">/</span><span class="n">connection</span><span class="o">/</span><span class="n">logging</span> <span class="n">settings</span> <span class="ow">in</span>
<span class="s1">&#39;/path/to/yourproject/alembic.ini&#39;</span> <span class="n">before</span> <span class="n">proceeding</span><span class="o">.</span>
</pre></div>
</div>
<p>The above layout is produced using a layout template called <code class="docutils literal notranslate"><span class="pre">generic</span></code>.
Alembic also includes other environment templates.  These can be listed out
using the <code class="docutils literal notranslate"><span class="pre">list_templates</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic list_templates
Available templates:

generic - Generic single-database configuration.
pyproject - pep-621 compliant configuration that includes pyproject.toml
async - Generic single-database configuration with an async dbapi.
multidb - Rudimentary multi-database configuration.

Templates are used via the &#39;init&#39; command, e.g.:

  alembic init --template generic ./scripts
</pre></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 1.16.0: </span>A new <code class="docutils literal notranslate"><span class="pre">pyproject</span></code> template has been added.  See
the section <a class="reference internal" href="#using-pep-621"><span class="std std-ref">Using pyproject.toml for configuration</span></a> for background.</p>
</div>
</section>
<section id="editing-the-ini-file">
<span id="tutorial-alembic-ini"></span><h2>Editing the .ini File<a class="headerlink" href="#editing-the-ini-file" title="Link to this heading">#</a></h2>
<p>Alembic placed a file <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> into the current directory. Alembic looks
in the current directory for this file when any other commands are run; to
indicate an alternative location, the <code class="docutils literal notranslate"><span class="pre">--config</span></code> option may be used, or the
<code class="docutils literal notranslate"><span class="pre">ALEMBIC_CONFIG</span></code> environment variable may be set.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The file generated with the <code class="docutils literal notranslate"><span class="pre">generic</span></code> configuration template contains all directives
for both source code configuration as well as database configuration.  When using
the <code class="docutils literal notranslate"><span class="pre">pyproject</span></code> template, the source code configuration elements will instead
be in a separate <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file, described in the section <a class="reference internal" href="#using-pep-621"><span class="std std-ref">Using pyproject.toml for configuration</span></a>.</p>
</div>
<p>The all-in-one .ini file created by <code class="docutils literal notranslate"><span class="pre">generic</span></code> is illustrated below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># A generic, single database configuration.

[alembic]
# path to migration scripts.
# this is typically a path given in POSIX (e.g. forward slashes)
# format, relative to the token %(here)s which refers to the location of this
# ini file
script_location = %(here)s/alembic

# template used to generate migration file names; The default value is %%(rev)s_%%(slug)s
# Uncomment the line below if you want the files to be prepended with date and time
# file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s

# sys.path path, will be prepended to sys.path if present.
# defaults to the current working directory.
prepend_sys_path = .

# timezone to use when rendering the date within the migration file
# as well as the filename.
# If specified, requires the python&gt;=3.9 or backports.zoneinfo library and tzdata library.
# Any required deps can installed by adding `alembic[tz]` to the pip requirements
# string value is passed to ZoneInfo()
# leave blank for localtime
# timezone =

# max length of characters to apply to the
# &quot;slug&quot; field
# truncate_slug_length = 40

# set to &#39;true&#39; to run the environment during
# the &#39;revision&#39; command, regardless of autogenerate
# revision_environment = false

# set to &#39;true&#39; to allow .pyc and .pyo files without
# a source .py file to be detected as revisions in the
# versions/ directory
# sourceless = false

# version location specification; This defaults
# to &lt;script_location&gt;/versions.  When using multiple version
# directories, initial revisions must be specified with --version-path.
# the special token `%(here)s` is available which indicates the absolute path
# to this configuration file.
#
# The path separator used here should be the separator specified by &quot;version_path_separator&quot; below.
# version_locations = %(here)s/bar:%(here)s/bat:%(here)s/alembic/versions

# path_separator (New in Alembic 1.16.0, supersedes version_path_separator);
# This indicates what character is used to
# split lists of file paths, including version_locations and prepend_sys_path
# within configparser files such as alembic.ini.
#
# The default rendered in new alembic.ini files is &quot;os&quot;, which uses os.pathsep
# to provide os-dependent path splitting.
#
# Note that in order to support legacy alembic.ini files, this default does NOT
# take place if path_separator is not present in alembic.ini.  If this
# option is omitted entirely, fallback logic is as follows:
#
# 1. Parsing of the version_locations option falls back to using the legacy
#    &quot;version_path_separator&quot; key, which if absent then falls back to the legacy
#    behavior of splitting on spaces and/or commas.
# 2. Parsing of the prepend_sys_path option falls back to the legacy
#    behavior of splitting on spaces, commas, or colons.
#
# Valid values for path_separator are:
#
# path_separator = :
# path_separator = ;
# path_separator = space
# path_separator = newline
#
# Use os.pathsep. Default configuration used for new projects.
path_separator = os

# set to &#39;true&#39; to search source files recursively
# in each &quot;version_locations&quot; directory
# new in Alembic version 1.10
# recursive_version_locations = false

# the output encoding used when revision files
# are written from script.py.mako
# output_encoding = utf-8

# database URL.  This is consumed by the user-maintained env.py script only.
# other means of configuring database URLs may be customized within the env.py
# file.
# See notes in &quot;escaping characters in ini files&quot; for guidelines on
# passwords
sqlalchemy.url = driver://user:pass@localhost/dbname

# [post_write_hooks]
# This section defines scripts or Python functions that are run
# on newly generated revision scripts.  See the documentation for further
# detail and examples

# format using &quot;black&quot; - use the console_scripts runner,
# against the &quot;black&quot; entrypoint
# hooks = black
# black.type = console_scripts
# black.entrypoint = black
# black.options = -l 79 REVISION_SCRIPT_FILENAME

# lint with attempts to fix using &quot;ruff&quot; - use the module runner, against the &quot;ruff&quot; module
# hooks = ruff
# ruff.type = module
# ruff.module = ruff
# ruff.options = check --fix REVISION_SCRIPT_FILENAME

# Alternatively, use the exec runner to execute a binary found on your PATH
# hooks = ruff
# ruff.type = exec
# ruff.executable = ruff
# ruff.options = check --fix REVISION_SCRIPT_FILENAME

# Logging configuration.  This is also consumed by the user-maintained
# env.py script only.
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARNING
handlers = console
qualname =

[logger_sqlalchemy]
level = WARNING
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> file is consumed by Alembic using Python’s
<a class="reference external" href="https://docs.python.org/3/library/configparser.html#configparser.ConfigParser">configparser.ConfigParser</a>
library.  The <code class="docutils literal notranslate"><span class="pre">%(here)s</span></code> variable is
provided as a substitution which is populated with the absolute path to the
<code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> file itself.  This can be used to produce correct pathnames
to directories and files relative to where the config file is located.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Percent signs in <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> configuration variables that are
not part of an interpolation token like <code class="docutils literal notranslate"><span class="pre">%(here)s</span></code>, including percent
signs that are part of the SQLAlchemy database URL for its own URL-escaping
requirements, must themselves be escaped.
See the section <a class="reference internal" href="#escaping-percent-signs"><span class="std std-ref">Escaping Characters in ini files</span></a> for more information.</p>
</div>
<p>This file contains the following features:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">[alembic]</span></code> - this is the section read by Alembic to determine configuration.  Alembic’s
core implementation does not directly read any other areas of the file, not
including additional directives that may be consumed from the
end-user-customizable <code class="docutils literal notranslate"><span class="pre">env.py</span></code> file (see note below). The name “alembic”
(for configparser config only, not <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>)
can be customized using the <code class="docutils literal notranslate"><span class="pre">--name</span></code> commandline flag; see
<a class="reference internal" href="cookbook.html#multiple-environments"><span class="std std-ref">Run Multiple Alembic Environments from one .ini file</span></a> for a basic example of this.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The default <code class="docutils literal notranslate"><span class="pre">env.py</span></code> file included with Alembic’s environment
templates will also read from the logging sections <code class="docutils literal notranslate"><span class="pre">[logging]</span></code>,
<code class="docutils literal notranslate"><span class="pre">[handlers]</span></code> etc. If the configuration file in use does not contain
logging directives, please remove the <code class="docutils literal notranslate"><span class="pre">fileConfig()</span></code> directive within
the generated <code class="docutils literal notranslate"><span class="pre">env.py</span></code> file to prevent it from attempting to configure
logging.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">script_location</span></code> - this is the location of the Alembic environment.   It is normally
specified as a filesystem location relative to the <code class="docutils literal notranslate"><span class="pre">%(here)s</span></code> token, which
indicates where the config file itself is located.   The location may also
be a plain relative path, where it’s interpreted as relative to the current directory,
or an absolute path.</p>
<p>This is the only key required by Alembic in all cases.   The generation
of the .ini file by the command <code class="docutils literal notranslate"><span class="pre">alembic</span> <span class="pre">init</span> <span class="pre">alembic</span></code> automatically placed the
directory name <code class="docutils literal notranslate"><span class="pre">alembic</span></code> here.   The special variable <code class="docutils literal notranslate"><span class="pre">%(here)s</span></code> can also be used,
as in <code class="docutils literal notranslate"><span class="pre">%(here)s/alembic</span></code>.</p>
<p>For support of applications that package themselves into .egg files, the value can
also be specified as a <a class="reference external" href="https://setuptools.readthedocs.io/en/latest/pkg_resources.html">package resource</a>, in which
case <code class="docutils literal notranslate"><span class="pre">resource_filename()</span></code> is used to find the file (new in 0.2.2).  Any non-absolute
URI which contains colons is interpreted here as a resource name, rather than
a straight filename.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">file_template</span></code> - this is the naming scheme used to generate new migration
files. Uncomment the presented value if you would like the migration files to
be prepended with date and time, so that they are listed in chronological
order.  The default value is <code class="docutils literal notranslate"><span class="pre">%%(rev)s_%%(slug)s</span></code>.  Tokens available
include:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">%%(rev)s</span></code> - revision id</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%%(slug)s</span></code> - a truncated string derived from the revision message</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%%(epoch)s</span></code> - epoch timestamp based on the create date; this makes
use of the Python <code class="docutils literal notranslate"><span class="pre">datetime.timestamp()</span></code> method to produce an epoch
value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%%(year)d</span></code>, <code class="docutils literal notranslate"><span class="pre">%%(month).2d</span></code>, <code class="docutils literal notranslate"><span class="pre">%%(day).2d</span></code>, <code class="docutils literal notranslate"><span class="pre">%%(hour).2d</span></code>,
<code class="docutils literal notranslate"><span class="pre">%%(minute).2d</span></code>, <code class="docutils literal notranslate"><span class="pre">%%(second).2d</span></code> - components of the create date,
by default <code class="docutils literal notranslate"><span class="pre">datetime.datetime.now()</span></code> unless the <code class="docutils literal notranslate"><span class="pre">timezone</span></code>
configuration option is also used.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">timezone</span></code> - an optional timezone name (e.g. <code class="docutils literal notranslate"><span class="pre">UTC</span></code>, <code class="docutils literal notranslate"><span class="pre">EST5EDT</span></code>, etc.)
that will be applied to the timestamp which renders inside the migration
file’s comment as well as within the filename. This option requires Python&gt;=3.9
or installing the <code class="docutils literal notranslate"><span class="pre">backports.zoneinfo</span></code> library and the <code class="docutils literal notranslate"><span class="pre">tzdata</span></code> library.
If <code class="docutils literal notranslate"><span class="pre">timezone</span></code> is specified, the create date object is no longer derived
from <code class="docutils literal notranslate"><span class="pre">datetime.datetime.now()</span></code> and is instead generated as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
  <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span>
<span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="o">&lt;</span><span class="n">timezone</span><span class="o">&gt;</span><span class="p">))</span>
</pre></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">Changed in version 1.13.0: </span>Python standard library <code class="docutils literal notranslate"><span class="pre">zoneinfo</span></code> is now used
for timezone rendering in migrations; previously <code class="docutils literal notranslate"><span class="pre">python-dateutil</span></code>
was used.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">truncate_slug_length</span></code> - defaults to 40, the max number of characters
to include in the “slug” field.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sqlalchemy.url</span></code> - A URL to connect to the database via SQLAlchemy.  This
configuration value is only used if the <code class="docutils literal notranslate"><span class="pre">env.py</span></code> file calls upon them;
in the “generic” template, the call to
<code class="docutils literal notranslate"><span class="pre">config.get_main_option(&quot;sqlalchemy.url&quot;)</span></code> in the
<code class="docutils literal notranslate"><span class="pre">run_migrations_offline()</span></code> function and the call to
<code class="docutils literal notranslate"><span class="pre">engine_from_config(prefix=&quot;sqlalchemy.&quot;)</span></code>  in the
<code class="docutils literal notranslate"><span class="pre">run_migrations_online()</span></code> function are where this key is referenced.   If
the SQLAlchemy URL should come from some other source, such as from
environment variables or a global registry, or if the migration environment
makes use of multiple database URLs, the developer is encouraged to alter the
<code class="docutils literal notranslate"><span class="pre">env.py</span></code> file to use whatever methods are appropriate in order to acquire
the database URL or URLs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">revision_environment</span></code> - this is a flag which when set to the value ‘true’, will indicate
that the migration environment script <code class="docutils literal notranslate"><span class="pre">env.py</span></code> should be run unconditionally when
generating new revision files, as well as when running the <code class="docutils literal notranslate"><span class="pre">alembic</span> <span class="pre">history</span></code>
command.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sourceless</span></code> - when set to ‘true’, revision files that only exist as .pyc
or .pyo files in the versions directory will be used as versions, allowing
“sourceless” versioning folders.  When left at the default of ‘false’,
only .py files are consumed as version files.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">version_locations</span></code> - an optional list of revision file locations, to
allow revisions to exist in multiple directories simultaneously.
See <a class="reference internal" href="branches.html#multiple-bases"><span class="std std-ref">Working with Multiple Bases</span></a> for examples.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">path_separator</span></code> - a separator character for the <code class="docutils literal notranslate"><span class="pre">version_locations</span></code>
and <code class="docutils literal notranslate"><span class="pre">prepend_sys_path</span></code> path lists.  Only applies to configparser config,
not needed if <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> configuration is used.
See <a class="reference internal" href="branches.html#multiple-bases"><span class="std std-ref">Working with Multiple Bases</span></a> for examples.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">recursive_version_locations</span></code> - when set to ‘true’, revision files
are searched recursively in each “version_locations” directory.</p>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 1.10.</span></p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">output_encoding</span></code> - the encoding to use when Alembic writes the
<code class="docutils literal notranslate"><span class="pre">script.py.mako</span></code> file into a new migration file.  Defaults to <code class="docutils literal notranslate"><span class="pre">'utf-8'</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">[loggers]</span></code>, <code class="docutils literal notranslate"><span class="pre">[handlers]</span></code>, <code class="docutils literal notranslate"><span class="pre">[formatters]</span></code>, <code class="docutils literal notranslate"><span class="pre">[logger_*]</span></code>, <code class="docutils literal notranslate"><span class="pre">[handler_*]</span></code>,
<code class="docutils literal notranslate"><span class="pre">[formatter_*]</span></code> - these sections are all part of Python’s standard logging configuration,
the mechanics of which are documented at <a class="reference external" href="http://docs.python.org/library/logging.config.html#configuration-file-format">Configuration File Format</a>.
As is the case with the database connection, these directives are used directly as the
result of the <code class="docutils literal notranslate"><span class="pre">logging.config.fileConfig()</span></code> call present in the
<code class="docutils literal notranslate"><span class="pre">env.py</span></code> script, which you’re free to modify.</p></li>
</ul>
<p>For starting up with just a single database and the generic configuration, setting up
the SQLAlchemy URL is all that’s needed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">postgresql</span><span class="p">:</span><span class="o">//</span><span class="n">scott</span><span class="p">:</span><span class="n">tiger</span><span class="nd">@localhost</span><span class="o">/</span><span class="n">test</span>
</pre></div>
</div>
<section id="escaping-characters-in-ini-files">
<span id="escaping-percent-signs"></span><h3>Escaping Characters in ini files<a class="headerlink" href="#escaping-characters-in-ini-files" title="Link to this heading">#</a></h3>
<p>As mentioned previously, Alembic’s .ini file format uses Python <a class="reference external" href="https://docs.python.org/3/library/configparser.html#configparser.ConfigParser">ConfigParser</a>
to parse the file.   <code class="docutils literal notranslate"><span class="pre">ConfigParser</span></code> ‘s <a class="reference external" href="https://docs.python.org/3/library/configparser.html#interpolation-of-values">interpolation feature is enabled</a>
in this operation to support the use of the <code class="docutils literal notranslate"><span class="pre">%(here)s</span></code> token, as well as any
other tokens that are user-configurable via the <a class="reference internal" href="api/config.html#alembic.config.Config.params.config_args" title="alembic.config.Config"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Config.config_args</span></code></a>
parameter when creating a custom <a class="reference internal" href="api/config.html#alembic.config.Config" title="alembic.config.Config"><code class="xref py py-class docutils literal notranslate"><span class="pre">Config</span></code></a> object.</p>
<p>This means that any literal string that includes a percent sign that is not
part of an interpolated variable must be escaped by doubling it.  That is, for
a configuration value like this in a Python script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_configuration_value</span> <span class="o">=</span> <span class="s2">&quot;some </span><span class="si">% s</span><span class="s2">tring&quot;</span>
</pre></div>
</div>
<p>To be parsed from the .ini file would need to be placed as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">alembic</span><span class="p">]</span>

<span class="n">my_configuration_value</span> <span class="o">=</span> <span class="n">some</span> <span class="o">%%</span> <span class="n">string</span>
</pre></div>
</div>
<p>This escaping can be seen in the sample <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> file, illustrated in
such values as <code class="docutils literal notranslate"><span class="pre">file_template</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># template used to generate migration file names; The default value is %%(rev)s_%%(slug)s</span>
<span class="n">file_template</span> <span class="o">=</span> <span class="o">%%</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="n">d_</span><span class="o">%%</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="mf">.2</span><span class="n">d_</span><span class="o">%%</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="mf">.2</span><span class="n">d_</span><span class="o">%%</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span><span class="mf">.2</span><span class="n">d</span><span class="o">%%</span><span class="p">(</span><span class="n">minute</span><span class="p">)</span><span class="mf">.2</span><span class="n">d</span><span class="o">-%%</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span><span class="n">s_</span><span class="o">%%</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span><span class="n">s</span>
</pre></div>
</div>
<p>Where above, the actual <code class="docutils literal notranslate"><span class="pre">file_template</span></code> that is sent to Alembic’s file generation system
would be <code class="docutils literal notranslate"><span class="pre">%(year)d_%(month).2d_%(day).2d_%(hour).2d%(minute).2d-%(rev)s_%(slug)s</span></code>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Alembic also employs percent-sign interpolation of values when retrieving
values from a <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file, as documented at <a class="reference internal" href="#using-pep-621"><span class="std std-ref">Using pyproject.toml for configuration</span></a>.
So the same percent-doubling steps must be applied in Alembic-parsed values,
for fields such as <code class="docutils literal notranslate"><span class="pre">file_template</span></code>.</p>
</div>
<p>For the SQLAlchemy URL, percent signs are used to escape syntactically-
significant characters such as the <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> sign as well as the percent sign
itself.  For a password such as <code class="docutils literal notranslate"><span class="pre">&quot;P&#64;ssw%rd&quot;</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">my_actual_password</span> <span class="o">=</span> <span class="s2">&quot;P@ssw</span><span class="si">%r</span><span class="s2">d&quot;</span>
</pre></div>
</div>
<p>As <a class="reference external" href="https://docs.sqlalchemy.org/core/engines.html#escaping-special-characters-such-as-signs-in-passwords">documented by SQLAlchemy</a>,
the <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> sign as well as the percent sign when placed into a URL should be escaped with <code class="docutils literal notranslate"><span class="pre">urllib.parse.quote_plus</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sqlalchemy_quoted_password</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">my_actual_password</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sqlalchemy_quoted_password</span>
<span class="go">&#39;P%40ssw%25rd&#39;</span>
</pre></div>
</div>
<p>This URL quoting can also be seen in SQLAlchemy’s own stringification of
URLs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">URL</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">URL</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<span class="gp">... </span>  <span class="s2">&quot;some_db&quot;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;scott&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">my_actual_password</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;host&quot;</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">render_as_string</span><span class="p">(</span><span class="n">hide_password</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="go">&#39;some_db://scott:P%40ssw%25rd@host&#39;</span>
</pre></div>
</div>
<p>For the above escaped password string <code class="docutils literal notranslate"><span class="pre">'P%40ssw%rd'</span></code> to be placed into a <code class="docutils literal notranslate"><span class="pre">ConfigParser</span></code> file that
includes interpolation of percent signs, <code class="docutils literal notranslate"><span class="pre">%</span></code> characters are doubled:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sqlalchemy_quoted_password</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%%</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">&#39;P%%40ssw%%25rd&#39;</span>
</pre></div>
</div>
<p>Here’s a complete program that will compose a URL and show the correct configparser form
for a given set of database connection details, as well as illustrate how to assert these
forms for correctness:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">URL</span><span class="p">,</span> <span class="n">make_url</span>

<span class="n">database_driver</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;database driver? &quot;</span><span class="p">)</span>
<span class="n">username</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;username? &quot;</span><span class="p">)</span>
<span class="n">password</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;password? &quot;</span><span class="p">)</span>
<span class="n">host</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;host? &quot;</span><span class="p">)</span>
<span class="n">port</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;port? &quot;</span><span class="p">)</span>
<span class="n">database</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;database? &quot;</span><span class="p">)</span>

<span class="n">sqlalchemy_url</span> <span class="o">=</span> <span class="n">URL</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">drivername</span><span class="o">=</span><span class="n">database_driver</span><span class="p">,</span>
    <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
    <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">),</span>
    <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">stringified_sqlalchemy_url</span> <span class="o">=</span> <span class="n">sqlalchemy_url</span><span class="o">.</span><span class="n">render_as_string</span><span class="p">(</span>
    <span class="n">hide_password</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="c1"># assert make_url round trip</span>
<span class="k">assert</span> <span class="n">make_url</span><span class="p">(</span><span class="n">stringified_sqlalchemy_url</span><span class="p">)</span> <span class="o">==</span> <span class="n">sqlalchemy_url</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;The correctly escaped string that can be passed &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;to SQLAlchemy make_url() and create_engine() is:&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">     </span><span class="si">{</span><span class="n">stringified_sqlalchemy_url</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="p">)</span>

<span class="n">percent_replaced_url</span> <span class="o">=</span> <span class="n">stringified_sqlalchemy_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%%</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># assert percent-interpolated plus make_url round trip</span>
<span class="k">assert</span> <span class="n">make_url</span><span class="p">(</span><span class="n">percent_replaced_url</span> <span class="o">%</span> <span class="p">{})</span> <span class="o">==</span> <span class="n">sqlalchemy_url</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;The SQLAlchemy URL that can be placed in a ConfigParser &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;file such as alembic.ini is:</span><span class="se">\n\n</span><span class="s2">      &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;sqlalchemy.url = </span><span class="si">{</span><span class="n">percent_replaced_url</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The above program should eliminate any ambiguity when placing a SQLAlchemy
URL into a configparser file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python alembic_pw_script.py
database driver? postgresql+psycopg2
username? scott
password? P@ssw%rd
host? localhost
port? 5432
database? testdb
The correctly escaped string that can be passed to SQLAlchemy make_url() and create_engine() is:

    &#39;postgresql+psycopg2://scott:P%40ssw%25rd@localhost:5432/testdb&#39;

The SQLAlchemy URL that can be placed in a ConfigParser file such as alembic.ini is:

      sqlalchemy.url = postgresql+psycopg2://scott:P%%40ssw%%25rd@localhost:5432/testdb
</pre></div>
</div>
</section>
</section>
<section id="using-pyproject-toml-for-configuration">
<span id="using-pep-621"></span><h2>Using pyproject.toml for configuration<a class="headerlink" href="#using-pyproject-toml-for-configuration" title="Link to this heading">#</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 1.16.0.</span></p>
</div>
<p>As the <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> file includes a subset of options that are specific to
the organization and production of Python code within the local environment,
these specific options may alternatively be placed in the application’s
<code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file, to allow for <span class="target" id="index-0"></span><a class="pep reference external" href="https://peps.python.org/pep-0621/"><strong>PEP 621</strong></a> compliant configuration.</p>
<p>Use of <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> does not preclude having an <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> file as
well, as <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> is still the default location for <strong>deployment</strong>
details such as database URLs, connectivity options, and logging to be present.
However, as connectivity and logging is consumed only by user-managed code
within the <code class="docutils literal notranslate"><span class="pre">env.py</span></code> file, it is feasible to have an environment that does not
require the <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> file itself to be present at all, if these
configurational elements are consumed from other places elsewhere in the
application.   Alembic will still run successfully if only a <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>
file is present and no <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> is found.</p>
<p>To start with a pyproject configuration, the most straightforward approach is
to use the <code class="docutils literal notranslate"><span class="pre">pyproject</span></code> template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alembic</span> <span class="n">init</span> <span class="o">--</span><span class="n">template</span> <span class="n">pyproject</span> <span class="n">alembic</span>
</pre></div>
</div>
<p>The output states that the existing pyproject file is being augmented with
additional directives:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Creating</span> <span class="n">directory</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">alembic</span><span class="o">...</span><span class="n">done</span>
<span class="n">Creating</span> <span class="n">directory</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">alembic</span><span class="o">/</span><span class="n">versions</span><span class="o">...</span><span class="n">done</span>
<span class="n">Appending</span> <span class="n">to</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">pyproject</span><span class="o">.</span><span class="n">toml</span><span class="o">...</span><span class="n">done</span>
<span class="n">Generating</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">alembic</span><span class="o">.</span><span class="n">ini</span><span class="o">...</span><span class="n">done</span>
<span class="n">Generating</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">alembic</span><span class="o">/</span><span class="n">env</span><span class="o">.</span><span class="n">py</span><span class="o">...</span><span class="n">done</span>
<span class="n">Generating</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">alembic</span><span class="o">/</span><span class="n">README</span><span class="o">...</span><span class="n">done</span>
<span class="n">Generating</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">yourproject</span><span class="o">/</span><span class="n">alembic</span><span class="o">/</span><span class="n">script</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">mako</span><span class="o">...</span><span class="n">done</span>
<span class="n">Please</span> <span class="n">edit</span> <span class="n">configuration</span><span class="o">/</span><span class="n">connection</span><span class="o">/</span><span class="n">logging</span> <span class="n">settings</span> <span class="ow">in</span>
<span class="s1">&#39;/path/to/yourproject/pyproject.toml&#39;</span> <span class="ow">and</span>
<span class="s1">&#39;/path/to/yourproject/alembic.ini&#39;</span> <span class="n">before</span> <span class="n">proceeding</span><span class="o">.</span>
</pre></div>
</div>
<p>Alembic’s template runner will generate a new <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file if
one does not exist, or it will append directives to an existing <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>
file that does not already include alembic directives.</p>
<p>Within the <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file, the default section generated looks mostly
like the <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> file, with the welcome exception that lists of values
are supported directly; this means the values <code class="docutils literal notranslate"><span class="pre">prepend_sys_path</span></code> and
<code class="docutils literal notranslate"><span class="pre">version_locations</span></code> are specified as lists.   The <code class="docutils literal notranslate"><span class="pre">%(here)s</span></code> token also
remains available as the absolute path to the <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">alembic</span><span class="p">]</span>
<span class="c1"># path to migration scripts</span>
<span class="n">script_location</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(here)s</span><span class="s2">/alembic&quot;</span>

<span class="c1"># template used to generate migration file names; The default value is %%(rev)s_%%(slug)s</span>
<span class="c1"># Uncomment the line below if you want the files to be prepended with date and time</span>
<span class="c1"># file_template = %%(year)d_%%(month).2d_%%(day).2d_%%(hour).2d%%(minute).2d-%%(rev)s_%%(slug)s</span>

<span class="c1"># additional paths to be prepended to sys.path. defaults to the current working directory.</span>
<span class="n">prepend_sys_path</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;.&quot;</span>
<span class="p">]</span>

<span class="c1"># timezone to use when rendering the date within the migration file</span>
<span class="c1"># as well as the filename.</span>
<span class="c1"># If specified, requires the python&gt;=3.9 or backports.zoneinfo library and tzdata library.</span>
<span class="c1"># Any required deps can installed by adding `alembic[tz]` to the pip requirements</span>
<span class="c1"># string value is passed to ZoneInfo()</span>
<span class="c1"># leave blank for localtime</span>
<span class="c1"># timezone =</span>

<span class="c1"># max length of characters to apply to the</span>
<span class="c1"># &quot;slug&quot; field</span>
<span class="c1"># truncate_slug_length = 40</span>

<span class="c1"># set to &#39;true&#39; to run the environment during</span>
<span class="c1"># the &#39;revision&#39; command, regardless of autogenerate</span>
<span class="c1"># revision_environment = false</span>

<span class="c1"># set to &#39;true&#39; to allow .pyc and .pyo files without</span>
<span class="c1"># a source .py file to be detected as revisions in the</span>
<span class="c1"># versions/ directory</span>
<span class="c1"># sourceless = false</span>

<span class="c1"># version location specification; This defaults</span>
<span class="c1"># to &lt;script_location&gt;/versions.  When using multiple version</span>
<span class="c1"># directories, initial revisions must be specified with --version-path.</span>
<span class="c1"># version_locations = [</span>
<span class="c1">#    &quot;%(here)s/alembic/versions&quot;,</span>
<span class="c1">#    &quot;%(here)s/foo/bar&quot;</span>
<span class="c1"># ]</span>

<span class="c1"># set to &#39;true&#39; to search source files recursively</span>
<span class="c1"># in each &quot;version_locations&quot; directory</span>
<span class="c1"># new in Alembic version 1.10</span>
<span class="c1"># recursive_version_locations = false</span>

<span class="c1"># the output encoding used when revision files</span>
<span class="c1"># are written from script.py.mako</span>
<span class="c1"># output_encoding = &quot;utf-8&quot;</span>


<span class="c1"># This section defines scripts or Python functions that are run</span>
<span class="c1"># on newly generated revision scripts.  See the documentation for further</span>
<span class="c1"># detail and examples</span>
<span class="c1"># [[tool.alembic.post_write_hooks]]</span>
<span class="c1"># format using &quot;black&quot; - use the console_scripts runner,</span>
<span class="c1"># against the &quot;black&quot; entrypoint</span>
<span class="c1"># name = &quot;black&quot;</span>
<span class="c1"># type = &quot;console_scripts&quot;</span>
<span class="c1"># entrypoint = &quot;black&quot;</span>
<span class="c1"># options = &quot;-l 79 REVISION_SCRIPT_FILENAME&quot;</span>
<span class="c1">#</span>
<span class="c1"># [[tool.alembic.post_write_hooks]]</span>
<span class="c1"># lint with attempts to fix using &quot;ruff&quot; - use the exec runner,</span>
<span class="c1"># execute a binary</span>
<span class="c1"># name = &quot;ruff&quot;</span>
<span class="c1"># type = &quot;exec&quot;</span>
<span class="c1"># executable = &quot;%(here)s/.venv/bin/ruff&quot;</span>
<span class="c1"># options = &quot;check --fix REVISION_SCRIPT_FILENAME&quot;</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>As Alembic adds support for interpolation tokens like <code class="docutils literal notranslate"><span class="pre">%(here)s</span></code> to
its handling of <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> values, the same percent-sign escaping
steps that apply to <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> configuration variables also apply
to <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>, even though database URLs are not configured in this
file.  This escaping can be seen in the sample <code class="docutils literal notranslate"><span class="pre">file_template</span></code> value
above.   See the section <a class="reference internal" href="#escaping-percent-signs"><span class="std std-ref">Escaping Characters in ini files</span></a> for background.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> file for this template is truncated and contains
only database configuration and logging configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[alembic]

# database URL.  This is consumed by the user-maintained env.py script only.
# other means of configuring database URLs may be customized within the env.py
# file.
sqlalchemy.url = driver://user:pass@localhost/dbname

# Logging configuration.  This is also consumed by the user-maintained
# env.py script only.
[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARNING
handlers = console
qualname =

[logger_sqlalchemy]
level = WARNING
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S
</pre></div>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">env.py</span></code> is configured to obtain database connectivity and logging
configuration from places other than <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code>, the file can be
omitted altogether.</p>
</section>
<section id="create-a-migration-script">
<span id="create-migration"></span><h2>Create a Migration Script<a class="headerlink" href="#create-a-migration-script" title="Link to this heading">#</a></h2>
<p>With the environment in place we can create a new revision, using <code class="docutils literal notranslate"><span class="pre">alembic</span> <span class="pre">revision</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic revision -m &quot;create account table&quot;
Generating /path/to/yourproject/alembic/versions/1975ea83b712_create_accoun
t_table.py...done
</pre></div>
</div>
<p>A new file <code class="docutils literal notranslate"><span class="pre">1975ea83b712_create_account_table.py</span></code> is generated.  Looking inside the file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;create account table</span>

<span class="sd">Revision ID: 1975ea83b712</span>
<span class="sd">Revises:</span>
<span class="sd">Create Date: 2011-11-08 11:40:27.089406</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;1975ea83b712&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">branch_labels</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>

<span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="k">pass</span>

<span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>The file contains some header information, identifiers for the current revision
and a “downgrade” revision, an import of basic Alembic directives,
and empty <code class="docutils literal notranslate"><span class="pre">upgrade()</span></code> and <code class="docutils literal notranslate"><span class="pre">downgrade()</span></code> functions.  Our
job here is to populate the <code class="docutils literal notranslate"><span class="pre">upgrade()</span></code> and <code class="docutils literal notranslate"><span class="pre">downgrade()</span></code> functions with directives that
will apply a set of changes to our database.    Typically, <code class="docutils literal notranslate"><span class="pre">upgrade()</span></code> is required
while <code class="docutils literal notranslate"><span class="pre">downgrade()</span></code> is only needed if down-revision capability is desired, though it’s
probably a good idea.</p>
<p>Another thing to notice is the <code class="docutils literal notranslate"><span class="pre">down_revision</span></code> variable.  This is how Alembic
knows the correct order in which to apply migrations.   When we create the next revision,
the new file’s <code class="docutils literal notranslate"><span class="pre">down_revision</span></code> identifier would point to this one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;ae1027a6acf&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="s1">&#39;1975ea83b712&#39;</span>
</pre></div>
</div>
<p>Every time Alembic runs an operation against the <code class="docutils literal notranslate"><span class="pre">versions/</span></code> directory, it reads all
the files in, and composes a list based on how the <code class="docutils literal notranslate"><span class="pre">down_revision</span></code> identifiers link together,
with the <code class="docutils literal notranslate"><span class="pre">down_revision</span></code> of <code class="docutils literal notranslate"><span class="pre">None</span></code> representing the first file.   In theory, if a
migration environment had thousands of migrations, this could begin to add some latency to
startup, but in practice a project should probably prune old migrations anyway
(see the section <a class="reference internal" href="cookbook.html#building-uptodate"><span class="std std-ref">Building an Up to Date Database from Scratch</span></a> for a description on how to do this, while maintaining
the ability to build the current database fully).</p>
<p>We can then add some directives to our script, suppose adding a new table <code class="docutils literal notranslate"><span class="pre">account</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
        <span class="s1">&#39;account&#39;</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">200</span><span class="p">)),</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="ops.html#alembic.operations.Operations.create_table" title="alembic.operations.Operations.create_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_table()</span></code></a> and <a class="reference internal" href="ops.html#alembic.operations.Operations.drop_table" title="alembic.operations.Operations.drop_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">drop_table()</span></code></a> are Alembic directives.   Alembic provides
all the basic database migration operations via these directives, which are designed to be as simple and
minimalistic as possible;
there’s no reliance upon existing table metadata for most of these directives.  They draw upon
a global “context” that indicates how to get at a database connection (if any; migrations can
dump SQL/DDL directives to files as well) in order to invoke the command.   This global
context is set up, like everything else, in the <code class="docutils literal notranslate"><span class="pre">env.py</span></code> script.</p>
<p>An overview of all Alembic directives is at <a class="reference internal" href="ops.html#ops"><span class="std std-ref">Operation Reference</span></a>.</p>
</section>
<section id="running-our-first-migration">
<h2>Running our First Migration<a class="headerlink" href="#running-our-first-migration" title="Link to this heading">#</a></h2>
<p>We now want to run our migration.   Assuming our database is totally clean, it’s as
yet unversioned.   The <code class="docutils literal notranslate"><span class="pre">alembic</span> <span class="pre">upgrade</span></code> command will run upgrade operations, proceeding
from the current database revision, in this example <code class="docutils literal notranslate"><span class="pre">None</span></code>, to the given target revision.
We can specify <code class="docutils literal notranslate"><span class="pre">1975ea83b712</span></code> as the revision we’d like to upgrade to, but it’s easier
in most cases just to tell it “the most recent”, in this case <code class="docutils literal notranslate"><span class="pre">head</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic upgrade head
INFO  [alembic.context] Context class PostgresqlContext.
INFO  [alembic.context] Will assume transactional DDL.
INFO  [alembic.context] Running upgrade None -&gt; 1975ea83b712
</pre></div>
</div>
<p>Wow that rocked!   Note that the information we see on the screen is the result of the
logging configuration set up in <code class="docutils literal notranslate"><span class="pre">alembic.ini</span></code> - logging the <code class="docutils literal notranslate"><span class="pre">alembic</span></code> stream to the
console (standard error, specifically).</p>
<p>The process which occurred here included that Alembic first checked if the database had
a table called <code class="docutils literal notranslate"><span class="pre">alembic_version</span></code>, and if not, created it.   It looks in this table
for the current version, if any, and then calculates the path from this version to
the version requested, in this case <code class="docutils literal notranslate"><span class="pre">head</span></code>, which is known to be <code class="docutils literal notranslate"><span class="pre">1975ea83b712</span></code>.
It then invokes the <code class="docutils literal notranslate"><span class="pre">upgrade()</span></code> method in each file to get to the target revision.</p>
</section>
<section id="running-our-second-migration">
<h2>Running our Second Migration<a class="headerlink" href="#running-our-second-migration" title="Link to this heading">#</a></h2>
<p>Let’s do another one so we have some things to play with.    We again create a revision
file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic revision -m &quot;Add a column&quot;
Generating /path/to/yourapp/alembic/versions/ae1027a6acf_add_a_column.py...
done
</pre></div>
</div>
<p>Let’s edit this file and add a new column to the <code class="docutils literal notranslate"><span class="pre">account</span></code> table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Add a column</span>

<span class="sd">Revision ID: ae1027a6acf</span>
<span class="sd">Revises: 1975ea83b712</span>
<span class="sd">Create Date: 2011-11-08 12:37:36.714947</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># revision identifiers, used by Alembic.</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;ae1027a6acf&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="s1">&#39;1975ea83b712&#39;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>

<span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;last_transaction_date&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_column</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">,</span> <span class="s1">&#39;last_transaction_date&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Running again to <code class="docutils literal notranslate"><span class="pre">head</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic upgrade head
INFO  [alembic.context] Context class PostgresqlContext.
INFO  [alembic.context] Will assume transactional DDL.
INFO  [alembic.context] Running upgrade 1975ea83b712 -&gt; ae1027a6acf
</pre></div>
</div>
<p>We’ve now added the <code class="docutils literal notranslate"><span class="pre">last_transaction_date</span></code> column to the database.</p>
</section>
<section id="partial-revision-identifiers">
<h2>Partial Revision Identifiers<a class="headerlink" href="#partial-revision-identifiers" title="Link to this heading">#</a></h2>
<p>Any time we need to refer to a revision number explicitly, we have the option
to use a partial number.  As long as this number uniquely identifies the
version, it may be used in any command in any place that version numbers
are accepted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic upgrade ae1
</pre></div>
</div>
<p>Above, we use <code class="docutils literal notranslate"><span class="pre">ae1</span></code> to refer to revision <code class="docutils literal notranslate"><span class="pre">ae1027a6acf</span></code>.
Alembic will stop and let you know if more than one version starts with
that prefix.</p>
</section>
<section id="relative-migration-identifiers">
<span id="relative-migrations"></span><h2>Relative Migration Identifiers<a class="headerlink" href="#relative-migration-identifiers" title="Link to this heading">#</a></h2>
<p>Relative upgrades/downgrades are also supported.  To move two versions from
the current, a decimal value “+N” can be supplied:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic upgrade +2
</pre></div>
</div>
<p>Negative values are accepted for downgrades:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic downgrade -1
</pre></div>
</div>
<p>Relative identifiers may also be in terms of a specific revision.  For example,
to upgrade to revision <code class="docutils literal notranslate"><span class="pre">ae1027a6acf</span></code> plus two additional steps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic upgrade ae10+2
</pre></div>
</div>
</section>
<section id="getting-information">
<h2>Getting Information<a class="headerlink" href="#getting-information" title="Link to this heading">#</a></h2>
<p>With a few revisions present we can get some information about the state of things.</p>
<p>First we can view the current revision:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic current
INFO  [alembic.context] Context class PostgresqlContext.
INFO  [alembic.context] Will assume transactional DDL.
Current revision for postgresql://scott:XXXXX@localhost/test: 1975ea83b712 -&gt; ae1027a6acf (head), Add a column
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">head</span></code> is displayed only if the revision identifier for this database matches the head revision.</p>
<p>We can also view history with <code class="docutils literal notranslate"><span class="pre">alembic</span> <span class="pre">history</span></code>; the <code class="docutils literal notranslate"><span class="pre">--verbose</span></code> option
(accepted by several commands, including <code class="docutils literal notranslate"><span class="pre">history</span></code>, <code class="docutils literal notranslate"><span class="pre">current</span></code>, <code class="docutils literal notranslate"><span class="pre">heads</span></code>
and <code class="docutils literal notranslate"><span class="pre">branches</span></code>) will show us full information about each revision:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic history --verbose

Rev: ae1027a6acf (head)
Parent: 1975ea83b712
Path: /path/to/yourproject/alembic/versions/ae1027a6acf_add_a_column.py

    add a column

    Revision ID: ae1027a6acf
    Revises: 1975ea83b712
    Create Date: 2014-11-20 13:02:54.849677

Rev: 1975ea83b712
Parent: &lt;base&gt;
Path: /path/to/yourproject/alembic/versions/1975ea83b712_add_account_table.py

    create account table

    Revision ID: 1975ea83b712
    Revises:
    Create Date: 2014-11-20 13:02:46.257104
</pre></div>
</div>
<section id="viewing-history-ranges">
<h3>Viewing History Ranges<a class="headerlink" href="#viewing-history-ranges" title="Link to this heading">#</a></h3>
<p>Using the <code class="docutils literal notranslate"><span class="pre">-r</span></code> option to <code class="docutils literal notranslate"><span class="pre">alembic</span> <span class="pre">history</span></code>, we can also view various slices
of history.  The <code class="docutils literal notranslate"><span class="pre">-r</span></code> argument accepts an argument <code class="docutils literal notranslate"><span class="pre">[start]:[end]</span></code>, where
either may be a revision number, symbols like <code class="docutils literal notranslate"><span class="pre">head</span></code>, <code class="docutils literal notranslate"><span class="pre">heads</span></code> or
<code class="docutils literal notranslate"><span class="pre">base</span></code>,  <code class="docutils literal notranslate"><span class="pre">current</span></code> to specify the current revision(s), as well as negative
relative ranges for <code class="docutils literal notranslate"><span class="pre">[start]</span></code> and positive relative ranges for <code class="docutils literal notranslate"><span class="pre">[end]</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic history -r1975ea:ae1027
</pre></div>
</div>
<p>A relative range starting from three revs ago up to current migration,
which will invoke the migration environment against the database
to get the current migration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic history -r-3:current
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As illustrated above, to use ranges that start with a negative number (i.e.
a dash), due to a
<a class="reference external" href="https://github.com/python/cpython/issues/53580">bug in argparse</a> , either
the syntax <code class="docutils literal notranslate"><span class="pre">-r-&lt;base&gt;:&lt;head&gt;</span></code>, without any space, must be used as above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic history -r-3:current
</pre></div>
</div>
<p>or if using <code class="docutils literal notranslate"><span class="pre">--rev-range</span></code>, an equals sign must be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic history --rev-range=-3:current
</pre></div>
</div>
<p>Using quotes or escape symbols will not work if there’s a space after
the argument name.</p>
</div>
<p>View all revisions from 1975 to the head:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic history -r1975ea:
</pre></div>
</div>
</section>
</section>
<section id="downgrading">
<h2>Downgrading<a class="headerlink" href="#downgrading" title="Link to this heading">#</a></h2>
<p>We can illustrate a downgrade back to nothing, by calling <code class="docutils literal notranslate"><span class="pre">alembic</span> <span class="pre">downgrade</span></code> back
to the beginning, which in Alembic is called <code class="docutils literal notranslate"><span class="pre">base</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic downgrade base
INFO  [alembic.context] Context class PostgresqlContext.
INFO  [alembic.context] Will assume transactional DDL.
INFO  [alembic.context] Running downgrade ae1027a6acf -&gt; 1975ea83b712
INFO  [alembic.context] Running downgrade 1975ea83b712 -&gt; None
</pre></div>
</div>
<p>Back to nothing - and up again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ alembic upgrade head
INFO  [alembic.context] Context class PostgresqlContext.
INFO  [alembic.context] Will assume transactional DDL.
INFO  [alembic.context] Running upgrade None -&gt; 1975ea83b712
INFO  [alembic.context] Running upgrade 1975ea83b712 -&gt; ae1027a6acf
</pre></div>
</div>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">#</a></h2>
<p>The vast majority of Alembic environments make heavy use of the
“autogenerate” feature.   Continue onto the next section, <a class="reference internal" href="autogenerate.html"><span class="doc">Auto Generating Migrations</span></a>.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="front.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Front Matter</p>
      </div>
    </a>
    <a class="right-next"
       href="autogenerate.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Auto Generating Migrations</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-migration-environment">The Migration Environment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-an-environment">Creating an Environment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-the-ini-file">Editing the .ini File</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#escaping-characters-in-ini-files">Escaping Characters in ini files</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-pyproject-toml-for-configuration">Using pyproject.toml for configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-migration-script">Create a Migration Script</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-our-first-migration">Running our First Migration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-our-second-migration">Running our Second Migration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#partial-revision-identifiers">Partial Revision Identifiers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#relative-migration-identifiers">Relative Migration Identifiers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-information">Getting Information</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#viewing-history-ranges">Viewing History Ranges</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downgrading">Downgrading</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next Steps</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Author name not set
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2010-2025, Mike Bayer.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>