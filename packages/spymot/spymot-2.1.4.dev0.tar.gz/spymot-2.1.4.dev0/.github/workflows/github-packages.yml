name: Publish to GitHub Packages

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish-to-github-packages:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # For setuptools_scm version detection
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Build package
      run: |
        python -m build
    
    - name: Publish to GitHub Packages
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
      run: |
        twine upload --repository-url https://upload.pypi.org/legacy/ dist/*
    
    - name: Create package info comment
      if: github.event_name == 'release'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Read package info
          const setupCfg = fs.readFileSync('pyproject.toml', 'utf8');
          const version = context.ref.replace('refs/tags/', '');
          
          const comment = `
          ðŸŽ‰ **Package Published Successfully!**
          
          **Version:** ${version}
          **Registry:** GitHub Packages
          
          **Installation:**
          \`\`\`bash
          pip install --index-url https://pypi.org/simple/ spymot==${version}
          \`\`\`
          
          **GitHub Package:**
          \`\`\`bash
          pip install --extra-index-url https://pypi.org/simple/ spymot==${version}
          \`\`\`
          
          **Features in this release:**
          - âœ… V1 & V2 motif detection systems
          - âœ… AlphaFold2 structural validation  
          - âœ… Cancer biology focus
          - âœ… CLI and Python API
          - âœ… Comprehensive test suite
          `;
          
          if (context.eventName === 'release') {
            github.rest.issues.createComment({
              issue_number: context.payload.release.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }