<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simkl Watch History</title>
    <link rel="stylesheet" href="style.css">
    <!-- Use Phosphor Icons Duotone for a more premium feel -->
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/duotone/style.css" />
    <!-- Data script is auto-generated by the app -->
    <script src="data.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="fonts.css">
    <script src="script.js" defer></script>
</head>
<body>
    <header>
        <div class="header-content">
            <h1><i class="ph-duotone ph-popcorn logo-icon"></i> MPSS Watch History</h1>
            <div class="header-actions">
                <button class="control-btn theme-toggle" id="theme-toggle" title="Toggle Theme">
                    <i class="ph-duotone ph-moon"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="loading-indicator" class="loading-state">
            <div class="spinner"></div>
            <p>Loading your watch history...</p>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search titles...">
                <i class="ph-duotone ph-magnifying-glass"></i>
            </div>

            <div class="filter-controls">
                <select id="filter-type" title="Filter by Type">
                    <option value="all">All Types</option>
                    <option value="movie">Movies</option>
                    <option value="tv">TV Shows</option>
                    <option value="anime">Anime</option>
                </select>

                <select id="filter-year" title="Filter by Year">
                    <option value="all">All Years</option>
                    <!-- Years populated by JS -->
                </select>

                <select id="sort-by" title="Sort By">
                    <option value="watched_at">Recent First</option>
                    <option value="title">Title (A-Z)</option>
                    <option value="year">Release Year</option>
                    <option value="runtime">Runtime</option>
                    <option value="rating">Rating</option>
                </select>

                <button class="control-btn toggle-view" id="view-toggle" title="Toggle View">
                    <i class="ph-duotone ph-list"></i> <!-- Default: List view icon -->
                </button>

                <button class="control-btn toggle-stats" id="stats-toggle" title="Toggle Statistics">
                    <i class="ph-duotone ph-chart-pie-slice"></i>
                </button>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="stats-panel">
                <div class="stat-card total-watched">
                    <div class="stat-icon"><i class="ph-duotone ph-film-slate"></i></div>
                    <div class="stat-content">
                        <span class="stat-value" id="total-count">0</span>
                        <span class="stat-label">Total Watched</span>
                    </div>
                </div>
                <div class="stat-card movies-count">
                    <div class="stat-icon"><i class="ph-duotone ph-film-strip"></i></div>
                    <div class="stat-content">
                        <span class="stat-value" id="movies-count">0</span>
                        <span class="stat-label">Movies</span>
                    </div>
                </div>
                <div class="stat-card shows-count">
                    <div class="stat-icon"><i class="ph-duotone ph-television-simple"></i></div>
                    <div class="stat-content">
                        <span class="stat-value" id="shows-count">0</span>
                        <span class="stat-label">TV Shows</span>
                    </div>
                </div>
                <div class="stat-card anime-count">
                    <div class="stat-icon"><i class="ph-duotone ph-star"></i></div>
                    <div class="stat-content">
                        <span class="stat-value" id="anime-count">0</span>
                        <span class="stat-label">Anime</span>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <!-- Main trends chart -->
                <div class="chart-container chart-container-full">
                    <canvas id="watch-trend-chart"></canvas>
                </div>
                
                <!-- Distribution pie chart -->
                <!-- <div class="chart-container chart-container-half">
                    <canvas id="media-type-chart"></canvas>
                </div> -->
                
                <!-- Viewing times chart -->
                <div class="chart-container chart-container-half">
                    <canvas id="viewing-times-chart"></canvas>
                </div>
                
            </div>
        </div>

        <!-- History Grid -->
        <div class="history-grid" id="history-container">
            <!-- History items will be loaded here via JavaScript -->
        </div>

        <!-- Empty State -->
        <div class="empty-history" id="empty-history" style="display: none;">
            <div class="empty-state-icon">
                <i class="ph-duotone ph-projector-screen"></i>
            </div>
            <h2>No Watch History Found</h2>
            <p>Your watched movies and TV shows will appear here once tracked.</p>
            <p>Ensure Simkl MPS is running and monitoring your media player.</p>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination">
            <button id="prev-page" class="page-btn" disabled><i class="ph-duotone ph-caret-left"></i> Previous</button>
            <span id="page-info">Page 1 of 1</span>
            <button id="next-page" class="page-btn" disabled>Next <i class="ph-duotone ph-caret-right"></i></button>
        </div>
    </div>

    <footer>
        <p>MPS for Simkl Watch History | <a href="https://github.com/ByteTrix/Media-Player-Scrobbler-for-Simkl" target="_blank" rel="noopener noreferrer"><i class="ph-duotone ph-github-logo"></i> GitHub</a></p>
        <p class="version">v1.0.2</p> <!-- Updated version -->
    </footer>

    <!-- Modal Backdrop -->
    <div class="modal-backdrop" id="modal-backdrop"></div>

    <!-- Template for expanded card content -->
    <template id="expanded-content-template">
        <!-- Header with Poster Background and Title -->
        <div class="expanded-header">
            <div class="expanded-poster-bg"></div> <!-- Blurred background -->
            <div class="expanded-header-content">
                <div class="expanded-poster-thumb">
                    <img src="" alt="Poster Thumbnail" loading="lazy">
                </div>
                <div class="expanded-title-area">
                    <h2 class="expanded-title"></h2>
                    <div class="expanded-meta">
                        <span data-field="release_year"><i class="ph-duotone ph-calendar"></i> <span>-</span></span>
                        <span data-field="runtime"><i class="ph-duotone ph-clock"></i> <span>-</span></span>
                        <span data-field="last_watched_at"><i class="ph-duotone ph-calendar-check"></i> <span>-</span></span> <!-- Changed from user_rating -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Close Button -->
        <button class="close-button" title="Close"><i class="ph-duotone ph-x"></i></button>

        <!-- Scrollable Content Wrapper -->
        <div class="expanded-content-wrapper">
            <!-- Overview/Description -->
            <div class="detail-description">
                <div class="detail-label">Overview</div>
                <div class="detail-value" data-field="overview">-</div>
            </div>

            <!-- External Links -->
            <div class="external-links">
                <div class="detail-label">Links</div>
                <!-- Links will be populated here -->
            </div>

            <!-- Details Grid -->
            <div class="expanded-details-grid">
                <!-- Movie/Show Details -->

                <div class="detail-group">
                    <div class="detail-label">Language</div>
                    <div class="detail-value" data-field="language">-</div>
                </div>

                <!-- File Details -->
                <div class="detail-group">
                    <div class="detail-label">File Path</div>
                    <div class="detail-value file-path-detail" data-field="file_path" title="Click to copy">-</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">File Size</div>
                    <div class="detail-value" data-field="file_size">-</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Resolution</div>
                    <div class="detail-value" data-field="resolution">-</div>
                </div>
                 <div class="detail-group">
                    <div class="detail-label">File Format</div>
                    <div class="detail-value" data-field="file_format">-</div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Last Modified</div>
                    <div class="detail-value" data-field="last_modified">-</div>
                </div>
                <!-- Removed MIME Type -->
            </div>

            <!-- TV Show/Anime Episodes (conditionally displayed) -->
            <div class="tv-details-section" style="display:none;">
                <div class="detail-label">Episode Information</div>
                <div class="expanded-details-grid"> <!-- Re-use grid for consistency -->
                    <div class="detail-group">
                        <div class="detail-label">Latest Watched</div>
                        <div class="detail-value" data-field="latest_watched_episode">-</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Total Episodes</div>
                        <div class="detail-value" data-field="total_episodes">-</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Watched Count</div>
                        <div class="detail-value" data-field="episodes_watched_count">-</div>
                    </div>
                </div>

                <!-- Watched Episodes List -->
                <div class="detail-group episode-list-section">
                    <div class="detail-label">Watched Episodes</div>
                    <div class="episode-list-container" data-field="episode_list">
                        <!-- Episode items will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="expanded-actions">
                <button class="action-btn play-media" title="Play the media file">
                    <i class="ph-duotone ph-play-circle"></i> Play Media
                </button>
                <button class="action-btn secondary open-folder" title="Open the containing folder">
                    <i class="ph-duotone ph-folder-open"></i> Open Folder
                </button>
                <a class="action-btn secondary" href="https://www.google.com/search?q=watch+online+" target="_blank" id="search-online" title="Search online sources">
                    <i class="ph-duotone ph-globe"></i> Find Online
                </a>
            </div>
        </div> <!-- End Scrollable Content Wrapper -->
    </template>

</body>
</html>