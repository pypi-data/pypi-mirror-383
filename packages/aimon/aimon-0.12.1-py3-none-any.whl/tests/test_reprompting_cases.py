import os
import pytest
from string import Template
from aimon.reprompting_api.config import RepromptingConfig
from aimon.reprompting_api.runner import run_reprompting_pipeline

AIMON_API_KEY = os.environ.get("AIMON_API_KEY")

# --- Fixtures ---

@pytest.fixture
def my_llm():
    """Mock LLM function for integration tests. Prints prompts and responses."""
    def _my_llm(recommended_prompt_template: Template, system_prompt, context, user_query) -> str:
        filled_prompt = recommended_prompt_template.safe_substitute(
            system_prompt=system_prompt or "",
            context=context or "",
            user_query=user_query or ""
        )
        return filled_prompt
    return _my_llm

@pytest.fixture
def base_config():
    return RepromptingConfig(
        aimon_api_key=AIMON_API_KEY,
        publish=False,
        return_telemetry=True,
        return_aimon_summary=True,
        application_name="api_test",
        max_iterations=2,
    )

@pytest.fixture
def config_without_telemetry():
    return RepromptingConfig(
        aimon_api_key=AIMON_API_KEY,
        publish=False,
        return_telemetry=False,
        return_aimon_summary=False,
        application_name="api_test",
        max_iterations=2,
    )

@pytest.fixture
def config_low_latency():
    return RepromptingConfig(
        aimon_api_key=AIMON_API_KEY,
        publish=False,
        return_telemetry=True,
        return_aimon_summary=True,
        application_name="api_test",
        max_iterations=2,
        latency_limit_ms=100
    )

@pytest.fixture
def config_high_latency():
    return RepromptingConfig(
        aimon_api_key=AIMON_API_KEY,
        publish=False,
        return_telemetry=True,
        return_aimon_summary=True,
        application_name="api_test",
        max_iterations=3,
        latency_limit_ms=5000
    )

@pytest.fixture
def config_iteration_limit():
    return RepromptingConfig(
        aimon_api_key=AIMON_API_KEY,
        publish=False,
        return_telemetry=True,
        return_aimon_summary=True,
        application_name="api_test",
        max_iterations=1,
    )

# --- Helper to print results nicely ---
def print_result(test_name, result):
    print(f"\n===== RESULTS FOR: {test_name} =====", flush=True)
    print("\n==== BEST RESPONSE ====", flush=True)
    print(result.get("best_response"), flush=True)
    print("\n==== TELEMETRY ====", flush=True)
    print(result.get("telemetry"), flush=True)
    print("\n==== SUMMARY ====", flush=True)
    print(result.get("summary"), flush=True)
    print("===== END OF RESULT =====\n", flush=True)

# --- Tests ---

def test_low_latency_limit(my_llm, config_low_latency):
    """Test stopping behavior when latency limit is very low (100ms)."""
    result = run_reprompting_pipeline(
        user_query="We just received a Cal/OSHA citation for emergency workplace safety violations with a 15-day correction deadline. What are our options to appeal or resolve this without facing business closure?",
        context="(Form DOSH-TRN-2025) [SECTION] Section 4: Consequences of Non-Compliance [SECTION] Failing to act may result in: [SECTION] - Daily penalties of $500 per violation after deadline [SECTION] - Business closure orders for willful violations [SECTION] - 300% penalty enhancements for repeat offenses [SECTION] Section 5: Recommended Resolution Path [SECTION] For fastest resolution: [SECTION] 1. Correct all hazards within 10 days [SECTION] 2. Submit Form DOSH-RESP-2025 with evidence [SECTION] 3. Request compliance verification inspection [SECTION] Remember: Appeal filings don’t suspend correction deadlines—address hazards immediately while preserving your appeal rights.[SECTION] California Business Emergency Preparedness Compliance Guide – 2025 Edition [SECTION] Document Ref: CA-BEP-2025-09 / Effective July 1, 2025 [SECTION] Section 1: Mandatory Earthquake Preparedness Protocol [SECTION] All California businesses with 10+ employees must maintain an approved earthquake readiness plan under CA Labor Code §6401.7. Don't worry—we'll walk you through each requirement step by step. [SECTION] 1. Plan Submission: [SECTION] - Complete Form BEP-22 (Earthquake Preparedness Certification) [SECTION] - Submit via CalOES Business Portal or mail to: [SECTION] Office of Emergency Services [SECTION] Business Compliance Division [SECTION] P.O. Box 419047 [SECTION] Sacramento, CA 95841 [SECTION] - Deadline: Within 30 days of plan creation or update [SECTION] 2. Employee Training: [SECTION] - Conduct quarterly drills using state-approved materials (Reference Guide BEP-TM-2025) [SECTION] - Maintain signed attendance records (Form BEP-23) for 3 years [SECTION] - New hires must complete training within 14 days of employment [SECTION] 3. Emergency Supplies: [SECTION] - Minimum 3-day water supply (1 gallon per person per day) [SECTION] - First aid kits meeting ANSI/ISEA Z308.1-2025 standards [SECTION] - Emergency lighting for all exits (tested monthly) [SECTION] - Battery-powered NOAA weather radio [SECTION] Section 2: Compliance Verification Process [SECTION] To schedule verification: [SECTION] 1. Create account on CalOES Business Portal (portal.caloes.ca.gov) [SECTION] 2. Submit Inspection Request Form BEP-30 [SECTION] 3. Pay verification fee: [SECTION] - $150 standard fee [SECTION] - $75 for businesses with 10-24 employees [SECTION] - Waived for non-profits with Form BEP-31 [SECTION] 4. Prepare for inspection: [SECTION] - Printed copy of Form BEP-22 submission receipt [SECTION] - Training records (Forms BEP-23 and BEP-23A) [SECTION] - Current supply inventory log (Form BEP-24) [SECTION] Section 3: Non-Compliance Penalties [SECTION] - First violation: $500 fine + mandatory corrective action plan (Form BEP-40) [SECTION] - Subsequent violations: $1,000 per occurrence [SECTION] - Willful neglect: Up to $5,000 + business license suspension [SECTION] - False certification: Misdemeanor charge under CA Business Code §17200  [SECTION] Section 6: Penalties for Non-Compliance [SECTION] Failure to properly report may result in: [SECTION] - Fines up to $25,000 per violation under Labor Code §6429. [SECTION] - Business license suspension for repeat offenses. [SECTION] - Potential criminal charges for willful violations causing harm. [SECTION] Section 7: Additional Resources [SECTION] - Cal/OSHA Spill Response Guidelines: dir.ca.gov/dosh/chemical-spills.html [SECTION] - 24/7 Emergency Consultation: 1-800-963-9424 [SECTION] - Small Business Compliance Assistance: 1-800-400-7115[SECTION] California Business Energy Efficiency Installation Guide – 2025 Edition [SECTION] ## Section 1: Understanding Your CBESP Installation Requirements [SECTION] You're asking about installing energy efficiency equipment under the CBESP program—let's walk through this step by step. The process is straightforward when you follow these guidelines. We recommend starting with a certified site assessment to maximize your benefits. [SECTION] ## Section 2: Pre-Installation Checklist [SECTION] Before installation begins: [SECTION] 1. Verify Equipment Eligibility: Check the CBESP-approved equipment list (available at cbesp.ca.gov/equipment) for your business category. For example, commercial kitchens must use NSF-certified refrigeration units. [SECTION] 2. Schedule Site Assessment: Contact a CBESP-certified assessor within 5 business days—this helps identify the best equipment placement and potential rebates. [SECTION] 3. Submit Installation Plan: Complete Form CBESP-IP-2025 with details like equipment specifications and safety protocols. [SECTION] ## Section 3: Installation Protocol [SECTION] Follow these key steps: [SECTION] 1. Power Isolation: Shut off circuits following standard safety procedures (typically 1-2 hours for most facilities). [SECTION] 2. Equipment Mounting: Use manufacturer-specified brackets with proper bracing in seismic zones. [SECTION] 3. Wiring Compliance: Follow all electrical safety requirements—consult an electrician if unsure. [SECTION] ## Section 4: Post-Installation Process [SECTION] 1. Functional Testing: Run diagnostic cycles for 24-48 hours to confirm everything works properly. [SECTION] 2. Documentation: Submit Form ICF-2025 within 3 business days of completion. [SECTION] 3. Inspector Scheduling: Request CBESP verification within 14 calendar days to avoid reinspection fees. [SECTION] ## Section 5: Important Deadlines [SECTION] - Assessment scheduling: Within 5 business days of equipment purchase [SECTION] - Form submission: 3 business days post-installation [SECTION] - Verification request: Within 14 calendar days of completion [SECTION] ## Section 6: Non-Compliance Consequences [SECTION] Not following procedures may result in:SECTION] 3. Referral to the California Franchise Tax Board for collection [SECTION] Section 5: Urgent Support Resources [SECTION] For time-sensitive applications: [SECTION] 1. Call the Disaster Relief Hotline: 1-800-CA-BIZ-AID (option 2 for expedited processing) [SECTION] 2. Email emergency@ca-bfa.gov with subject line URGENT: [Your Business Name] [SECTION] 3. Visit designated disaster recovery centers (list at ca-bfa.gov/locations) [SECTION] Note: Applications submitted after the 14-day window will be processed under standard timelines (4–6 weeks).[SECTION] California Business Licensing Compliance Guide – 2025 Edition [SECTION] Document Ref: CA-BLC-2025-12 / Effective July 1, 2025 [SECTION] Section 1: Renewal Notice Verification [SECTION] 1. Submit Form BLC-ADDR-2025 through our online portal or by mail to verify your address on file. Processing takes 3 business days. [SECTION] 2. If your address is correct but the notice hasn't arrived, request a duplicate notice by calling 1-800-CA-BIZLIC or visiting any Regional Business License Center. [SECTION] 3. For urgent renewals, submit Form BLC-RENEW-2025 with a written explanation of the missing notice. [SECTION] Section 2: Required Renewal Documentation [SECTION] To complete your renewal, you must provide: [SECTION] 1. Form BLC-RENEW-2025 with Sections A, C, and E completed [SECTION] 2. Your current business license number from prior correspondence [SECTION] 3. Proof of local zoning compliance (Form ZON-2025 or equivalent) [SECTION] Section 3: Late Renewal Procedures [SECTION] Renewals submitted within 30 days of expiration require: [SECTION] 1. Payment of $50 late fee via Form BLC-LATE-2025 [SECTION] 2. Submission of all standard renewal documents [SECTION] 3. Written justification for delay [SECTION] After 30 days, you must submit Form BLC-NEW-2025 for full reapplication. [SECTION] Section 4: Operating Without Renewal [SECTION] Continuing business operations with an expired license may result in: [SECTION] 1. Fines of $500 per violation [SECTION] 2. Mandatory compliance review (Form BLC-COMP-2025) [SECTION] 3. Potential license suspension for repeated violations",
        llm_fn=my_llm,
        reprompting_config=config_low_latency,
        user_instructions=["Use sentence structures that sound natural in spoken English, avoiding overly formal or stilted constructions.","Do not suggest actions that bypass or undermine official company processes (e.g., “You could just submit a new request under a different name”); mentioning formal appeal or exception procedures is acceptable if supported by context."]
    )
    print_result("Low Latency Limit Test (100ms)", result)
    assert "best_response" in result

def test_latency_limit(my_llm, config_high_latency):
    """Test behavior with a high latency limit and contradictory instructions."""
    result = run_reprompting_pipeline(
        user_query="I manage data compliance for a healthcare startup using CloudSync's Enterprise tier. We need to ensure all patient-related files are automatically deleted after 7 years to meet HIPAA requirements, while maintaining the ability to recover accidentally deleted files for at least 30 days. Can CloudSync support this workflow, and what configuration changes would we need to make?",
        context="[SECTION] # Data Retention and Privacy Policy for CloudSync Services [SECTION] ## Overview [SECTION] This document outlines the data retention, storage, and privacy practices for CloudSync, a cloud-based file synchronization service. It applies to all users of the Free, Pro, and Enterprise tiers unless superseded by a signed Enterprise Agreement. [SECTION] ## Data Retention Periods [SECTION] - **Active Accounts:** User data is retained indefinitely unless manually deleted by the user or via automated compliance workflows (e.g., legal hold expiration). [SECTION] - **Inactive Accounts:** Accounts with no login activity for 24 months are flagged for review. After 30 days in review status, data is permanently deleted unless an extension is requested via Form CS-102. [SECTION] - **Deleted Files:** Files removed from the trash bin are retained in a recoverable state for 30 days. After this period, they are irreversibly purged from all systems. [SECTION] ## Privacy Controls [SECTION] Users can configure: [SECTION] - Automatic deletion of files older than a specified age (1, 3, or 5 years) [SECTION] - Geographic restrictions for data storage (US, EU, or APAC regions) [SECTION] - Access logs retention (default 90 days, extendable to 365 days for Enterprise) [SECTION] ## Legal and Compliance [SECTION] - Data may be retained beyond standard periods if subject to litigation hold, subpoena, or regulatory investigation. Users will be notified unless prohibited by law. [SECTION] - Third-party audits are conducted annually for SOC 2 Type II compliance. Reports available upon request for Enterprise customers. [SECTION] - Data sovereignty requirements are enforced at the storage layer; metadata may transit through global networks for synchronization purposes. [SECTION] ## Data Recovery [SECTION] - Enterprise accounts can request point-in-time recovery for entire accounts (14-day window) or individual files (30-day window). [SECTION] - Recovery operations incur a $150 base fee plus $0.03/GB for data restored. [SECTION] ## Policy Changes [SECTION] - Notice of material changes will be provided 60 days in advance via email and in-app notifications. [SECTION] - Continued use of the service after changes take effect constitutes acceptance of the new terms.",
        llm_fn=my_llm,
        reprompting_config=config_high_latency,
        user_instructions=["Do not use the letter e", "Only use the letter e"]
    )
    print_result("High Latency Limit Test (5000ms)", result)
    assert "best_response" in result

def test_iteration_limit(my_llm, config_iteration_limit):
    """Test behavior when max_iterations is 1."""
    result = run_reprompting_pipeline(
        user_query="Our systems are showing vulnerability alerts but we can't find the patch file in the vendor portal. What should we do?",
        system_prompt="Keep the tone professionally neutral by avoiding emotionally charged words, exclamations, or informal phrases (e.g., awesome, ugh, or emojis)",
        context="[SECTION] # Emergency Software Patch Installation Guide [SECTION] ## Critical Security Patch Notification – CVE-2025-1234 [SECTION] This notice applies to all systems running versions prior to 3.2.1. Immediate action is required under Cybersecurity Policy CP-2025-07 to address authentication vulnerabilities. [SECTION] ## Patch Acquisition Procedures [SECTION] 1. Verify your system meets the requirements using Form LIC-VER-15 [SECTION] 2. Access the Emergency Patch Portal at epp.vendor.com/alert/CVE-2025-1234 [SECTION] 3. If the patch isn't available, submit Form PATCH-REQ-22 for manual distribution [SECTION] ## Installation Process [SECTION] We understand urgent updates can be stressful—here's how to proceed safely: [SECTION] 1. First, create a complete system backup [SECTION] 2. Run the patch installer with administrator privileges [SECTION] 3. Check the system logs to confirm successful installation [SECTION] ## Post-Installation Steps [SECTION] - Submit Form EP-ACK-22 within 24 hours [SECTION] - Retain installation records for 90 days [SECTION] - Schedule a security scan within 7 days [SECTION] ## Support Options [SECTION] - 24/7 Technical Support: 1-800-PATCH-HELP [SECTION] - Priority assistance: Submit Form IRF-89 with CRITICAL flag",
        llm_fn=my_llm,
        reprompting_config=config_iteration_limit,
        user_instructions=["do not use the letter e","only use the letter e"]
    )
    print_result("Iteration Limit Test (no re-prompting, only 1 iteration allowed)", result)
    assert "best_response" in result

def test_empty_context_and_instructions(my_llm, base_config):
    """Ensure pipeline works with no context, instructions, or system prompt."""
    result = run_reprompting_pipeline(
        user_query="Testing with empty context, instructions, and system prompt",
        context="",
        llm_fn=my_llm,
        reprompting_config=base_config,
        user_instructions=[]
    )
    print_result("Empty Context & Instructions Test", result)
    assert "best_response" in result

def test_no_telemetry(my_llm, config_without_telemetry):
    """Confirm telemetry and summary are excluded when disabled in config."""
    result = run_reprompting_pipeline(
        user_query="I keep getting 401 errors when trying to connect to your API. What should I check first?",
        context="[SECTION] API Integration Troubleshooting Guide – Version 2.1 [SECTION] Document Ref: API-TS-2025-07 / Issued March 2025 [SECTION] Step 1: Verify Authentication Details [SECTION] To resolve 401 errors, first check these key items: [SECTION] - Ensure your API key has exactly 32 characters [SECTION] - Confirm the key is active in your Developer Portal account [SECTION] - Check that your IP address is whitelisted if required [SECTION] Step 2: Gather Required Information [SECTION] For support cases, prepare: [SECTION] - Screenshot of the error message [SECTION] - Recent API call logs [SECTION] - Your account ID and integration details [SECTION] Step 3: Submit Support Request [SECTION] You can submit your request through: [SECTION] - The Developer Portal ticket system (fastest response) [SECTION] - Email to api-support@company.com with 401 Error in subject [SECTION] Typical response time is 2 business days. [SECTION] Step 4: After Resolution [SECTION] Once fixed: [SECTION] - Update your integration settings [SECTION] - Keep records of the troubleshooting process [SECTION] For immediate help: [SECTION] Call 1-800-API-HELP (24/7 for Priority customers) [SECTION] Email: api-support@company.com[SECTION] API Rate Limit and Throttling Policy – 2025 Update [SECTION] Document Ref: API-POL-2025-07 / Effective March 2025 [SECTION] Section 1: Standard Rate Limits [SECTION] The following rate limits apply to all API endpoints unless otherwise specified in your service tier agreement: [SECTION] - Free Tier: 100 requests per minute, 1,000 requests per day [SECTION] - Business Tier: 500 requests per minute, 10,000 requests per day [SECTION] - Enterprise Tier: Custom limits negotiated per contract [SECTION] Section 2: Throttling Behavior [SECTION] When limits are exceeded: [SECTION] 1. First violation: API returns HTTP 429 (Too Many Requests) with Retry-After header [SECTION] 2. Subsequent violations within 24 hours: Temporary suspension for 1 hour [SECTION] 3. Chronic violations (3+ in 7 days): Account review and potential permanent rate reduction [SECTION] Section 3: Best Practices for Avoiding Throttling [SECTION] To maintain optimal API performance: [SECTION] 1. Implement exponential backoff when receiving 429 responses [SECTION] 2. Cache responses where possible (ETag headers supported on all GET endpoints) [SECTION] 3. Use batch endpoints instead of individual calls for bulk operations [SECTION] 4. Monitor usage via the X-RateLimit-Remaining header [SECTION] Section 4: Consequences of Policy Violations [SECTION] Repeated throttling may result in: [SECTION] 1. Temporary API key revocation [SECTION] 2. Mandatory migration to higher service tier [SECTION] 3. Suspension of account privileges pending review [SECTION] Section 5: Monitoring and Alerts [SECTION] Configure usage alerts through: [SECTION] 1. Dashboard notifications (available in Account Settings) [SECTION] 2. Webhook integrations (documented in API Guide Section 12.4) [SECTION] 3. Email warnings at 75% and 90% of daily limits[SECTION] API Rate Limit and Throttling Policy – Version 2.1 [SECTION] Effective Date: March 2025 [SECTION] This document outlines the rate limits, throttling policies, and escalation procedures for the Enterprise API tier. All API calls are subject to these limits unless otherwise specified in a signed Service Level Agreement (SLA). [SECTION] ## Rate Limit Tiers [SECTION] - **Standard Tier:** 1,000 requests per minute (RPM) across all endpoints [SECTION] - **High-Capacity Tier:** 5,000 RPM, available for an additional $200/month fee [SECTION] - **Burst Capacity:** Temporary spikes up to 2x your tier limit for 5-minute intervals, max twice per hour [SECTION] ## Throttling Behavior [SECTION] When limits are exceeded: [SECTION] - First violation: API returns HTTP 429 with Retry-After header (typically 30 seconds) [SECTION] - Repeated violations within 1 hour: 15-minute cool-down period enforced [SECTION] - Chronic violations (3+ incidents/day): Account review and potential downgrade to Standard Tier [SECTION] ## Urgent Limit Increase Process [SECTION] Follow these steps to resolve your rate limit issue: [SECTION] 1. **Submit Request:** Log into the API Dashboard and navigate to Manage Quotas [SECTION] 2. **Select Priority:** Choose Urgent and provide: [SECTION]    - Business justification for the increase [SECTION]    - Expected call volume during peak hours [SECTION]    - Required duration (maximum 72 hours) [SECTION] 3. **Payment:** Submit the $75 expedited processing fee [SECTION] 4. **Activation:** Approved increases take effect within 2 hours of submissionSECTION] ## Consequences of Not Following Process [SECTION] - Unapproved workarounds may trigger account suspension [SECTION] - Repeated urgent requests may require SLA upgrade [SECTION] - All limit changes are logged and audited [SECTION] ## Recommended Action [SECTION] For immediate relief while waiting for approval: [SECTION] - Implement client-side retry logic with exponential backoff [SECTION] - Distribute calls across multiple API keys if available [SECTION] - Schedule non-critical requests during off-peak hours [SECTION] ## Support Resources [SECTION] - Emergency Support: api-support@example.com (Subject: URGENT - Rate Limit) [SECTION] - Real-time Monitoring: api.example.com/status [SECTION] - Documentation: docs.example.com/api/rate-limits [SECTION] ## Note on Eligibility [SECTION] Temporary increases are granted based on system capacity and historical usage patterns. Approval is not guaranteed for accounts with frequent violation history.[SECTION] API Rate Limit and Throttling Policy – 2025 Update [SECTION] Document Ref: API-POL-2025-07 / Effective March 2025 [SECTION] Section 1: Standard Rate Limits [SECTION] The following rate limits apply to all API endpoints unless otherwise specified in your service tier agreement: [SECTION] - Free Tier: 100 requests per minute, 1,000 requests per day [SECTION] - Business Tier: 500 requests per minute, 10,000 requests per day [SECTION] - Enterprise Tier: Custom limits negotiated per contract [SECTION] Section 2: Throttling Behavior [SECTION] When limits are exceeded: [SECTION] 1. First violation: API returns HTTP 429 (Too Many Requests) with Retry-After header [SECTION] 2. Subsequent violations within 24 hours: Temporary suspension for 1 hour [SECTION] 3. Chronic violations (3+ in 7 days): Account review and potential permanent rate reduction [SECTION] Section 3: Best Practices for Avoiding Throttling [SECTION] To maintain optimal API performance: [SECTION] 1. Implement exponential backoff when receiving 429 responses [SECTION] 2. Cache responses where possible (ETag headers supported on all GET endpoints) [SECTION] 3. Use batch endpoints instead of individual calls for bulk operations [SECTION] 4. Monitor usage via the X-RateLimit-Remaining header [SECTION] Section 4: Consequences of Policy Violations [SECTION] Repeated throttling may result in: [SECTION] 1. Temporary API key revocation [SECTION] 2. Mandatory migration to higher service tier [SECTION] 3. Suspension of account privileges pending review [SECTION] Section 5: Monitoring and Alerts [SECTION] Configure usage alerts through: [SECTION] 1. Dashboard notifications (available in Account Settings) [SECTION] 2. Webhook integrations (documented in API Guide Section 12.4) [SECTION] 3. Email warnings at 75% and 90% of daily limits[SECTION] API Rate Limit Enforcement Policy – California Department of Technology (2025 Revision) [SECTION] Document Ref: CDT-API-2025-09 / Effective March 1, 2025 [SECTION] Section 1: Rate Limit Thresholds [SECTION] All API endpoints enforce the following limits per client IP: [SECTION] - Standard Tier: 100 requests per minute [SECTION] - Elevated Tier: 500 requests per minute (requires Form API-T2 submitted 5 business days in advance) [SECTION] - Emergency Tier: 1,000 requests per minute (requires Form API-EMG with justification; valid for 72 hours) [SECTION] Section 2: Violation Consequences [SECTION] Exceeding rate limits triggers these automated responses: [SECTION] 1. First violation: HTTP 429 response with Retry-After header (60 seconds) [SECTION] 2. Second violation within 24 hours: 15-minute suspension [SECTION] 3. Third violation within 7 days: Account review and potential permanent blacklisting [SECTION] Section 3: Immediate Resolution Steps [SECTION] If your API access is suspended: [SECTION] 1. Check your request logs for spikes using CDT API Monitor (Form API-MON required for access) [SECTION] 2. Implement exponential backoff with jitter in your client code [SECTION] 3. Submit Form API-RES with: [SECTION] a. Incident timeline [SECTION] b. Corrective action plan [SECTION] c. Client IP ranges needing whitelisting [SECTION] Section 4: Permanent Blacklist Appeals [SECTION] To contest a blacklisting decision: [SECTION] 1. File Form API-APL within 10 business days [SECTION] 2. Provide technical documentation proving compliance with: [SECTION] a. California Code §11546.45 (API Fair Use) [SECTION] b. CDT Technical Bulletin 2025-7 (Throttling Best Practices) [SECTION] 3. Await review by the API Governance Board (5-10 business days) [SECTION] Note: Emergency service applications may qualify for expedited review if submitting Form API-EMG with wildfire response documentation.[SECTION] API Rate Limit Policy – Enterprise Developer Portal [SECTION] Document Ref: API-POL-2025-03 / Effective June 2025 [SECTION] Section 1: Understanding Your Rate Limit Issue [SECTION] Your application hitting rate limits during peak hours is a common challenge. Let's walk through the steps to resolve this while maintaining API access. [SECTION] Section 2: Immediate Actions [SECTION] 1. Review your API-LOG-78 reports to identify: [SECTION] * Which endpoints are exceeding limits [SECTION] * Time patterns of high traffic [SECTION] 2. Implement request throttling per Technical Bulletin API-TB-104 [SECTION] 3. For temporary relief, submit Form API-RL-22 for a 72-hour limit increase [SECTION] Section 3: Long-Term Solutions [SECTION] To permanently increase your rate limits: [SECTION] 1. Submit Form API-HC-45 with: [SECTION] * Business justification for higher limits [SECTION] * 30 days of API-LOG-78 reports [SECTION] 2. Our team will review within 5 business days [SECTION] Section 4: Best Practices [SECTION] * Spread high-volume requests evenly throughout the day [SECTION] * Cache responses where possible [SECTION] * Consider upgrading to Enterprise Tier (5,000 RPM) [SECTION] Section 5: What to Avoid [SECTION] Repeated violations may lead to: [SECTION] * Temporary API key suspension [SECTION] * Mandatory compliance review (Form API-COMP-19) [SECTION] * Service tier downgrade [SECTION] Section 6: Recommended Next Steps [SECTION] We recommend starting with Form API-RL-22 for immediate relief while preparing your materials for a permanent tier upgrade. Our support team is available to review your API-LOG-78 reports if needed.[SECTION] API Service Level Agreement – Version 2.1 [SECTION] Effective Date: March 15, 2025 [SECTION] Section 1: Service Availability Standards [SECTION] The API maintains 99.9% monthly uptime excluding scheduled maintenance. Downtime incidents exceeding 30 consecutive minutes qualify for service credit compensation under Section 7. [SECTION] Section 2: Incident Reporting Protocol [SECTION] To report 503 errors: [SECTION] 1. Document the incident with: [SECTION]   - Exact timestamps (UTC) [SECTION]   - Affected endpoint URLs [SECTION]   - HTTP response headers [SECTION] 2. Complete Form API-INC-2025 (available in Developer Portal > Support) [SECTION]   - Attach redacted error logs [SECTION]   - Include business impact assessment [SECTION] 3. Submit within 60 minutes of first occurrence for priority handling [SECTION] Section 3: Investigation Timeline [SECTION] Upon submission: [SECTION] 1. Initial response within 15 minutes (email confirmation with Case ID) [SECTION] 2. Severity assessment using Priority Matrix API-PM-2025 within 30 minutes [SECTION] 3. Hourly status updates posted to Case ID portal [SECTION] Section 4: Resolution Procedures [SECTION] For confirmed outages: [SECTION] 1. Emergency patch deployment within 4 hours for Severity 1 incidents [SECTION] 2. Full root cause analysis report within 3 business days [SECTION] 3. Post-mortem review available upon request (Form API-PM-2025) [SECTION] Section 5: Compensation Policy [SECTION] Service credits apply as follows: [SECTION] - 5% of monthly fee for 30-59 minutes downtime [SECTION] - 10% for 1-2 hours [SECTION] - 15% for 2-4 hours [SECTION] Note: Credits require submission of Form API-CR-2025 within 7 calendar days. [SECTION] Section 6: Penalties for False Reports [SECTION] Misrepresented incidents may result in: [SECTION] - Suspension of incident reporting privileges for 30 days [SECTION] - Forfeiture of accrued service credits [SECTION] - Administrative fee of $250 per invalid claim [SECTION] Section 7: Emergency Contacts [SECTION] For unresolved Severity 1 incidents after 2 hours: [SECTION] 1. Primary: api-emergency@company.com (monitored 24/7) [SECTION] 2. Secondary: +1-800-555-API1 (follow voice prompts for engineer dispatch) [SECTION] 3. Escalation: File Form API-ESC-2025 with VP of Engineering CC [SECTION] Section 8: Preventive Measures [SECTION] Recommended best practices: [SECTION] - Implement exponential backoff with jitter [SECTION] - Monitor status.company.com for real-time updates [SECTION] - Maintain fallback endpoints per API-FB-2025 guidelines[SECTION] API Usage and Rate Limit Policy – Version 2025.1 [SECTION] We understand hitting rate limits can disrupt your workflow—let's review your options to resolve this. [SECTION] SECTION 1: CURRENT LIMITS AND UPGRADE PATHS [SECTION] Your Free Tier currently allows: [SECTION] - 100 requests per minute [SECTION] - 5,000 requests per day [SECTION] To increase these limits, consider: [SECTION] Option 1: Basic Tier ($49/month) [SECTION] - 500 requests per minute [SECTION] - 25,000 requests per day [SECTION] - Immediate activation via Developer Portal > Billing [SECTION] Option 2: Enterprise Tier [SECTION] - Custom limits tailored to your needs [SECTION] - Requires signed agreement (Form API-ENT-2025) [SECTION] - Contact sales@company.com for consultation [SECTION] SECTION 2: TEMPORARY LIMIT INCREASE [SECTION] If you need short-term relief: [SECTION] 1. Submit Form API-LIMIT-REQ through Developer Portal [SECTION] 2. Provide: [SECTION] - Technical justification (e.g., expected traffic spikes) [SECTION] - Duration needed (max 30 days) [SECTION] 3. Typical approval time: 2 business days [SECTION] SECTION 3: AVOIDING FUTURE ISSUES [SECTION] Best practices we recommend: [SECTION] - Implement exponential backoff (sample code in Dev Docs Section 4.3) [SECTION] - Cache responses using ETag headers [SECTION] - Monitor usage via Dashboard > API Analytics [SECTION] SECTION 4: IMPORTANT NOTES [SECTION] - Repeated violations (5+/month) may trigger account review [SECTION] - Emergency after-hours support: Submit Priority Ticket with 'Rate Limit' tag [SECTION] - Full policy details available in Document API-POL-2025.1 [SECTION] SECTION 5: IMMEDIATE HELP [SECTION] For urgent assistance: [SECTION] - Live chat: Developer Portal > Support [SECTION] - Phone: 1-800-555-API1 (Mon-Fri 9AM-5PM ET) [SECTION] Remember: Our team is here to help you scale efficiently while maintaining system stability for all users",
        llm_fn=my_llm,
        reprompting_config=config_without_telemetry,
        user_instructions=["Keep the tone professionally neutral by avoiding emotionally charged words, exclamations, or informal phrases (e.g., awesome, ugh, or emojis)","Provide a detailed, ordered explanation of a process with at least three sequential steps.","Avoid expressions of uncertainty about company policies and eliminate vague or speculative phrases (e.g., “I think we cover that”)."]
    )
    print_result("No Telemetry Test", result)
    assert "telemetry" not in result
    assert "summary" not in result

def test_no_system_prompt(my_llm, base_config):
    """Test behavior when system prompt is excluded."""
    result = run_reprompting_pipeline(
        user_query="What penalties can credit bureaus face if they don’t fix errors on my report, and how do I make sure they take my dispute seriously?",
        context="[SECTION] California Credit Reporting & Dispute Resolution Policy – 2025 Update [SECTION] Document Ref: CA-CRDP-2025-09 / Effective January 1, 2025 [SECTION] Section 1: Credit Bureau Responsibilities [SECTION] Credit reporting agencies must correct errors on your report within 30 days. If they fail to do so, they may face penalties under state and federal law, including fines and required corrections. [SECTION] Section 2: How to File a Dispute [SECTION] Follow these steps to ensure your dispute is processed correctly: [SECTION] 1. Get your credit reports from all three bureaus using AnnualCreditReport.com or Form CR-REQUEST-2025 [SECTION] 2. Complete Form CA-DISPUTE-9, available on the DFPI website, including: [SECTION] • Your personal information in Section 3A [SECTION] • Details about each error in Section 4B [SECTION] • Supporting documents like bank statements [SECTION] 3. Submit your dispute online through the secure portal or by certified mail [SECTION] Section 3: What Happens Next [SECTION] After you file: [SECTION] 1. You'll receive a confirmation letter within 5 business days [SECTION] 2. The bureau will investigate and send results within 30 days [SECTION] 3. They must either correct the error, verify it's accurate, or remove the item [SECTION] Section 4: If the Error Isn't Fixed [SECTION] If the bureau doesn't correct a verified error: [SECTION] 1. File a complaint with the DFPI within 60 days using Form DFPI-CR-7 [SECTION] 2. Contact the Federal Trade Commission for assistance [SECTION] 3. You may have the right to take legal action [SECTION] Section 5: Getting Help Quickly [SECTION] For urgent situations like mortgage applications: [SECTION] • Call the DFPI Dispute Hotline at 1-800-555-REPORT (option 2) [SECTION] • Submit Form CR-EXPEDITE with proof of urgency [SECTION] • Visit a DFPI office by appointment [SECTION] Note: There may be a $25 fee if you dispute the same item more than twice. Medical debt disputes require extra documentation.[SECTION] California Credit Reporting Compliance Policy – FCRA Section 605 Enforcement [SECTION] Document Ref: CRCP-2025-09 / Effective Immediately [SECTION] Section 1: FCRA Violation Penalties Under California Law [SECTION] The Fair Credit Reporting Act (FCRA) violations in California are subject to the following penalties: [SECTION] - **Incorrect Reporting (FCRA §605(a)):** $2,500 per violation, with additional civil penalties up to $10,000 for willful non-compliance. [SECTION] - **Failure to Investigate Disputes (FCRA §611):** Mandatory $1,000 penalty per unresolved dispute, plus actual damages if litigation ensues. [SECTION] - **Unauthorized Access (FCRA §604):** Statutory damages of $3,000 per instance, plus potential criminal charges under California Penal Code 502(c). [SECTION] Section 2: Mandatory Corrective Actions [SECTION] Upon identification of an FCRA violation, regulated entities must: [SECTION] 1. Submit Form CR-25 (Credit Reporting Correction Notice) to the California Department of Financial Protection and Innovation (DFPI) within 5 business days. [SECTION] 2. Provide corrected information to all affected consumers via certified mail (Form CR-30) within 10 business days. [SECTION] 3. File an attestation of compliance (Form CR-35) with the CFPB within 15 business days, including: [SECTION] - Copies of corrected consumer reports [SECTION] - Proof of consumer notification [SECTION] - Internal audit documentation [SECTION] Section 3: Consumer Eligibility for Remedies [SECTION] Consumers may file claims if they meet these criteria: [SECTION] - Demonstrated financial harm via bank statements showing denied credit applications or increased interest rates. [SECTION] - Timely submission of Form CR-40 (Consumer Dispute Affidavit) within 60 days of violation discovery. [SECTION] - Documentation of at least two unsuccessful dispute attempts with the credit bureau (retain copies of Form CR-45). [SECTION] Section 4: Enforcement Timeline [SECTION] - **Immediate Actions (0-5 days):** Credit bureaus must place fraud alerts or security freezes upon request (Form CR-50). [SECTION] - **Investigation Phase (30 days):** Regulated entities must complete dispute investigations per FCRA §611(a)(1). [SECTION] - **Remediation Deadline (45 days):** All corrections must be reflected in consumer reports by this date. [SECTION] Section 5: Consequences of Non-Compliance [SECTION] Failure to adhere to these requirements results in: [SECTION] - Automatic referral to the California Attorney General's Office for enforcement action. [SECTION] - Suspension of credit reporting privileges for 90 days (extendable to 180 days for repeat violations). [SECTION] - Mandatory participation in quarterly FCRA compliance audits for two years. [SECTION] Section 6: Contact Information [SECTION] For compliance questions or dispute submissions: [SECTION] DFPI Credit Reporting Division: 1-800-555-7890 [SECTION] Email: cr.compliance@dfpi.ca.gov [SECTION] Overnight Mail: DFPI – CR Unit, 1500 11th Street, Sacramento, CA 95814[SECTION] California Credit Reporting Policy – 2025 Consumer Rights Update [SECTION] Document Ref: CCRP-2025-09 / Effective March 2025 [SECTION] Section 1: Requesting Your Credit Report [SECTION] California residents may request free credit reports under the following conditions: [SECTION] - **Annual Request**: One free report per year from each major bureau (Equifax, Experian, TransUnion) via AnnualCreditReport.com or Form CR-22. [SECTION] - **Additional Requests**: Free reports are available if: [SECTION]   * You’ve been denied credit, employment, or housing within the last 60 days (submit denial letter with Form CR-25) [SECTION]   * You’re a victim of identity theft (submit police report or FTC affidavit with Form CR-28) [SECTION]   * You’re unemployed and plan to seek employment within 90 days (submit unemployment verification with Form CR-30) [SECTION] Section 2: Disputing Errors [SECTION] To dispute inaccuracies on your credit report: [SECTION] 1. **Document the Error**: Identify the incorrect item and gather supporting evidence (e.g., bank statements, payment confirmations). [SECTION] 2. **Submit Dispute**: File online through the credit bureau’s dispute portal or mail Form CR-40 with: [SECTION]   * Copy of your credit report with errors circled [SECTION]   * Proof of identity (CA driver’s license or state ID) [SECTION]   * Supporting documentation [SECTION] 3. **Await Investigation**: Bureaus must respond within 30 days (45 days if submitting additional evidence later). [SECTION] Section 3: HIPAA-Related Medical Debt Reporting [SECTION] Under HIPAA Privacy Rule §164.528, medical debt reporting must comply with: [SECTION] - **Consent Requirement**: Providers must obtain written consent (Form HIPAA-15) before reporting medical debt to credit bureaus. [SECTION] - **Dispute Process**: If medical debt appears without consent, submit Form CR-45 to the bureau with a copy of the unsigned HIPAA-15. [SECTION] - **Removal Timeline**: Unauthorized medical debt must be removed within 5 business days of dispute receipt. [SECTION] Section 4: Contact Information [SECTION] For credit report assistance in California: [SECTION] - **Equifax**: 1-800-685-1111 | PO Box 740241, Atlanta, GA 30374 [SECTION] - **Experian**: 1-888-397-3742 | PO Box 4500, Allen, TX 75013 [SECTION] - **TransUnion**: 1-800-916-8800 | PO Box 2000, Chester, PA 19016 [SECTION] - **CA Attorney General’s Office**: 1-800-952-5225 | credit.reports@doj.ca.gov [SECTION] - **HIPAA Complaints**: Submit Form OCR-200 to the U.S. Department of Health and Human Services [SECTION] Section 5: Penalties for Non-Compliance [SECTION] Violations of credit reporting laws may result in: [SECTION] - **Bureau Penalties**: $2,500 per willful violation under the FCRA [SECTION] - **Provider Penalties**: Up to $50,000 per HIPAA violation for unauthorized medical debt reporting [SECTION] - **Consumer Remedies**: Actual damages plus attorney fees for successful lawsuits [SECTION] Note: Retain copies of all correspondence for at least 3 years. Dispute status can be checked online or by calling the bureau’s toll-free number.",
        llm_fn=my_llm,
        reprompting_config=base_config,
        user_instructions=["use the letter e only", "do not use the letter e"]
    )
    print_result("No System Prompt Test", result)
    assert "best_response" in result

@pytest.mark.integration
def test_with_system_prompt(my_llm, base_config):
    """Test behavior when a system prompt is explicitly provided."""
    result = run_reprompting_pipeline(
        user_query="Can I dispute my background check results if they’re wrong?",
        context="[SECTION] California Employment Background Check Dispute Process – FCRA Compliance [SECTION] Effective: July 2025 / Policy Ref: BGC-2025-07 [SECTION] This document outlines the formal dispute procedure for inaccurate background check reports under Fair Credit Reporting Act (FCRA) §611 and California Civil Code §1786.16. [SECTION] SECTION 1: ELIGIBILITY REQUIREMENTS [SECTION] You may dispute your background check report if: [SECTION] - The report contains factual errors (e.g., incorrect employment dates, misattributed criminal records, or expired violations) [SECTION] - The disputed information falls within FCRA's 7-year reporting period (10 years for positions with salaries exceeding $125,000 annually) [SECTION] - You have not previously disputed the same item within the past 12 months [SECTION] SECTION 2: DISPUTE SUBMISSION PROCESS [SECTION] Step 1: Documentation Preparation [SECTION] - Complete Form BGC-2025-D (Dispute Request) with: [SECTION]   * Notarized statement of inaccuracy [SECTION]   * Supporting evidence (pay stubs, court disposition forms, or government-issued ID) [SECTION]   * For healthcare positions: current medical license (Form MC-114) and malpractice insurance verification [SECTION] Step 2: Submission Methods [SECTION] - Secure Online Portal: Upload documents at bgcdispute.ca.gov (Case Type 45B) [SECTION] - Certified Mail: Send to California Background Check Bureau, PO Box 980, Sacramento, CA 95812 [SECTION] - In-Person: Submit at any California Department of Consumer Affairs office with appointment (Form APT-2025 required) [SECTION] Step 3: Processing Timeline [SECTION] - Acknowledgement issued within 3 business days via Form BGC-2025-R [SECTION] - Investigation completed within 30 calendar days (45 days for complex cases involving multiple jurisdictions) [SECTION] - Corrected reports distributed to you and requesting employer within 5 business days of resolution [SECTION] SECTION 3: CONSEQUENCES OF NON-COMPLIANCE [SECTION] - Incomplete submissions will be rejected and require re-filing (Form BGC-2025-RF) with $25 processing fee [SECTION] - Frivolous disputes (more than 3 in 12 months) may result in 6-month filing suspension [SECTION] - Employment applications may be automatically denied if dispute isn't resolved before employer's decision deadline [SECTION] SECTION 4: EXAMPLE SCENARIOS [SECTION] Example 1: A report lists a dismissed misdemeanor from 2022. Submit Form BGC-2025-D with court dismissal paperwork (Form CR-180) for automatic removal. [SECTION] Example 2: For incorrect drug test results, include lab retest documentation (Form DT-114) and chain-of-custody records. [SECTION] SECTION 5: CONTACT INFORMATION [SECTION] For assistance: [SECTION] - Phone: 1-800-555-1234 (Monday-Friday, 8 AM to 5 PM PST) [SECTION] - Email: bgc.disputes@ca.gov (Response within 2 business days) [SECTION] - In-Person: Schedule appointments using Form APT-2025 at approved locations [SECTION] Note: All disputes are subject to audit under FCRA §609 and may require additional verification. Fraudulent submissions may result in legal action under California Penal Code §532.",
        llm_fn=my_llm,
        reprompting_config=base_config,
        user_instructions=["use the letter e only", "do not use the letter e", "use a neutral tone"],
        system_prompt="this is a system prompt"
    )
    print_result("With System Prompt Test", result)
    assert "best_response" in result
    assert "telemetry" in result
    assert "summary" in result
