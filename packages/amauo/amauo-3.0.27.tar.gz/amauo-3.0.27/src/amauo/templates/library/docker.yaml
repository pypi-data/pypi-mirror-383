#cloud-config
# Docker-enabled cloud-init template

users:
  - default
  - name: ubuntu
    groups: sudo, docker
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL{{SSH_KEY_SECTION}}  # pragma: allowlist secret

packages:
  - docker.io
  - docker-compose
# {{PACKAGES}}

write_files:
  - path: /opt/deploy.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      echo "Starting Docker deployment..."

      # Wait for uploads
      while [ ! -f /opt/uploads.complete ]; do
        sleep 2
      done

      # Enable Docker
      systemctl enable docker
      systemctl start docker

      # Run docker-compose if exists
      if [ -f /opt/deployment/docker-compose.yml ]; then
        cd /opt/deployment
        docker-compose up -d
      fi

      echo "Docker deployment complete"
      touch /opt/deployment.complete

runcmd:
  - mkdir -p /opt/deployment
  - usermod -aG docker ubuntu
  - nohup bash -c 'sleep 30; /opt/deploy.sh' > /opt/deploy.log 2>&1 &
