# Generated by Django 5.2.4 on 2025-07-10 17:00

from django.db import migrations

CREATE_EPISODE_TRIGGER = """
CREATE OR REPLACE FUNCTION set_episode_ordinal()
RETURNS TRIGGER AS $$
BEGIN
    NEW.ordinal := (
        SELECT COALESCE(MAX(ordinal), 0) + 1
        FROM pbsmm_episode
        WHERE season_id = NEW.season_id
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_set_episode_ordinal
BEFORE INSERT ON pbsmm_episode
FOR EACH ROW
EXECUTE FUNCTION set_episode_ordinal();
"""

DROP_EPISODE_TRIGGER = """
DROP TRIGGER IF EXISTS trigger_set_episode_ordinal ON pbsmm_episode;
DROP FUNCTION IF EXISTS set_episode_ordinal();
"""


class Migration(migrations.Migration):
    dependencies = [
        ("episode", "0017_episode_provisional"),
    ]

    operations = [
        migrations.RunSQL(
            sql=CREATE_EPISODE_TRIGGER,
            reverse_sql=DROP_EPISODE_TRIGGER,
        ),
    ]
