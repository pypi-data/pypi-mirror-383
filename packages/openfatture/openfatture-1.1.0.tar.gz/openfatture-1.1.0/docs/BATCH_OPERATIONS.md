# Batch Operations (CSV)

Guide for importing, exporting, and validating large volumes of invoices with the `openfatture batch` CLI.

---

## When to Use Batch Mode

- Migrating from another system (export the CSV and import into OpenFatture).
- Periodically loading invoices generated by external software.
- Producing high-level analytics (export CSV for BI/Excel tooling).

---

## Prerequisites

1. **Customers already exist** in the database. Customer IDs are referenced in the CSV. Retrieve them with:
   ```bash
   uv run openfatture cliente list
   ```
2. **Environment initialised** (`openfatture init`) and `.env` configured with PEC/notifications if you want email summaries.
3. CSV files encoded in UTF-8 whose headers match the format described below.

---

## Import CSV Format

Required columns:

| Field | Description | Example |
|-------|-------------|---------|
| `numero` | Invoice number (string). | `001` |
| `anno` | Fiscal year. | `2025` |
| `data_emissione` | ISO date (`YYYY-MM-DD`). | `2025-01-15` |
| `cliente_id` | ID of an existing customer. | `3` |
| `imponibile` | Taxable amount (decimal). | `500.00` |
| `iva` | VAT amount. | `110.00` |
| `totale` | Gross total. | `610.00` |
| `note` | Optional â€“ free-form notes. | `Consulting January` |

> **Tip:** If you need detailed lines, load them separately with a custom script or add them manually using `openfatture fattura show` â†’ `fattura righe add` (planned feature). The current importer creates invoices with pre-calculated totals.

### CSV Example

```csv
numero,anno,data_emissione,cliente_id,imponibile,iva,totale,note
001,2025,2025-01-15,3,500.00,110.00,610.00,"Consulting services"
002,2025,2025-01-18,5,1200.00,264.00,1464.00,"Backend API development"
```

---

## Import Invoices

1. **Dry run (recommended)**
   ```bash
   uv run openfatture batch import invoices.csv --dry-run
   ```
   - Validates structure and customers without persisting.
   - Prints detailed errors (up to 10 rows, then a summary).

2. **Real import**
   ```bash
   uv run openfatture batch import invoices.csv
   ```
   - Reports total rows, successes/failures, and duration.
   - Sends a professional email summary to `NOTIFICATION_EMAIL` (disable with `--no-summary`).

3. **Verify**
   ```bash
   uv run openfatture fattura list --anno 2025
   ```

### Common Errors

- `Client X not found`: create the customer first or fix the ID in the CSV.
- `Row N: ... invalid literal`: numbers with commas â†’ use `.` as decimal separator.
- `Import failed: ...`: unreadable file or wrong encoding â†’ save as UTF-8 (without BOM).

---

## Export Invoices

```bash
uv run openfatture batch export export_2025.csv --anno 2025 --stato inviata
```

- Produces an invoice summary (number, date, customer, taxable, VAT, total, notes).
- The target directory is created automatically if missing.
- Open the file in Excel/Numbers/LibreOffice and set the separator to `,`.

> Exporting detailed lines (`include_lines`) is available via the API (`openfatture.core.batch.operations`) and will surface in the CLI in future releases.

---

## Maintenance & History

- Imported invoices stay in **draft** status. Add missing lines before sending to SDI.
- Archive the imported CSV alongside logs (`~/.openfatture/data/logs`).
- `openfatture batch history` currently shows a placeholder: historical tracking will rely on a dedicated `batch_operation` table (on the roadmap).

---

## Post-Import Checklist

1. `openfatture fattura list --stato bozza` to inspect drafts.
2. `openfatture fattura show ID` to validate data and totals.
3. Generate XML/PDF and send to SDI using `fattura xml` / `fattura invia`.
4. Process incoming PEC notifications with `openfatture notifiche process`.

---

Questions or edge cases? Open an issue on GitHub or reach out through the batch channel referenced in the README. Happy importing! ðŸ“¦
