<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'nonce-inline-script' https://cdnjs.cloudflare.com https://aws-toolkit-language-servers.amazonaws.com https://aws-language-servers.us-east-1.amazonaws.com blob:; connect-src 'self' https://aws-toolkit-language-servers.amazonaws.com https://aws-language-servers.us-east-1.amazonaws.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'self';"
    />
    <title>Chat UI</title>
    <style nonce="inline-style">
      /* CSS Custom Property Map - Dark Mode (default) */
      html:root,
      :root,
      body {
        --mynah-max-width: 2560px;
        --mynah-sizing-base: 0.2rem;
        --mynah-chat-wrapper-spacing: var(--mynah-sizing-4);
        --mynah-font-family: system-ui, -apple-system, sans-serif;
        --mynah-syntax-code-font-family: monospace;
        --mynah-color-text-default: #ffffff;
        --mynah-color-text-alternate: #e8e8ed;
        --mynah-color-text-strong: #ffffff;
        --mynah-color-text-weak: #dedee3;
        --mynah-color-text-link: #8fffce;
        --mynah-color-text-input: #ffffff;
        --mynah-color-light: rgba(0, 0, 0, 0.05);
        --mynah-color-highlight: rgba(208, 212, 231, 0.25);
        --mynah-color-highlight-text: #222849;
        --mynah-color-border-default: hsla(230, 5%, 26%, 1);
        --mynah-color-tab-active: #000000;
        --mynah-button-border-width: 1px;
        --mynah-border-width: 1px;
        --mynah-color-syntax-variable: #9b46b0;
        --mynah-color-syntax-function: #6b89ff;
        --mynah-color-syntax-operator: #9b46b0;
        --mynah-color-syntax-attr-value: #b3beff;
        --mynah-color-syntax-attr: #e68484;
        --mynah-color-syntax-property: #0598bc;
        --mynah-color-syntax-comment: #31c99b;
        --mynah-color-syntax-code: #d4d8e8;
        --mynah-color-syntax-bg: hsla(221, 14%, 26%, 1);
        --mynah-color-status-info: hsla(204, 100%, 33%, 1);
        --mynah-color-status-success: hsla(120, 100%, 39%, 1);
        --mynah-color-status-warning: hsla(52, 100%, 48%, 1);
        --mynah-color-status-error: hsla(0, 100%, 51%, 1);
        --mynah-color-bg: hsla(212, 25%, 7%, 1);
        --mynah-color-tab-active: hsla(213, 25%, 13%, 1);
        --mynah-color-toggle: #fafbfc;
        --mynah-color-toggle-reverse: rgba(0, 0, 0, 0.5);
        --mynah-color-button: hsla(223, 10%, 38%, 1);
        --mynah-color-button-reverse: #ffffff;
        --mynah-color-alternate: hsla(223, 10%, 38%, 1);
        --mynah-color-alternate-reverse: #ffffff;
        --mynah-card-bg: hsla(213, 25%, 13%, 1);
        --mynah-card-bg-alternate: hsla(223, 10%, 38%, 1);
        --mynah-shadow-button: 0 5px 10px -10px rgba(0, 0, 0, 0.25);
        --mynah-shadow-card: 0 20px 25px -20px rgba(0, 0, 0, 0.5);
        --mynah-shadow-overlay: 0 10px 35px -10px rgba(0, 0, 0, 0.75);
        --mynah-syntax-code-font-size: 0.9rem;
        --mynah-syntax-code-line-height: 1.25rem;
        --mynah-font-size-xxsmall: 0.75rem;
        --mynah-font-size-xsmall: 0.85rem;
        --mynah-font-size-small: 0.95rem;
        --mynah-font-size-medium: 1rem;
        --mynah-font-size-large: 1.125rem;
        --mynah-line-height: 1.25rem;
        --mynah-card-radius: var(--mynah-sizing-5);
        --mynah-card-radius-corner: 0;
        --mynah-button-radius: var(--mynah-sizing-5);
        --mynah-input-radius: var(--mynah-sizing-2);
        --mynah-main-wrapper-transition: all 350ms
          cubic-bezier(0.83, 0, 0.17, 1);
        --mynah-bottom-panel-transition: all 450ms cubic-bezier(0.25, 1, 0, 1);
        --mynah-short-rev-transition: all 280ms cubic-bezier(0.35, 1, 0, 1);
        --mynah-very-short-transition: all 300ms cubic-bezier(0.25, 1, 0, 1);
        --mynah-very-long-transition: all 1000ms cubic-bezier(0.25, 1, 0, 1);
        --mynah-short-transition: all 300ms cubic-bezier(0.85, 0.15, 0, 1);
        --mynah-short-transition-rev: all 280ms cubic-bezier(0.35, 1, 0, 1);
        --mynah-short-transition-rev-opacity: opacity 350ms
          cubic-bezier(0.35, 1, 0, 1);
        --mynah-text-flow-transition:
          all 400ms cubic-bezier(0.35, 1.2, 0, 1),
          transform 400ms cubic-bezier(0.2, 1.05, 0, 1);
        default: undefined;
      }

      button.mynah-button:has(.mynah-ui-icon-external) {
        display: none !important;
      }

      /* Light Mode Overrides */
      @media (prefers-color-scheme: light) {
        html:root,
        :root,
        body {
          --mynah-color-text-default: #000000;
          --mynah-color-text-alternate: #333333;
          --mynah-color-text-strong: #000000;
          --mynah-color-text-weak: #666666;
          --mynah-color-tab-active: #ffffff;
          --mynah-color-text-link: #98a8ec;
          --mynah-color-bg: #ffffff;
          --mynah-card-bg: #f5f5f5;
          --mynah-card-bg-alternate: #e0e0e0;
          --mynah-color-border-default: #d0d0d0;
          --mynah-color-syntax-bg: #f8f8f8;
          --mynah-color-text-input: #000000;
        }
      }

      body,
      html {
        background-color: var(--mynah-color-bg);
        color: var(--mynah-color-text-default);
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        display: block;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript" nonce="inline-script">
      const init = () => {
        const postMessage = event => {
          window.parent.postMessage(event, window.location.origin);
        };
        const api = {
          postMessage: postMessage.bind(window)
        };

        const mockQuickActions = [
          {
            commands: [
              {
                command: '/clear',
                icon: 'file',
                description: 'Clear the chat window'
              },
              {
                command: '/fix',
                icon: 'file',
                description: 'Fx an error cell selected in your notebook'
              },
              {
                command: '/explain',
                icon: 'file',
                description: 'Explains code included in a selection'
              },
              {
                command: '/optimize',
                icon: 'file',
                description: 'Optimizes code included in a selection'
              },
              {
                command: '/refactor',
                icon: 'file',
                description: 'Refactors code included in a selection'
              },
              {
                command: '/help',
                icon: 'file',
                description: 'Display this help message'
              }
            ]
          }
        ];

        // key will exist in local storage if user acknowledged the Amazon Q Developer disclaimer
        const disclaimerAcknowledged = localStorage.getItem(
          'disclaimerAcknowledged'
        );
        // key will exist in local storage if the user closed the agentic Q introduction alert
        const pairProgrammingAcknowledged = localStorage.getItem(
          'chatPromptOptionAcknowledged'
        );

        amazonQChat.createChat(api, {
          disclaimerAcknowledged,
          pairProgrammingAcknowledged,
          agenticMode: true,
          quickActionCommands: mockQuickActions
        });
      };

      // Add JSZip library from local static folder
      const jsZipScript = document.createElement('script');
      jsZipScript.src = '/static/jszip.min.js';
      jsZipScript.onload = loadClient;
      jsZipScript.onerror = () => {
        console.error('Failed to load JSZip from static folder, trying CDN fallback');
        const fallbackScript = document.createElement('script');
        fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        fallbackScript.onload = loadClient;
        fallbackScript.onerror = () => {
          console.error('Failed to load JSZip from all sources');
        };
        document.body.appendChild(fallbackScript);
      };
      document.body.appendChild(jsZipScript);

      function loadClient() {
        // Try to load pre-extracted client from static folder first
        const script = document.createElement('script');
        script.type = 'application/javascript';
        script.onload = init;
        script.src = '/static/amazonq-ui.js';
        script.onerror = () => {
          console.warn('Pre-extracted client not found, falling back to runtime download');
          loadClientFromAWS();
        };
        document.body.appendChild(script);
      }

      function loadClientFromAWS() {
        const MANIFEST_URL =
          'https://aws-toolkit-language-servers.amazonaws.com/qAgenticChatServer/0/manifest.json';
        const FLARE_SERVER_VERSION = '1.25.0';

        // Fetch manifest to get clients.zip URL
        fetch(MANIFEST_URL)
          .then(response => response.json())
          .then(manifest => {
            // Find the specified version
            const version = manifest.versions.find(
              v => v.serverVersion === FLARE_SERVER_VERSION
            );
            if (!version) {
              throw new Error(`Version ${FLARE_SERVER_VERSION} not found`);
            }

            // Find clients.zip URL from any target (clients.zip is platform-independent)
            let clientsZipUrl = null;
            for (const target of version.targets) {
              const clientsContent = target.contents.find(
                c => c.filename === 'clients.zip'
              );
              if (clientsContent) {
                clientsZipUrl = clientsContent.url;
                break;
              }
            }

            if (!clientsZipUrl) {
              throw new Error('clients.zip not found in manifest');
            }

            return fetch(clientsZipUrl);
          })
          .then(response => response.arrayBuffer())
          .then(data => {
            // Use JSZip to extract the contents
            return JSZip.loadAsync(data);
          })
          .then(zip => {
            // Find the JS file in the ZIP
            const jsFile = Object.keys(zip.files).find(
              name => name.endsWith('.js') && !name.includes('/')
            );

            if (!jsFile) {
              throw new Error('JavaScript file not found in ZIP');
            }

            // Extract the JS file content
            return zip.file(jsFile).async('blob');
          })
          .then(jsBlob => {
            // Create a URL for the blob
            const blobUrl = URL.createObjectURL(jsBlob);

            // Create and load the script
            const script = document.createElement('script');
            script.type = 'application/javascript';
            script.onload = init;
            script.src = blobUrl;
            document.body.appendChild(script);
          })
          .catch(error => {
            console.error('Error loading client:', error);
          });
      }
    </script>
  </body>
</html>
