{"version":3,"file":"structured-field-form.js","sources":["../../../reactive-forms/callbacks.js","../../../reactive-forms/patches.js","../../../reactive-forms/main.js"],"sourcesContent":["export function initCallbacks() {\n    window.JSONEditor.defaults.callbacks = {\n        \"select2\": {\n            \"createQueryParams\": function (_editor, params) {\n                return {\n                  _q: params.term, // search term\n                  page: params.page || 1,\n                };\n              },\n            \"processResultData\": function (_editor, data, params) {\n                params.page = params.page || 1;\n                return {\n                    results: data.items.map(item => ({id: btoa(JSON.stringify(item)), text: item.name})),\n                    pagination: {\n                        more: data.more\n                    }\n                };\n              },\n        }\n    };\n}\n","export function patchSelect2Editor() {\n    window.JSONEditor.defaults.editors.select2 = class extends window.JSONEditor.defaults.editors.select2 {\n        titleFieldsPriority = ['__str__', 'name', 'title', 'label', 'id']\n\n        preBuild() {\n            if (this.schema.type === \"relation\") {\n                this.schema.enum = []\n            }\n            super.preBuild()\n        }\n\n        forceAddOption(value, text) {\n            if (this.enum_values.includes(value)) return\n            this.schema.enum.push(value)\n            this.enum_values.push(value)\n            this.enum_options.push(value)\n            this.enum_display.push(text)\n            this.theme.setSelectOptions(this.input, this.enum_options, this.enum_display)\n        }\n\n        isRelation() {\n            return this.schema.type === \"relation\"\n        }\n        isManyRelation(value = []) {\n            return this.isRelation() && this.schema.multiple && Array.isArray(value)\n        }\n        isClearable(value = null) {\n            return this.isRelation() && this.schema.options.select2.allowClear && value === null\n        }\n        isObject(x) {\n            return typeof x === 'object' && !Array.isArray(x) && x !== null\n        }\n        isString(x) {\n            return typeof x === 'string'\n        }\n        isArray(x) {\n            return Array.isArray(x)\n        }\n        isNumber(x) {\n            return typeof x === 'number' || !isNaN(x)\n        }\n        isRelationObject(x) {\n            return this.isObject(x) && x.id && x.model\n        }\n        isB64Encoded(x) {\n            return this.isString(x) && x.match(/^[a-zA-Z0-9-_]+={0,2}$/)\n        }\n        isJSONString(x) {\n            try {\n                return this.isString(x) && this.isObject(JSON.parse(x))\n            } catch (e) {\n                return false\n            }\n        }\n        isb64RelationObject(x) {\n            if (this.isB64Encoded(x)) {\n                var decoded = atob(x)\n                return this.isJSONString(decoded) && this.isRelationObject(JSON.parse(decoded))\n            }\n            return false\n        }\n        decodeB64Object(x) {\n            return this.isb64RelationObject(x) ? JSON.parse(atob(x)) : x\n        }\n\n        deserializeRelValue(value) {\n            if (this.isManyRelation(value)) {\n                return value && value.map(val => this.deserializeRelValue(val))\n            }\n            else if (this.isRelationObject(value)) {\n                return value\n            }\n            else if (this.isJSONString(value)) {\n                return JSON.parse(value)\n            }\n            else if (this.isb64RelationObject(value)) {\n                return this.decodeB64Object(value)\n            }\n            return value\n        }\n\n        serializeRelValue(value) {\n            if (this.isManyRelation(value)) {\n                return value.map(val => this.serializeRelValue(val))\n            }\n            else if (this.isRelationObject(value)) {\n                let name = value[this.titleFieldsPriority.find(field => value[field])]\n                let serialized = JSON.stringify(value)\n                this.forceAddOption(serialized, name)\n                return serialized\n            }\n            else if (this.isJSONString(value)) {\n                return this.serializeRelValue(JSON.parse(value))\n            } else if (this.isb64RelationObject(value)) {\n                return value\n            }\n            return value\n        }\n\n        typecast(value) {\n            if (this.isRelation()) {\n                if (this.isManyRelation(value)) {\n                    return value.map(val => val && this.serializeRelValue(val))\n                } else if (this.isClearable(value)) {\n                    return null\n                }\n            }\n            return super.typecast(value)\n        }\n\n        updateValue(value) {\n            if (this.isRelation()) {\n                if (this.isClearable(value)) {\n                    this.value = null\n                    return this.value\n                }\n                this.value = this.serializeRelValue(value)\n                return this.value\n            }\n            return super.updateValue(value)\n        }\n\n        getValue() {\n            if (this.isRelation()) {\n                return this.deserializeRelValue(this.value)\n            }\n            return super.getValue()\n        }\n\n        async setValue(value, initial) {\n            if (this.isRelation()) {\n                value = this.updateValue(value)\n                while (!this.select2_instance) {\n                    await new Promise(resolve => setTimeout(resolve, 100))\n                }\n            }\n            return super.setValue(value, initial)\n        }\n\n        afterInputReady() {\n            super.afterInputReady()\n            if (this.isRelation()) {\n                this.newEnumAllowed = true\n                this.control?.querySelector('.select2-container')?.removeAttribute('style')\n            }\n        }\n    }\n    window.JSONEditor.defaults.resolvers.unshift(function (schema) {\n        if (schema.type === \"relation\" && schema.format === \"select2\") {\n            return \"select2\"\n        }\n    })\n}\n","import './scss/main.scss';\nimport { initCallbacks } from './callbacks';\nimport { patchSelect2Editor } from './patches';\n\nfunction renderForm(element) {\n    const schema = JSON.parse(element.dataset.schema);\n    console.log(\"🧱 schema\", schema)\n    const uiSchema = JSON.parse(element.dataset.uischema);\n    const formData = JSON.parse(element.dataset.formdata);\n    console.log(\"🫐 formData\", formData)\n    const inputTextArea = document.getElementById(`id_${element.dataset.name}`);\n    const editor = new JSONEditor(element, { \n        schema,\n        startval: formData,\n        max_depth: 10,\n        show_errors: 'always',\n    });\n    editor.on('change', () => {\n        inputTextArea.innerHTML = JSON.stringify(editor.getValue());\n    });\n}\n\ndocument.addEventListener('DOMContentLoaded', () => {\n    JSONEditor.defaults.options.theme = 'html';\n    JSONEditor.defaults.options.iconlib = 'fontawesome5';\n    initCallbacks();\n    patchSelect2Editor();\n    const elements = document.querySelectorAll('.structured-field-editor');\n    for (let i = 0; i < elements.length; i++) {\n        renderForm(elements[i]);\n    }\n});"],"names":[],"mappings":"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"}