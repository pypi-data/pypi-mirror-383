import{r as reactExports,v as Icon,_ as _extends,e as useOutletContext,j as jsxRuntimeExports,c as Row,C as Col,g as Flex,B as Button,P as Popconfirm,w as RefIcon$1,F as Form,f as staticMethods,M as Modal,i as Collapse,I as Input,d as Typography,a as axios,R as React,o as Tooltip}from"./main-gLMaKCvr.js";import{R as ResultList}from"./index-Ci9o3BMm.js";import{F as FormJsonComp,a as BioDatabaseForm}from"./index-DEhiFitC.js";import{R as ResultList$1}from"./index-BpTPZbHm.js";import{A as AnalysisForm}from"./index-4ifBGcWk.js";import{C as Card}from"./index-Jdu54dr5.js";import{S as Spin}from"./index-B-_sZvQI.js";var CloseCircleOutlined$1={icon:{tag:"svg",attrs:{"fill-rule":"evenodd",viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64c247.4 0 448 200.6 448 448S759.4 960 512 960 64 759.4 64 512 264.6 64 512 64zm0 76c-205.4 0-372 166.6-372 372s166.6 372 372 372 372-166.6 372-372-166.6-372-372-372zm128.01 198.83c.03 0 .05.01.09.06l45.02 45.01a.2.2 0 01.05.09.12.12 0 010 .07c0 .02-.01.04-.05.08L557.25 512l127.87 127.86a.27.27 0 01.05.06v.02a.12.12 0 010 .07c0 .03-.01.05-.05.09l-45.02 45.02a.2.2 0 01-.09.05.12.12 0 01-.07 0c-.02 0-.04-.01-.08-.05L512 557.25 384.14 685.12c-.04.04-.06.05-.08.05a.12.12 0 01-.07 0c-.03 0-.05-.01-.09-.05l-45.02-45.02a.2.2 0 01-.05-.09.12.12 0 010-.07c0-.02.01-.04.06-.08L466.75 512 338.88 384.14a.27.27 0 01-.05-.06l-.01-.02a.12.12 0 010-.07c0-.03.01-.05.05-.09l45.02-45.02a.2.2 0 01.09-.05.12.12 0 01.07 0c.02 0 .04.01.08.06L512 466.75l127.86-127.86c.04-.05.06-.06.08-.06a.12.12 0 01.07 0z"}}]},name:"close-circle",theme:"outlined"},CloseCircleOutlined=function(o,t){return reactExports.createElement(Icon,_extends({},o,{ref:t,icon:CloseCircleOutlined$1}))},RefIcon=reactExports.forwardRef(CloseCircleOutlined);const AnalysisSoftwarePanel=({inputFile:e,outputFile:o,pipeline:t,wrapAnalysisPipeline:r,analysisPipline:f,inputAnalysisMethod:S,analysisMethod:j,appendSampleColumns:m,analysisType:R="nonSample",children:_,cardExtra:i,upstreamFormJson:l,downstreamAnalysis:h,operatePipeline:a,...n})=>{const{project:y}=useOutletContext();reactExports.useEffect(()=>{},[]),reactExports.useRef(null);const[g,d]=reactExports.useState(),x=u=>u&&Array.isArray(u)&&u.length>0;return jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(Row,{children:jsxRuntimeExports.jsxs(Col,{lg:24,sm:24,xs:24,children:[jsxRuntimeExports.jsx(Card,{size:"small",style:{marginBottom:"1rem"},children:jsxRuntimeExports.jsxs(Flex,{gap:"small",style:{marginBottom:"1rem",flexWrap:"wrap"},children:[t&&jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{a.openModal("modalC",{data:void 0,structure:{component_type:"software",relation_type:"pipeline_software",parent_component_id:t.component_id}})},children:"新增软件"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{a.openModal("modalC",{data:n,structure:{component_type:"software"}})},children:"更新软件"}),t&&jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{a.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"pipeline_software",parent_component_id:t.component_id}})},children:"添加软件"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{a.openModal("modalA",{data:n,pipelineStructure:{relation_type:"pipeline_software"}})},children:"替换软件"}),jsxRuntimeExports.jsx(Popconfirm,{title:"是否移除文件?",onConfirm:()=>{a.deletePipelineRelation(n.relation_id)},children:jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",children:"移除软件"})})]}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{a.openModal("modalB",{module_type:"nextflow",file_type:"nf",module_name:f,component_id:n.component_id})},children:"组件代码"}),n.databases&&jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{a.openModal("modalE",n.databases)},children:"配置数据库"}),jsxRuntimeExports.jsx(RefIcon$1,{onClick:()=>{a.openModal("descriptionModal",n.description)},style:{cursor:"pointer"}})]})}),x(e)?jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(UpstreamAnalysisInput,{...n,pipeline:t,record:g,onClickItem:d,project:y,operatePipeline:a,cardExtra:i,upstreamFormJson:l,analysisPipline:f,analysisMethod:j,inputAnalysisMethod:e})}):jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsxs(Flex,{justify:"center",style:{margin:"2rem"},gap:"small",children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{a.openModal("modalC",{data:void 0,structure:{relation_type:"software_input_file",parent_component_id:n.component_id,component_type:"file"}})},children:"新增文件"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{a.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"software_input_file",parent_component_id:n.component_id}})},children:"添加文件"})]})}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),x(o)?jsxRuntimeExports.jsx(UpstreamAnalysisOutput,{...n,pipeline:t,software:{pipeline_id:n.pipeline_id,component_id:n.component_id},children:_,onClickItem:d,downstreamAnalysis:h,operatePipeline:a,project:y,analysisType:R,analysisMethod:o,appendSampleColumns:m}):jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsxs(Flex,{justify:"center",style:{margin:"2rem"},gap:"small",children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{a.openModal("modalC",{data:void 0,structure:{relation_type:"software_output_file",parent_component_id:n.component_id,component_type:"file"}})},children:"新增文件"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{a.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"software_output_file",parent_component_id:n.component_id}})},children:"添加文件"})]})})]})})})},UpstreamAnalysisInput=({record:e,pipeline:o,operatePipeline:t,project:r,markdown:f,analysisPipline:S,upstreamFormJson:j,inputAnalysisMethod:m,onClickItem:R,cardExtra:_,...i})=>{const[l]=Form.useForm(),[h,a]=reactExports.useState(),[n,y]=staticMethods.useMessage(),[g,d]=reactExports.useState(!1),x=Form.useWatch(s=>s==null?void 0:s.analysis_id,l),[u,F]=reactExports.useState(),[w,b]=reactExports.useState(),[I,B]=Modal.useModal(),{projectObj:T}=useOutletContext(),C=reactExports.useRef(null),M=s=>{const p=m.map(E=>E.component_id);return{...s,project:r,inputFormJson:m,component_id:i.component_id,data_component_ids:JSON.stringify(p)}},v=async s=>{var E;const p=await l.validateFields(),A=M(p);d(!0);try{const c=await axios.post(`/fast-api/analysis-controller?save=${s}`,A);console.log(c),s?(n.success("执行成功!"),C.current&&C.current.reload()):t.openModal("modalF",c.data)}catch(c){console.log(c),(E=c.response)!=null&&E.data&&n.error(c.response.data.detail)}d(!1)},D={host_genome_index:[{label:"人类",value:"/data/metagenome_data/bowtie2_index/human/human38"},{label:"小鼠",value:"/data/databases/mouse/bowtie2/Mus_musculus.GRCm39.dna_sm.toplevel.fa"}]};return jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[y,B,!(i!=null&&i.hiddenUpstreamAnalysis)&&jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),jsxRuntimeExports.jsx(Form,{form:l,children:jsxRuntimeExports.jsx(Collapse,{style:{marginTop:"1rem"},size:"small",items:[{key:"1",label:`执行分析 (${i.component_name})`,children:jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[m&&jsxRuntimeExports.jsx(ResultList,{...i,pipeline:o,software:i,currentAnalysisMethod:w,setCurrentAnalysisMethod:b,operatePipeline:t,relationType:"software_input_file",cardExtra:_,title:`输入文件 ${m.length>0?"":m.map(s=>s.label)}`,activeTabKey:u,setActiveTabKey:F,shouldTrigger:!0,analysisType:"sample",analysisMethod:m,setResultTableList:a}),jsxRuntimeExports.jsxs(Spin,{spinning:g,children:[jsxRuntimeExports.jsx(Form.Item,{name:"analysis_id",label:"分析ID",children:jsxRuntimeExports.jsx(Input,{disabled:!0})}),jsxRuntimeExports.jsx(Form.Item,{initialValue:`${i.component_name}`,name:"analysis_name",label:"分析名称",rules:[{required:!0,message:"该字段不能为空!"}],children:jsxRuntimeExports.jsx(Input,{})}),jsxRuntimeExports.jsx(FormJsonComp,{formJson:[{name:"group_field",label:"分组列",rules:[{required:!0,message:"该字段不能为空!"}],type:"GroupFieldSelect"}],dataMap:[]}),jsxRuntimeExports.jsx(FormJsonComp,{formJson:m,dataMap:h}),jsxRuntimeExports.jsx(BioDatabaseForm,{operatePipeline:t,formJson:i.databases}),j&&jsxRuntimeExports.jsx(FormJsonComp,{formJson:j,dataMap:D}),jsxRuntimeExports.jsxs(Flex,{gap:"small",children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{v(!1)},children:"查看参数"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>v(!0),children:x?jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:"更新分析"}):jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:"保存分析"})}),x&&jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>l.setFieldValue("analysis_id",void 0),children:"取消更新"})]}),jsxRuntimeExports.jsx(Collapse,{ghost:!0,items:[{key:"1",label:"更多",children:jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(Form.Item,{noStyle:!0,shouldUpdate:!0,children:()=>jsxRuntimeExports.jsx(Typography,{children:jsxRuntimeExports.jsx("pre",{children:JSON.stringify(M(l.getFieldsValue()),null,2)})})})})}]})]})]})}]})}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),jsxRuntimeExports.jsx(ResultList$1,{project:r,ref:C,shouldTrigger:!0,software:i,component_id:i==null?void 0:i.component_id,operatePipeline:t,editParams:s=>{const p=JSON.parse(s.request_param);console.log(p),l.resetFields(),l.setFieldsValue(p),s!=null&&s.id&&l.setFieldValue("analysis_id",s==null?void 0:s.analysis_id),s.dataType="analysis",R(s)}}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}})]})]})},UpstreamAnalysisOutput=({pipeline,component_id,component_type,operatePipeline,children,project,onClickItem,analysisType,analysisMethod,appendSampleColumns,script,...rest})=>{const[form]=Form.useForm(),[record,setRecord]=reactExports.useState(),[filePlot,setFilePlot]=reactExports.useState(),[plotLoading,setPlotLoading]=reactExports.useState(!1),[formDom,setFormDom]=reactExports.useState(),[formJson,setFormJson]=reactExports.useState(),[sampleSelectComp,setSampleSelectComp]=reactExports.useState(!1),{Search}=Input,[messageApi,contextHolder]=staticMethods.useMessage(),[moduleName,setModuleName]=reactExports.useState(),[params,setParams]=reactExports.useState(),[downstreamData,setDownstreamData]=reactExports.useState(),[resultTableList,setResultTableList]=reactExports.useState([]),[saveAnalysisMethod,setSaveAnalysisMethod]=reactExports.useState(),[collapseActiveKey,setCollapseActiveKey]=reactExports.useState("1"),[activeTabKey,setActiveTabKey]=reactExports.useState(),[currentAnalysisMethod,setCurrentAnalysisMethod]=reactExports.useState(),[sampleGroupJSON,setSampleGroupJSON]=reactExports.useState(),[btnName,setBtnName]=reactExports.useState(),[origin,setOrigin]=reactExports.useState(!1),tableRef=reactExports.useRef(null),[sampleGroupApI,setSampleGroupApI]=reactExports.useState(!1),analysis_id=Form.useWatch(e=>e==null?void 0:e.analysis_id,form);reactExports.useEffect(()=>{if(downstreamData&&(currentAnalysisMethod!=null&&currentAnalysisMethod.downstreamAnalysis)){const e=currentAnalysisMethod==null?void 0:currentAnalysisMethod.downstreamAnalysis.find(o=>o.component_id==downstreamData.component_id);plot(e)}},[JSON.stringify(currentAnalysisMethod==null?void 0:currentAnalysisMethod.downstreamAnalysis)]);const plot=async data=>{let{origin=!1,url,moduleName,params,paramsFun,formDom,formJson,saveAnalysisMethod,sampleSelectComp=!1,sampleGroupJSON=!0,sampleGroupApI=!1,...rest}=data;if(cleanDom(),setCollapseActiveKey("1"),setDownstreamData(data),setFormDom(formDom),setModuleName(moduleName),setParams(params),setSampleGroupApI(sampleGroupApI),setFilePlot(void 0),setOrigin(origin),form.resetFields(),form.setFieldValue("analysis_name",rest.component_name),setFormJson(formJson),setSampleSelectComp(sampleSelectComp),setSampleGroupJSON(sampleGroupJSON),paramsFun&&(paramsFun=eval(paramsFun),params=paramsFun(record),console.log(params),setParams(params)),saveAnalysisMethod&&setSaveAnalysisMethod(saveAnalysisMethod),origin){const e=await axios.post(`/fast-api/file-parse-plot/${moduleName}`,{...params,is_save_analysis_result:!1,origin:!0});console.log(e),setFilePlot(e.data)}},cleanDom=()=>{setFormDom(void 0),setFilePlot(void 0),setDownstreamData(void 0),setSaveAnalysisMethod(void 0)},getScript=e=>{const{name:o,analysisType:t,...r}=e;return record&&t=="one"?jsxRuntimeExports.jsxs(Button,{size:"small",color:"purple",variant:(downstreamData==null?void 0:downstreamData.component_id)==r.component_id?"solid":"filled",onClick:()=>plot({...r}),children:[r.component_name,"(",record.sample_name,")"]}):jsxRuntimeExports.jsx(Button,{size:"small",color:"primary",variant:(downstreamData==null?void 0:downstreamData.component_id)==r.component_id?"solid":"filled",onClick:()=>plot({...r}),children:r.component_name})},[componentIds,setComponentIds]=reactExports.useState();reactExports.useEffect(()=>{const e=analysisMethod.filter(t=>t.downstreamAnalysis).map(t=>t.downstreamAnalysis).flat();console.log(e);const o=e.map(t=>t.component_id);o.length>0&&setComponentIds(o)},[]),reactExports.useEffect(()=>{script&&(plot({...script,name:script.name}),setComponentIds([script.component_id]))},[script]);const[scriptMap,setScriptMap]=reactExports.useState();return reactExports.useEffect(()=>{if(script)setScriptMap({[script.component_id]:script});else{const o=analysisMethod.filter(t=>"downstreamAnalysis"in t).map(t=>t.downstreamAnalysis).flat(1/0).reduce((t,r)=>(t[r.component_id]=r,t),{});setScriptMap(o)}},[analysisMethod]),jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[contextHolder,analysisMethod&&Array.isArray(analysisMethod)&&analysisMethod.length>0&&jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(ResultList,{...rest,pipeline,software:rest,currentAnalysisMethod,setCurrentAnalysisMethod,operatePipeline,relationType:"software_output_file",title:`输出文件 ${analysisMethod.length>0?"":analysisMethod.map(e=>e.name)}`,appendSampleColumns,activeTabKey,setActiveTabKey,cleanDom,analysisType:"sample",analysisMethod,shouldTrigger:!0,form,setResultTableList,setRecord:e=>{setRecord(e)}})}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),jsxRuntimeExports.jsxs(Flex,{style:{marginBottom:"1rem"},gap:"small",children:[(currentAnalysisMethod==null?void 0:currentAnalysisMethod.downstreamAnalysis)&&(currentAnalysisMethod==null?void 0:currentAnalysisMethod.downstreamAnalysis.map((e,o)=>jsxRuntimeExports.jsx("span",{children:getScript(e)},o))),script?jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{}):jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalC",{data:void 0,structure:{relation_type:"file_script",parent_component_id:currentAnalysisMethod.component_id,component_type:"script"}})},children:"新增分析"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:"file_script",parent_component_id:currentAnalysisMethod.component_id}})},children:"添加分析"}),(downstreamData==null?void 0:downstreamData.component_id)&&jsxRuntimeExports.jsx(RefIcon,{onClick:()=>{setDownstreamData(void 0)}})]})]}),children&&React.cloneElement(children,{record,plot,cleanDom,form,activeTabKey,resultTableList}),jsxRuntimeExports.jsx("div",{children:downstreamData&&jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsx(Collapse,{style:{marginTop:"1rem"},defaultActiveKey:["1"],size:"small",items:[{key:"1",label:jsxRuntimeExports.jsxs(Tooltip,{title:jsxRuntimeExports.jsx(jsxRuntimeExports.Fragment,{children:jsxRuntimeExports.jsxs("ul",{children:[jsxRuntimeExports.jsxs("li",{children:["software:",rest==null?void 0:rest.component_id]}),jsxRuntimeExports.jsxs("li",{children:["file:",currentAnalysisMethod==null?void 0:currentAnalysisMethod.component_id]}),jsxRuntimeExports.jsxs("li",{children:["script:",downstreamData==null?void 0:downstreamData.component_id]})]})}),children:["执行分析",downstreamData?`(${downstreamData.component_name})`:"",analysis_id?`(${analysis_id})`:""]}),children:jsxRuntimeExports.jsxs(jsxRuntimeExports.Fragment,{children:[jsxRuntimeExports.jsxs(Flex,{gap:"small",children:[jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalB",{component_id:downstreamData.component_id})},children:"组件代码"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalC",{data:downstreamData,structure:{component_type:"script"}})},children:"更新分析"}),jsxRuntimeExports.jsx(Button,{size:"small",color:"cyan",variant:"solid",onClick:()=>{operatePipeline.openModal("modalA",{data:downstreamData,pipelineStructure:{relation_type:"file_script",pipeline_id:pipeline.component_id}})},children:"替换分析"}),jsxRuntimeExports.jsx(Popconfirm,{title:"确认删除!",onConfirm:()=>{operatePipeline.deletePipelineRelation(downstreamData.relation_id),setBtnName(void 0)},children:jsxRuntimeExports.jsx(Button,{size:"small",color:"danger",variant:"solid",children:"删除分析"})}),jsxRuntimeExports.jsx(RefIcon$1,{onClick:()=>{operatePipeline.openModal("descriptionModal",downstreamData.description)},style:{cursor:"pointer"}})]}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),jsxRuntimeExports.jsx(AnalysisForm,{...downstreamData,pipeline,form,resultTableList,formJson,formDom,sampleGroupApI,operatePipeline,params,name:btnName,setPlotLoading,dataComponentIds:analysisMethod.map(e=>e.component_id),inputAnalysisMethod:currentAnalysisMethod,saveAnalysisMethod,project,setFilePlot,callback:()=>{tableRef.current&&tableRef.current.reload()},plotReloadTable:()=>{tableRef.current&&tableRef.current.reload()}})]})}]})})}),jsxRuntimeExports.jsx("div",{style:{marginBottom:"1rem"}}),componentIds&&jsxRuntimeExports.jsx(ResultList$1,{project,ref:tableRef,shouldTrigger:!0,software:downstreamData,component_ids:componentIds,operatePipeline,editParams:e=>{if(e.component_id in scriptMap){plot({...scriptMap[e.component_id]});const o=JSON.parse(e.request_param);console.log(o),form.resetFields(),form.setFieldsValue(o),e!=null&&e.analysis_id&&form.setFieldValue("analysis_id",e==null?void 0:e.analysis_id)}},setRecord:e=>{}})]})};export{AnalysisSoftwarePanel as A,UpstreamAnalysisOutput as U,UpstreamAnalysisInput as a};
