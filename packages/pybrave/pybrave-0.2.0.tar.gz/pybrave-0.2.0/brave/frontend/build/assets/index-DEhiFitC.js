import{Z as ze,a0 as Oe,a1 as ae,r as h,a5 as Me,O as G,Y as ke,aj as De,ak as Ae,al as Be,am as Te,an as Ne,ao as Le,ap as Pe,aq as Ve,x as We,A as Re,z as Ge,e as T,j as e,F as b,S as N,I as B,T as Ke,B as F,a as E,g as k,n as He,d as L,M as H,P as R,q as le,i as Je,u as qe,U as Ue,t as Ye,c as Xe,C as Qe,m as J,p as Ze}from"./main-gLMaKCvr.js";import{M as et}from"./index-CjYZg4K2.js";import{C as ce}from"./index-Jdu54dr5.js";import{T as z}from"./index-BrNLqRge.js";import{T as tt,R as q,M as de}from"./index-ByQpjXWK.js";import{S as st}from"./study-page-BLC-2qgz.js";import{T as ue}from"./index-ZwmWfN3I.js";import{F as he}from"./Table-CWRWFg95.js";import{D as nt}from"./index-DDpcHwmR.js";import{KGMLMapSVG as ot}from"./index-Das8pPKs.js";import{S as rt}from"./index-B-_sZvQI.js";import{_ as it}from"./callSuper-DlyBkZi7.js";import{I as at}from"./index-B__zS0KG.js";const V=(s,i,t,n,o)=>({background:s,border:`${ae(n.lineWidth)} ${n.lineType} ${i}`,[`${o}-icon`]:{color:t}}),lt=s=>{const{componentCls:i,motionDurationSlow:t,marginXS:n,marginSM:o,fontSize:r,fontSizeLG:l,lineHeight:a,borderRadiusLG:c,motionEaseInOutCirc:u,withDescriptionIconSize:d,colorText:m,colorTextHeading:p,withDescriptionPadding:x,defaultPadding:f}=s;return{[i]:Object.assign(Object.assign({},Oe(s)),{position:"relative",display:"flex",alignItems:"center",padding:f,wordWrap:"break-word",borderRadius:c,[`&${i}-rtl`]:{direction:"rtl"},[`${i}-content`]:{flex:1,minWidth:0},[`${i}-icon`]:{marginInlineEnd:n,lineHeight:0},"&-description":{display:"none",fontSize:r,lineHeight:a},"&-message":{color:p},[`&${i}-motion-leave`]:{overflow:"hidden",opacity:1,transition:`max-height ${t} ${u}, opacity ${t} ${u},
        padding-top ${t} ${u}, padding-bottom ${t} ${u},
        margin-bottom ${t} ${u}`},[`&${i}-motion-leave-active`]:{maxHeight:0,marginBottom:"0 !important",paddingTop:0,paddingBottom:0,opacity:0}}),[`${i}-with-description`]:{alignItems:"flex-start",padding:x,[`${i}-icon`]:{marginInlineEnd:o,fontSize:d,lineHeight:0},[`${i}-message`]:{display:"block",marginBottom:n,color:p,fontSize:l},[`${i}-description`]:{display:"block",color:m}},[`${i}-banner`]:{marginBottom:0,border:"0 !important",borderRadius:0}}},ct=s=>{const{componentCls:i,colorSuccess:t,colorSuccessBorder:n,colorSuccessBg:o,colorWarning:r,colorWarningBorder:l,colorWarningBg:a,colorError:c,colorErrorBorder:u,colorErrorBg:d,colorInfo:m,colorInfoBorder:p,colorInfoBg:x}=s;return{[i]:{"&-success":V(o,n,t,s,i),"&-info":V(x,p,m,s,i),"&-warning":V(a,l,r,s,i),"&-error":Object.assign(Object.assign({},V(d,u,c,s,i)),{[`${i}-description > pre`]:{margin:0,padding:0}})}}},dt=s=>{const{componentCls:i,iconCls:t,motionDurationMid:n,marginXS:o,fontSizeIcon:r,colorIcon:l,colorIconHover:a}=s;return{[i]:{"&-action":{marginInlineStart:o},[`${i}-close-icon`]:{marginInlineStart:o,padding:0,overflow:"hidden",fontSize:r,lineHeight:ae(r),backgroundColor:"transparent",border:"none",outline:"none",cursor:"pointer",[`${t}-close`]:{color:l,transition:`color ${n}`,"&:hover":{color:a}}},"&-close-text":{color:l,transition:`color ${n}`,"&:hover":{color:a}}}}},ut=s=>({withDescriptionIconSize:s.fontSizeHeading3,defaultPadding:`${s.paddingContentVerticalSM}px 12px`,withDescriptionPadding:`${s.paddingMD}px ${s.paddingContentHorizontalLG}px`}),ht=ze("Alert",s=>[lt(s),ct(s),dt(s)],ut);var Z=function(s,i){var t={};for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&i.indexOf(n)<0&&(t[n]=s[n]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,n=Object.getOwnPropertySymbols(s);o<n.length;o++)i.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(s,n[o])&&(t[n[o]]=s[n[o]]);return t};const mt={success:Pe,info:Le,error:Ne,warning:Te},pt=s=>{const{icon:i,prefixCls:t,type:n}=s,o=mt[n]||null;return i?Be(i,h.createElement("span",{className:`${t}-icon`},i),()=>({className:G(`${t}-icon`,i.props.className)})):h.createElement(o,{className:`${t}-icon`})},ft=s=>{const{isClosable:i,prefixCls:t,closeIcon:n,handleClose:o,ariaProps:r}=s,l=n===!0||n===void 0?h.createElement(Ve,null):n;return i?h.createElement("button",Object.assign({type:"button",onClick:o,className:`${t}-close-icon`,tabIndex:0},r),l):null},me=h.forwardRef((s,i)=>{const{description:t,prefixCls:n,message:o,banner:r,className:l,rootClassName:a,style:c,onMouseEnter:u,onMouseLeave:d,onClick:m,afterClose:p,showIcon:x,closable:f,closeText:j,closeIcon:y,action:v,id:S}=s,w=Z(s,["description","prefixCls","message","banner","className","rootClassName","style","onMouseEnter","onMouseLeave","onClick","afterClose","showIcon","closable","closeText","closeIcon","action","id"]),[g,I]=h.useState(!1),C=h.useRef(null);h.useImperativeHandle(i,()=>({nativeElement:C.current}));const{getPrefixCls:O,direction:P,closable:_,closeIcon:U,className:ye,style:je}=Me("alert"),$=O("alert",n),[be,ve,Se]=ht($),we=M=>{var D;I(!0),(D=s.onClose)===null||D===void 0||D.call(s,M)},Y=h.useMemo(()=>s.type!==void 0?s.type:r?"warning":"info",[s.type,r]),Ce=h.useMemo(()=>typeof f=="object"&&f.closeIcon||j?!0:typeof f=="boolean"?f:y!==!1&&y!==null&&y!==void 0?!0:!!_,[j,y,f,_]),X=r&&x===void 0?!0:x,Ie=G($,`${$}-${Y}`,{[`${$}-with-description`]:!!t,[`${$}-no-icon`]:!X,[`${$}-banner`]:!!r,[`${$}-rtl`]:P==="rtl"},ye,l,a,Se,ve),Fe=ke(w,{aria:!0,data:!0}),Ee=h.useMemo(()=>typeof f=="object"&&f.closeIcon?f.closeIcon:j||(y!==void 0?y:typeof _=="object"&&_.closeIcon?_.closeIcon:U),[y,f,j,U]),_e=h.useMemo(()=>{const M=f??_;if(typeof M=="object"){const{closeIcon:D}=M;return Z(M,["closeIcon"])}return{}},[f,_]);return be(h.createElement(De,{visible:!g,motionName:`${$}-motion`,motionAppear:!1,motionEnter:!1,onLeaveStart:M=>({maxHeight:M.offsetHeight}),onLeaveEnd:p},(M,D)=>{let{className:Q,style:$e}=M;return h.createElement("div",Object.assign({id:S,ref:Ae(C,D),"data-show":!g,className:G(Ie,Q),style:Object.assign(Object.assign(Object.assign({},je),c),$e),onMouseEnter:u,onMouseLeave:d,onClick:m,role:"alert"},Fe),X?h.createElement(pt,{description:t,icon:s.icon,prefixCls:$,type:Y}):null,h.createElement("div",{className:`${$}-content`},o?h.createElement("div",{className:`${$}-message`},o):null,t?h.createElement("div",{className:`${$}-description`},t):null),v?h.createElement("div",{className:`${$}-action`},v):null,h.createElement(ft,{isClosable:Ce,prefixCls:$,closeIcon:Ee,handleClose:we,ariaProps:_e}))}))});let gt=function(s){function i(){var t;return Ge(this,i),t=it(this,i,arguments),t.state={error:void 0,info:{componentStack:""}},t}return We(i,s),Re(i,[{key:"componentDidCatch",value:function(n,o){this.setState({error:n,info:o})}},{key:"render",value:function(){const{message:n,description:o,id:r,children:l}=this.props,{error:a,info:c}=this.state,u=(c==null?void 0:c.componentStack)||null,d=typeof n>"u"?(a||"").toString():n,m=typeof o>"u"?u:o;return a?h.createElement(me,{id:r,type:"error",message:d,description:h.createElement("pre",{style:{fontSize:"0.9em",overflowX:"auto"}},m)}):l}}])}(h.Component);const pe=me;pe.ErrorBoundary=gt;const xt=({type:s,dataMap:i,constDataMap:t,componentMap:n,inputAnalysisMethod:o,dataKey:r,data:l,name:a,component_id:c,inputKey:u,...d})=>{if(!i)return e.jsx("div",{children:"加载中...."});i={...i,...t};const m=n[s];if(!m)return e.jsxs("div",{children:["未知类型 ",s]});const{Component:p,dataKey:x,...f}=m;console.log(f);let j=[];return l?j=l:o?j=i[o]:r?r in i&&(j=i[r]):x?x in i&&(j=i[x]):"first_data_key"in i?j=i[i.first_data_key]:c in i&&(j=i[c]),e.jsx(p,{...f,...d,data:j,name:a})},K=h.memo(({formJson:s,dataMap:i})=>{if(!s)return null;const{projectObj:t}=T(),r={rank:[{label:"SGB",value:"SGB"},{label:"SPECIES",value:"SPECIES"},{label:"GENUS",value:"GENUS"},{label:"FAMILY",value:"FAMILY"},{label:"ORDER",value:"ORDER"},{label:"CLASS",value:"CLASS"},{label:"PHYLUM",value:"PHYLUM"}],group_field:t!=null&&t.metadata_form?t==null?void 0:t.metadata_form.map(a=>({label:a.label,value:a.name})):[]},l={GroupSelect:{Component:W,dataKey:"sample_group_list"},Input:{Component:vt},GroupCompareSelect:{Component:bt},BaseSelect:{Component:W},BaseInputNumber:{Component:Ct},BaseInput:{Component:St},BaseSwitch:{Component:wt},RankSelect:{Component:W,dataKey:"rank",mode:void 0,initialValue:"SPECIES"},GroupFieldSelect:{Component:W,dataKey:"group_field",mode:void 0,initialValue:"group"},FilterFieldSelect:{Component:yt,dataKey:"sample_group_list",mode:void 0},GroupSelectSampleButton:{Component:It},MetaphlanCladeSelect:{Component:jt},SelectAll:{Component:Ft,dataKey:"sample_group_list"}};return e.jsx(e.Fragment,{children:s.map((a,c)=>e.jsx(xt,{...a,dataMap:i,componentMap:l,constDataMap:r},c))})},(s,i)=>(console.log("prevProps==nextProps: ",JSON.stringify(s)===JSON.stringify(i)),JSON.stringify(s)===JSON.stringify(i))),yt=({label:s,name:i,data:t,rules:n,field:o,...r})=>{const[l,a]=h.useState(),c=b.useFormInstance();return h.useEffect(()=>{if(t&&o){const u=[...new Set(t.map(o))],d=u.map(m=>({label:m,value:m}));a(d),c.setFieldValue(i,u[0])}},[t]),e.jsx(e.Fragment,{children:e.jsx(b.Item,{label:s,name:i,rules:n,children:e.jsx(fe,{...r,options:l})})})},fe=({options:s,clear:i,value:t,onChange:n,...o})=>{const r=b.useFormInstance(),l=a=>{n(a),i&&r.resetFields(i)};return e.jsx(N,{showSearch:!0,filterOption:(a,c)=>((c==null?void 0:c.label)??"").toLowerCase().includes(a.toLowerCase()),...o,options:s,value:t,onChange:l})},jt=({label:s,name:i,data:t,initialValue:n,rules:o,...r})=>{const[l,a]=h.useState(),c=async()=>{let d=(await E.get("/fast-api/get_metaphlan_clade")).data.map(m=>({label:`${m.taxon.replaceAll(" ","_")}_${m.clade}`,value:m.clade}));a(d)};return h.useEffect(()=>{c()},[]),e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:o,children:e.jsx(N,{...r,options:l,showSearch:!0,filterOption:(u,d)=>((d==null?void 0:d.label)??"").toLowerCase().includes(u.toLowerCase())})})})},bt=({label:s,name:i,data:t,initialValue:n,rules:o,...r})=>{const l=b.useFormInstance(),a=b.useWatch(["sites1","group"],l),c=b.useWatch(["sites2","group"],l),[u,d]=h.useState();return h.useEffect(()=>{a&&c&&d([{label:"Prevalent in both sites",value:"Prevalent in both sites"},{label:`Prevalent in ${c.join("-")}`,value:`Prevalent in ${c.join("-")}`},{label:`Prevalent in ${a.join("-")}`,value:`Prevalent in ${a.join("-")}`},{label:"Not prevalent in either sites",value:"Not prevalent in either sites"}])},[a,c]),e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:o,children:e.jsx(N,{showSearch:!0,filterOption:(m,p)=>((p==null?void 0:p.label)??"").toLowerCase().includes(m.toLowerCase()),...r,options:u})})})},vt=({label:s,name:i,data:t,initialValue:n,rules:o,...r})=>e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:o,children:e.jsx(Ke,{...r})})}),St=({label:s,name:i,data:t,initialValue:n,rules:o,...r})=>e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:o,children:e.jsx(B,{...r})})}),wt=({label:s,name:i,data:t,initialValue:n,rules:o,...r})=>e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:o,children:e.jsx(st,{...r})})}),Ct=({label:s,name:i,data:t,initialValue:n,rules:o,...r})=>e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:o,children:e.jsx(tt,{...r})})}),W=({label:s,name:i,data:t,initialValue:n,rules:o,...r})=>e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n||null,label:s,name:i,rules:o,children:e.jsx(fe,{...r,options:t})})}),It=({label:s,name:i,rules:t,data:n,filter:o,group:r,groupField:l})=>{const[a,c]=h.useState(),[u,d]=h.useState([]),m=b.useFormInstance();let p=[];o&&(p=o.map(y=>y.name));const x=b.useWatch(y=>{const v=Object.entries(y).filter(([S])=>p.includes(S));return Object.fromEntries(v)},m),f=b.useWatch(r,m),j=(y,v)=>{const S=y.reduce((w,g)=>{const I=g[v];return w[I]||(w[I]=[]),w[I].push(g.value),w},{});c(S)};return h.useEffect(()=>{o&&x&&(n=o.reduce((y,v)=>y.filter(S=>v.method(S)===x[v.name]),n),n=n.map(y=>{const{label:v,id:S,value:w,...g}=y;return{label:`${y.label}(${o[0].method(y)})`,value:y.value,...g}})),n&&l?j(n,l):n&&f&&j(n,f),d(n)},[n,f,x]),e.jsxs(e.Fragment,{children:[e.jsx(b.Item,{label:s,name:[i,"sample"],rules:t,children:e.jsx(_t,{sampleGrouped:a,sampleGroup:u,watch:[i,"group"]})}),e.jsx(b.Item,{label:s,name:[i,"group"],children:e.jsx($t,{sampleGrouped:a})})]})},Ft=({label:s,name:i,data:t,initialValue:n,rules:o,...r})=>e.jsx(e.Fragment,{children:e.jsx(b.Item,{initialValue:n,label:s,name:i,rules:o,children:e.jsx(Et,{data:t,...r})})}),Et=({data:s,value:i,onChange:t,mode:n,...o})=>{const[r,l]=h.useState(i),a=c=>{console.log(c),t(c),l(c)};return e.jsxs(e.Fragment,{children:[e.jsx(N,{...o,mode:n,value:r,onChange:a,allowClear:!0,options:s}),n=="multiple"&&e.jsxs(F,{onClick:()=>{const c=s.map(u=>u.value);l(c),t(c)},children:["选择全部",r&&e.jsxs(e.Fragment,{children:["(",r.length,")"]})]})]})},_t=({value:s,onChange:i,sampleGroup:t,watch:n,sampleGrouped:o})=>{const[r,l]=h.useState(),a=b.useFormInstance(),c=b.useWatch(n,a);h.useEffect(()=>{l(c)},[c]);const u=d=>{const m=Object.entries(o||{}).filter(([p])=>d.includes(p)).flatMap(([,p])=>p);i(m)};return h.useEffect(()=>{r&&u(r)},[r]),e.jsxs(e.Fragment,{children:[e.jsx(N,{showSearch:!0,filterOption:(d,m)=>((m==null?void 0:m.label)??"").toLowerCase().includes(d.toLowerCase()),mode:"multiple",value:s,onChange:i,options:t}),s&&e.jsxs(e.Fragment,{children:["一共选择",s.length,"个样本"]})]})},$t=({value:s,onChange:i,sampleGrouped:t})=>{const n=o=>{if((s||[]).includes(o)){const r=(s||[]).filter(l=>!l.includes(o));i(r)}else{const r=[...s||[],o];i(r)}};return e.jsx(e.Fragment,{children:e.jsx(k,{gap:"small",wrap:!0,children:Object.entries(t||{}).map(([o,r])=>e.jsx("span",{children:e.jsxs(F,{size:"small",type:(s||[]).includes(o)?"primary":"dashed",onClick:()=>n(o),children:[o,"(",r.length,")"]})},o))})})},vs=async s=>await E.get("/file-operation/read-file",{params:{file_path:s}}),zt=async(s,i=0)=>await E.get("/file-operation/read-log-file",{params:{file_path:s,offset:i}}),Ss=async(s,i)=>await E.post("/file-operation/write-file",{file_path:s,content:i}),ws=async s=>await E.get(`/find-analysis-by-id/${s}`),Ot=async(s,i)=>await E.post(`/run-analysis-v2/${s}?run_type=${i}`),Mt=async s=>await E.post(`/analysis/stop-analysis/${s}`);function A(s,i,t){let n=t.initialDeps??[],o;function r(){var l,a,c,u;let d;t.key&&((l=t.debug)!=null&&l.call(t))&&(d=Date.now());const m=s();if(!(m.length!==n.length||m.some((f,j)=>n[j]!==f)))return o;n=m;let x;if(t.key&&((a=t.debug)!=null&&a.call(t))&&(x=Date.now()),o=i(...m),t.key&&((c=t.debug)!=null&&c.call(t))){const f=Math.round((Date.now()-d)*100)/100,j=Math.round((Date.now()-x)*100)/100,y=j/16,v=(S,w)=>{for(S=String(S);S.length<w;)S=" "+S;return S};console.info(`%c⏱ ${v(j,5)} /${v(f,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*y,120))}deg 100% 31%);`,t==null?void 0:t.key)}return(u=t==null?void 0:t.onChange)==null||u.call(t,o),o}return r.updateDeps=l=>{n=l},r}function ee(s,i){if(s===void 0)throw new Error("Unexpected undefined");return s}const kt=(s,i)=>Math.abs(s-i)<1.01,Dt=(s,i,t)=>{let n;return function(...o){s.clearTimeout(n),n=s.setTimeout(()=>i.apply(this,o),t)}},te=s=>{const{offsetWidth:i,offsetHeight:t}=s;return{width:i,height:t}},At=s=>s,Bt=s=>{const i=Math.max(s.startIndex-s.overscan,0),t=Math.min(s.endIndex+s.overscan,s.count-1),n=[];for(let o=i;o<=t;o++)n.push(o);return n},Tt=(s,i)=>{const t=s.scrollElement;if(!t)return;const n=s.targetWindow;if(!n)return;const o=l=>{const{width:a,height:c}=l;i({width:Math.round(a),height:Math.round(c)})};if(o(te(t)),!n.ResizeObserver)return()=>{};const r=new n.ResizeObserver(l=>{const a=()=>{const c=l[0];if(c!=null&&c.borderBoxSize){const u=c.borderBoxSize[0];if(u){o({width:u.inlineSize,height:u.blockSize});return}}o(te(t))};s.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(a):a()});return r.observe(t,{box:"border-box"}),()=>{r.unobserve(t)}},se={passive:!0},ne=typeof window>"u"?!0:"onscrollend"in window,Nt=(s,i)=>{const t=s.scrollElement;if(!t)return;const n=s.targetWindow;if(!n)return;let o=0;const r=s.options.useScrollendEvent&&ne?()=>{}:Dt(n,()=>{i(o,!1)},s.options.isScrollingResetDelay),l=d=>()=>{const{horizontal:m,isRtl:p}=s.options;o=m?t.scrollLeft*(p&&-1||1):t.scrollTop,r(),i(o,d)},a=l(!0),c=l(!1);c(),t.addEventListener("scroll",a,se);const u=s.options.useScrollendEvent&&ne;return u&&t.addEventListener("scrollend",c,se),()=>{t.removeEventListener("scroll",a),u&&t.removeEventListener("scrollend",c)}},Lt=(s,i,t)=>{if(i!=null&&i.borderBoxSize){const n=i.borderBoxSize[0];if(n)return Math.round(n[t.options.horizontal?"inlineSize":"blockSize"])}return s[t.options.horizontal?"offsetWidth":"offsetHeight"]},Pt=(s,{adjustments:i=0,behavior:t},n)=>{var o,r;const l=s+i;(r=(o=n.scrollElement)==null?void 0:o.scrollTo)==null||r.call(o,{[n.options.horizontal?"left":"top"]:l,behavior:t})};class Vt{constructor(i){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let t=null;const n=()=>t||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:t=new this.targetWindow.ResizeObserver(o=>{o.forEach(r=>{const l=()=>{this._measureElement(r.target,r)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(l):l()})}));return{disconnect:()=>{var o;(o=n())==null||o.disconnect(),t=null},observe:o=>{var r;return(r=n())==null?void 0:r.observe(o,{box:"border-box"})},unobserve:o=>{var r;return(r=n())==null?void 0:r.unobserve(o)}}})(),this.range=null,this.setOptions=t=>{Object.entries(t).forEach(([n,o])=>{typeof o>"u"&&delete t[n]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:At,rangeExtractor:Bt,onChange:()=>{},measureElement:Lt,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...t}},this.notify=t=>{var n,o;(o=(n=this.options).onChange)==null||o.call(n,this,t)},this.maybeNotify=A(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),t=>{this.notify(t)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(t=>t()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var t;const n=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==n){if(this.cleanup(),!n){this.maybeNotify();return}this.scrollElement=n,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((t=this.scrollElement)==null?void 0:t.window)??null,this.elementsCache.forEach(o=>{this.observer.observe(o)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,o=>{this.scrollRect=o,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(o,r)=>{this.scrollAdjustments=0,this.scrollDirection=r?this.getScrollOffset()<o?"forward":"backward":null,this.scrollOffset=o,this.isScrolling=r,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(t,n)=>{const o=new Map,r=new Map;for(let l=n-1;l>=0;l--){const a=t[l];if(o.has(a.lane))continue;const c=r.get(a.lane);if(c==null||a.end>c.end?r.set(a.lane,a):a.end<c.end&&o.set(a.lane,!0),o.size===this.options.lanes)break}return r.size===this.options.lanes?Array.from(r.values()).sort((l,a)=>l.end===a.end?l.index-a.index:l.end-a.end)[0]:void 0},this.getMeasurementOptions=A(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(t,n,o,r,l)=>(this.pendingMeasuredCacheIndexes=[],{count:t,paddingStart:n,scrollMargin:o,getItemKey:r,enabled:l}),{key:!1}),this.getMeasurements=A(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:t,paddingStart:n,scrollMargin:o,getItemKey:r,enabled:l},a)=>{if(!l)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(d=>{this.itemSizeCache.set(d.key,d.size)}));const c=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const u=this.measurementsCache.slice(0,c);for(let d=c;d<t;d++){const m=r(d),p=this.options.lanes===1?u[d-1]:this.getFurthestMeasurement(u,d),x=p?p.end+this.options.gap:n+o,f=a.get(m),j=typeof f=="number"?f:this.options.estimateSize(d),y=x+j,v=p?p.lane:d%this.options.lanes;u[d]={index:d,start:x,size:j,end:y,key:m,lane:v}}return this.measurementsCache=u,u},{key:!1,debug:()=>this.options.debug}),this.calculateRange=A(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(t,n,o,r)=>this.range=t.length>0&&n>0?Wt({measurements:t,outerSize:n,scrollOffset:o,lanes:r}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=A(()=>{let t=null,n=null;const o=this.calculateRange();return o&&(t=o.startIndex,n=o.endIndex),this.maybeNotify.updateDeps([this.isScrolling,t,n]),[this.options.rangeExtractor,this.options.overscan,this.options.count,t,n]},(t,n,o,r,l)=>r===null||l===null?[]:t({startIndex:r,endIndex:l,overscan:n,count:o}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=t=>{const n=this.options.indexAttribute,o=t.getAttribute(n);return o?parseInt(o,10):(console.warn(`Missing attribute name '${n}={index}' on measured element.`),-1)},this._measureElement=(t,n)=>{const o=this.indexFromElement(t),r=this.measurementsCache[o];if(!r)return;const l=r.key,a=this.elementsCache.get(l);a!==t&&(a&&this.observer.unobserve(a),this.observer.observe(t),this.elementsCache.set(l,t)),t.isConnected&&this.resizeItem(o,this.options.measureElement(t,n,this))},this.resizeItem=(t,n)=>{const o=this.measurementsCache[t];if(!o)return;const r=this.itemSizeCache.get(o.key)??o.size,l=n-r;l!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(o,l,this):o.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=l,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(o.index),this.itemSizeCache=new Map(this.itemSizeCache.set(o.key,n)),this.notify(!1))},this.measureElement=t=>{if(!t){this.elementsCache.forEach((n,o)=>{n.isConnected||(this.observer.unobserve(n),this.elementsCache.delete(o))});return}this._measureElement(t,void 0)},this.getVirtualItems=A(()=>[this.getVirtualIndexes(),this.getMeasurements()],(t,n)=>{const o=[];for(let r=0,l=t.length;r<l;r++){const a=t[r],c=n[a];o.push(c)}return o},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=t=>{const n=this.getMeasurements();if(n.length!==0)return ee(n[ge(0,n.length-1,o=>ee(n[o]).start,t)])},this.getOffsetForAlignment=(t,n,o=0)=>{const r=this.getSize(),l=this.getScrollOffset();n==="auto"&&(n=t>=l+r?"end":"start"),n==="center"?t+=(o-r)/2:n==="end"&&(t-=r);const a=this.getTotalSize()+this.options.scrollMargin-r;return Math.max(Math.min(a,t),0)},this.getOffsetForIndex=(t,n="auto")=>{t=Math.max(0,Math.min(t,this.options.count-1));const o=this.measurementsCache[t];if(!o)return;const r=this.getSize(),l=this.getScrollOffset();if(n==="auto")if(o.end>=l+r-this.options.scrollPaddingEnd)n="end";else if(o.start<=l+this.options.scrollPaddingStart)n="start";else return[l,n];const a=n==="end"?o.end+this.options.scrollPaddingEnd:o.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(a,n,o.size),n]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(t,{align:n="start",behavior:o}={})=>{o==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(t,n),{adjustments:void 0,behavior:o})},this.scrollToIndex=(t,{align:n="auto",behavior:o}={})=>{o==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),t=Math.max(0,Math.min(t,this.options.count-1));let r=0;const l=10,a=u=>{if(!this.targetWindow)return;const d=this.getOffsetForIndex(t,u);if(!d){console.warn("Failed to get offset for index:",t);return}const[m,p]=d;this._scrollToOffset(m,{adjustments:void 0,behavior:o}),this.targetWindow.requestAnimationFrame(()=>{const x=this.getScrollOffset(),f=this.getOffsetForIndex(t,p);if(!f){console.warn("Failed to get offset for index:",t);return}kt(f[0],x)||c(p)})},c=u=>{this.targetWindow&&(r++,r<l?this.targetWindow.requestAnimationFrame(()=>a(u)):console.warn(`Failed to scroll to index ${t} after ${l} attempts.`))};a(n)},this.scrollBy=(t,{behavior:n}={})=>{n==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+t,{adjustments:void 0,behavior:n})},this.getTotalSize=()=>{var t;const n=this.getMeasurements();let o;if(n.length===0)o=this.options.paddingStart;else if(this.options.lanes===1)o=((t=n[n.length-1])==null?void 0:t.end)??0;else{const r=Array(this.options.lanes).fill(null);let l=n.length-1;for(;l>=0&&r.some(a=>a===null);){const a=n[l];r[a.lane]===null&&(r[a.lane]=a.end),l--}o=Math.max(...r.filter(a=>a!==null))}return Math.max(o-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(t,{adjustments:n,behavior:o})=>{this.options.scrollToFn(t,{behavior:o,adjustments:n},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(i)}}const ge=(s,i,t,n)=>{for(;s<=i;){const o=(s+i)/2|0,r=t(o);if(r<n)s=o+1;else if(r>n)i=o-1;else return o}return s>0?s-1:0};function Wt({measurements:s,outerSize:i,scrollOffset:t,lanes:n}){const o=s.length-1,r=c=>s[c].start;if(s.length<=n)return{startIndex:0,endIndex:o};let l=ge(0,o,r,t),a=l;if(n===1)for(;a<o&&s[a].end<t+i;)a++;else if(n>1){const c=Array(n).fill(0);for(;a<o&&c.some(d=>d<t+i);){const d=s[a];c[d.lane]=d.end,a++}const u=Array(n).fill(t+i);for(;l>=0&&u.some(d=>d>=t);){const d=s[l];u[d.lane]=d.start,l--}l=Math.max(0,l-l%n),a=Math.min(o,a+(n-1-a%n))}return{startIndex:l,endIndex:a}}const oe=typeof document<"u"?h.useLayoutEffect:h.useEffect;function Rt(s){const i=h.useReducer(()=>({}),{})[1],t={...s,onChange:(o,r)=>{var l;r?He.flushSync(i):i(),(l=s.onChange)==null||l.call(s,o,r)}},[n]=h.useState(()=>new Vt(t));return n.setOptions(t),oe(()=>n._didMount(),[]),oe(()=>n._willUpdate()),n}function Gt(s){return Rt({observeElementRect:Tt,observeElementOffset:Nt,scrollToFn:Pt,...s})}const{Text:re}=L,Kt=({file_path:s})=>{var u;h.useEffect(()=>{console.log("fileKey",s),s&&r(s)},[s]);const{messageApi:i}=T(),t=h.useRef(0),[n,o]=h.useState([]),r=async(d,m=!1)=>{const p=await zt(d);t.current=p.data.offset,o(p.data.content),m&&i.success(`日志加载成功: ${d}`)},l=h.useRef(null),a=Gt({count:n.length,getScrollElement:()=>l.current,estimateSize:()=>30,overscan:10});h.useEffect(()=>{(n==null?void 0:n.length)>0&&a.scrollToIndex(n.length-1,{align:"end",behavior:"smooth"})},[n==null?void 0:n.length]);const c=a.getVirtualItems();return e.jsx(ce,{size:"small",extra:e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>{r(s)},children:"刷新日志"}),title:e.jsxs(k,{gap:"small",wrap:"wrap",children:[e.jsxs(z,{color:"blue",children:["文件: ",s]}),e.jsxs(z,{color:"purple",children:["偏移量: ",t.current]})]}),bodyStyle:{padding:0},children:e.jsx("div",{ref:l,style:{height:400,overflowY:"auto",fontFamily:"monospace",backgroundColor:"#1e1e1e",color:"#d4d4d4",padding:"0 12px"},children:e.jsx("div",{style:{height:a.getTotalSize(),width:"100%",position:"relative"},children:e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${((u=c[0])==null?void 0:u.start)??0}px)`},children:c.map(d=>e.jsx("div",{"data-index":d.index,ref:a.measureElement,style:{padding:"4px 0",borderBottom:"1px solid #333"},children:e.jsxs(k,{gap:"middle",children:[e.jsxs(re,{type:"secondary",style:{width:60,color:"#d4d4d4"},children:["#",d.index+1]}),e.jsx(re,{style:{whiteSpace:"pre-wrap",color:"#d4d4d4"},children:n[d.index]})]})},d.key))})})})})},Ht=({visible:s,onClose:i,params:t})=>e.jsx(H,{footer:null,title:"参数",width:"50%",open:s,onCancel:i,children:e.jsx(L,{children:e.jsx("pre",{children:JSON.stringify(t,null,2)})})}),Jt=({formJson:s,openModal:i})=>{if(!s)return null;const[t,n]=h.useState([]),o=async()=>{const r=s.map(c=>c.dataKey),a=((await E.post("/list-bio-database",{type_list:r})).data||[]).reduce((c,u)=>{const d=u.type;c[d]||(c[d]=[]);const{name:m,database_id:p,...x}=u;return c[d].push({label:m,value:p,...x}),c},{});n(a),console.log(a)};return h.useEffect(()=>{o()},[s]),e.jsx(e.Fragment,{children:e.jsxs(k,{gap:"small",children:[e.jsx("div",{style:{flex:1},children:e.jsx(K,{formJson:s,dataMap:t})}),e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:i,children:"配置数据库"}),e.jsx(F,{onClick:o,size:"small",type:"primary",children:"刷新"})]})})},qt=({visible:s,onClose:i,params:t,callback:n})=>{if(!s)return null;const[o,r]=h.useState([]),[l,a]=h.useState(!1),[c]=b.useForm(),[u,d]=h.useState(t[0].dataKey),[m,p]=h.useState(null),x=async g=>{a(!0);const I=await E.post("/list-bio-database",g);r(I.data),a(!1)},f=async()=>({...await c.validateFields(),type:u}),j=async()=>{const g=await f();m?await E.post("/update-bio-database",{...g,database_id:m.database_id}):await E.post("/add-bio-database",g),y(),p(void 0),c.resetFields()},y=()=>{x({type:u})};h.useEffect(()=>{x({type:u})},[t]);const v=g=>{d(g),x({type:g})},S=async g=>{await E.delete(`/delete-bio-database/${g.id}`),y()},w=g=>{c.setFieldsValue(g),p(g)};return e.jsxs(H,{title:"数据库操作",open:s,onCancel:i,width:"50%",footer:null,children:[e.jsx(ue,{tabBarExtraContent:e.jsxs(e.Fragment,{children:[e.jsx(F,{size:"small",color:"cyan",variant:"solid",style:{marginRight:"0.5rem"},type:"primary",onClick:y,children:" 刷新"}),e.jsxs(F,{size:"small",color:"cyan",variant:"solid",type:"primary",onClick:()=>{p(void 0),j()},children:[" ",m?"更新":"添加"]})]}),activeKey:u,onChange:v,items:t.map(g=>({key:g.name,label:g.label,children:e.jsx("div",{})}))}),e.jsxs(b,{form:c,style:{maxWidth:600},labelCol:{span:3},children:[e.jsx(b.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:e.jsx(B,{})}),e.jsx(b.Item,{name:"path",label:"路径",rules:[{required:!0,message:"请输入路径"}],children:e.jsx(B,{})}),e.jsx(b.Item,{name:"db_index",label:"索引",children:e.jsx(B,{})})]}),e.jsx(he,{dataSource:o,columns:[{title:"名称",dataIndex:"name",key:"name"},{title:"数据库ID",dataIndex:"database_id",key:"database_id"},{title:"类型",dataIndex:"type",key:"type"},{title:"路径",dataIndex:"path",key:"path"},{title:"索引",dataIndex:"db_index",key:"db_index"},{title:"操作",dataIndex:"action",key:"action",ellipsis:!0,render:(g,I)=>e.jsxs(k,{gap:"small",children:[e.jsx(R,{title:"确定删除吗？",onConfirm:()=>{S(I)},children:e.jsx(F,{size:"small",type:"primary",danger:!0,children:"删除"})}),e.jsx(F,{size:"small",type:"primary",onClick:()=>{w(I)},children:"编辑"})]})}],loading:l,pagination:!1})]})},Ut=({visible:s,params:i,onClose:t,callback:n})=>{var y,v,S;const[o]=b.useForm(),{messageApi:r,project:l}=T();h.useEffect(()=>{s&&f()},[i]);const[a,c]=h.useState(),[u,d]=h.useState(),m=()=>{t(),n&&n()},[p,x]=h.useState(),f=async()=>{x(!0);const w=await E.post(`/analysis/edit-params/${i}`);c(w.data),d(w.data.analysis_result),o.resetFields(),o.setFieldsValue(w.data.request_param),x(!1)},j=w=>{if(w&&Object.keys(w).length>0)return Object.keys(w)[0]};return e.jsx(e.Fragment,{children:e.jsx(nt,{size:"default",loading:p,title:e.jsx(e.Fragment,{children:a&&e.jsxs(e.Fragment,{children:[e.jsx(z,{children:a==null?void 0:a.component_name}),e.jsx(z,{children:a==null?void 0:a.analysis_name}),e.jsx(z,{children:String(a==null?void 0:a.analysis_id).slice(0,8)})]})}),width:"50%",open:s,onClose:t,children:a&&e.jsx(e.Fragment,{children:e.jsx(Yt,{form:o,requestParam:{...a.request_param,analysis_id:a==null?void 0:a.analysis_id},dataMap:{...u,first_data_key:j(u)},formJson:[...((y=a.content)==null?void 0:y.formJson)||[],...((v=a.content)==null?void 0:v.upstreamFormJson)||[],...(a==null?void 0:a.inputFormJson)||[]],databases:(S=a.content)==null?void 0:S.databases,upstreamFormJson:a==null?void 0:a.upstreamFormJson,callback:m})})})})},Yt=({form:s,requestParam:i,dataMap:t,formJson:n,databases:o,callback:r,showCancal:l=!1})=>{const{modals:a,openModals:c,closeModals:u}=le(["paramsView","bioDatabases"]),[d,m]=h.useState([]),[p,x]=h.useState([]),{messageApi:f,projectList:j,project:y}=T();h.useEffect(()=>{v()},[JSON.stringify(n)]);const v=()=>{if(Array.isArray(n)){const g=n.filter(C=>!(C!=null&&C.required)&&!(C!=null&&C.db)&&!C.component_id),I=n.filter(C=>(C==null?void 0:C.required)||(C==null?void 0:C.db)||C.component_id);m(I),x(g)}},S=g=>({...i,...g}),w=async(g,I=!1)=>{var P;const C=await s.validateFields(),O=S(C);try{const _=await E.post(`/fast-api/analysis-controller?save=${g}&is_submit=${I}`,O);console.log(_),g?(f.success("执行成功!"),r&&r()):c("paramsView",_.data)}catch(_){console.log(_),(P=_.response)!=null&&P.data&&f.error(_.response.data.detail)}};return e.jsxs(e.Fragment,{children:[e.jsxs(b,{form:s,onValuesChange:(g,I)=>{},children:[e.jsx(ue,{items:[{key:"1",label:"必填参数",forceRender:!0,children:e.jsxs(e.Fragment,{children:[e.jsx(K,{formJson:[...d],dataMap:t}),o&&e.jsx(Jt,{openModal:()=>{c("bioDatabases",o)},formJson:o})]})},{key:"2",label:"可选参数",forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(K,{formJson:[...p],dataMap:{}})})}]}),e.jsx(b.Item,{label:"分析名称",name:"analysis_name",style:{maxWidth:600},rules:[{required:!0,message:"该字段不能为空!"}],children:e.jsx(B,{})}),e.jsxs(k,{gap:"small",children:[e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w(!1)},children:"查看参数"}),e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>w(!0),children:i!=null&&i.analysis_id?e.jsxs(e.Fragment,{children:["更新分析(",i.analysis_name,")(",String(i.analysis_id).slice(0,8),")"]}):e.jsx(e.Fragment,{children:"保存分析"})}),(i==null?void 0:i.analysis_id)&&l&&e.jsx(F,{size:"small",color:"cyan",onClick:()=>s.setFieldValue("analysis_id",void 0),children:"取消更新"})]}),e.jsx(Je,{ghost:!0,items:[{key:"1",label:"更多",children:e.jsx(e.Fragment,{children:e.jsx(b.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(L,{children:e.jsx("pre",{children:JSON.stringify(S(s.getFieldsValue()),null,2)})})})})}]})]}),e.jsx(Ht,{visible:a.paramsView.visible,onClose:()=>u("paramsView"),params:a.paramsView.params}),e.jsx(qt,{visible:a.bioDatabases.visible,onClose:()=>u("bioDatabases"),params:a.bioDatabases.params})]})},xe=({data:s,url:i,filename:t,columns:n})=>{const{Search:o}=B,[r,l]=h.useState([]),a=c=>c?Object.keys(c).map(u=>({title:u,dataIndex:u,key:u,ellipsis:!0,width:150})):[];return h.useEffect(()=>{if(s){const c=s.map((u,d)=>({...u,key:d}));l(c)}},[s]),e.jsx(e.Fragment,{children:Array.isArray(r)&&e.jsx(e.Fragment,{children:e.jsx(he,{style:{border:"1px solid #f0f0f0"},size:"small",title:()=>e.jsxs(k,{gap:"small",children:[e.jsx(o,{size:"small",placeholder:"input search text",allowClear:!0,onSearch:c=>{const u=s.filter(d=>Object.values(d).some(m=>typeof m=="string"&&m.includes(c)));l(u)},style:{width:304}}),i&&e.jsx(J,{title:`${window.location.origin}${i}`,children:e.jsxs(z,{color:"success",style:{cursor:"pointer"},onClick:()=>{window.open(`${i}?t=${Date.now()}`,"_blank")},children:[t," ",e.jsx(q,{})]})})]}),scroll:{x:"max-content",y:55*5},dataSource:r,pagination:!1,virtual:!0,columns:n||a(s[0]),footer:()=>`一共${s.length}条记录`})})})},ie=({data:s,url:i,filename:t})=>e.jsx("div",{children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx(at,{src:t!=null&&t.endsWith("pdf")?s:`${s}?t=${Date.now()}`,style:{maxWidth:"20rem",marginRight:"0.5rem"}}),i&&e.jsx(J,{title:`${window.location.origin}${i}`,children:e.jsxs(z,{color:"success",style:{cursor:"pointer"},onClick:()=>{window.open(`${i}?t=${Date.now()}`,"_blank")},children:[t," ",e.jsx(q,{})]})})]})}),{Paragraph:Cs}=L,Xt=({data:s})=>e.jsx(e.Fragment,{children:e.jsx(de,{value:s})}),Qt=({data:s})=>e.jsx("div",{children:e.jsx(pe,{closable:!0,message:s,type:"info",showIcon:!0})}),Zt=({data:s})=>e.jsx(e.Fragment,{children:e.jsx(L,{children:e.jsx("pre",{style:{margin:0},children:s})})}),es=({data:s})=>e.jsx(e.Fragment,{children:e.jsx(de,{value:s,defaultLanguage:"json"})}),ts=({data:s})=>e.jsx(e.Fragment,{children:s&&s.startsWith("/brave")?e.jsx(e.Fragment,{children:e.jsx("iframe",{src:s,width:"100%",style:{height:"80vh",border:"none"}})}):e.jsx(e.Fragment,{children:s})}),ss=({url:s,filename:i})=>e.jsx(e.Fragment,{children:s&&e.jsx(J,{title:`${window.location.origin}${s}`,children:e.jsxs(z,{color:"success",style:{cursor:"pointer"},onClick:()=>{window.open(`${s}?t=${Date.now()}`,"_blank")},children:[i," ",e.jsx(q,{})]})})}),ns=({data:s,...i})=>{var r,l,a,c,u;const{modal:t,openModal:n,closeModal:o}=Ze();return e.jsxs(e.Fragment,{children:[e.jsx(xe,{data:s==null?void 0:s.list,...i,columns:[{title:"ID",dataIndex:"ID",key:"ID",ellipsis:!0,width:150},{title:"Description",dataIndex:"Description",key:"Description",ellipsis:!0,width:400},{title:"GeneRatio",dataIndex:"GeneRatio",key:"GeneRatio",ellipsis:!0,width:150},{title:"geneID",dataIndex:"geneID",key:"geneID",ellipsis:!0,width:150},{title:"Count",dataIndex:"Count",key:"Count",ellipsis:!0,width:150},{title:"pvalue",dataIndex:"pvalue",key:"pvalue",ellipsis:!0,width:150},{title:"p.adjust",dataIndex:"p.adjust",key:"p.adjust",ellipsis:!0,width:150},{title:"qvalue",dataIndex:"qvalue",key:"qvalue",ellipsis:!0,width:150},{title:"organism",dataIndex:"organism",key:"organism",ellipsis:!0,width:150},{title:"pathwayId",dataIndex:"pathwayId",key:"pathwayId",ellipsis:!0,width:150},{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(d,m)=>e.jsx(e.Fragment,{children:e.jsx(F,{onClick:()=>{n("KGMLMapSVG",m)},size:"small",color:"cyan",variant:"solid",children:"pathview"})})}]}),t.visible&&e.jsx(H,{width:"80%",title:`${(r=t.params)==null?void 0:r.Description}(${(l=t.params)==null?void 0:l.ID})`,footer:null,onCancel:o,onClose:o,open:t.visible&&t.key=="KGMLMapSVG",children:e.jsx(ot,{compound:s==null?void 0:s.compound,highlightKeys:(a=t.params)==null?void 0:a.geneID.split("/"),pathwayId:(c=t.params)==null?void 0:c.pathwayId,organisms:(u=t.params)==null?void 0:u.organism})})]})},os={table:xe,string:Xt,html:ts,json:es,text:Zt,info:Qt,kegg_map:ns,download:ss},rs=({type:s,...i})=>{const t=os[s]||(()=>e.jsxs("div",{children:["未知类型 ",s]}));return e.jsx("div",{style:{marginBottom:"1rem"},children:e.jsx(t,{...i})})},Is=h.forwardRef(({params:s,visible:i,onClose:t},n)=>{const{output_dir:o,analysis_id:r}=s||{};return i?e.jsx(e.Fragment,{children:r&&e.jsx(is,{onClose:t,analysis_id:r})}):null}),is=({analysis_id:s,onClose:i,cancalReportCallback:t})=>{var S,w;const[n,o]=h.useState(!1),[r,l]=h.useState(null),a=qe(),{eventSourceRef:c,status:u,reconnect:d}=Ue(),m=h.useRef(null),p=h.useRef(null),{messageApi:x}=T(),{modals:f,openModals:j,closeModals:y}=le(["editParams"]),v=async g=>{o(!0);const I=await E.get(`/analysis/visualization-results/${g}`);l(I.data),m.current=g,o(!1)};return h.useEffect(()=>{v(s)},[s]),h.useEffect(()=>{var g;if(c){const I=C=>{const O=JSON.parse(C.data);p.current=O,m.current==O.analysis_id&&(O.event=="analysis_complete"||O.event=="analysis_failed"||O.event=="analysis_started")&&v(m.current)};return(g=c.current)==null||g.addEventListener("message",I),()=>{var C;console.log("removeEventListener"),(C=c.current)==null||C.removeEventListener("message",I)}}},[c.current]),e.jsx(e.Fragment,{children:e.jsxs(ce,{size:"small",bodyStyle:{padding:0},title:e.jsx(e.Fragment,{children:r?e.jsxs(e.Fragment,{children:[e.jsx(z,{style:{cursor:"pointer"},onClick:()=>{a(`/component/${r==null?void 0:r.component_type}/${r==null?void 0:r.component_id}`)},children:r==null?void 0:r.component_name}),e.jsx(z,{children:r==null?void 0:r.analysis_name}),e.jsx(z,{children:String(r==null?void 0:r.analysis_id).slice(0,8)}),e.jsx(z,{children:r==null?void 0:r.analysis_status}),m.current==((S=p.current)==null?void 0:S.analysis_id)&&e.jsxs(z,{children:[" ",e.jsx(e.Fragment,{children:(w=p.current)==null?void 0:w.event})]})]}):e.jsx(e.Fragment,{})}),extra:e.jsxs(k,{gap:"small",children:[i&&e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>i(),children:"关闭"}),r&&e.jsxs(e.Fragment,{children:[e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>{j("editParams",r.analysis_id)},children:"编辑参数"}),(r==null?void 0:r.analysis_status)=="running"?e.jsx(e.Fragment,{children:e.jsx(R,{title:"是否停止!",onConfirm:async()=>{await Mt(r.analysis_id),x.success("停止成功")},children:e.jsx(F,{size:"small",color:"cyan",variant:"solid",children:"停止"})})}):e.jsx(e.Fragment,{children:e.jsx(R,{title:"是否运行!",onConfirm:async()=>{await Ot(r.analysis_id,"job"),x.success("运行成功")},children:e.jsx(F,{size:"small",color:"cyan",variant:"solid",children:r.analysis_status=="created"?"运行":"重新运行"})})})]}),e.jsx(R,{title:r!=null&&r.is_report?"是否取消报告":"是否报告",onConfirm:async()=>{await E.post(`/analysis/update-report/${r==null?void 0:r.analysis_id}`),x.success("操作成功!"),l(null),t&&t()},children:e.jsx(F,{size:"small",color:"cyan",variant:"solid",children:r!=null&&r.is_report?"取消报告":"报告"})}),e.jsx(F,{size:"small",color:"cyan",variant:"solid",onClick:()=>v(s),children:"刷新"})]}),children:[(r==null?void 0:r.analysis_status)=="failed"?e.jsx("div",{style:{textAlign:"center"},children:e.jsx(Kt,{file_path:r==null?void 0:r.command_log_path})}):e.jsx(e.Fragment,{children:(r==null?void 0:r.analysis_status)=="running"&&(r==null?void 0:r.run_type)!="server"?e.jsx(Ye,{active:!0}):e.jsx(e.Fragment,{children:s&&e.jsx(as,{analsyisResult:r,loading:n})})}),e.jsx(Ut,{callback:()=>v(s),visible:f.editParams.visible,params:f.editParams.params,onClose:()=>y("editParams")})]})})},as=({analsyisResult:s,loading:i})=>e.jsxs(rt,{spinning:i,children:[s&&e.jsxs(e.Fragment,{children:[s.images&&e.jsx("div",{style:{marginBottom:"1rem",padding:"1rem",borderBottom:"1px solid #f0f0f0"},children:Array.isArray(s.images)?e.jsx(Xe,{gutter:{xs:8,sm:16,md:24,lg:32},children:s.images.map((t,n)=>e.jsx(Qe,{span:4,children:e.jsx(ie,{...t})},n))}):e.jsx(e.Fragment,{children:e.jsx(ie,{...s.images})})}),e.jsx("div",{style:{padding:"1rem"},children:s.tables&&Array.isArray(s.tables)&&e.jsx(e.Fragment,{children:s.tables.map((t,n)=>e.jsx(rs,{...t},n))})})]}),e.jsx(et,{data:s==null?void 0:s.description})]});export{Is as A,qt as B,Yt as C,Ut as E,K as F,Kt as L,Ht as P,Jt as a,vs as b,rs as c,is as d,ws as f,Ot as r,Mt as s,Ss as w};
