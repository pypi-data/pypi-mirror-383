import{r as p,e as se,U as ie,a as q,j as e,o,m as oe,B as g,d as Q,P as W,I as te,g as me,V as de,w as ce,f as re,M as _e}from"./main-gLMaKCvr.js";import{S as X,F as pe,D as xe,b as je}from"./Table-CWRWFg95.js";import{C as ge}from"./index-Jdu54dr5.js";const ue=p.forwardRef(({pipeline:r,software:m,title:v,form:fe,appendSampleColumns:Y=[],setResultTableList:b,cleanDom:ke,analysisType:Ce,setRecord:L,setTableLoading:Se,setTabletData:Fe,shouldTrigger:Ie,analysisMethod:s,columnsParamsALL:E,activeTabKey:u,setActiveTabKey:D,cardExtra:Z,operatePipeline:i,relationType:h,currentAnalysisMethod:l,setCurrentAnalysisMethod:R,params:J,...N},K)=>{p.useImperativeHandle(K,()=>({reload:x}));const{project:B,projectObj:_}=se(),[w,f]=p.useState([]),[y,P]=p.useState(),[A,T]=p.useState(!1),{eventSourceRef:k,status:ve,reconnect:De}=ie();p.useEffect(()=>{var a;if(!k)return;const n=d=>{const c=JSON.parse(d.data);if(c.msgType==="analysis_result"){const t=s.map(F=>F.component_id);console.log("componentIdList",t),console.log("data.component_id ",c.component_id),console.log(" componentIdList.includes(data.component_id) ",t.includes(c.component_id)),t.includes(c.component_id)&&x()}};return(a=k.current)==null||a.addEventListener("message",n),()=>{var d;console.log("removeEventListener"),(d=k.current)==null||d.removeEventListener("message",n)}},[k.current]);const x=()=>{if(console.log("analysisMethod: ",s),s&&Array.isArray(s)){const n=s.flatMap(a=>a.component_id);O({componentIdList:n})}else O({params:J})},$=n=>s.reduce((c,t)=>(c[t==null?void 0:t.component_id]=t,c),{})[n];p.useEffect(()=>{var n,a;if(s&&Array.isArray(s)&&s.length>0&&D){D((n=s[0])==null?void 0:n.component_id);const d=$((a=s[0])==null?void 0:a.component_id);R(d)}x()},[JSON.stringify(J),JSON.stringify(s),B]);const M=n=>{f(y[n]),D(n);const a=$(n);R(a)},O=async({analysisMethodValues:n,params:a,componentIdList:d})=>{var t,F;T(!0);let c=await q.post("/analysis-result/list-analysis-result",{project:B,component_ids:d,...a});if(d){const j=c.data.reduce((I,V)=>{const z=V.component_id;I[z]||(I[z]=[]);const{sample_name:G,id:H,sample_group:U,...ae}=V;return I[z].push({label:G,value:H,sample_group:U||"no_group",sample_name:G,id:H,...ae}),I},{});console.log("groupedData",j),b&&b(j),P(j),f(u?j[u]?j[u]:[]:j[(t=s[0])==null?void 0:t.component_id]?j[(F=s[0])==null?void 0:F.component_id]:[])}else f(c.data);T(!1)},ee=async n=>{await q.delete(`/analyais-result/delete-by-id/${n}`),re.success("删除成功!"),x()};let le=[{title:"项目名称",dataIndex:"project_name",key:"project_name",width:100,ellipsis:!0,render:(n,a)=>e.jsx(o,{title:a.project,children:e.jsx("span",{style:{cursor:"pointer"},children:n})})},{title:"分析结果ID",dataIndex:"analysis_result_id",key:"analysis_result_id",width:50,ellipsis:!0,render:(n,a)=>e.jsx(o,{title:a.analysis_result_id,children:e.jsx("span",{style:{cursor:"pointer"},children:String(n).slice(0,8)})})},{title:"分析ID",dataIndex:"analysis_id",key:"analysis_id",width:50,ellipsis:!0,render:(n,a)=>e.jsx(o,{title:a.analysis_id,children:e.jsx("span",{style:{cursor:"pointer"},children:n?String(n).slice(0,8):""})})},{title:"组件名称",dataIndex:"component_name",key:"component_name",width:100,ellipsis:!0,render:(n,a)=>e.jsx(o,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["analysis_id: ",a.analysis_id]}),e.jsxs("li",{children:["component_id: ",a.component_id]}),e.jsxs("li",{children:["analysis_result_id: ",a.analysis_result_id]}),e.jsxs("li",{children:["sample_id: ",a.sample_id]}),e.jsxs("li",{children:["file_name: ",a.file_name]}),e.jsxs("li",{children:["analysis_result_hash: ",a.analysis_result_hash]})]})}),children:e.jsx("span",{style:{cursor:"pointer"},children:n})})},{title:"样本名称",dataIndex:"sample_name",key:"sample_name",width:100,ellipsis:!0,render:(n,a)=>e.jsx(o,{title:e.jsx(e.Fragment,{children:e.jsx("ul",{children:e.jsxs("li",{children:["sample_id: ",a.sample_id]})})}),children:e.jsx("span",{style:{cursor:"pointer"},children:n})})},{title:"样本来源",dataIndex:"sample_source",key:"sample_source",width:100,ellipsis:!0},...(()=>{var n;return!(_!=null&&_.metadata_form)||!Array.isArray(_==null?void 0:_.metadata_form)?[]:(n=_==null?void 0:_.metadata_form)==null?void 0:n.map(a=>({title:a.label,dataIndex:a.name,key:a.name,ellipsis:!0}))})(),...Y,{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(n,a)=>e.jsxs(X,{size:"middle",children:[e.jsx(oe,{content:e.jsx(e.Fragment,{children:e.jsx(Q,{children:e.jsx("pre",{children:JSON.stringify(a.content,null,2)})})}),children:e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:()=>{L&&L(a),i.openModal("openFile",{content:a.content,description:l.description})},children:"查看"})}),a.sample_name?e.jsx(e.Fragment,{children:e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("metadataForm",{analysis_result_id:a.analysis_result_id,sample_id:a.sample_id,callback:x})},children:"metadata"})}):e.jsx(e.Fragment,{children:e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModal("metadataForm",{analysis_result_id:a.analysis_result_id,callback:x})},children:"添加metadata"})}),e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:()=>{console.log(i),i.openModals("bindSample",{analysis_result_id:a.analysis_result_id,callback:x})},children:"绑定样本"}),e.jsx(W,{title:"确定删除吗?",onConfirm:async()=>{await ee(a.analysis_result_id)},children:e.jsx(g,{size:"small",color:"danger",variant:"solid",children:"删除"})})]})}];const[C,ne]=p.useState(""),S=p.useMemo(()=>C?w.filter(n=>Object.values(n).some(a=>String(a).toLowerCase().includes(C.toLowerCase()))):w,[w,C]);return e.jsx(e.Fragment,{children:e.jsxs(ge,{size:"small",title:e.jsxs(e.Fragment,{children:[e.jsx(je,{})," ",v,(l==null?void 0:l.component_name)&&e.jsx(o,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["namespace: ",l==null?void 0:l.namespace_name]}),(r==null?void 0:r.component_id)&&e.jsxs("li",{children:["pipeline: ",r==null?void 0:r.component_id]}),(m==null?void 0:m.component_id)&&e.jsxs("li",{children:["software: ",m==null?void 0:m.component_id]}),(l==null?void 0:l.component_id)&&e.jsxs("li",{children:["file: ",l==null?void 0:l.component_id]}),(l==null?void 0:l.name)&&e.jsxs("li",{children:["name: ",l==null?void 0:l.name]})]})}),children:e.jsxs("span",{style:{cursor:"pointer"},children:["(",l==null?void 0:l.component_name,")"]})})]}),extra:e.jsxs(e.Fragment,{children:[Z,e.jsxs(me,{gap:"small",children:[(i==null?void 0:i.openModal)&&e.jsxs(e.Fragment,{children:[e.jsx(g,{size:"small",color:"cyan",variant:"solid",onClick:()=>{i.openModals("modalD",{...l,operatePipeline:i})},children:"导入数据"}),e.jsx(g,{size:"small",color:"primary",variant:"solid",onClick:x,children:"刷新"}),(N.component_type=="software"||N.component_type=="file")&&e.jsx(e.Fragment,{children:e.jsx(xe,{menu:{items:[{key:"4",label:e.jsx(o,{title:l==null?void 0:l.component_name,children:e.jsx("a",{onClick:()=>{i.openModal("modalC",{data:void 0,structure:{relation_type:h,parent_component_id:m.component_id,component_type:"file"}})},children:"新增文件"})})},{key:"3",label:e.jsx(o,{title:l==null?void 0:l.component_name,children:e.jsx("a",{onClick:()=>{i.openModal("modalC",{data:l,structure:{component_type:"file"}})},children:"更新文件"})})},{key:"2",label:e.jsx(o,{title:l==null?void 0:l.component_name,children:e.jsx("a",{onClick:()=>{i.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:h,parent_component_id:m.component_id}})},children:"添加文件"})})},{key:"1",label:e.jsx(o,{title:l==null?void 0:l.component_name,children:e.jsx("a",{onClick:()=>{i.openModal("modalA",{data:l,pipelineStructure:{relation_type:h}})},children:"替换文件"})})},{label:e.jsx(o,{title:l==null?void 0:l.component_name,children:e.jsx(W,{title:"是否移除文件!",onConfirm:()=>{i.deletePipelineRelation(l.relation_id)},children:e.jsx("a",{children:"移除文件"})})}),key:"0"}]},children:e.jsx("a",{onClick:n=>n.preventDefault(),children:e.jsxs(X,{children:["更多",e.jsx(de,{})]})})})})]}),e.jsx(ce,{onClick:()=>{i.openModal("descriptionModal",l.description)},style:{cursor:"pointer"}})]})]}),tabList:s&&Array.isArray(s)&&s.length>1?s.map(n=>({key:n.component_id,label:e.jsx(o,{title:n.component_id,children:n.component_name?n.component_name:"no_name"})})):void 0,activeTabKey:u,onTabChange:M,children:[e.jsx(pe,{title:()=>e.jsx(te.Search,{size:"small",placeholder:"搜索结果...",allowClear:!0,enterButton:!0,value:C,onChange:n=>ne(n.target.value),style:{width:300}}),rowKey:n=>n.id,size:"small",bordered:!0,pagination:{pageSize:10},loading:A,scroll:{x:"max-content",y:55*5},columns:E||le,footer:()=>`一共${S&&Array.isArray(S)&&S.length}条记录`,dataSource:S}),(l==null?void 0:l.parseFormat)&&(l==null?void 0:l.relation_type)=="software_output_file"&&e.jsx(Q,{children:e.jsx("pre",{children:JSON.stringify(l.parseFormat,null,2)})})]})})}),Le=({visible:r,onClose:m,params:v})=>r?e.jsx(e.Fragment,{children:e.jsx(_e,{title:"分析结果",open:r,onCancel:m,width:"80%",children:e.jsx(ue,{...v,analysisType:"sample"})})}):null;export{Le as A,ue as R};
