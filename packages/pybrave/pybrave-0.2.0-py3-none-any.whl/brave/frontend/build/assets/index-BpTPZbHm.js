import{r as i,v as se,_ as ae,f as v,p as ne,u as ie,Q as te,U as le,a as b,j as e,I as re,g as oe,B as u,o as k,m as ce,P as y,V as de,e as ue,F as I,M as me,S as xe}from"./main-gLMaKCvr.js";import{P as pe}from"./index-D1xRfB3g.js";import{A as je,E as ye,s as he,r as _e}from"./index-DEhiFitC.js";import{C as fe}from"./index-Jdu54dr5.js";import{F as ge,S as $,D as ve}from"./Table-CWRWFg95.js";import{T as C}from"./index-BrNLqRge.js";var ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M888 792H200V168c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v688c0 4.4 3.6 8 8 8h752c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM305.8 637.7c3.1 3.1 8.1 3.1 11.3 0l138.3-137.6L583 628.5c3.1 3.1 8.2 3.1 11.3 0l275.4-275.3c3.1-3.1 3.1-8.2 0-11.3l-39.6-39.6a8.03 8.03 0 00-11.3 0l-230 229.9L461.4 404a8.03 8.03 0 00-11.3 0L266.3 586.7a8.03 8.03 0 000 11.3l39.5 39.7z"}}]},name:"line-chart",theme:"outlined"},Ce=function(t,m){return i.createElement(se,ae({},t,{ref:m,icon:ke}))},be=i.forwardRef(Ce);const He=i.forwardRef(({title:w,form:t,appendSampleColumns:m=[],setResultTableList:x,cleanDom:P,analysisType:R,setRecord:h,setTableLoading:F,setTabletData:S,shouldTrigger:p,columnsParamsALL:E,project:r,software:Fe,component_id:D,component_ids:V,operatePipeline:Se,editParams:Le},H)=>{i.useImperativeHandle(H,()=>({reload:l}));const[Ae,N]=i.useState(),[Ie,J]=v.useMessage(),{modal:n,openModal:j,closeModal:d}=ne(),[Pe,Re]=i.useState(!1),U=ie(),K=te(),{eventSourceRef:_,status:Ee,reconnect:ze}=le(),[o,Q]=i.useState([]),L=i.useRef([]),A=i.useRef(null),[q,z]=i.useState(!1),[Me,G]=i.useState();i.useEffect(()=>{if(o&&Array.isArray(o)&&o.length>0&&n.visible&&n.params){const a=o.find(s=>s.analysis_id==n.params.analysis_id);a&&G(a)}},[o,n.params]),i.useEffect(()=>{var a;if(_){const s=c=>{var T;const g=JSON.parse(c.data);console.log("analysisId",L.current),L.current.includes(g.analysis_id)&&(g.event=="analysis_complete"||g.event=="analysis_failed"||g.event=="analysis_started")&&(l(),A.current&&((T=A.current)==null||T.relaod()))};return(a=_.current)==null||a.addEventListener("message",s),()=>{var c;console.log("removeEventListener"),(c=_.current)==null||c.removeEventListener("message",s)}}},[_.current,r]);const W=a=>{h&&h(a),N(a)},l=async()=>{z(!0);let a=await b.post("/list-analysis",{component_id:D,component_ids:V,project:r});x&&x(a.data),Q(a.data);const s=a.data.map(c=>c.analysis_id);L.current=s,z(!1)},X=async a=>{await b.delete(`/fast-api/analysis/${a}`),v.success("删除成功!"),l()},M=(a,s)=>n.params?a.analysis_id==n.params.analysis_id&&s==n.key:!1,B=async(a,s)=>{await _e(a.analysis_id,s),v.success("运行成功"),l()},Y=async a=>{await he(a.analysis_id),v.success("停止成功"),l()};let Z=[{title:"project_name",dataIndex:"project_name",key:"project_name",ellipsis:!0,render:(a,s)=>e.jsx(k,{title:s.project,children:e.jsx("span",{style:{cursor:"pointer"},children:a})})},{title:"analysis_status",dataIndex:"analysis_status",key:"analysis_status",ellipsis:!0,render:a=>e.jsx(C,{color:a==="success"?"green":a==="failed"?"red":"blue",children:a})},{title:"组件名称",dataIndex:"component_name",key:"component_name",ellipsis:!0,render:(a,s)=>e.jsx(k,{title:s.component_id,children:e.jsx("span",{style:{cursor:"pointer"},children:a})})},{title:"分析名称",dataIndex:"analysis_name",key:"analysis_name",ellipsis:!0},{title:"报告",dataIndex:"is_report",key:"is_report",ellipsis:!0,render:(a,s)=>e.jsx(C,{color:a?"green":"blue",children:a?"报告":"不报告"})},{title:"analysis_id",dataIndex:"analysis_id",key:"analysis_id",ellipsis:!0,render:(a,s)=>e.jsx(ce,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["analysis_id:",s.analysis_id]}),e.jsxs("li",{children:["analysis_name:",s.analysis_name]}),e.jsxs("li",{children:["pipeline_script:",s.pipeline_script]}),e.jsxs("li",{children:["work_dir:",s.work_dir]}),e.jsxs("li",{children:["output_dir:",s.output_dir]}),e.jsxs("li",{children:["command_log_path:",s.command_log_path]}),e.jsxs("li",{children:["trace_file:",s.trace_file]}),e.jsxs("li",{children:["executor_log_file:",s.executor_log_file]}),e.jsxs("li",{children:["workflow_log_file:",s.workflow_log_file]})]})}),children:e.jsxs("span",{style:{cursor:"pointer"},children:[" ",e.jsx("span",{style:{cursor:"pointer"},children:String(a).slice(0,8)})]})})},{title:"容器",dataIndex:"container_name",key:"container_name",ellipsis:!0,render:(a,s)=>e.jsxs(k,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsx("li",{children:s.container_image}),s.sub_container_image&&e.jsx("li",{children:s.sub_container_image})]})}),children:[e.jsx(C,{style:{cursor:"pointer"},children:a}),s.sub_container_name&&e.jsx(C,{style:{cursor:"pointer"},children:s.sub_container_name})]})},{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(a,s)=>e.jsxs($,{size:"middle",children:[s.analysis_status=="running"?e.jsx(e.Fragment,{children:e.jsx(y,{title:"是否停止!",onConfirm:()=>{Y(s)},children:e.jsx(u,{size:"small",color:"cyan",variant:"solid",children:"停止"})})}):e.jsx(e.Fragment,{children:e.jsx(y,{title:"是否运行!",onConfirm:()=>{B(s,"job"),j("modalA",s),W(s)},children:e.jsx(u,{size:"small",color:"cyan",variant:"solid",children:s.analysis_status=="created"?"运行":"重新运行"})})}),e.jsx(u,{size:"small",color:"cyan",variant:"solid",onClick:()=>j("editParams",s.analysis_id),children:"编辑参数"}),M(s,"modalA")?e.jsx(u,{size:"small",color:"cyan",variant:"solid",onClick:()=>{d()},children:"关闭"}):e.jsx(u,{size:"small",color:"cyan",variant:"solid",onClick:()=>{j("modalA",s)},children:"查看结果"}),e.jsx(ve,{menu:{items:[{key:"1",label:e.jsx(e.Fragment,{children:M(s,"modalB")?e.jsx("a",{onClick:()=>{d()},children:"关闭"}):e.jsx("a",{onClick:()=>{j("modalB",s)},children:"详情"})})},{key:"2",label:e.jsx(e.Fragment,{children:s.analysis_status=="running"?e.jsx(e.Fragment,{children:s.run_type=="server"&&e.jsx(e.Fragment,{children:e.jsx(k,{title:e.jsx(e.Fragment,{children:s.url}),children:e.jsx("a",{onClick:()=>{window.open(`${s.url}`,"_blank")},children:"打开URL"})})})}):e.jsx(e.Fragment,{children:e.jsx(y,{title:"是否启动服务?",onConfirm:()=>{B(s,"server")},children:e.jsx("a",{children:"启动服务"})})})})},{key:"3",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:()=>{U(`/software-analysis-editor/${s.analysis_id}`,{state:{location:K.pathname}})},children:"编辑"})})},{key:"4",label:e.jsxs(e.Fragment,{children:[" ",e.jsx(y,{title:"是否删除!",onConfirm:async()=>{await X(s.analysis_id),l()},children:e.jsx("a",{children:"删除"})})]})},{key:"5",label:e.jsxs(e.Fragment,{children:[" ",e.jsx(y,{title:s.is_report?"是否取消报告":"是否报告",onConfirm:async()=>{await b.post(`/analysis/update-report/${s.analysis_id}`),l()},children:s.is_report?"取消报告":"报告"})]})},{key:"6",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:()=>{j("addProject",s)},children:"添加项目"})})}]},children:e.jsx("a",{onClick:c=>c.preventDefault(),children:e.jsxs($,{children:["更多",e.jsx(de,{})]})})})]})}];i.useEffect(()=>{d()},[r]),i.useEffect(()=>{l()},[r]);const[f,ee]=i.useState(""),O=i.useMemo(()=>f?o.filter(a=>Object.values(a).some(s=>String(s).toLowerCase().includes(f.toLowerCase()))):o,[o,f]);return e.jsxs(e.Fragment,{children:[J,e.jsx(fe,{size:"small",title:e.jsxs(e.Fragment,{children:[e.jsx(be,{})," 分析记录"]}),extra:e.jsx(oe,{gap:"small",children:e.jsx(u,{size:"small",type:"primary",onClick:l,children:"刷新"})}),children:e.jsx(ge,{title:()=>e.jsx(re.Search,{size:"small",placeholder:"搜索结果...",allowClear:!0,enterButton:!0,value:f,onChange:a=>ee(a.target.value),style:{width:300}}),rowKey:"analysis_id",size:"small",bordered:!0,pagination:!1,loading:q,scroll:{x:"max-content",y:55*5},columns:Z,footer:()=>`一共${O.length}条记录`,dataSource:O})}),e.jsx("div",{style:{marginBottom:"1rem"}}),e.jsx(je,{visible:n.key=="modalA"&&n.visible,params:n.params,onClose:d}),e.jsx(pe,{ref:A,visible:n.key=="modalB"&&n.visible,params:n.params,onClose:d,callback:l}),e.jsx(ye,{callback:l,visible:n.key=="editParams"&&n.visible,params:n.params,onClose:d}),e.jsx(we,{callback:l,visible:n.key=="addProject"&&n.visible,params:n.params,onClose:d})]})}),we=({visible:w,params:t,onClose:m,callback:x})=>{const[P,R]=i.useState([]),{messageApi:h,projectList:F,project:S}=ue(),[p]=I.useForm();i.useEffect(()=>{F&&R(F.filter(r=>r.value!=S)),p.resetFields(),t!=null&&t.extra_project_ids&&p.setFieldValue("project",JSON.parse(t==null?void 0:t.extra_project_ids))},[S]);const E=async()=>{const r=await p.validateFields();await b.post(`/analysis/update-extra-project/${t==null?void 0:t.analysis_id}`,r),h.success("添加成功!"),x&&x()};return e.jsx(me,{onOk:E,title:`添加项目(${t==null?void 0:t.analysis_name})`,open:w,onCancel:m,onClose:m,children:e.jsx(I,{form:p,children:e.jsx(I.Item,{name:"project",label:"项目",children:e.jsx(xe,{options:P,mode:"multiple"})})})})};export{He as R};
