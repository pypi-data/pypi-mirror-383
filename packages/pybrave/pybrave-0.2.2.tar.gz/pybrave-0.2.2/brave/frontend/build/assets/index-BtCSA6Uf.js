import{r as n,x as le,_ as re,s as S,b as oe,v as ce,c as de,X as ue,Y as pe,u as me,a as x,j as e,I as he,F as je,B as r,t as v,l as j,p as xe,P as p,Z as ye,k as _e,d as F,M as fe,e as ge}from"./main-CuY7LwDi.js";import{P as ve}from"./index-BGst5tb7.js";import{A as be,E as ke,s as Ce,r as Se}from"./index-C56i7L-C.js";import{I as we}from"./index-BEzmeFWl.js";import{C as Ie}from"./index-BMhTxeKN.js";import{F as Pe,S as H,D as Re}from"./Table-C4qk6tSP.js";var Fe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M888 792H200V168c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v688c0 4.4 3.6 8 8 8h752c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM305.8 637.7c3.1 3.1 8.1 3.1 11.3 0l138.3-137.6L583 628.5c3.1 3.1 8.2 3.1 11.3 0l275.4-275.3c3.1-3.1 3.1-8.2 0-11.3l-39.6-39.6a8.03 8.03 0 00-11.3 0l-230 229.9L461.4 404a8.03 8.03 0 00-11.3 0L266.3 586.7a8.03 8.03 0 000 11.3l39.5 39.7z"}}]},name:"line-chart",theme:"outlined"},Ae=function(i,y){return n.createElement(le,re({},i,{ref:y,icon:Fe}))},Le=n.forwardRef(Ae);const Ye=n.forwardRef(({title:w,form:i,appendSampleColumns:y=[],setResultTableList:_,cleanDom:A,analysisType:L,setRecord:b,setTableLoading:I,setTabletData:f,shouldTrigger:z,columnsParamsALL:E,project:d,software:M,component_id:m,component_ids:U,operatePipeline:Ee,editParams:Me},K)=>{n.useImperativeHandle(K,()=>({reload:l}));const[$e,X]=n.useState(),[De,Y]=S.useMessage(),{modal:a,openModal:g,closeModal:u}=oe(),{modals:$,openModals:D,closeModals:Z}=ce(["inspectPanel"]),[Oe,Be]=n.useState(!1),q=de(),G=ue(),{eventSourceRef:k,status:Ne,reconnect:Te}=pe(),[o,Q]=n.useState([]),P=n.useRef([]),R=n.useRef(null),[ee,O]=n.useState(!1),[We,se]=n.useState(),{containerURL:B}=me(t=>t.user);n.useEffect(()=>{if(o&&Array.isArray(o)&&o.length>0&&a.visible&&a.params){const t=o.find(s=>s.analysis_id==a.params.analysis_id);t&&se(t)}},[o,a.params]),n.useEffect(()=>{var t;if(k){const s=c=>{var V;const h=JSON.parse(c.data);console.log("analysisId",P.current),P.current.includes(h.analysis_id)?(h.event=="analysis_complete"||h.event=="analysis_failed"||h.event=="analysis_started")&&(l(),R.current&&((V=R.current)==null||V.relaod())):h.run_type=="retry"&&h.event=="container_pulled"&&l()};return(t=k.current)==null||t.addEventListener("message",s),()=>{var c;console.log("removeEventListener"),(c=k.current)==null||c.removeEventListener("message",s)}}},[k.current,d]);const te=t=>{b&&b(t),X(t)},l=async()=>{O(!0);let t=await x.post("/list-analysis",{component_id:m,component_ids:U,project:d});_&&_(t.data),Q(t.data);const s=t.data.map(c=>c.analysis_id);P.current=s,O(!1)},ae=async t=>{await x.delete(`/fast-api/analysis/${t}`),S.success("successfully delete!"),l()},N=(t,s)=>a.params?t.analysis_id==a.params.analysis_id&&s==a.key:!1,T=async(t,s)=>{await Se(t.analysis_id,s),S.success("run successfully"),l()},W=async(t,s)=>{await Ce(t.analysis_id,s),S.success("Stop Success"),l()};let ne=[{title:"Project Name",dataIndex:"project_name",key:"project_name",ellipsis:!0,render:(t,s)=>e.jsx(v,{title:s.project,children:e.jsx("span",{style:{cursor:"pointer"},children:t})})},{title:"Job Status",dataIndex:"job_status",key:"job_status",ellipsis:!0,render:t=>e.jsx(j,{color:t==="success"?"green":t==="failed"?"red":"blue",children:t})},{title:"Server Status",dataIndex:"server_status",key:"server_status",ellipsis:!0,render:t=>e.jsx(j,{color:t==="success"?"green":t==="failed"?"red":"blue",children:t})},{title:"Component Name",dataIndex:"component_name",key:"component_name",ellipsis:!0,render:(t,s)=>e.jsx(v,{title:s.component_id,children:e.jsx("span",{style:{cursor:"pointer"},children:t})})},{title:"Analysis Name",dataIndex:"analysis_name",key:"analysis_name",ellipsis:!0},{title:"Report",dataIndex:"is_report",key:"is_report",ellipsis:!0,render:(t,s)=>e.jsx(j,{color:t?"green":"blue",children:t?"Report":"NonReport"})},{title:"Analysis Id",dataIndex:"analysis_id",key:"analysis_id",ellipsis:!0,render:(t,s)=>e.jsx(xe,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["analysis_id:",s.analysis_id]}),e.jsxs("li",{children:["analysis_name:",s.analysis_name]}),e.jsxs("li",{children:["pipeline_script:",s.pipeline_script]}),e.jsxs("li",{children:["work_dir:",s.work_dir]}),e.jsxs("li",{children:["output_dir:",s.output_dir]}),e.jsxs("li",{children:["command_log_path:",s.command_log_path]}),e.jsxs("li",{children:["trace_file:",s.trace_file]}),e.jsxs("li",{children:["executor_log_file:",s.executor_log_file]}),e.jsxs("li",{children:["workflow_log_file:",s.workflow_log_file]})]})}),children:e.jsxs("span",{style:{cursor:"pointer"},children:[" ",e.jsx("span",{style:{cursor:"pointer"},children:String(t).slice(0,8)})]})})},{title:"Container Name",dataIndex:"container_name",key:"container_name",ellipsis:!0,render:(t,s)=>e.jsxs(v,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsx("li",{children:s.container_image}),s.sub_container_image&&e.jsx("li",{children:s.sub_container_image})]})}),children:[e.jsx(j,{style:{cursor:"pointer"},children:t}),s.sub_container_name&&e.jsx(j,{style:{cursor:"pointer"},children:s.sub_container_name})]})},{title:"Image Status",dataIndex:"image_status",key:"image_status",ellipsis:!0,render:(t,s)=>e.jsx(v,{title:s.image_id,children:e.jsx(j,{color:"green",children:t})})},{title:"Action",key:"action",fixed:"right",ellipsis:!0,width:200,render:(t,s)=>e.jsxs(H,{size:"middle",children:[s.image_status=="exist"?e.jsxs(e.Fragment,{children:[s.job_status=="running"?e.jsx(e.Fragment,{children:e.jsx(p,{title:"Whether or not to stop?",onConfirm:()=>{W(s,"job")},children:e.jsx(r,{size:"small",color:"red",variant:"solid",children:"Stop Job"})})}):e.jsx(e.Fragment,{children:e.jsx(p,{title:"Whether or not to run?",onConfirm:()=>{T(s,"job"),g("modalA",s),te(s)},children:e.jsx(r,{size:"small",color:"cyan",variant:"solid",children:s.analysis_status=="created"?"Run":"Re-Run"})})}),s.server_status=="running"?e.jsxs(e.Fragment,{children:[e.jsx(v,{title:e.jsx(e.Fragment,{children:`${B}/container/${s.analysis_id}/`}),children:e.jsx(r,{size:"small",color:"blue",variant:"solid",onClick:()=>{window.open(`${B}/container/${s.analysis_id}/`,"_blank")},children:"Open URL"})}),e.jsx(p,{title:"Whether or not to stop?",onConfirm:()=>{W(s,"server")},children:e.jsx(r,{size:"small",color:"red",variant:"solid",children:"Stop Server"})})]}):e.jsx(e.Fragment,{children:e.jsx(p,{title:"Whether to start the server?",onConfirm:()=>{T(s,"server")},children:e.jsx(r,{size:"small",color:"cyan",variant:"solid",children:"Run Server"})})})]}):e.jsx(e.Fragment,{children:e.jsx(p,{title:"Pull?",onConfirm:async()=>{await x.post(`/container/pull-image/${s.container_id}`),l()},children:e.jsx(r,{size:"small",color:"cyan",variant:"solid",children:s.image_status=="pulling"?"pulling":"Pull"})})}),e.jsx(r,{size:"small",color:"cyan",variant:"solid",onClick:()=>g("editParams",s.analysis_id),children:"Edit Parameters"}),N(s,"modalA")?e.jsx(r,{size:"small",color:"cyan",variant:"solid",onClick:()=>{u()},children:"Close"}):e.jsx(r,{size:"small",color:"cyan",variant:"solid",onClick:()=>{g("modalA",s)},children:"View Results"}),e.jsx(Re,{menu:{items:[{key:"1",label:e.jsx(e.Fragment,{children:N(s,"modalB")?e.jsx("a",{onClick:()=>{u()},children:"Close"}):e.jsx("a",{onClick:()=>{g("modalB",s)},children:"Details"})})},{key:"inspect_job",disabled:s.job_status!="running",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:async()=>{D("inspectPanel",{inspect:"inspect",id:s.analysis_id,run_type:"job"})},children:"Inspect Job"})})},{key:"inspect_server",disabled:s.server_status!="running",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:async()=>{D("inspectPanel",{inspect:"inspect",id:s.analysis_id,run_type:"server"})},children:"Inspect Server"})})},{key:"3",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:()=>{q(`/software-analysis-editor/${s.analysis_id}`,{state:{location:G.pathname}})},children:"Edit"})})},{key:"4",label:e.jsxs(e.Fragment,{children:[" ",e.jsx(p,{title:"Delete or not?",onConfirm:async()=>{await ae(s.analysis_id),l()},children:e.jsx("a",{children:"Delete"})})]})},{key:"5",label:e.jsxs(e.Fragment,{children:[" ",e.jsx(p,{title:s.is_report?"Whether to cancel the report?":"Whether to the report?",onConfirm:async()=>{await x.post(`/analysis/update-report/${s.analysis_id}`),l()},children:s.is_report?"Cancel Report":"Report"})]})},{key:"6",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:()=>{g("addProject",s)},children:"Add Project"})})}]},children:e.jsx("a",{onClick:c=>c.preventDefault(),children:e.jsxs(H,{children:["More",e.jsx(ye,{})]})})})]})}];n.useEffect(()=>{u()},[d]),n.useEffect(()=>{l()},[d]);const[C,ie]=n.useState(""),J=n.useMemo(()=>C?o.filter(t=>Object.values(t).some(s=>String(s).toLowerCase().includes(C.toLowerCase()))):o,[o,C]);return e.jsxs(e.Fragment,{children:[Y,e.jsx(Ie,{size:"small",title:e.jsxs(e.Fragment,{children:[e.jsx(Le,{}),"  Analysis Record"]}),extra:e.jsx(je,{gap:"small",children:e.jsx(r,{size:"small",type:"primary",onClick:l,children:"Refresh"})}),children:e.jsx(Pe,{title:()=>e.jsx(he.Search,{size:"small",placeholder:"搜索结果...",allowClear:!0,enterButton:!0,value:C,onChange:t=>ie(t.target.value),style:{width:300}}),rowKey:"analysis_id",size:"small",bordered:!0,pagination:!1,loading:ee,scroll:{x:"max-content",y:55*5},columns:ne,footer:()=>`A total of ${J.length} records`,dataSource:J})}),e.jsx("div",{style:{marginBottom:"1rem"}}),e.jsx(be,{visible:a.key=="modalA"&&a.visible,params:a.params,onClose:u}),e.jsx(ve,{ref:R,visible:a.key=="modalB"&&a.visible,params:a.params,onClose:u,callback:l}),e.jsx(ke,{callback:l,visible:a.key=="editParams"&&a.visible,params:a.params,onClose:u}),e.jsx(ze,{callback:l,visible:a.key=="addProject"&&a.visible,params:a.params,onClose:u}),e.jsx(we,{callback:l,visible:$.inspectPanel.visible,params:$.inspectPanel.params,onClose:()=>Z("inspectPanel")})]})}),ze=({visible:w,params:i,onClose:y,callback:_})=>{const[A,L]=n.useState([]),{messageApi:b,project:I}=_e(),[f]=F.useForm(),z=async()=>{const M=(await x.get("/project/list-project")).data.map(m=>({label:`${m.project_name}`,value:m.project_id}));L(M.filter(m=>m.value!=I))};n.useEffect(()=>{z(),f.resetFields(),i!=null&&i.extra_project_ids&&f.setFieldValue("project",JSON.parse(i==null?void 0:i.extra_project_ids))},[I]);const E=async()=>{const d=await f.validateFields();await x.post(`/analysis/update-extra-project/${i==null?void 0:i.analysis_id}`,d),b.success("添加成功!"),_&&_()};return e.jsx(fe,{onOk:E,title:`添加项目(${i==null?void 0:i.analysis_name})`,open:w,onCancel:y,onClose:y,children:e.jsx(F,{form:f,children:e.jsx(F.Item,{name:"project",label:"项目",children:e.jsx(ge,{options:A,mode:"multiple"})})})})};export{Ye as R};
