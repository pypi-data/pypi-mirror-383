const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./force-graph-DC8_aVgX.js","./main-CuY7LwDi.js","./main-DLoYsyAm.css","./rgb-BwIoVOhg.js","./zoom-BGsqVsDF.js","./vis-network-Ddq-M9kC.js"])))=>i.map(i=>d[i]);
import{r as i,x as E,_ as I,ce as ge,b as be,k as we,M as Z,cf as ye,u as je,a as ze,j as e,I as Re,aI as ke,F as Ce,cg as Se,t as D,l as Y,aT as ee,S as _e,B as Me,D as Le,e as Ve}from"./main-CuY7LwDi.js";import{C as De}from"./index-BMhTxeKN.js";import{S as P}from"./index-C59h2Yua.js";import{R as Ee}from"./study-page-B40m6mCQ.js";import{R as Ie}from"./RedoOutlined-BNTfk6-k.js";import{D as te,c as Oe,C as Ge}from"./Table-C4qk6tSP.js";import{R as Te}from"./NodeIndexOutlined-Clw5SraY.js";import"./index-qOmqaMb2.js";import"./Dropdown-BHbGj-Fl.js";import"./usePagination-7P2VlRbv.js";import"./index-KrImrJYw.js";import"./addEventListener-3f_zys3z.js";var He={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M880.1 154H143.9c-24.5 0-39.8 26.7-27.5 48L349 597.4V838c0 17.7 14.2 32 31.8 32h262.4c17.6 0 31.8-14.3 31.8-32V597.4L907.7 202c12.2-21.3-3.1-48-27.6-48zM603.4 798H420.6V642h182.9v156zm9.6-236.6l-9.5 16.6h-183l-9.5-16.6L212.7 226h598.6L613 561.4z"}}]},name:"filter",theme:"outlined"},Ae=function(t,n){return i.createElement(E,I({},t,{ref:n,icon:He}))},$e=i.forwardRef(Ae),Ne={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"}},{tag:"path",attrs:{d:"M464 336a48 48 0 1096 0 48 48 0 10-96 0zm72 112h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V456c0-4.4-3.6-8-8-8z"}}]},name:"info-circle",theme:"outlined"},Be=function(t,n){return i.createElement(E,I({},t,{ref:n,icon:Ne}))},Pe=i.forwardRef(Be),Fe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M926.8 397.1l-396-288a31.81 31.81 0 00-37.6 0l-396 288a31.99 31.99 0 00-11.6 35.8l151.3 466a32 32 0 0030.4 22.1h489.5c13.9 0 26.1-8.9 30.4-22.1l151.3-466c4.2-13.2-.5-27.6-11.7-35.8zM838.6 417l-98.5 32-200-144.7V199.9L838.6 417zM466 567.2l-89.1 122.3-55.2-169.2L466 567.2zm-116.3-96.8L484 373.3v140.8l-134.3-43.7zM512 599.2l93.9 128.9H418.1L512 599.2zm28.1-225.9l134.2 97.1L540.1 514V373.3zM558 567.2l144.3-46.9-55.2 169.2L558 567.2zm-74-367.3v104.4L283.9 449l-98.5-32L484 199.9zM169.3 470.8l86.5 28.1 80.4 246.4-53.8 73.9-113.1-348.4zM327.1 853l50.3-69h269.3l50.3 69H327.1zm414.5-33.8l-53.8-73.9 80.4-246.4 86.5-28.1-113.1 348.4z"}}]},name:"radar-chart",theme:"outlined"},We=function(t,n){return i.createElement(E,I({},t,{ref:n,icon:Fe}))},Qe=i.forwardRef(We),qe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M300 328a60 60 0 10120 0 60 60 0 10-120 0zM852 64H172c-17.7 0-32 14.3-32 32v660c0 17.7 14.3 32 32 32h680c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-32 660H204V128h616v596zM604 328a60 60 0 10120 0 60 60 0 10-120 0zm250.2 556H169.8c-16.5 0-29.8 14.3-29.8 32v36c0 4.4 3.3 8 7.4 8h729.1c4.1 0 7.4-3.6 7.4-8v-36c.1-17.7-13.2-32-29.7-32zM664 508H360c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"robot",theme:"outlined"},Je=function(t,n){return i.createElement(E,I({},t,{ref:n,icon:qe}))},Ue=i.forwardRef(Je),Ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 208H676V232h212v136zm0 224H676V432h212v160zM412 432h200v160H412V432zm200-64H412V232h200v136zm-476 64h212v160H136V432zm0-200h212v136H136V232zm0 424h212v136H136V656zm276 0h200v136H412V656zm476 136H676V656h212v136z"}}]},name:"table",theme:"outlined"},Xe=function(t,n){return i.createElement(E,I({},t,{ref:n,icon:Ke}))},Ye=i.forwardRef(Xe);function Ze(o,t,{signal:n,edges:s}={}){let a,l=null;const h=s!=null&&s.includes("leading"),g=s==null||s.includes("trailing"),x=()=>{l!==null&&(o.apply(a,l),a=void 0,l=null)},m=()=>{g&&x(),C()};let u=null;const f=()=>{u!=null&&clearTimeout(u),u=setTimeout(()=>{u=null,m()},t)},v=()=>{u!==null&&(clearTimeout(u),u=null)},C=()=>{v(),a=void 0,l=null},w=()=>{x()},b=function(...S){if(n!=null&&n.aborted)return;a=this,l=S;const y=u==null;f(),h&&y&&x()};return b.schedule=f,b.cancel=C,b.flush=w,n==null||n.addEventListener("abort",C,{once:!0}),b}function ne(o,t=0,n={}){typeof n!="object"&&(n={});const{leading:s=!1,trailing:a=!0,maxWait:l}=n,h=Array(2);s&&(h[0]="leading"),a&&(h[1]="trailing");let g,x=null;const m=Ze(function(...v){g=o.apply(this,v),x=null},t,{edges:h}),u=function(...v){return l!=null&&(x===null&&(x=Date.now()),Date.now()-x>=l)?(g=o.apply(this,v),x=Date.now(),m.cancel(),m.schedule(),g):(m.apply(this,v),g)},f=()=>(m.flush(),g);return u.cancel=m.cancel,u.flush=f,u}function et(o,t=0,n={}){const{leading:s=!0,trailing:a=!0}=n;return ne(o,t,{leading:s,maxWait:t,trailing:a})}const tt=(o,t,n,s)=>{switch(t){case"debounce":return ne(o,n,s);case"throttle":return et(o,n,s);default:return o}},nt=o=>{const t=i.useRef(o);return i.useEffect(()=>{t.current=o}),i.useMemo(()=>(...n)=>{var s;return(s=t.current)===null||s===void 0?void 0:s.call(t,...n)},[])},ot=o=>{const[t,n]=i.useState((o==null?void 0:o.current)||null);return o&&setTimeout(()=>{o.current!==t&&n(o.current)},0),{refProxy:i.useMemo(()=>new Proxy(a=>{a!==t&&n(a)},{get(a,l){return l==="current"?t:a[l]},set(a,l,h){return l==="current"?n(h):a[l]=h,!0}}),[t]),refElement:t,setRefElement:n}},rt=(o,t)=>{var n,s;const a=(n=o.borderBoxSize)===null||n===void 0?void 0:n[0],l=(s=o.contentBoxSize)===null||s===void 0?void 0:s[0];return t==="border-box"&&a?{width:a.inlineSize,height:a.blockSize}:t==="content-box"&&l?{width:l.inlineSize,height:l.blockSize}:{width:o.contentRect.width,height:o.contentRect.height}};function it({skipOnMount:o=!1,refreshMode:t,refreshRate:n=1e3,refreshOptions:s,handleWidth:a=!0,handleHeight:l=!0,targetRef:h,observerOptions:g,onResize:x,disableRerender:m=!1}={}){const u=i.useRef(o),f=nt(x),[v,C]=i.useState({width:void 0,height:void 0}),w=i.useRef({width:void 0,height:void 0}),{refProxy:b,refElement:S}=ot(h),{box:y}=g||{},O=i.useCallback(j=>{if(!a&&!l)return;if(u.current){u.current=!1;return}const z=(p,d)=>a&&p.width!==d.width||l&&p.height!==d.height;j.forEach(p=>{const d=rt(p,y);m?z(w.current,d)&&(w.current.width=d.width,w.current.height=d.height,f==null||f({width:d.width,height:d.height,entry:p})):C(A=>z(A,d)?(f==null||f({width:d.width,height:d.height,entry:p}),d):A)})},[a,l,u,y,m]),_=i.useCallback(tt(O,t,n,s),[O,t,n,s]);return i.useEffect(()=>{let j;if(S)try{j=new window.ResizeObserver(_),j.observe(S,g)}catch(z){console.warn("ResizeObserver not supported or failed to initialize:",z)}else(v.width||v.height)&&(f==null||f({width:null,height:null,entry:null}),w.current.width=void 0,w.current.height=void 0,m||C({width:void 0,height:void 0}));return()=>{var z,p,d;(z=j==null?void 0:j.disconnect)===null||z===void 0||z.call(j),(d=(p=_).cancel)===null||d===void 0||d.call(p)}},[_,S]),Object.assign({ref:b},m?w.current:v)}const{Option:Vt}=Ve,{Search:lt}=Re,H=[{label:"Disease",value:"disease"},{label:"Taxonomy",value:"taxonomy"},{label:"Diet_and_food",value:"diet_and_food"},{label:"Study",value:"study"}],st=i.lazy(()=>ee(()=>import("./force-graph-DC8_aVgX.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url)),at=i.lazy(()=>ee(()=>import("./vis-network-Ddq-M9kC.js"),__vite__mapDeps([5,1,2]),import.meta.url)),ct=[{key:"forceGraphView",label:"ai chat",component:st},{key:"visNetwork",label:"details",component:at}],dt=({view:o,...t})=>{if(!o)return e.jsx("div",{onClick:close,children:"未知类型"});const n=ct.find(h=>h.key===o);if(!n)return e.jsx("div",{children:"未知类型"});const{component:s,key:a,...l}=n;return e.jsx(i.Suspense,{fallback:e.jsx(_e,{active:!0}),children:e.jsx(s,{...l,...t})})},ut=({openView:o,height:t,activeView:n,updateQueryParams:s,entity_id:a,openGlobalModal:l,...h},g)=>{const[x,m]=i.useState({nodes:[],links:[]}),[u,f]=i.useState(),[v,C]=i.useState("visNetwork"),w=i.useRef(new Map);console.log("GraphView mounted");const b=i.useRef(null),{locale:S}=ge(),{modal:y,openModal:O,closeModal:_}=be(),{width:j,ref:z}=it(),[p,d]=i.useState(null),[A,vt]=i.useState(null),[G,F]=i.useState(!1),[L,$]=i.useState(null),[W,oe]=i.useState({x:0,y:0}),[Q,N]=i.useState(!1),{messageApi:re}=we(),[ie,le]=i.useState(null),[xt,se]=Z.useModal(),ae=ye(),{displayNode:ce}=je(r=>r.graph),[q,de]=i.useState(!0),ue=()=>{var r,c;if((r=b.current)!=null&&r.renderer){const k=b.current.renderer();console.log(k.info),le({geometries:k.info.memory.geometries,textures:k.info.memory.textures,programs:((c=k.info.programs)==null?void 0:c.length)||0,renderCalls:k.info.render.calls})}};i.useImperativeHandle(g,()=>({reload:T,cancelSelectLink:()=>f(null),cancelSelectNode:()=>$(null),updateQueryParam:V,queryParams:R}));const fe=[{key:"details",label:"details"}],he=r=>{r.key=="details"&&(console.log(r),console.log(L),V("entity_id",L.id)),N(!1)};i.useEffect(()=>{const r=()=>{N(!1)};return Q&&window.addEventListener("click",r),()=>{window.removeEventListener("click",r)}},[L]);const J=()=>{console.log("isWebGLAvailable");try{const r=document.createElement("canvas");return!!window.WebGLRenderingContext&&!!r.getContext("webgl")}catch{return!1}},[R,U]=i.useState({label:"",keyword:void 0,entity_id:a,nodes:ce,nodes_dict:void 0,nodes_dict_condition:"OR"}),V=(r,c)=>{U(k=>({...k,[r]:c||void 0}))},T=async()=>{B(),F(!0),console.log("请求参数:",R);const r=await ze.post("/entity-relation/graph",{...R,locale:S});m(r.data),F(!1)},pe=r=>{U(c=>({...c,[r]:void 0}))},B=()=>{var K,X;if(!b.current)return;const r=b.current;r.pauseAnimation&&r.pauseAnimation();const c=(K=r.renderer)==null?void 0:K.call(r);c&&c.dispose();const k=(X=r.scene)==null?void 0:X.call(r);k&&k.traverse(M=>{M.geometry&&M.geometry.dispose(),M.material&&(Array.isArray(M.material)?M.material.forEach(xe=>xe.dispose()):M.material.dispose())}),w.current.clear()};i.useEffect(()=>(J()?d(!0):d(!1),()=>{B()}),[]);const me=()=>{p&&B(),J()?d(!p):(d(!1),re.error("WebGL not available!"))};i.useEffect(()=>{T(),s&&s(R)},[R,S]);const ve={loading:G,is3D:p,fgRef:b,graphData:x,width:j,height:t,queryParams:R,contextNode:L,labelColorMap:{study:"#6a5acd",disease:"#ff6347",taxonomy:"#3cb371",association:"#ffa500",diet_and_food:"#20b2aa"},spriteCacheRef:w,graphReady:q,openView:o,setContextNode:$,setSelectedLink:f,setOpenRightMenu:N,setMenuPos:oe,selectedLink:u,setGraphReady:de};return e.jsxs(e.Fragment,{children:[se,e.jsx("div",{style:{width:"100%",display:"flex",justifyContent:"center"},children:e.jsxs(De,{title:e.jsxs("div",{children:[Object.entries(R).filter(([r,c])=>r!=="nodes"&&r!=="label"&&r!=="nodes_dict"&&r!="nodes_dict_condition"&&c!==void 0).map(([r,c])=>e.jsxs(Y,{closable:!0,color:"blue",onClose:()=>pe(r),style:{marginBottom:8},children:[r,": ",String(c)]},r)),R.nodes_dict&&Object.entries(R.nodes_dict).filter(([r,c])=>c&&c.length>0).map(([r,c])=>e.jsxs(Y,{onClick:()=>o("dataFilter"),color:"green",style:{marginBottom:"0.5rem",cursor:"pointer"},children:[r,": ",c.length]},r))]}),styles:{body:{padding:0}},size:"small",extra:e.jsx(e.Fragment,{children:e.jsxs(Ce,{justify:"flex-end",gap:"small",children:[v=="forceGraphView"&&e.jsx("span",{style:{cursor:"pointer"},onClick:me,children:p?"2D":"3D"}),e.jsx(mt,{options:[{label:"VisNetwork",value:"visNetwork"},{label:"ForceGraphView",value:"forceGraphView"}],onChange:()=>{},selectedLabel:v,setSelectedLabel:C,loading:G}),e.jsx(pt,{loading:G,options:H,selectedLabels:R.nodes,setSelectedLabels:r=>V("nodes",r),onChange:r=>{V("nodes",r),ae(Se(r))}}),e.jsx(D,{title:"association page",children:e.jsx(Ye,{onClick:()=>{o("associationPage")}})}),e.jsx(D,{title:"data screening",children:e.jsx($e,{onClick:()=>{o("dataFilter")}})}),e.jsx(D,{title:"AI",children:e.jsx(Ue,{onClick:()=>{o("chat")}})}),e.jsx(D,{title:"create",children:e.jsx(Ee,{onClick:()=>{l("optModal",{entityType:"association"})}})}),e.jsx(D,{title:"refresh",children:e.jsx(Ie,{onClick:()=>T()})}),e.jsx(Pe,{onClick:()=>{ue(),O("webGLInfo")}})]})}),style:{borderRadius:"12px",height:t,boxShadow:"0 4px 20px rgba(0,0,0,0.1)",padding:"0.5rem",overflow:"hidden",width:"100%"},children:[e.jsx("div",{style:{display:"flex",gap:8,marginBottom:16},children:e.jsx(lt,{placeholder:"搜索...",allowClear:!0,onSearch:r=>{V("keyword",r)},style:{flex:1}})}),e.jsx(P,{indicator:e.jsx(ke,{spin:!0}),spinning:G||p==null||!q,children:e.jsxs("div",{ref:z,style:{height:`${t}px`},children:[e.jsx(dt,{...ve,...h,view:v}),Q&&L&&e.jsx("div",{style:{position:"fixed",top:W.y,left:W.x,background:"#222",border:"1px solid #444",borderRadius:"8px",boxShadow:"0 5px 15px rgba(0,0,0,0.5)",zIndex:100,padding:"4px 0",minWidth:"160px",color:"white"},children:fe.map(r=>e.jsx("div",{onClick:()=>he(r),style:{padding:"8px 16px",cursor:"pointer",transition:"background 0.2s, color 0.2s"},onMouseEnter:c=>{c.currentTarget.style.background="#555",c.currentTarget.style.color="#fff"},onMouseLeave:c=>{c.currentTarget.style.background="transparent",c.currentTarget.style.color="white"},children:r.label},r.key))})]})})]})}),e.jsx(ht,{callback:()=>T(),visible:y.key=="nodeView"&&y.visible,params:y.params,onClose:()=>{$(null),_()}}),e.jsx(ft,{webglInfo:ie,visible:y.key=="webGLInfo"&&y.visible,onClose:_})]})},ft=({webglInfo:o,visible:t,onClose:n})=>e.jsx(Z,{title:"webGL",footer:null,open:t,onCancel:n,onClose:n,children:o&&e.jsxs("ul",{children:[e.jsxs("li",{children:["geometries: ",o.geometries]}),e.jsxs("li",{children:["textures: ",o.textures]}),e.jsxs("li",{children:["programs: ",o.programs]}),e.jsxs("li",{children:["renderCalls: ",o.renderCalls]})]})}),ht=({visible:o,params:t,onClose:n,callback:s})=>e.jsx(Le,{title:`${t!=null&&t.entity_name?t.entity_name:""}`,open:o,onClose:n,width:"50%",placement:"right",children:JSON.stringify(t)}),Dt=i.forwardRef(ut),pt=({options:o,onChange:t,selectedLabels:n,setSelectedLabels:s,loading:a})=>e.jsx(te,{trigger:["hover"],dropdownRender:()=>e.jsxs("div",{style:{padding:12,backgroundColor:"#1f1f1f",borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.3)",color:"#fff"},children:[e.jsx(P,{spinning:a,children:e.jsx(Ge.Group,{style:{display:"flex",flexDirection:"column",gap:8},options:o.map(l=>({label:l.label,value:l.value,style:{color:"#fff"}})),value:n,onChange:l=>{s(l),t(l)}})}),e.jsx("div",{style:{marginTop:12,textAlign:"center"},children:e.jsx(Me,{size:"small",type:"primary",onClick:()=>{if(n.length===H.length)s([]),t([]);else{const l=H.map(h=>h.value);s(l),t(l)}},children:n.length===H.length?" Unselect All":"Select All"})})]}),children:e.jsx(Te,{})}),mt=({options:o,onChange:t,selectedLabel:n,setSelectedLabel:s,loading:a=!1})=>e.jsx(te,{trigger:["hover"],dropdownRender:()=>e.jsx("div",{style:{padding:12,backgroundColor:"#1f1f1f",borderRadius:8,boxShadow:"0 4px 12px rgba(0,0,0,0.3)",color:"#fff"},children:e.jsx(P,{spinning:a,children:e.jsx(Oe.Group,{style:{display:"flex",flexDirection:"column",gap:8},options:o.map(l=>({label:l.label,value:l.value,style:{color:"#fff"}})),value:n,onChange:l=>{s(l.target.value),t(l.target.value)}})})}),children:e.jsx(Qe,{})});export{dt as GraphRender,Dt as default,ct as graphViewMapping};
