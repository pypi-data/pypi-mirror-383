import{a as F,r as f,q as te,k as V,j as e,F as _,i as A,l as z,B as v,M as $,d as M,I as O,P as D,v as q,m as se,D as ne,c as ie,Y as re,S as oe,u as G,R as ae,C as le,b as ce,p as de}from"./main-CuY7LwDi.js";import he from"./index-C3ZkAJoo.js";import{C as U}from"./index-BMhTxeKN.js";import{M as H,R as ue}from"./index-DFeHvYNt.js";import{F as T}from"./index-DQ88mTzX.js";import{T as Y}from"./index-qOmqaMb2.js";import{F as Q}from"./Table-C4qk6tSP.js";import{KGMLMapSVG as me}from"./index-CMWrhJTm.js";import{S as X}from"./index-C59h2Yua.js";import{A as fe}from"./index-BYHgQKhy.js";import{I as pe}from"./index-CozlEGtu.js";const rt=async n=>await F.get("/file-operation/read-file",{params:{file_path:n}}),ge=async(n,a=0)=>await F.get("/file-operation/read-log-file",{params:{file_path:n,offset:a}}),ot=async(n,a)=>await F.post("/file-operation/write-file",{file_path:n,content:a}),at=async n=>await F.get(`/find-analysis-by-id/${n}`),xe=async(n,a)=>await F.post(`/run-analysis-v2/${n}?run_type=${a}`),ye=async(n,a)=>await F.post(`/analysis/stop-analysis/${n}?run_type=${a}`);function k(n,a,t){let s=t.initialDeps??[],i;function r(){var l,o,c,h;let d;t.key&&((l=t.debug)!=null&&l.call(t))&&(d=Date.now());const m=n();if(!(m.length!==s.length||m.some((j,w)=>s[w]!==j)))return i;s=m;let g;if(t.key&&((o=t.debug)!=null&&o.call(t))&&(g=Date.now()),i=a(...m),t.key&&((c=t.debug)!=null&&c.call(t))){const j=Math.round((Date.now()-d)*100)/100,w=Math.round((Date.now()-g)*100)/100,S=w/16,b=(x,y)=>{for(x=String(x);x.length<y;)x=" "+x;return x};console.info(`%c⏱ ${b(w,5)} /${b(j,5)} ms`,`
            font-size: .6rem;
            font-weight: bold;
            color: hsl(${Math.max(0,Math.min(120-120*S,120))}deg 100% 31%);`,t==null?void 0:t.key)}return(h=t==null?void 0:t.onChange)==null||h.call(t,i),i}return r.updateDeps=l=>{s=l},r}function W(n,a){if(n===void 0)throw new Error("Unexpected undefined");return n}const je=(n,a)=>Math.abs(n-a)<1.01,be=(n,a,t)=>{let s;return function(...i){n.clearTimeout(s),s=n.setTimeout(()=>a.apply(this,i),t)}},R=n=>{const{offsetWidth:a,offsetHeight:t}=n;return{width:a,height:t}},ve=n=>n,we=n=>{const a=Math.max(n.startIndex-n.overscan,0),t=Math.min(n.endIndex+n.overscan,n.count-1),s=[];for(let i=a;i<=t;i++)s.push(i);return s},Se=(n,a)=>{const t=n.scrollElement;if(!t)return;const s=n.targetWindow;if(!s)return;const i=l=>{const{width:o,height:c}=l;a({width:Math.round(o),height:Math.round(c)})};if(i(R(t)),!s.ResizeObserver)return()=>{};const r=new s.ResizeObserver(l=>{const o=()=>{const c=l[0];if(c!=null&&c.borderBoxSize){const h=c.borderBoxSize[0];if(h){i({width:h.inlineSize,height:h.blockSize});return}}i(R(t))};n.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(o):o()});return r.observe(t,{box:"border-box"}),()=>{r.unobserve(t)}},P={passive:!0},B=typeof window>"u"?!0:"onscrollend"in window,Fe=(n,a)=>{const t=n.scrollElement;if(!t)return;const s=n.targetWindow;if(!s)return;let i=0;const r=n.options.useScrollendEvent&&B?()=>{}:be(s,()=>{a(i,!1)},n.options.isScrollingResetDelay),l=d=>()=>{const{horizontal:m,isRtl:p}=n.options;i=m?t.scrollLeft*(p&&-1||1):t.scrollTop,r(),a(i,d)},o=l(!0),c=l(!1);c(),t.addEventListener("scroll",o,P);const h=n.options.useScrollendEvent&&B;return h&&t.addEventListener("scrollend",c,P),()=>{t.removeEventListener("scroll",o),h&&t.removeEventListener("scrollend",c)}},Ce=(n,a,t)=>{if(a!=null&&a.borderBoxSize){const s=a.borderBoxSize[0];if(s)return Math.round(s[t.options.horizontal?"inlineSize":"blockSize"])}return n[t.options.horizontal?"offsetWidth":"offsetHeight"]},Ie=(n,{adjustments:a=0,behavior:t},s)=>{var i,r;const l=n+a;(r=(i=s.scrollElement)==null?void 0:i.scrollTo)==null||r.call(i,{[s.options.horizontal?"left":"top"]:l,behavior:t})};class ze{constructor(a){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.measurementsCache=[],this.itemSizeCache=new Map,this.pendingMeasuredCacheIndexes=[],this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let t=null;const s=()=>t||(!this.targetWindow||!this.targetWindow.ResizeObserver?null:t=new this.targetWindow.ResizeObserver(i=>{i.forEach(r=>{const l=()=>{this._measureElement(r.target,r)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(l):l()})}));return{disconnect:()=>{var i;(i=s())==null||i.disconnect(),t=null},observe:i=>{var r;return(r=s())==null?void 0:r.observe(i,{box:"border-box"})},unobserve:i=>{var r;return(r=s())==null?void 0:r.unobserve(i)}}})(),this.range=null,this.setOptions=t=>{Object.entries(t).forEach(([s,i])=>{typeof i>"u"&&delete t[s]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:ve,rangeExtractor:we,onChange:()=>{},measureElement:Ce,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...t}},this.notify=t=>{var s,i;(i=(s=this.options).onChange)==null||i.call(s,this,t)},this.maybeNotify=k(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),t=>{this.notify(t)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(t=>t()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var t;const s=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==s){if(this.cleanup(),!s){this.maybeNotify();return}this.scrollElement=s,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=((t=this.scrollElement)==null?void 0:t.window)??null,this.elementsCache.forEach(i=>{this.observer.observe(i)}),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0}),this.unsubs.push(this.options.observeElementRect(this,i=>{this.scrollRect=i,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(i,r)=>{this.scrollAdjustments=0,this.scrollDirection=r?this.getScrollOffset()<i?"forward":"backward":null,this.scrollOffset=i,this.isScrolling=r,this.maybeNotify()}))}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??(typeof this.options.initialOffset=="function"?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(t,s)=>{const i=new Map,r=new Map;for(let l=s-1;l>=0;l--){const o=t[l];if(i.has(o.lane))continue;const c=r.get(o.lane);if(c==null||o.end>c.end?r.set(o.lane,o):o.end<c.end&&i.set(o.lane,!0),i.size===this.options.lanes)break}return r.size===this.options.lanes?Array.from(r.values()).sort((l,o)=>l.end===o.end?l.index-o.index:l.end-o.end)[0]:void 0},this.getMeasurementOptions=k(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled],(t,s,i,r,l)=>(this.pendingMeasuredCacheIndexes=[],{count:t,paddingStart:s,scrollMargin:i,getItemKey:r,enabled:l}),{key:!1}),this.getMeasurements=k(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:t,paddingStart:s,scrollMargin:i,getItemKey:r,enabled:l},o)=>{if(!l)return this.measurementsCache=[],this.itemSizeCache.clear(),[];this.measurementsCache.length===0&&(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(d=>{this.itemSizeCache.set(d.key,d.size)}));const c=this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[];const h=this.measurementsCache.slice(0,c);for(let d=c;d<t;d++){const m=r(d),p=this.options.lanes===1?h[d-1]:this.getFurthestMeasurement(h,d),g=p?p.end+this.options.gap:s+i,j=o.get(m),w=typeof j=="number"?j:this.options.estimateSize(d),S=g+w,b=p?p.lane:d%this.options.lanes;h[d]={index:d,start:g,size:w,end:S,key:m,lane:b}}return this.measurementsCache=h,h},{key:!1,debug:()=>this.options.debug}),this.calculateRange=k(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(t,s,i,r)=>this.range=t.length>0&&s>0?Me({measurements:t,outerSize:s,scrollOffset:i,lanes:r}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=k(()=>{let t=null,s=null;const i=this.calculateRange();return i&&(t=i.startIndex,s=i.endIndex),this.maybeNotify.updateDeps([this.isScrolling,t,s]),[this.options.rangeExtractor,this.options.overscan,this.options.count,t,s]},(t,s,i,r,l)=>r===null||l===null?[]:t({startIndex:r,endIndex:l,overscan:s,count:i}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=t=>{const s=this.options.indexAttribute,i=t.getAttribute(s);return i?parseInt(i,10):(console.warn(`Missing attribute name '${s}={index}' on measured element.`),-1)},this._measureElement=(t,s)=>{const i=this.indexFromElement(t),r=this.measurementsCache[i];if(!r)return;const l=r.key,o=this.elementsCache.get(l);o!==t&&(o&&this.observer.unobserve(o),this.observer.observe(t),this.elementsCache.set(l,t)),t.isConnected&&this.resizeItem(i,this.options.measureElement(t,s,this))},this.resizeItem=(t,s)=>{const i=this.measurementsCache[t];if(!i)return;const r=this.itemSizeCache.get(i.key)??i.size,l=s-r;l!==0&&((this.shouldAdjustScrollPositionOnItemSizeChange!==void 0?this.shouldAdjustScrollPositionOnItemSizeChange(i,l,this):i.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=l,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(i.index),this.itemSizeCache=new Map(this.itemSizeCache.set(i.key,s)),this.notify(!1))},this.measureElement=t=>{if(!t){this.elementsCache.forEach((s,i)=>{s.isConnected||(this.observer.unobserve(s),this.elementsCache.delete(i))});return}this._measureElement(t,void 0)},this.getVirtualItems=k(()=>[this.getVirtualIndexes(),this.getMeasurements()],(t,s)=>{const i=[];for(let r=0,l=t.length;r<l;r++){const o=t[r],c=s[o];i.push(c)}return i},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=t=>{const s=this.getMeasurements();if(s.length!==0)return W(s[Z(0,s.length-1,i=>W(s[i]).start,t)])},this.getOffsetForAlignment=(t,s,i=0)=>{const r=this.getSize(),l=this.getScrollOffset();s==="auto"&&(s=t>=l+r?"end":"start"),s==="center"?t+=(i-r)/2:s==="end"&&(t-=r);const o=this.getTotalSize()+this.options.scrollMargin-r;return Math.max(Math.min(o,t),0)},this.getOffsetForIndex=(t,s="auto")=>{t=Math.max(0,Math.min(t,this.options.count-1));const i=this.measurementsCache[t];if(!i)return;const r=this.getSize(),l=this.getScrollOffset();if(s==="auto")if(i.end>=l+r-this.options.scrollPaddingEnd)s="end";else if(i.start<=l+this.options.scrollPaddingStart)s="start";else return[l,s];const o=s==="end"?i.end+this.options.scrollPaddingEnd:i.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(o,s,i.size),s]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(t,{align:s="start",behavior:i}={})=>{i==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(t,s),{adjustments:void 0,behavior:i})},this.scrollToIndex=(t,{align:s="auto",behavior:i}={})=>{i==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),t=Math.max(0,Math.min(t,this.options.count-1));let r=0;const l=10,o=h=>{if(!this.targetWindow)return;const d=this.getOffsetForIndex(t,h);if(!d){console.warn("Failed to get offset for index:",t);return}const[m,p]=d;this._scrollToOffset(m,{adjustments:void 0,behavior:i}),this.targetWindow.requestAnimationFrame(()=>{const g=this.getScrollOffset(),j=this.getOffsetForIndex(t,p);if(!j){console.warn("Failed to get offset for index:",t);return}je(j[0],g)||c(p)})},c=h=>{this.targetWindow&&(r++,r<l?this.targetWindow.requestAnimationFrame(()=>o(h)):console.warn(`Failed to scroll to index ${t} after ${l} attempts.`))};o(s)},this.scrollBy=(t,{behavior:s}={})=>{s==="smooth"&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+t,{adjustments:void 0,behavior:s})},this.getTotalSize=()=>{var t;const s=this.getMeasurements();let i;if(s.length===0)i=this.options.paddingStart;else if(this.options.lanes===1)i=((t=s[s.length-1])==null?void 0:t.end)??0;else{const r=Array(this.options.lanes).fill(null);let l=s.length-1;for(;l>=0&&r.some(o=>o===null);){const o=s[l];r[o.lane]===null&&(r[o.lane]=o.end),l--}i=Math.max(...r.filter(o=>o!==null))}return Math.max(i-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(t,{adjustments:s,behavior:i})=>{this.options.scrollToFn(t,{behavior:i,adjustments:s},this)},this.measure=()=>{this.itemSizeCache=new Map,this.notify(!1)},this.setOptions(a)}}const Z=(n,a,t,s)=>{for(;n<=a;){const i=(n+a)/2|0,r=t(i);if(r<s)n=i+1;else if(r>s)a=i-1;else return i}return n>0?n-1:0};function Me({measurements:n,outerSize:a,scrollOffset:t,lanes:s}){const i=n.length-1,r=c=>n[c].start;if(n.length<=s)return{startIndex:0,endIndex:i};let l=Z(0,i,r,t),o=l;if(s===1)for(;o<i&&n[o].end<t+a;)o++;else if(s>1){const c=Array(s).fill(0);for(;o<i&&c.some(d=>d<t+a);){const d=n[o];c[d.lane]=d.end,o++}const h=Array(s).fill(t+a);for(;l>=0&&h.some(d=>d>=t);){const d=n[l];h[d.lane]=d.start,l--}l=Math.max(0,l-l%s),o=Math.min(i,o+(s-1-o%s))}return{startIndex:l,endIndex:o}}const K=typeof document<"u"?f.useLayoutEffect:f.useEffect;function Ee(n){const a=f.useReducer(()=>({}),{})[1],t={...n,onChange:(i,r)=>{var l;r?te.flushSync(a):a(),(l=n.onChange)==null||l.call(n,i,r)}},[s]=f.useState(()=>new ze(t));return s.setOptions(t),K(()=>s._didMount(),[]),K(()=>s._willUpdate()),s}function _e(n){return Ee({observeElementRect:Se,observeElementOffset:Fe,scrollToFn:Ie,...n})}const{Text:J}=A,ke=({file_path:n})=>{var h;f.useEffect(()=>{console.log("fileKey",n),n&&r(n)},[n]);const{messageApi:a}=V(),t=f.useRef(0),[s,i]=f.useState([]),r=async(d,m=!1)=>{const p=await ge(d);t.current=p.data.offset,i(p.data.content),m&&a.success(`日志加载成功: ${d}`)},l=f.useRef(null),o=_e({count:s.length,getScrollElement:()=>l.current,estimateSize:()=>30,overscan:10});f.useEffect(()=>{(s==null?void 0:s.length)>0&&o.scrollToIndex(s.length-1,{align:"end",behavior:"smooth"})},[s==null?void 0:s.length]);const c=o.getVirtualItems();return e.jsx(U,{size:"small",extra:e.jsx(v,{size:"small",type:"primary",onClick:()=>{r(n)},children:"Refresh Log"}),title:e.jsxs(_,{gap:"small",wrap:"wrap",children:[e.jsxs(z,{color:"blue",children:["File: ",n]}),e.jsxs(z,{color:"purple",children:["Offset: ",t.current]})]}),bodyStyle:{padding:0},children:e.jsx("div",{ref:l,style:{height:400,overflowY:"auto",fontFamily:"monospace",backgroundColor:"#1e1e1e",color:"#d4d4d4",padding:"0 12px"},children:e.jsx("div",{style:{height:o.getTotalSize(),width:"100%",position:"relative"},children:e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",transform:`translateY(${((h=c[0])==null?void 0:h.start)??0}px)`},children:c.map(d=>e.jsx("div",{"data-index":d.index,ref:o.measureElement,style:{padding:"4px 0",borderBottom:"1px solid #333"},children:e.jsxs(_,{gap:"middle",children:[e.jsxs(J,{type:"secondary",style:{width:60,color:"#d4d4d4"},children:["#",d.index+1]}),e.jsx(J,{style:{whiteSpace:"pre-wrap",color:"#d4d4d4"},children:s[d.index]})]})},d.key))})})})})},Oe=({visible:n,onClose:a,params:t})=>e.jsx($,{footer:null,title:"参数",width:"50%",open:n,onCancel:a,children:e.jsx(A,{children:e.jsx("pre",{children:JSON.stringify(t,null,2)})})}),Ae=({formJson:n,openModal:a})=>{if(!n)return null;const[t,s]=f.useState([]),i=async()=>{const r=n.map(c=>c.dataKey),o=((await F.post("/list-bio-database",{type_list:r})).data||[]).reduce((c,h)=>{const d=h.type;c[d]||(c[d]=[]);const{name:m,database_id:p,...g}=h;return c[d].push({label:m,value:p,...g}),c},{});s(o),console.log(o)};return f.useEffect(()=>{i()},[n]),e.jsx(e.Fragment,{children:e.jsxs(_,{gap:"small",children:[e.jsx("div",{style:{flex:1},children:e.jsx(T,{formJson:n,dataMap:t})}),e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:a,children:"配置数据库"}),e.jsx(v,{onClick:i,size:"small",type:"primary",children:"刷新"})]})})},De=({visible:n,onClose:a,params:t,callback:s})=>{if(!n)return null;const[i,r]=f.useState([]),[l,o]=f.useState(!1),[c]=M.useForm(),[h,d]=f.useState(t[0].dataKey),[m,p]=f.useState(null),g=async u=>{o(!0);const I=await F.post("/list-bio-database",u);r(I.data),o(!1)},j=async()=>({...await c.validateFields(),type:h}),w=async()=>{const u=await j();m?await F.post("/update-bio-database",{...u,database_id:m.database_id}):await F.post("/add-bio-database",u),S(),p(void 0),c.resetFields()},S=()=>{g({type:h})};f.useEffect(()=>{g({type:h})},[t]);const b=u=>{d(u),g({type:u})},x=async u=>{await F.delete(`/delete-bio-database/${u.id}`),S()},y=u=>{c.setFieldsValue(u),p(u)};return e.jsxs($,{title:"数据库操作",open:n,onCancel:a,width:"50%",footer:null,children:[e.jsx(Y,{tabBarExtraContent:e.jsxs(e.Fragment,{children:[e.jsx(v,{size:"small",color:"cyan",variant:"solid",style:{marginRight:"0.5rem"},type:"primary",onClick:S,children:" 刷新"}),e.jsxs(v,{size:"small",color:"cyan",variant:"solid",type:"primary",onClick:()=>{p(void 0),w()},children:[" ",m?"更新":"添加"]})]}),activeKey:h,onChange:b,items:t.map(u=>({key:u.name,label:u.label,children:e.jsx("div",{})}))}),e.jsxs(M,{form:c,style:{maxWidth:600},labelCol:{span:3},children:[e.jsx(M.Item,{name:"name",label:"名称",rules:[{required:!0,message:"请输入名称"}],children:e.jsx(O,{})}),e.jsx(M.Item,{name:"path",label:"路径",rules:[{required:!0,message:"请输入路径"}],children:e.jsx(O,{})}),e.jsx(M.Item,{name:"db_index",label:"索引",children:e.jsx(O,{})})]}),e.jsx(Q,{dataSource:i,columns:[{title:"名称",dataIndex:"name",key:"name"},{title:"数据库ID",dataIndex:"database_id",key:"database_id"},{title:"类型",dataIndex:"type",key:"type"},{title:"路径",dataIndex:"path",key:"path"},{title:"索引",dataIndex:"db_index",key:"db_index"},{title:"操作",dataIndex:"action",key:"action",ellipsis:!0,render:(u,I)=>e.jsxs(_,{gap:"small",children:[e.jsx(D,{title:"确定删除吗？",onConfirm:()=>{x(I)},children:e.jsx(v,{size:"small",type:"primary",danger:!0,children:"删除"})}),e.jsx(v,{size:"small",type:"primary",onClick:()=>{y(I)},children:"编辑"})]})}],loading:l,pagination:!1})]})},Ve=({visible:n,params:a,onClose:t,callback:s})=>{var S,b,x;const[i]=M.useForm(),{messageApi:r,project:l}=V();f.useEffect(()=>{n&&j()},[a]);const[o,c]=f.useState(),[h,d]=f.useState(),m=()=>{t(),s&&s()},[p,g]=f.useState(),j=async()=>{g(!0);const y=await F.post(`/analysis/edit-params/${a}`);c(y.data),d(y.data.analysis_result),i.resetFields(),i.setFieldsValue(y.data.request_param),g(!1)},w=y=>{if(y&&Object.keys(y).length>0)return Object.keys(y)[0]};return e.jsx(e.Fragment,{children:e.jsx(ne,{size:"default",loading:p,title:e.jsx(e.Fragment,{children:o&&e.jsxs(e.Fragment,{children:[e.jsx(z,{children:o==null?void 0:o.component_name}),e.jsx(z,{children:o==null?void 0:o.analysis_name}),e.jsx(z,{children:String(o==null?void 0:o.analysis_id).slice(0,8)})]})}),width:"50%",open:n,onClose:t,children:o&&e.jsx(e.Fragment,{children:e.jsx(Te,{form:i,requestParam:{...o.request_param,analysis_id:o==null?void 0:o.analysis_id},dataMap:{...h,first_data_key:w(h)},formJson:[...((S=o.content)==null?void 0:S.formJson)||[],...((b=o.content)==null?void 0:b.upstreamFormJson)||[],...(o==null?void 0:o.inputFormJson)||[],(o==null?void 0:o.component_type)=="software"?{name:"group_field",label:"Group Field",rules:[{required:!0,message:"该字段不能为空!"}],type:"GroupFieldSelect"}:{}],databases:(x=o.content)==null?void 0:x.databases,upstreamFormJson:o==null?void 0:o.upstreamFormJson,callback:m})})})})},Te=({form:n,requestParam:a,dataMap:t,formJson:s,databases:i,callback:r,showCancal:l=!1})=>{const{modals:o,openModals:c,closeModals:h}=q(["paramsView","bioDatabases"]),[d,m]=f.useState([]),[p,g]=f.useState([]),{messageApi:j}=V();f.useEffect(()=>{w()},[JSON.stringify(s)]);const w=()=>{if(Array.isArray(s)){const x=s.filter(u=>!(u!=null&&u.required)&&!(u!=null&&u.db)&&!u.component_id),y=s.filter(u=>(u==null?void 0:u.required)||(u==null?void 0:u.db)||u.component_id);m(y),g(x)}},S=x=>({...a,...x}),b=async(x,y=!1)=>{var E;const u=await n.validateFields(),I=S(u);try{const C=await F.post(`/fast-api/analysis-controller?save=${x}&is_submit=${y}`,I);console.log(C),x?(j.success("执行成功!"),r&&r()):c("paramsView",C.data)}catch(C){console.log(C),(E=C.response)!=null&&E.data&&j.error(C.response.data.detail)}};return e.jsxs(e.Fragment,{children:[e.jsxs(M,{form:n,onValuesChange:(x,y)=>{},children:[e.jsx(Y,{items:[{key:"1",label:"Required Parameters",forceRender:!0,children:e.jsxs(e.Fragment,{children:[e.jsx(T,{formJson:[...d],dataMap:t}),i&&e.jsx(Ae,{openModal:()=>{c("bioDatabases",i)},formJson:i})]})},{key:"2",label:"Optional parameters",forceRender:!0,children:e.jsx(e.Fragment,{children:e.jsx(T,{formJson:[...p],dataMap:{}})})}]}),e.jsx(M.Item,{label:"Analysyis Name",name:"analysis_name",style:{maxWidth:600},rules:[{required:!0,message:"This field cannot be empty!"}],children:e.jsx(O,{})}),e.jsxs(_,{gap:"small",children:[e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>{b(!1)},children:"View Parameters"}),e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>b(!0),children:a!=null&&a.analysis_id?e.jsxs(e.Fragment,{children:["Update Analysis(",a.analysis_name,")(",String(a.analysis_id).slice(0,8),")"]}):e.jsx(e.Fragment,{children:"Save Analysis"})}),(a==null?void 0:a.analysis_id)&&l&&e.jsx(v,{size:"small",color:"cyan",onClick:()=>n.setFieldValue("analysis_id",void 0),children:"Cancel Analysis"})]}),e.jsx(se,{ghost:!0,items:[{key:"1",label:"更多",children:e.jsx(e.Fragment,{children:e.jsx(M.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(A,{children:e.jsx("pre",{children:JSON.stringify(S(n.getFieldsValue()),null,2)})})})})}]})]}),e.jsx(Oe,{visible:o.paramsView.visible,onClose:()=>h("paramsView"),params:o.paramsView.params}),e.jsx(De,{visible:o.bioDatabases.visible,onClose:()=>h("bioDatabases"),params:o.bioDatabases.params})]})},L=({url:n,filename:a,baseURL:t})=>e.jsx(e.Fragment,{children:n&&e.jsx(de,{title:`${t}${n}`,children:e.jsxs(z,{color:"success",style:{cursor:"pointer"},onClick:()=>{window.open(`${t}${n}?t=${Date.now()}`,"_blank")},children:[a," ",e.jsx(ue,{})]})})}),ee=({data:n,url:a,filename:t,columns:s,baseURL:i})=>{const{Search:r}=O,[l,o]=f.useState([]),c=h=>h?Object.keys(h).map(d=>({title:d,dataIndex:d,key:d,ellipsis:!0,width:150})):[];return f.useEffect(()=>{if(n){const h=n.map((d,m)=>({...d,key:m}));o(h)}},[n]),e.jsx(e.Fragment,{children:Array.isArray(l)&&e.jsx(e.Fragment,{children:e.jsx(Q,{style:{border:"1px solid #f0f0f0"},size:"small",title:()=>e.jsxs(_,{gap:"small",children:[e.jsx(r,{size:"small",placeholder:"input search text",allowClear:!0,onSearch:h=>{const d=n.filter(m=>Object.values(m).some(p=>typeof p=="string"&&p.includes(h)));o(d)},style:{width:304}}),e.jsx(L,{url:a,filename:t,baseURL:i})]}),scroll:{x:"max-content",y:55*5},dataSource:l,pagination:!1,virtual:!0,columns:s||c(n[0]),footer:()=>`A total of ${n.length} records`})})})},N=({data:n,url:a,filename:t,baseURL:s})=>e.jsx("div",{children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx(pe,{src:t!=null&&t.endsWith("pdf")?n:`${n}?t=${Date.now()}`,style:{maxWidth:"20rem",marginRight:"0.5rem"}}),e.jsx(L,{url:a,filename:t,baseURL:s})]})}),{Paragraph:lt}=A,$e=({data:n})=>e.jsx(e.Fragment,{children:e.jsx(H,{value:n})}),Le=({data:n})=>e.jsx("div",{children:e.jsx(fe,{closable:!0,message:n,type:"info",showIcon:!0})}),We=({data:n})=>e.jsx(e.Fragment,{children:e.jsx(A,{children:e.jsx("pre",{style:{margin:0},children:n})})}),Re=({data:n})=>e.jsx(e.Fragment,{children:e.jsx(H,{value:n,defaultLanguage:"json"})}),Pe=({data:n,url:a})=>{const{baseURL:t}=G(r=>r.user),[s,i]=f.useState(!0);return e.jsx(e.Fragment,{children:e.jsxs("div",{style:{position:"relative",width:"100%",height:"80vh"},children:[s&&e.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(255,255,255,0.8)",zIndex:1},children:e.jsx(X,{size:"large",tip:"Loading..."})}),e.jsx("iframe",{src:`${t}${a}`,width:"100%",style:{height:"100%",border:"none"},onLoad:()=>i(!1),title:"content-frame"})]})})},Be=({url:n,filename:a,baseURL:t})=>e.jsx(e.Fragment,{children:e.jsx(L,{url:n,filename:a,baseURL:t})}),Ke=({data:n,...a})=>{var r,l,o,c,h;const{modal:t,openModal:s,closeModal:i}=ce();return e.jsxs(e.Fragment,{children:[e.jsx(ee,{data:n==null?void 0:n.list,...a,columns:[{title:"ID",dataIndex:"ID",key:"ID",ellipsis:!0,width:150},{title:"Description",dataIndex:"Description",key:"Description",ellipsis:!0,width:400},{title:"GeneRatio",dataIndex:"GeneRatio",key:"GeneRatio",ellipsis:!0,width:150},{title:"geneID",dataIndex:"geneID",key:"geneID",ellipsis:!0,width:150},{title:"Count",dataIndex:"Count",key:"Count",ellipsis:!0,width:150},{title:"pvalue",dataIndex:"pvalue",key:"pvalue",ellipsis:!0,width:150},{title:"p.adjust",dataIndex:"p.adjust",key:"p.adjust",ellipsis:!0,width:150},{title:"qvalue",dataIndex:"qvalue",key:"qvalue",ellipsis:!0,width:150},{title:"organism",dataIndex:"organism",key:"organism",ellipsis:!0,width:150},{title:"pathwayId",dataIndex:"pathwayId",key:"pathwayId",ellipsis:!0,width:150},{title:"操作",key:"action",fixed:"right",ellipsis:!0,width:200,render:(d,m)=>e.jsx(e.Fragment,{children:e.jsx(v,{onClick:()=>{s("KGMLMapSVG",m)},size:"small",color:"cyan",variant:"solid",children:"pathview"})})}]}),t.visible&&e.jsx($,{width:"80%",title:`${(r=t.params)==null?void 0:r.Description}(${(l=t.params)==null?void 0:l.ID})`,footer:null,onCancel:i,onClose:i,open:t.visible&&t.key=="KGMLMapSVG",children:e.jsx(me,{compound:n==null?void 0:n.compound,highlightKeys:(o=t.params)==null?void 0:o.geneID.split("/"),pathwayId:(c=t.params)==null?void 0:c.pathwayId,organisms:(h=t.params)==null?void 0:h.organism})})]})},Je={table:ee,string:$e,html:Pe,json:Re,text:We,info:Le,kegg_map:Ke,download:Be},Ne=({type:n,...a})=>{const t=Je[n]||(()=>e.jsxs("div",{children:["未知类型 ",n]}));return e.jsx("div",{style:{marginBottom:"1rem"},children:e.jsx(t,{...a})})},ct=f.forwardRef(({params:n,visible:a,onClose:t},s)=>{const{output_dir:i,analysis_id:r}=n||{};return a?e.jsx(e.Fragment,{children:r&&e.jsx(qe,{onClose:t,analysis_id:r})}):null}),qe=({analysis_id:n,onClose:a,cancalReportCallback:t})=>{var x,y;const[s,i]=f.useState(!1),[r,l]=f.useState(null),o=ie(),{eventSourceRef:c,status:h,reconnect:d}=re(),m=f.useRef(null),p=f.useRef(null),{messageApi:g}=V(),{modals:j,openModals:w,closeModals:S}=q(["editParams"]),b=async u=>{i(!0);const I=await F.get(`/analysis/visualization-results/${u}`);l(I.data),m.current=u,i(!1)};return f.useEffect(()=>{b(n)},[n]),f.useEffect(()=>{var u;if(c){const I=E=>{const C=JSON.parse(E.data);p.current=C,m.current==C.analysis_id&&(C.event=="analysis_complete"||C.event=="analysis_failed"||C.event=="analysis_started")&&b(m.current)};return(u=c.current)==null||u.addEventListener("message",I),()=>{var E;console.log("removeEventListener"),(E=c.current)==null||E.removeEventListener("message",I)}}},[c.current]),e.jsx(e.Fragment,{children:e.jsxs(U,{size:"small",bodyStyle:{padding:0},title:e.jsx(e.Fragment,{children:r?e.jsxs(e.Fragment,{children:[e.jsx(z,{style:{cursor:"pointer"},onClick:()=>{o(`/component/${r==null?void 0:r.component_type}/${r==null?void 0:r.component_id}`)},children:r==null?void 0:r.component_name}),e.jsx(z,{children:r==null?void 0:r.analysis_name}),e.jsx(z,{children:String(r==null?void 0:r.analysis_id).slice(0,8)}),e.jsx(z,{children:r==null?void 0:r.job_status}),m.current==((x=p.current)==null?void 0:x.analysis_id)&&e.jsxs(z,{children:[" ",e.jsx(e.Fragment,{children:(y=p.current)==null?void 0:y.event})]})]}):e.jsx(e.Fragment,{})}),extra:e.jsxs(_,{gap:"small",children:[a&&e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>a(),children:"Close"}),r&&e.jsxs(e.Fragment,{children:[e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>{w("editParams",r.analysis_id)},children:"Edit Parameters"}),(r==null?void 0:r.job_status)=="running"?e.jsx(e.Fragment,{children:e.jsx(D,{title:"Whether or not to stop?",onConfirm:async()=>{await ye(r.analysis_id,"job"),g.success("Stop Success")},children:e.jsx(v,{size:"small",color:"cyan",variant:"solid",children:"Stop"})})}):e.jsx(e.Fragment,{children:e.jsx(D,{title:"Whether or not to run?",onConfirm:async()=>{await xe(r.analysis_id,"job"),g.success("run successfully")},children:e.jsx(v,{size:"small",color:"cyan",variant:"solid",children:r.job_status=="created"?"Run":"Rerun"})})})]}),e.jsx(D,{title:r!=null&&r.is_report?"Whether to cancel the report?":"Reported or not?",onConfirm:async()=>{await F.post(`/analysis/update-report/${r==null?void 0:r.analysis_id}`),g.success("operate successfully!"),l(null),t&&t()},children:e.jsx(v,{size:"small",color:"cyan",variant:"solid",children:r!=null&&r.is_report?"Cancel Report":"Report"})}),e.jsx(v,{size:"small",color:"cyan",variant:"solid",onClick:()=>b(n),children:"Refresh"})]}),children:[(r==null?void 0:r.job_status)=="failed"?e.jsx("div",{style:{textAlign:"center"},children:e.jsx(ke,{file_path:r==null?void 0:r.command_log_path})}):e.jsx(e.Fragment,{children:(r==null?void 0:r.job_status)=="running"&&(r==null?void 0:r.run_type)!="server"?e.jsx(oe,{active:!0}):e.jsx(e.Fragment,{children:n&&e.jsx(Ge,{analsyisResult:r,loading:s})})}),e.jsx(Ve,{callback:()=>b(n),visible:j.editParams.visible,params:j.editParams.params,onClose:()=>S("editParams")})]})})},Ge=({analsyisResult:n,loading:a})=>{const{baseURL:t}=G(s=>s.user);return e.jsxs(X,{spinning:a,children:[n&&e.jsxs(e.Fragment,{children:[n.images&&e.jsx("div",{style:{marginBottom:"1rem",padding:"1rem",borderBottom:"1px solid #f0f0f0"},children:Array.isArray(n.images)?e.jsx(ae,{gutter:{xs:8,sm:16,md:24,lg:32},children:n.images.map((s,i)=>e.jsx(le,{span:4,children:e.jsx(N,{...s,baseURL:t})},i))}):e.jsx(e.Fragment,{children:e.jsx(N,{...n.images,baseURL:t})})}),e.jsx("div",{style:{padding:"1rem"},children:n.tables&&Array.isArray(n.tables)&&e.jsx(e.Fragment,{children:n.tables.map((s,i)=>e.jsx(Ne,{...s,baseURL:t},i))})})]}),e.jsx(he,{data:n==null?void 0:n.description})]})};export{ct as A,De as B,Te as C,Ve as E,ke as L,Oe as P,Ae as a,rt as b,Ne as c,qe as d,at as f,xe as r,ye as s,ot as w};
