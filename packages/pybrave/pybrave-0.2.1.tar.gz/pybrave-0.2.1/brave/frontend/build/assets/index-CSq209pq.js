import{r as h,k as O,j as e,d as i,e as b,I as _,T as y,B as G,a as L,F as N}from"./main-BzPVmAp-.js";import{S as P}from"./index-sAnz6zLe.js";import{T as A}from"./index-BQm1iTRH.js";const K=({type:s,dataMap:t,constDataMap:o,componentMap:r,inputAnalysisMethod:n,dataKey:l,data:u,name:c,component_id:a,inputKey:d,...p})=>{if(!t)return e.jsx("div",{children:"加载中...."});t={...t,...o};const m=r[s];if(!m)return e.jsxs("div",{children:["未知类型 ",s]});const{Component:S,dataKey:j,...C}=m;console.log(C);let x=[];return u?x=u:n?x=t[n]:l?l in t&&(x=t[l]):j?j in t&&(x=t[j]):"first_data_key"in t?x=t[t.first_data_key]:a in t&&(x=t[a]),e.jsx(S,{...C,...p,data:x,name:c})},Z=h.memo(({formJson:s,dataMap:t})=>{if(!s)return null;const{projectObj:o}=O(),l={rank:[{label:"SGB",value:"SGB"},{label:"SPECIES",value:"SPECIES"},{label:"GENUS",value:"GENUS"},{label:"FAMILY",value:"FAMILY"},{label:"ORDER",value:"ORDER"},{label:"CLASS",value:"CLASS"},{label:"PHYLUM",value:"PHYLUM"}],group_field:o!=null&&o.metadata_form?o==null?void 0:o.metadata_form.map(c=>({label:c.label,value:c.name})):[]},u={GroupSelect:{Component:w,dataKey:"sample_group_list"},Input:{Component:T},GroupCompareSelect:{Component:k},BaseSelect:{Component:w},BaseInputNumber:{Component:J},BaseInput:{Component:W},BaseSwitch:{Component:D},RankSelect:{Component:w,dataKey:"rank",mode:void 0,initialValue:"SPECIES"},GroupFieldSelect:{Component:w,dataKey:"group_field",mode:void 0,initialValue:"group"},FilterFieldSelect:{Component:$,dataKey:"sample_group_list",mode:void 0},GroupSelectSampleButton:{Component:U},MetaphlanCladeSelect:{Component:R},SelectAll:{Component:V,dataKey:"sample_group_list"}};return e.jsx(e.Fragment,{children:s.map((c,a)=>e.jsx(K,{...c,dataMap:t,componentMap:u,constDataMap:l},a))})},(s,t)=>(console.log("prevProps==nextProps: ",JSON.stringify(s)===JSON.stringify(t)),JSON.stringify(s)===JSON.stringify(t))),$=({label:s,name:t,data:o,rules:r,field:n,...l})=>{const[u,c]=h.useState(),a=i.useFormInstance();return h.useEffect(()=>{if(o&&n){const d=[...new Set(o.map(n))],p=d.map(m=>({label:m,value:m}));c(p),a.setFieldValue(t,d[0])}},[o]),e.jsx(e.Fragment,{children:e.jsx(i.Item,{label:s,name:t,rules:r,children:e.jsx(B,{...l,options:u})})})},B=({options:s,clear:t,value:o,onChange:r,...n})=>{const l=i.useFormInstance(),u=c=>{r(c),t&&l.resetFields(t)};return e.jsx(b,{showSearch:!0,filterOption:(c,a)=>((a==null?void 0:a.label)??"").toLowerCase().includes(c.toLowerCase()),...n,options:s,value:o,onChange:u})},R=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>{const[u,c]=h.useState(),a=async()=>{let p=(await L.get("/fast-api/get_metaphlan_clade")).data.map(m=>({label:`${m.taxon.replaceAll(" ","_")}_${m.clade}`,value:m.clade}));c(p)};return h.useEffect(()=>{a()},[]),e.jsx(e.Fragment,{children:e.jsx(i.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(b,{...l,options:u,showSearch:!0,filterOption:(d,p)=>((p==null?void 0:p.label)??"").toLowerCase().includes(d.toLowerCase())})})})},k=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>{const u=i.useFormInstance(),c=i.useWatch(["sites1","group"],u),a=i.useWatch(["sites2","group"],u),[d,p]=h.useState();return h.useEffect(()=>{c&&a&&p([{label:"Prevalent in both sites",value:"Prevalent in both sites"},{label:`Prevalent in ${a.join("-")}`,value:`Prevalent in ${a.join("-")}`},{label:`Prevalent in ${c.join("-")}`,value:`Prevalent in ${c.join("-")}`},{label:"Not prevalent in either sites",value:"Not prevalent in either sites"}])},[c,a]),e.jsx(e.Fragment,{children:e.jsx(i.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(b,{showSearch:!0,filterOption:(m,S)=>((S==null?void 0:S.label)??"").toLowerCase().includes(m.toLowerCase()),...l,options:d})})})},T=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>e.jsx(e.Fragment,{children:e.jsx(i.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(y,{...l})})}),W=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>e.jsx(e.Fragment,{children:e.jsx(i.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(_,{...l})})}),D=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>e.jsx(e.Fragment,{children:e.jsx(i.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(P,{...l})})}),J=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>e.jsx(e.Fragment,{children:e.jsx(i.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(A,{...l})})}),w=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>e.jsx(e.Fragment,{children:e.jsx(i.Item,{initialValue:r||null,label:s,name:t,rules:n,children:e.jsx(B,{...l,options:o})})}),U=({label:s,name:t,rules:o,data:r,filter:n,group:l,groupField:u})=>{const[c,a]=h.useState(),[d,p]=h.useState([]),m=i.useFormInstance();let S=[];n&&(S=n.map(f=>f.name));const j=i.useWatch(f=>{const g=Object.entries(f).filter(([F])=>S.includes(F));return Object.fromEntries(g)},m),C=i.useWatch(l,m),x=(f,g)=>{const F=f.reduce((I,v)=>{const E=v[g];return I[E]||(I[E]=[]),I[E].push(v.value),I},{});a(F)};return h.useEffect(()=>{n&&j&&(r=n.reduce((f,g)=>f.filter(F=>g.method(F)===j[g.name]),r),r=r.map(f=>{const{label:g,id:F,value:I,...v}=f;return{label:`${f.label}(${n[0].method(f)})`,value:f.value,...v}})),r&&u?x(r,u):r&&C&&x(r,C),p(r)},[r,C,j]),e.jsxs(e.Fragment,{children:[e.jsx(i.Item,{label:s,name:[t,"sample"],rules:o,children:e.jsx(q,{sampleGrouped:c,sampleGroup:d,watch:[t,"group"]})}),e.jsx(i.Item,{label:s,name:[t,"group"],children:e.jsx(z,{sampleGrouped:c})})]})},V=({label:s,name:t,data:o,initialValue:r,rules:n,...l})=>e.jsx(e.Fragment,{children:e.jsx(i.Item,{initialValue:r,label:s,name:t,rules:n,children:e.jsx(Y,{data:o,...l})})}),Y=({data:s,value:t,onChange:o,mode:r,...n})=>{const[l,u]=h.useState(t),c=a=>{console.log(a),o(a),u(a)};return e.jsxs(e.Fragment,{children:[e.jsx(b,{...n,mode:r,value:l,onChange:c,allowClear:!0,options:s}),r=="multiple"&&e.jsxs(G,{onClick:()=>{const a=s.map(d=>d.value);u(a),o(a)},children:["选择全部",l&&e.jsxs(e.Fragment,{children:["(",l.length,")"]})]})]})},q=({value:s,onChange:t,sampleGroup:o,watch:r,sampleGrouped:n})=>{const[l,u]=h.useState(),c=i.useFormInstance(),a=i.useWatch(r,c);h.useEffect(()=>{u(a)},[a]);const d=p=>{const m=Object.entries(n||{}).filter(([S])=>p.includes(S)).flatMap(([,S])=>S);t(m)};return h.useEffect(()=>{l&&d(l)},[l]),e.jsxs(e.Fragment,{children:[e.jsx(b,{showSearch:!0,filterOption:(p,m)=>((m==null?void 0:m.label)??"").toLowerCase().includes(p.toLowerCase()),mode:"multiple",value:s,onChange:t,options:o}),s&&e.jsxs(e.Fragment,{children:["A total of ",s.length," samples were selected"]})]})},z=({value:s,onChange:t,sampleGrouped:o})=>{const r=n=>{if((s||[]).includes(n)){const l=(s||[]).filter(u=>!u.includes(n));t(l)}else{const l=[...s||[],n];t(l)}};return e.jsx(e.Fragment,{children:e.jsx(N,{gap:"small",wrap:!0,children:Object.entries(o||{}).map(([n,l])=>e.jsx("span",{children:e.jsxs(G,{size:"small",type:(s||[]).includes(n)?"primary":"dashed",onClick:()=>r(n),children:[n,"(",l.length,")"]})},n))})})};export{Z as F};
