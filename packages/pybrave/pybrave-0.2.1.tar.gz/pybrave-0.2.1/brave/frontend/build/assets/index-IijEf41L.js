import{r as n,x as ae,_ as ne,s as S,b as ie,c as le,X as re,Y as oe,u as ce,a as y,j as e,I as de,F as ue,B as r,t as v,l as x,p as pe,P as m,Z as me,k as he,d as A,M as je,e as xe}from"./main-BzPVmAp-.js";import{P as ye}from"./index-2r9flV8X.js";import{A as _e,E as fe,s as ge,r as ve}from"./index-B-RBPprY.js";import{I as be}from"./index-BfzdirmR.js";import{C as ke}from"./index-7u0Bo8e4.js";import{F as Ce,S as J,D as Se}from"./Table-kIlrKW-9.js";var we={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M888 792H200V168c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v688c0 4.4 3.6 8 8 8h752c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM305.8 637.7c3.1 3.1 8.1 3.1 11.3 0l138.3-137.6L583 628.5c3.1 3.1 8.2 3.1 11.3 0l275.4-275.3c3.1-3.1 3.1-8.2 0-11.3l-39.6-39.6a8.03 8.03 0 00-11.3 0l-230 229.9L461.4 404a8.03 8.03 0 00-11.3 0L266.3 586.7a8.03 8.03 0 000 11.3l39.5 39.7z"}}]},name:"line-chart",theme:"outlined"},Ie=function(i,_){return n.createElement(ae,ne({},i,{ref:_,icon:we}))},Fe=n.forwardRef(Ie);const He=n.forwardRef(({title:w,form:i,appendSampleColumns:_=[],setResultTableList:f,cleanDom:P,analysisType:L,setRecord:b,setTableLoading:I,setTabletData:g,shouldTrigger:z,columnsParamsALL:E,project:u,software:$,component_id:h,component_ids:V,operatePipeline:Ae,editParams:Pe},H)=>{n.useImperativeHandle(H,()=>({reload:l}));const[Le,U]=n.useState(),[ze,K]=S.useMessage(),{modal:a,openModal:p,closeModal:o}=ie(),[Ee,$e]=n.useState(!1),X=le(),Y=re(),{eventSourceRef:k,status:Me,reconnect:De}=oe(),[c,Z]=n.useState([]),F=n.useRef([]),R=n.useRef(null),[q,M]=n.useState(!1),[Oe,G]=n.useState(),{containerURL:D}=ce(t=>t.user);n.useEffect(()=>{if(c&&Array.isArray(c)&&c.length>0&&a.visible&&a.params){const t=c.find(s=>s.analysis_id==a.params.analysis_id);t&&G(t)}},[c,a.params]),n.useEffect(()=>{var t;if(k){const s=d=>{var W;const j=JSON.parse(d.data);console.log("analysisId",F.current),F.current.includes(j.analysis_id)?(j.event=="analysis_complete"||j.event=="analysis_failed"||j.event=="analysis_started")&&(l(),R.current&&((W=R.current)==null||W.relaod())):j.run_type=="retry"&&j.event=="container_pulled"&&l()};return(t=k.current)==null||t.addEventListener("message",s),()=>{var d;console.log("removeEventListener"),(d=k.current)==null||d.removeEventListener("message",s)}}},[k.current,u]);const Q=t=>{b&&b(t),U(t)},l=async()=>{M(!0);let t=await y.post("/list-analysis",{component_id:h,component_ids:V,project:u});f&&f(t.data),Z(t.data);const s=t.data.map(d=>d.analysis_id);F.current=s,M(!1)},ee=async t=>{await y.delete(`/fast-api/analysis/${t}`),S.success("successfully delete!"),l()},O=(t,s)=>a.params?t.analysis_id==a.params.analysis_id&&s==a.key:!1,B=async(t,s)=>{await ve(t.analysis_id,s),S.success("run successfully"),l()},N=async(t,s)=>{await ge(t.analysis_id,s),S.success("Stop Success"),l()};let se=[{title:"Project Name",dataIndex:"project_name",key:"project_name",ellipsis:!0,render:(t,s)=>e.jsx(v,{title:s.project,children:e.jsx("span",{style:{cursor:"pointer"},children:t})})},{title:"Job Status",dataIndex:"job_status",key:"job_status",ellipsis:!0,render:t=>e.jsx(x,{color:t==="success"?"green":t==="failed"?"red":"blue",children:t})},{title:"Server Status",dataIndex:"server_status",key:"server_status",ellipsis:!0,render:t=>e.jsx(x,{color:t==="success"?"green":t==="failed"?"red":"blue",children:t})},{title:"Component Name",dataIndex:"component_name",key:"component_name",ellipsis:!0,render:(t,s)=>e.jsx(v,{title:s.component_id,children:e.jsx("span",{style:{cursor:"pointer"},children:t})})},{title:"Analysis Name",dataIndex:"analysis_name",key:"analysis_name",ellipsis:!0},{title:"Report",dataIndex:"is_report",key:"is_report",ellipsis:!0,render:(t,s)=>e.jsx(x,{color:t?"green":"blue",children:t?"Report":"NonReport"})},{title:"Analysis Id",dataIndex:"analysis_id",key:"analysis_id",ellipsis:!0,render:(t,s)=>e.jsx(pe,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["analysis_id:",s.analysis_id]}),e.jsxs("li",{children:["analysis_name:",s.analysis_name]}),e.jsxs("li",{children:["pipeline_script:",s.pipeline_script]}),e.jsxs("li",{children:["work_dir:",s.work_dir]}),e.jsxs("li",{children:["output_dir:",s.output_dir]}),e.jsxs("li",{children:["command_log_path:",s.command_log_path]}),e.jsxs("li",{children:["trace_file:",s.trace_file]}),e.jsxs("li",{children:["executor_log_file:",s.executor_log_file]}),e.jsxs("li",{children:["workflow_log_file:",s.workflow_log_file]})]})}),children:e.jsxs("span",{style:{cursor:"pointer"},children:[" ",e.jsx("span",{style:{cursor:"pointer"},children:String(t).slice(0,8)})]})})},{title:"Container Name",dataIndex:"container_name",key:"container_name",ellipsis:!0,render:(t,s)=>e.jsxs(v,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsx("li",{children:s.container_image}),s.sub_container_image&&e.jsx("li",{children:s.sub_container_image})]})}),children:[e.jsx(x,{style:{cursor:"pointer"},children:t}),s.sub_container_name&&e.jsx(x,{style:{cursor:"pointer"},children:s.sub_container_name})]})},{title:"Image Status",dataIndex:"image_status",key:"image_status",ellipsis:!0,render:(t,s)=>e.jsx(v,{title:s.image_id,children:e.jsx(x,{color:"green",children:t})})},{title:"Action",key:"action",fixed:"right",ellipsis:!0,width:200,render:(t,s)=>e.jsxs(J,{size:"middle",children:[s.image_status=="exist"?e.jsxs(e.Fragment,{children:[s.job_status=="running"?e.jsx(e.Fragment,{children:e.jsx(m,{title:"Whether or not to stop?",onConfirm:()=>{N(s,"job")},children:e.jsx(r,{size:"small",color:"cyan",variant:"solid",children:"Stop Job"})})}):e.jsx(e.Fragment,{children:e.jsx(m,{title:"Whether or not to run?",onConfirm:()=>{B(s,"job"),p("modalA",s),Q(s)},children:e.jsx(r,{size:"small",color:"cyan",variant:"solid",children:s.analysis_status=="created"?"Run":"Rerun"})})}),s.server_status=="running"?e.jsxs(e.Fragment,{children:[e.jsx(v,{title:e.jsx(e.Fragment,{children:`${D}/container/${s.analysis_id}/`}),children:e.jsx(r,{size:"small",color:"cyan",variant:"solid",onClick:()=>{window.open(`${D}/container/${s.analysis_id}/`,"_blank")},children:"Open URL"})}),e.jsx(m,{title:"Whether or not to stop?",onConfirm:()=>{N(s,"server")},children:e.jsx(r,{size:"small",color:"cyan",variant:"solid",children:"Stop Server"})})]}):e.jsx(e.Fragment,{children:e.jsx(m,{title:"Whether to start the server?",onConfirm:()=>{B(s,"server")},children:e.jsx(r,{size:"small",color:"cyan",variant:"solid",children:"Run Server"})})})]}):e.jsx(e.Fragment,{children:e.jsx(m,{title:"Pull?",onConfirm:async()=>{await y.post(`/container/pull-image/${s.container_id}`),l()},children:e.jsx(r,{size:"small",color:"cyan",variant:"solid",children:s.image_status=="pulling"?"pulling":"Pull"})})}),e.jsx(r,{size:"small",color:"cyan",variant:"solid",onClick:()=>p("editParams",s.analysis_id),children:"Edit Parameters"}),O(s,"modalA")?e.jsx(r,{size:"small",color:"cyan",variant:"solid",onClick:()=>{o()},children:"Close"}):e.jsx(r,{size:"small",color:"cyan",variant:"solid",onClick:()=>{p("modalA",s)},children:"View Results"}),e.jsx(Se,{menu:{items:[{key:"1",label:e.jsx(e.Fragment,{children:O(s,"modalB")?e.jsx("a",{onClick:()=>{o()},children:"Close"}):e.jsx("a",{onClick:()=>{p("modalB",s)},children:"Details"})})},{key:"inspect_job",disabled:s.job_status!="running",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:async()=>{p("inspectPanel",{inspect:"inspect",id:s.analysis_id,run_type:"job"})},children:"Inspect Job"})})},{key:"inspect_server",disabled:s.server_status!="running",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:async()=>{p("inspectPanel",{inspect:"inspect",id:s.analysis_id,run_type:"server"})},children:"Inspect Server"})})},{key:"3",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:()=>{X(`/software-analysis-editor/${s.analysis_id}`,{state:{location:Y.pathname}})},children:"Edit"})})},{key:"4",label:e.jsxs(e.Fragment,{children:[" ",e.jsx(m,{title:"Delete or not?",onConfirm:async()=>{await ee(s.analysis_id),l()},children:e.jsx("a",{children:"Delete"})})]})},{key:"5",label:e.jsxs(e.Fragment,{children:[" ",e.jsx(m,{title:s.is_report?"Whether to cancel the report?":"Whether to the report?",onConfirm:async()=>{await y.post(`/analysis/update-report/${s.analysis_id}`),l()},children:s.is_report?"Cancel Report":"Report"})]})},{key:"6",label:e.jsx(e.Fragment,{children:e.jsx("a",{onClick:()=>{p("addProject",s)},children:"Add Project"})})}]},children:e.jsx("a",{onClick:d=>d.preventDefault(),children:e.jsxs(J,{children:["More",e.jsx(me,{})]})})})]})}];n.useEffect(()=>{o()},[u]),n.useEffect(()=>{l()},[u]);const[C,te]=n.useState(""),T=n.useMemo(()=>C?c.filter(t=>Object.values(t).some(s=>String(s).toLowerCase().includes(C.toLowerCase()))):c,[c,C]);return e.jsxs(e.Fragment,{children:[K,e.jsx(ke,{size:"small",title:e.jsxs(e.Fragment,{children:[e.jsx(Fe,{}),"  Analysis Record"]}),extra:e.jsx(ue,{gap:"small",children:e.jsx(r,{size:"small",type:"primary",onClick:l,children:"Refresh"})}),children:e.jsx(Ce,{title:()=>e.jsx(de.Search,{size:"small",placeholder:"搜索结果...",allowClear:!0,enterButton:!0,value:C,onChange:t=>te(t.target.value),style:{width:300}}),rowKey:"analysis_id",size:"small",bordered:!0,pagination:!1,loading:q,scroll:{x:"max-content",y:55*5},columns:se,footer:()=>`A total of ${T.length} records`,dataSource:T})}),e.jsx("div",{style:{marginBottom:"1rem"}}),e.jsx(_e,{visible:a.key=="modalA"&&a.visible,params:a.params,onClose:o}),e.jsx(ye,{ref:R,visible:a.key=="modalB"&&a.visible,params:a.params,onClose:o,callback:l}),e.jsx(fe,{callback:l,visible:a.key=="editParams"&&a.visible,params:a.params,onClose:o}),e.jsx(Re,{callback:l,visible:a.key=="addProject"&&a.visible,params:a.params,onClose:o}),e.jsx(be,{callback:l,visible:a.key=="inspectPanel"&&a.visible,params:a.params,onClose:o})]})}),Re=({visible:w,params:i,onClose:_,callback:f})=>{const[P,L]=n.useState([]),{messageApi:b,project:I}=he(),[g]=A.useForm(),z=async()=>{const $=(await y.get("/project/list-project")).data.map(h=>({label:`${h.project_name}`,value:h.project_id}));L($.filter(h=>h.value!=I))};n.useEffect(()=>{z(),g.resetFields(),i!=null&&i.extra_project_ids&&g.setFieldValue("project",JSON.parse(i==null?void 0:i.extra_project_ids))},[I]);const E=async()=>{const u=await g.validateFields();await y.post(`/analysis/update-extra-project/${i==null?void 0:i.analysis_id}`,u),b.success("添加成功!"),f&&f()};return e.jsx(je,{onOk:E,title:`添加项目(${i==null?void 0:i.analysis_name})`,open:w,onCancel:_,onClose:_,children:e.jsx(A,{form:g,children:e.jsx(A.Item,{name:"project",label:"项目",children:e.jsx(xe,{options:P,mode:"multiple"})})})})};export{He as R};
