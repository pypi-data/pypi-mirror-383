import{d as U,k as ce,r as m,u as Fe,j as e,F as A,B as x,I as de,E as ke,m as Se,i as M,a as W,M as me,Y as Ie,b as ve,t as _,p as ye,P as ie,Z as De,y as we,s as be}from"./main-BzPVmAp-.js";import{F as ze}from"./index-CSq209pq.js";import{C as pe}from"./index-7u0Bo8e4.js";import{F as xe,S as re,D as Ee,b as Re}from"./Table-kIlrKW-9.js";const Ne=({parseData:a,columns:s,importData:u})=>e.jsx(xe,{size:"small",bordered:!0,pagination:!1,footer:()=>e.jsxs("div",{style:{textAlign:"right"},children:["A total of",a.length," records   ",e.jsx(x,{size:"small",color:"cyan",variant:"solid",onClick:u,children:"确认"})]}),columns:s,dataSource:a}),P=({component_type:a,component_id:s,component_name:u,inputForm:d,operatePipeline:D,name:Y,callback:Z})=>{const[b]=U.useForm();console.log("-->ImportFile渲染");const{messageApi:F,project:Q}=ce(),[z,E]=m.useState([]);Fe(n=>n.global.setting);const[i,J]=m.useState(),S=m.useRef(null);m.useEffect(()=>{if(d){let r=d.map(o=>Array.isArray(o.name)?o.name[1]:o.name).map(o=>({title:o,dataIndex:o,key:o,render:f=>e.jsx("span",{children:f})}));r=[{title:"Sample Name",dataIndex:"sample_name",key:"sample_name",render:o=>e.jsx("span",{children:o})},...r,{title:"Action",dataIndex:"action",key:"action",ellipsis:!0,render:(o,f)=>e.jsx(A,{gap:"small",children:e.jsx(x,{size:"small",danger:!0,onClick:()=>{R(f.sample_name)},children:"删除"})})}],console.log(r),S.current=r,J(r)}},[d]);const R=n=>{E(r=>r.filter(o=>o.sample_name!==n))},L=n=>{const{content:r,sample_name:o}=n;return z?z.map(f=>{const{sample_name:T,...I}=f;return{...n,project:Q,component_id:s,content:JSON.stringify(I),sample_name:T}}):[{...n,project:Q,component_id:s,content:JSON.stringify(r),sample_name:o}]},c=async()=>{const n=await b.validateFields();if(n.length==0){F.error("No data added!");return}if(d&&d.length==0){F.error("This component does not have inputForm configured!");return}const r=L(n);try{const o=await W.post("/import-data",r);F.success("Imported successfully!"),Z&&Z()}catch(o){F.error(o.response.data.detail)}},N=async()=>{const n=await b.validateFields();if(d&&d.length==0){F.error("This component does not have inputForm configured!");return}const r=await W.post("/parse-import-data",{content:JSON.stringify(n.content)});console.log(r),E(r.data)};return m.useEffect(()=>{const n=r=>{var w;const o=((w=r.clipboardData)==null?void 0:w.getData("Text"))||"";if(!o)return;const f=o.includes("	")?"	":",",I=o.split(/\r?\n/).filter(j=>j.trim()!=="").map(j=>j.split(f).map(v=>v.trim()));console.log(I);const p=I.map(j=>{const v={};return S.current.forEach((O,$)=>{j.length<=$?v[O.dataIndex]="unknown":v[O.dataIndex]=j[$]}),v});E(p),F.success("Paste successful!")};return document.addEventListener("paste",n),()=>{document.removeEventListener("paste",n)}},[]),e.jsx(e.Fragment,{children:e.jsx(pe,{title:`${u}(${s})`,extra:e.jsxs(A,{gap:"small",children:[e.jsx(x,{size:"small",color:"cyan",variant:"solid",onClick:()=>{D.openModal("modalC",{data:{component_id:s},structure:{component_type:a}})},children:"Edit InputForm"}),e.jsx(x,{size:"small",color:"cyan",variant:"solid",disabled:!z,onClick:()=>E([]),children:"Clear"}),e.jsx(x,{size:"small",color:"cyan",variant:"solid",disabled:!d,onClick:N,children:"Parse"})]}),children:e.jsxs(U,{form:b,children:[e.jsx(U.Item,{name:"sample_source",label:"Sample Source",rules:[{required:!0,message:"This field cannot be empty!"}],children:e.jsx(de,{placeholder:"gut,brain..."})}),d?e.jsx(e.Fragment,{children:e.jsx(ze,{formJson:d,dataMap:{}})}):e.jsx(e.Fragment,{children:e.jsx(ke,{description:"This component does not have inputForm configured!",children:e.jsx(x,{color:"cyan",variant:"solid",onClick:()=>{D.openModal("modalC",{data:{component_id:s},structure:{component_type:a}})},children:"配置inputForm"})})}),e.jsx(Ne,{parseData:z,columns:i,importData:c}),e.jsx(Se,{ghost:!0,items:[{key:"1",label:"More",children:e.jsx(e.Fragment,{children:e.jsx(U.Item,{noStyle:!0,shouldUpdate:!0,children:()=>e.jsx(M,{children:e.jsx("pre",{children:JSON.stringify(L(b.getFieldsValue()),null,2)})})})})}]})]})})})},Je=({visible:a,onClose:s,params:u,callback:d})=>a?e.jsx(e.Fragment,{children:e.jsx(me,{open:a,onClose:s,width:"80%",onCancel:s,title:"Import Data",footer:null,children:e.jsx(Te,{params:u,type:"inputFile",callback:()=>{s(),d&&d()}})})}):null,Le=({params:a,type:s,callback:u})=>{if(!a)return e.jsx(e.Fragment,{children:"无数据"});if(a.component_type=="software"){if(a[s]&&Array.isArray(a[s])&&a[s].length>0)return a[s].map((d,D)=>m.createElement(P,{...d,operatePipeline:a.operatePipeline,key:D,callback:u}))}else{if(a.component_type=="pipeline")return e.jsx(P,{...a});if(a.component_type=="file")return e.jsx(P,{...a,callback:u})}},Te=m.memo(Le),Oe=m.forwardRef(({pipeline:a,software:s,title:u,form:d,appendSampleColumns:D=[],setResultTableList:Y,cleanDom:Z,analysisType:b,setRecord:F,setTableLoading:Q,setTabletData:z,shouldTrigger:E,analysisMethod:i,columnsParamsALL:J,activeTabKey:S,setActiveTabKey:R,cardExtra:L,operatePipeline:c,relationType:N,currentAnalysisMethod:n,setCurrentAnalysisMethod:r,params:o,...f},T)=>{m.useImperativeHandle(T,()=>({reload:k}));const{project:I,projectObj:p}=ce(),[w,j]=m.useState([]),[v,O]=m.useState(),[$,ee]=m.useState(!1),{eventSourceRef:B,status:$e,reconnect:Be}=Ie(),{modal:X,openModal:ue,closeModal:_e}=ve();m.useEffect(()=>{var t;if(!B)return;const l=h=>{const C=JSON.parse(h.data);if(C.msgType==="analysis_result"){const g=i.map(G=>G.component_id);console.log("componentIdList",g),console.log("data.component_id ",C.component_id),console.log(" componentIdList.includes(data.component_id) ",g.includes(C.component_id)),g.includes(C.component_id)&&k()}};return(t=B.current)==null||t.addEventListener("message",l),()=>{var h;console.log("removeEventListener"),(h=B.current)==null||h.removeEventListener("message",l)}},[B.current]);const k=()=>{if(console.log("analysisMethod: ",i),i&&Array.isArray(i)){const l=i.flatMap(t=>t.component_id);le({componentIdList:l})}else le({params:o})},ne=l=>i.reduce((C,g)=>(C[g==null?void 0:g.component_id]=g,C),{})[l];m.useEffect(()=>{var l,t;if(i&&Array.isArray(i)&&i.length>0&&R){R((l=i[0])==null?void 0:l.component_id);const h=ne((t=i[0])==null?void 0:t.component_id);r(h)}k()},[JSON.stringify(o),JSON.stringify(i),I,p==null?void 0:p.metadata_form]);const je=l=>{j(v[l]),R(l);const t=ne(l);r(t)},le=async({analysisMethodValues:l,params:t,componentIdList:h})=>{var g,G;ee(!0);let C=await W.post("/analysis-result/list-analysis-result",{project:I,component_ids:h,...t});if(h){const y=C.data.reduce((H,te)=>{const K=te.component_id;H[K]||(H[K]=[]);const{sample_name:ae,id:se,sample_group:oe,...Ce}=te;return H[K].push({label:ae,value:se,sample_group:oe||"no_group",sample_name:ae,id:se,...Ce}),H},{});console.log("groupedData",y),Y&&Y(y),O(y),j(S?y[S]?y[S]:[]:y[(g=i[0])==null?void 0:g.component_id]?y[(G=i[0])==null?void 0:G.component_id]:[])}else j(C.data);ee(!1)},ge=async l=>{await W.delete(`/analyais-result/delete-by-id/${l}`),be.success("删除成功!"),k()};let fe=[{title:"Project Name",dataIndex:"project_name",key:"project_name",width:100,ellipsis:!0,render:(l,t)=>e.jsx(_,{title:t.project,children:e.jsx("span",{style:{cursor:"pointer"},children:l})})},{title:"Analysis Result ID",dataIndex:"analysis_result_id",key:"analysis_result_id",width:50,ellipsis:!0,render:(l,t)=>e.jsx(_,{title:t.analysis_result_id,children:e.jsx("span",{style:{cursor:"pointer"},children:String(l).slice(0,8)})})},{title:"Analysis Id",dataIndex:"analysis_id",key:"analysis_id",width:50,ellipsis:!0,render:(l,t)=>e.jsx(_,{title:t.analysis_id,children:e.jsx("span",{style:{cursor:"pointer"},children:l?String(l).slice(0,8):""})})},{title:"Component Name",dataIndex:"component_name",key:"component_name",width:100,ellipsis:!0,render:(l,t)=>e.jsx(_,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["analysis_id: ",t.analysis_id]}),e.jsxs("li",{children:["component_id: ",t.component_id]}),e.jsxs("li",{children:["analysis_result_id: ",t.analysis_result_id]}),e.jsxs("li",{children:["sample_id: ",t.sample_id]}),e.jsxs("li",{children:["file_name: ",t.file_name]}),e.jsxs("li",{children:["analysis_result_hash: ",t.analysis_result_hash]})]})}),children:e.jsx("span",{style:{cursor:"pointer"},children:l})})},{title:"Sample Name",dataIndex:"sample_name",key:"sample_name",width:100,ellipsis:!0,render:(l,t)=>e.jsx(_,{title:e.jsx(e.Fragment,{children:e.jsx("ul",{children:e.jsxs("li",{children:["sample_id: ",t.sample_id]})})}),children:e.jsx("span",{style:{cursor:"pointer"},children:l})})},{title:"Sample Source",dataIndex:"sample_source",key:"sample_source",width:100,ellipsis:!0},...(()=>{var l;return!(p!=null&&p.metadata_form)||!Array.isArray(p==null?void 0:p.metadata_form)?[]:(l=p==null?void 0:p.metadata_form)==null?void 0:l.map(t=>({title:t.label,dataIndex:t.name,key:t.name,ellipsis:!0}))})(),...D,{title:"Action",key:"action",fixed:"right",ellipsis:!0,width:200,render:(l,t)=>e.jsxs(re,{size:"middle",children:[e.jsx(ye,{content:e.jsx(e.Fragment,{children:e.jsx(M,{children:e.jsx("pre",{children:JSON.stringify(t.content,null,2)})})}),children:e.jsx(x,{size:"small",color:"cyan",variant:"solid",onClick:()=>{F&&F(t),c.openModal("openFile",{content:t.content,description:n.description})},children:"Open"})}),t.sample_name?e.jsx(e.Fragment,{children:e.jsx(x,{size:"small",color:"cyan",variant:"solid",onClick:()=>{c.openModal("metadataForm",{analysis_result_id:t.analysis_result_id,sample_id:t.sample_id,callback:k})},children:"metadata"})}):e.jsx(e.Fragment,{children:e.jsx(x,{size:"small",color:"cyan",variant:"solid",onClick:()=>{c.openModal("metadataForm",{analysis_result_id:t.analysis_result_id,callback:k})},children:"Add Metadata"})}),e.jsx(x,{size:"small",color:"cyan",variant:"solid",onClick:()=>{console.log(c),c.openModals("bindSample",{analysis_result_id:t.analysis_result_id,callback:k})},children:"Bind Sample "}),e.jsx(ie,{title:"Are you sure you want to delete it?",onConfirm:async()=>{await ge(t.analysis_result_id)},children:e.jsx(x,{size:"small",color:"danger",variant:"solid",children:"Delete"})})]})}];const[q,he]=m.useState(""),V=m.useMemo(()=>q?w.filter(l=>Object.values(l).some(t=>String(t).toLowerCase().includes(q.toLowerCase()))):w,[w,q]);return e.jsxs(e.Fragment,{children:[e.jsxs(pe,{size:"small",title:e.jsxs(e.Fragment,{children:[e.jsx(Re,{})," ",u,(n==null?void 0:n.component_name)&&e.jsx(_,{title:e.jsx(e.Fragment,{children:e.jsxs("ul",{children:[e.jsxs("li",{children:["namespace: ",n==null?void 0:n.namespace_name]}),(a==null?void 0:a.component_id)&&e.jsxs("li",{children:["pipeline: ",a==null?void 0:a.component_id]}),(s==null?void 0:s.component_id)&&e.jsxs("li",{children:["software: ",s==null?void 0:s.component_id]}),(n==null?void 0:n.component_id)&&e.jsxs("li",{children:["file: ",n==null?void 0:n.component_id]}),(n==null?void 0:n.name)&&e.jsxs("li",{children:["name: ",n==null?void 0:n.name]})]})}),children:e.jsxs("span",{style:{cursor:"pointer"},children:["(",n==null?void 0:n.component_name,")"]})})]}),extra:e.jsxs(e.Fragment,{children:[L,e.jsxs(A,{gap:"small",children:[(c==null?void 0:c.openModal)&&e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"small",color:"cyan",variant:"solid",onClick:()=>{ue("importFile",{...n,operatePipeline:c})},children:"Import data "}),e.jsx(x,{size:"small",color:"primary",variant:"solid",onClick:k,children:"Refresh"}),(f.component_type=="software"||f.component_type=="file")&&e.jsx(e.Fragment,{children:e.jsx(Ee,{menu:{items:[{key:"4",label:e.jsx(_,{title:n==null?void 0:n.component_name,children:e.jsx("a",{onClick:()=>{c.openModal("modalC",{data:void 0,structure:{relation_type:N,parent_component_id:s.component_id,component_type:"file"}})},children:"Add File"})})},{key:"3",label:e.jsx(_,{title:n==null?void 0:n.component_name,children:e.jsx("a",{onClick:()=>{c.openModal("modalC",{data:n,structure:{component_type:"file"}})},children:"Edit File"})})},{key:"2",label:e.jsx(_,{title:n==null?void 0:n.component_name,children:e.jsx("a",{onClick:()=>{c.openModal("modalA",{data:void 0,pipelineStructure:{relation_type:N,parent_component_id:s.component_id}})},children:"New File"})})},{key:"1",label:e.jsx(_,{title:n==null?void 0:n.component_name,children:e.jsx("a",{onClick:()=>{c.openModal("modalA",{data:n,pipelineStructure:{relation_type:N}})},children:"Replace File"})})},{label:e.jsx(_,{title:n==null?void 0:n.component_name,children:e.jsx(ie,{title:"Whether to remove file?",onConfirm:()=>{c.deletePipelineRelation(n.relation_id)},children:e.jsx("a",{children:"Remove File"})})}),key:"0"}]},children:e.jsx("a",{onClick:l=>l.preventDefault(),children:e.jsxs(re,{children:["More",e.jsx(De,{})]})})})})]}),e.jsx(we,{onClick:()=>{c.openModal("descriptionModal",n.description)},style:{cursor:"pointer"}})]})]}),tabList:i&&Array.isArray(i)&&i.length>1?i.map(l=>({key:l.component_id,label:e.jsx(_,{title:l.component_id,children:l.component_name?l.component_name:"no_name"})})):void 0,activeTabKey:S,onTabChange:je,children:[e.jsx(xe,{title:()=>e.jsx(de.Search,{size:"small",placeholder:"搜索结果...",allowClear:!0,enterButton:!0,value:q,onChange:l=>he(l.target.value),style:{width:300}}),rowKey:l=>l.id,size:"small",bordered:!0,pagination:{pageSize:10},loading:$,scroll:{x:"max-content",y:55*5},columns:J||fe,footer:()=>`A total of ${V&&Array.isArray(V)&&V.length} records`,dataSource:V}),(n==null?void 0:n.parseFormat)&&(n==null?void 0:n.relation_type)=="software_output_file"&&e.jsx(M,{children:e.jsx("pre",{children:JSON.stringify(n.parseFormat,null,2)})})]}),e.jsx(Je,{visible:X.visible&&X.key=="importFile",params:X.params,callback:k,onClose:_e})]})}),We=({visible:a,onClose:s,params:u})=>a?e.jsx(e.Fragment,{children:e.jsx(me,{title:"分析结果",open:a,onCancel:s,width:"80%",children:e.jsx(Oe,{...u,analysisType:"sample"})})}):null;export{We as A,Oe as R};
