import{z as ke,A as _e,G as be,H as Me,f as x,r as k,J as Se,K as ue,L as de,N as we,O as Ce,Q as Ee,U as ne,W as We,V as Ae,a as me,d as re,s as $e,j as te}from"./main-BzPVmAp-.js";import{C as Ne}from"./index-B-RBPprY.js";x.Component;var Re={subtree:!0,childList:!0,attributeFilter:["style","class"]};function Fe(t,e){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Re;k.useEffect(function(){if(!(!Se()||!t)){var s,i=Array.isArray(t)?t:[t];return"MutationObserver"in window&&(s=new MutationObserver(e),i.forEach(function(a){s.observe(a,n)})),function(){var a,l;(a=s)===null||a===void 0||a.takeRecords(),(l=s)===null||l===void 0||l.disconnect()}}},[n,t])}const pe=3,se=function(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const s=document.createElement("canvas"),i=s.getContext("2d"),a=t*n,l=e*n;return s.setAttribute("width",`${a}px`),s.setAttribute("height",`${l}px`),i.save(),[i,s,a,l]},ze=(t,e,n)=>{const s=t*Math.cos(n)-e*Math.sin(n),i=t*Math.sin(n)+e*Math.cos(n);return[s,i]},Pe=()=>{const t=(e,n,s,i,a,l,m,g)=>{const[_,K,b,H]=se(i,a,s);if(e instanceof HTMLImageElement)_.drawImage(e,0,0,b,H);else{const{color:u,fontSize:p,fontStyle:Y,fontWeight:E,fontFamily:v,textAlign:q}=l,V=Number(p)*s;_.font=`${Y} normal ${E} ${V}px/${a}px ${v}`,_.fillStyle=u,_.textAlign=q,_.textBaseline="top";const P=ue(e);P==null||P.forEach((I,ee)=>{_.fillText(I??"",b/2,ee*(V+pe*s))})}const J=Math.PI/180*Number(n),M=Math.max(i,a),[O,T,W]=se(M,M,s);O.translate(W/2,W/2),O.rotate(J),b>0&&H>0&&O.drawImage(K,-b/2,-H/2);let A=0,$=0,N=0,D=0;const R=b/2,F=H/2;[[0-R,0-F],[0+R,0-F],[0+R,0+F],[0-R,0+F]].forEach(u=>{let[p,Y]=u;const[E,v]=ze(p,Y,J);A=Math.min(A,E),$=Math.max($,E),N=Math.min(N,v),D=Math.max(D,v)});const L=A+W/2,U=N+W/2,S=$-A,w=D-N,C=m*s,z=g*s,X=(S+C)*2,y=w+z,[Z,B]=se(X,y),r=function(){let u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,p=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;Z.drawImage(T,L,U,S,w,u,p,S,w)};return r(),r(S+C,-w/2-z/2),r(S+C,+w/2+z/2),[B.toDataURL(),X/s,y/s]};return x.useCallback(t,[])};function je(t){const e=x.useRef(!1),n=x.useRef(null),s=de(t);return()=>{e.current||(e.current=!0,s(),n.current=we(()=>{e.current=!1}))}}function Oe(){const t=k.useRef([null,null]);return(n,s)=>{const i=n.map(a=>a instanceof HTMLElement||Number.isNaN(a)?"":a);return Ce(t.current[0],i)||(t.current=[i,s()]),t.current[1]}}function De(t){return t.replace(/([A-Z])/g,"-$1").toLowerCase()}function Ie(t){return Object.keys(t).map(e=>`${De(e)}: ${t[e]};`).join(" ")}function Ge(){return window.devicePixelRatio||1}const He=(t,e)=>{let n=!1;return t.removedNodes.length&&(n=Array.from(t.removedNodes).some(s=>e(s))),t.type==="attributes"&&e(t.target)&&(n=!0),n},Te={visibility:"visible !important"};function Xe(t){const e=k.useRef(new Map);return[(a,l,m)=>{if(m){if(!e.current.get(m)){const _=document.createElement("div");e.current.set(m,_)}const g=e.current.get(m);g.setAttribute("style",Ie(Object.assign(Object.assign(Object.assign({},t),{backgroundImage:`url('${a}')`,backgroundSize:`${Math.floor(l)}px`}),Te))),g.removeAttribute("class"),g.removeAttribute("hidden"),g.parentElement!==m&&m.append(g)}return e.current.get(m)},a=>{const l=e.current.get(a);l&&a&&a.removeChild(l),e.current.delete(a)},a=>Array.from(e.current.values()).includes(a)]}function oe(t,e){return t.size===e.size?t:e}const ce=100,ie=100,le={position:"relative",overflow:"hidden"},Ye=t=>{var e,n;const{zIndex:s=9,rotate:i=-22,width:a,height:l,image:m,content:g,font:_={},style:K,className:b,rootClassName:H,gap:J=[ce,ie],offset:M,children:O,inherit:T=!0}=t,W=Object.assign(Object.assign({},le),K),[,A]=Ee(),{color:$=A.colorFill,fontSize:N=A.fontSizeLG,fontWeight:D="normal",fontStyle:R="normal",fontFamily:F="sans-serif",textAlign:Q="center"}=_,[L=ce,U=ie]=J,S=L/2,w=U/2,C=(e=M==null?void 0:M[0])!==null&&e!==void 0?e:S,z=(n=M==null?void 0:M[1])!==null&&n!==void 0?n:w,X=x.useMemo(()=>{const o={zIndex:s,position:"absolute",left:0,top:0,width:"100%",height:"100%",pointerEvents:"none",backgroundRepeat:"repeat"};let c=C-S,d=z-w;return c>0&&(o.left=`${c}px`,o.width=`calc(100% - ${c}px)`,c=0),d>0&&(o.top=`${d}px`,o.height=`calc(100% - ${d}px)`,d=0),o.backgroundPosition=`${c}px ${d}px`,o},[s,C,S,z,w]),[y,Z]=x.useState(),[B,r]=x.useState(new Set),u=x.useMemo(()=>{const o=y?[y]:[];return[].concat(o,ne(Array.from(B)))},[y,B]),p=o=>{let c=120,d=64;if(!m&&o.measureText){o.font=`${Number(N)}px ${F}`;const j=ue(g),G=j.map(h=>{const f=o.measureText(h);return[f.width,f.fontBoundingBoxAscent+f.fontBoundingBoxDescent]});c=Math.ceil(Math.max.apply(Math,ne(G.map(h=>h[0])))),d=Math.ceil(Math.max.apply(Math,ne(G.map(h=>h[1]))))*j.length+(j.length-1)*pe}return[a??c,l??d]},Y=Pe(),E=Oe(),[v,q]=x.useState(null),P=je(()=>{const c=document.createElement("canvas").getContext("2d");if(c){const d=Ge(),[j,G]=p(c),h=f=>{const ae=[f||"",i,d,j,G,{color:$,fontSize:N,fontStyle:R,fontWeight:D,fontFamily:F,textAlign:Q},L,U],[ve,xe]=E(ae,()=>Y.apply(void 0,ae));q([ve,xe])};if(m){const f=new Image;f.onload=()=>{h(f)},f.onerror=()=>{h(g)},f.crossOrigin="anonymous",f.referrerPolicy="no-referrer",f.src=m}else h(g)}}),[I,ee,fe]=Xe(X);k.useEffect(()=>{v&&u.forEach(o=>{I(v[0],v[1],o)})},[v,u]);const ge=de(o=>{o.forEach(c=>{if(He(c,fe))P();else if(c.target===y&&c.attributeName==="style"){const d=Object.keys(le);for(let j=0;j<d.length;j+=1){const G=d[j],h=W[G],f=y.style[G];h&&h!==f&&(y.style[G]=h)}}})});Fe(u,ge),k.useEffect(P,[i,s,a,l,m,g,$,N,D,R,F,Q,L,U,C,z]);const he=x.useMemo(()=>({add:o=>{r(c=>{const d=new Set(c);return d.add(o),oe(c,d)})},remove:o=>{ee(o),r(c=>{const d=new Set(c);return d.delete(o),oe(c,d)})}}),[]),ye=T?x.createElement(We.Provider,{value:he},O):O;return x.createElement("div",{ref:Z,className:Ae(b,H),style:W},ye)},qe=async({project:t,analysisFileNames:e,params:n})=>(await me.post("/fast-api/find-analyais-result-by-analysis-method",{project:t,analysis_method:e,...n})).data,Be=({pipeline:t,form:e,resultTableList:n,operatePipeline:s,formJson:i,formDom:a,params:l,sampleGroupApI:m,setPlotLoading:g,inputAnalysisMethod:_,saveAnalysisMethod:K,project:b,setFilePlot:H,plotReloadTable:J,callback:M,dataComponentIds:O,name:T,...W})=>{const A=re.useWatch(r=>r==null?void 0:r.analysis_id,e),$=re.useWatch(r=>r,e),[N,D]=k.useState([]),[R,F]=k.useState("xlsx"),[Q,L]=k.useState("pdf"),[U,S]=$e.useMessage(),w=async()=>{try{const u=(await me.post("/fast-api/find-sample",{project:"hexiaoyan",sequencing_target:"DNA",sequencing_technique:"NGS",sample_composition:"meta_genome"})).data.map(p=>({label:p.sample_key,value:p.sample_key,sample_group:p.sample_group,sample_source:p.sample_source,host_disease:p.host_disease}));D(u)}catch(r){console.log(r)}};k.useEffect(()=>{e.resetFields()},[b]);const C={first_data_key:void 0},[z,X]=k.useState(C);k.useEffect(()=>{T&&e.setFieldValue("analysis_name",T)},[T]);const y=r=>{if(r&&Object.keys(r).length>0)return Object.keys(r)[0]},Z=async r=>{const p=(await qe({project:b,analysisFileNames:r})).reduce((E,v)=>{const q=v.analysis_method;E[q]||(E[q]=[]);const{sample_key:V,id:P,sample_group:I,...ee}=v;return E[q].push({label:V,value:P,sample_group:I||"no_group",sample_key:V,id:P,...ee}),E},{}),Y={...C,...n,...p,first_data_key:y(n)};X(Y)};k.useEffect(()=>{if(m)w();else{let r=[];if(i&&(r=i.filter(u=>u.inputAnalysisMethod!==void 0).map(u=>u.inputAnalysisMethod)),r.length!=0)Z(r);else{const u={...C,...n,first_data_key:y(n)};console.log(u),X(u)}}},[JSON.stringify(n)]);const B={...l,project:b,analysis_method:K,table_type:R,imgType:Q,software:"python",component_id:W.component_id,data_component_ids:JSON.stringify(O)};return te.jsxs(te.Fragment,{children:[S,te.jsx(Ye,{content:A&&`更新分析(${$.analysis_name})(${String($.analysis_id).slice(0,8)})`,children:te.jsx(Ne,{form:e,requestParam:B,dataMap:z,formJson:i,databases:W.databases,callback:M})})]})};export{Be as A};
