name: PR Release to TestPyPI

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-deploy:
    name: Deploy PR to TestPyPI
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11.7"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Get PR number
        id: pr
        run: echo "::set-output name=number::${{ github.event.pull_request.number }}"

      - name: Set PR version
        run: |
          current_version=$(uv version --short)
          # PEP 440: {version}rc{pr}.dev{run}
          # Example: 0.0.16rc72.dev1 (PR #72, first run)
          pr_version="${current_version}rc${PR_NUMBER}.dev${GITHUB_RUN_NUMBER}"
          uv version $pr_version
          echo "VERSION=$pr_version" >> $GITHUB_ENV
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Build package
        run: uv build

      - name: Publish package
        run: uv publish --index testpypi
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.TEST_PYPI_TOKEN }}

      - name: Comment PR
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ“¦ PR version deployed to TestPyPI\n\nYou can install this version with:\n\`\`\`bash\npip install --index-url https://test.pypi.org/simple/ pynenc==${{ env.VERSION }}\n\`\`\``
            })
