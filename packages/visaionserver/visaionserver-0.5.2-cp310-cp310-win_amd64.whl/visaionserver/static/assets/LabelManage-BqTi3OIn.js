import{al as ae,r as w,y as N,s as ne,d as re,V as se,E as y,c as D,b as f,e as v,g as B,w as b,q as j,P as z,Q as O,a2 as Y,M as Z,o as A,t as ie,aa as ce,j as ue,m as G}from"./index-DKhC6MDA.js";import{g as H,c as de,m as me,u as fe,d as ve}from"./label-x0sVxddY.js";import{n as ge,g as be,m as pe}from"./tools-xmMdAE4-.js";import{P as he}from"./const-DgT7xBJS.js";import{_ as Le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ye=ae("label",()=>{const e=w({}),n=w(""),r=N(()=>o=>(e.value[o]||[]).reduce((d,c)=>(d[c.id]=c,d),{})),l=N(()=>o=>(e.value[o]||[]).reduce((d,c)=>(d[c.name]=c.color,d),{})),m=(o,a)=>{var I;const c=(I=ne().currentProject)==null?void 0:I.id;if(!c)return{id:`temp-${Date.now()}`,name:o,color:a||T(),projectId:"temp"};const _=p(c,o);if(_)return _;const R={id:`label-${Date.now()}`,name:o,color:a||T(),projectId:c};return u(c,R),R},p=(o,a)=>(e.value[o]||[]).find(c=>c.name===a),h=(o,a)=>(e.value[o]||[]).find(c=>c.id===a),k=(o,a)=>{e.value[o]=a},L=o=>e.value[o]||[],u=(o,a)=>{e.value[o]||(e.value[o]=[]);const d=e.value[o].findIndex(c=>c.id===a.id);d>=0?e.value[o][d]=a:e.value[o].push(a)},P=(o,a,d)=>{if(!e.value[o])return;const c=e.value[o].findIndex(_=>_.id===a);c>=0&&(e.value[o][c]={...e.value[o][c],...d})},V=(o,a)=>{e.value[o]&&(e.value[o]=e.value[o].filter(d=>d.id!==a))},E=o=>{n.value=o},M=o=>{if(!(!n.value||!e.value[o]))return e.value[o].find(a=>a.id===n.value)},x=async o=>{try{if(e.value[o]&&e.value[o].length>0)return e.value[o];const a={project_id:o},{data:d}=await H(a);if(d.code===200){const c=d.data.labels.map(_=>({id:_.id||String(_.label_id),name:_.name,color:_.color||T(),projectId:o,description:_.description||"",shortcut:_.shortcut||""}));return k(o,c),!n.value&&c.length>0&&(n.value=c[0].id),c}else return console.warn("API返回的标签数据格式不正确:",d),S(o)}catch(a){return console.error("加载项目标签失败:",a),S(o)}},S=o=>{const a=[{id:"1",name:"人",color:"#FF0000",projectId:o},{id:"2",name:"车",color:"#00FF00",projectId:o},{id:"3",name:"动物",color:"#0000FF",projectId:o},{id:"4",name:"植物",color:"#FFFF00",projectId:o}];return k(o,a),!n.value&&a.length>0&&(n.value=a[0].id),a},T=()=>{const o="0123456789ABCDEF";let a="#";for(let d=0;d<6;d++)a+=o[Math.floor(Math.random()*16)];return a};return{projectLabels:e,selectedLabelId:n,getLabels:H,getLabelMap:r,getLabelColorMap:l,getOrCreateLabelByName:m,findLabelByName:p,findLabelById:h,setProjectLabels:k,getProjectLabels:L,addProjectLabel:u,updateProjectLabel:P,removeProjectLabel:V,setSelectedLabel:E,getSelectedLabel:M,loadProjectLabels:x,reset:()=>{e.value={},n.value=""}}}),_e={Z:"0",N:"1"," ":" "},Ce=e=>{if(!e)return"";try{const n=e.match(/(\d+)(\w|\s)/g);return n?n.reduce((r,l)=>{const m=l.slice(-1),p=Number(l.slice(0,l.length-1)),h=_e[m]||"";return h?`${r}${h.repeat(p)}`:r},""):""}catch(n){return console.error("解码分割图数据失败:",n),""}},W=(e,n=[255,0,0])=>e?typeof e=="string"&&e.startsWith("#")?pe(e):Array.isArray(e)?e:n:n,ee=(e,n,r,l)=>{try{if(!e.segmentationMap||!e.rangeBox)return"";const[m,p,h,k]=e.rangeBox,L=document.createElement("canvas");L.width=n,L.height=r;const u=L.getContext("2d");if(!u)return"";u.clearRect(0,0,L.width,L.height);const P=u.createImageData(h,k),V=P.data;V.fill(0);const E=Ce(e.segmentationMap),M=l();for(let x=0,S=0;x<V.length;x+=4,S++)S<E.length&&E[S]==="1"&&(V[x]=M[0],V[x+1]=M[1],V[x+2]=M[2],V[x+3]=153);return u.putImageData(P,m,p),L.toDataURL("image/png")}catch(m){return console.error("创建掩码图像失败:",m),""}},Oe=(e,n,r,l)=>ee(e,n,r,()=>{let m=[255,0,0];if(e.color)m=W(e.color);else if(l){const p=l.find(h=>h.name===e.labelName);p&&p.color&&(m=W(p.color))}return m}),qe=(e,n,r,l)=>ee(e,n,r,()=>{let m=be(l);return e.color&&(m=W(e.color)),m}),He=(e,n)=>{try{const r=document.createElement("canvas");r.width=e,r.height=n;const l=r.getContext("2d");if(!l)return"";l.clearRect(0,0,r.width,r.height),l.fillStyle="rgba(0, 0, 0, 0)",l.fillRect(0,0,r.width,r.height);const m=r.width/2,p=r.height/2,h=Math.min(r.width,r.height)/4;return l.beginPath(),l.arc(m,p,h,0,Math.PI*2),l.fillStyle="rgba(255, 0, 0, 5)",l.fill(),l.strokeStyle="rgba(255, 0, 0, 8)",l.lineWidth=2,l.stroke(),r.toDataURL("image/png")}catch(r){return console.error("创建测试圆形失败:",r),""}},We=(e,n)=>!e||!n?!1:e===n,q=e=>{if(typeof e=="string")return e;if(!Array.isArray(e)||e.length<3)return"#00FF00";const n=e[0].toString(16).padStart(2,"0"),r=e[1].toString(16).padStart(2,"0"),l=e[2].toString(16).padStart(2,"0");return`#${n}${r}${l}`},J=e=>ge(e),we={class:"label-manage-container"},ke={class:"label-add-form"},xe={class:"form-item"},Ve={class:"form-item"},Se={class:"label-list"},Me={class:"label-name"},Fe={class:"label-tag"},Pe={class:"label-color"},Be={class:"label-actions"},je={class:"edit-form"},Ae={class:"form-item"},Ee={class:"form-item"},Te={class:"dialog-footer"},Ue=re({__name:"LabelManage",props:{projectId:{type:[String,Number],required:!0},from:{type:String,default:""}},emits:["changeData"],setup(e,{emit:n}){const r=n,l=e,m=ye(),p=w(!1),h=w(""),k=w("#1890ff"),L=w(!1),u=w({id:"",name:"",color:""});w(1),w(10);const P=N(()=>m.getProjectLabels(l.projectId));N(()=>P.value.length);const V=w(he);se(async()=>{if(l.projectId)try{await m.loadProjectLabels(l.projectId)}catch(s){console.error("加载标签失败:",s),y.error("加载标签失败")}});const E=async()=>{if(!h.value.trim()){y.warning("请输入类别名称");return}try{const s=J(k.value),{data:t}=await de({name:h.value,color:s,project_id:l.projectId});t.code===200?(y.success("添加类别成功"),h.value="",k.value=te(),await m.addProjectLabel(l.projectId,t.data),r("changeData")):y.error("添加类别失败: "+t.msg)}catch(s){console.error("添加类别失败:",s),y.error("添加类别失败")}},M=w(""),x=w(""),S=w([]),T=()=>{p.value=!0,H({project_id:l.projectId}).then(s=>{var t,g;S.value=(g=(t=s.data)==null?void 0:t.data)==null?void 0:g.labels})},K=()=>{const s=Y.service({lock:!0,text:"处理中...",background:"rgba(0, 0, 0, 0.7)"});me({project_id:l.projectId,fromLabel:M.value,toLabel:x.value}).then(t=>{s.close(),Z.alert("合并完成即将刷新页面,请重新训练模型及评测","提示",{confirmButtonText:"确定",callback:g=>{location.href=location.href}})})},o=async s=>{let t=null;try{await Z.confirm(`确定要删除类别 "${s.name}" 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",appendTo:document.body}),t=Y.service({lock:!0,text:"正在删除...",background:"rgba(0, 0, 0, 0.7)"});const g={project_id:l.projectId,label_id:s.id},{data:C}=await ve(g);C.code===200?(await m.removeProjectLabel(l.projectId,s.id),y.success("删除类别成功"),r("changeData")):y.error("删除类别失败: "+C.msg)}catch(g){g!=="cancel"&&(console.error("删除类别失败:",g),y.error("删除类别失败"))}finally{t&&t.close()}},a=s=>{u.value={...s},u.value.color=q(u.value.color),L.value=!0},d=s=>{k.value=s},c=s=>{k.value=s},_=s=>{u.value.color=s},R=s=>{u.value.color=s},I=async()=>{if(!u.value.name.trim()){y.warning("请输入类别名称");return}const s=P.value.find(C=>C.id===u.value.id);if(!s){y.error("找不到原始标签数据");return}const t=s.name!==u.value.name,g=q(s.color)!==u.value.color;if(!t&&!g){y.info("标签信息未发生变化"),L.value=!1;return}try{const C=J(u.value.color);console.log(C),console.log(g);const F={project_id:l.projectId,label_id:u.value.id,name:t?u.value.name:void 0,color:g?C:void 0},{data:U}=await fe(F);U.code===200?(y.success("修改类别成功"),L.value=!1,await m.updateProjectLabel(l.projectId,u.value.id,{name:u.value.name,color:C})):y.error("修改类别失败: "+U.msg)}catch(C){console.error("修改类别失败:",C),y.error("修改类别失败")}},te=()=>{const s="0123456789ABCDEF";let t="#";for(let g=0;g<6;g++)t+=s[Math.floor(Math.random()*16)];return t};return(s,t)=>{const g=B("el-input"),C=B("el-color-picker"),F=B("el-button"),U=B("el-dialog"),Q=B("el-option"),X=B("el-select"),$=B("el-form-item"),oe=B("el-form");return A(),D("div",we,[f("div",ke,[f("div",xe,[t[9]||(t[9]=f("span",null,"类别名称",-1)),v(g,{modelValue:h.value,"onUpdate:modelValue":t[0]||(t[0]=i=>h.value=i),placeholder:"请输入类别名称"},null,8,["modelValue"])]),f("div",Ve,[t[10]||(t[10]=f("span",null,"颜色",-1)),v(C,{modelValue:k.value,"onUpdate:modelValue":t[1]||(t[1]=i=>k.value=i),predefine:V.value,onChange:d,onActiveChange:c},null,8,["modelValue","predefine"])]),v(F,{style:{"background-color":"#555fff",color:"#fff"},onClick:E},{default:b(()=>t[11]||(t[11]=[j("添加")])),_:1}),v(F,{style:{"background-color":"#555fff",color:"#fff"},onClick:T},{default:b(()=>t[12]||(t[12]=[j("合并")])),_:1})]),f("div",Se,[t[15]||(t[15]=f("div",{class:"label-header"},[f("div",{class:"label-name"},"名称"),f("div",{class:"label-color"},"颜色"),f("div",{class:"label-actions"},"操作")],-1)),(A(!0),D(z,null,O(P.value,(i,De)=>(A(),D("div",{class:"label-item",key:i.id},[f("div",Me,[f("span",Fe,ie(i.name),1)]),f("div",Pe,[f("div",{class:"color-block",style:ce({backgroundColor:ue(q)(i.color)})},null,4)]),f("div",Be,[v(F,{type:"danger",size:"small",onClick:le=>o(i)},{default:b(()=>t[13]||(t[13]=[j("删除")])),_:2},1032,["onClick"]),v(F,{type:"success",size:"small",onClick:le=>a(i)},{default:b(()=>t[14]||(t[14]=[j("修改")])),_:2},1032,["onClick"])])]))),128))]),v(U,{modelValue:L.value,"onUpdate:modelValue":t[5]||(t[5]=i=>L.value=i),title:"修改类别",width:"30%","append-to-body":!1,"custom-class":"label-edit-dialog","close-on-click-modal":!1},{footer:b(()=>[f("span",Te,[v(F,{onClick:t[4]||(t[4]=i=>L.value=!1)},{default:b(()=>t[18]||(t[18]=[j("取消")])),_:1}),v(F,{style:{"background-color":"#555FFF",color:"#fff"},onClick:I},{default:b(()=>t[19]||(t[19]=[j("确认")])),_:1})])]),default:b(()=>[f("div",je,[f("div",Ae,[t[16]||(t[16]=f("span",null,"类别名称",-1)),v(g,{modelValue:u.value.name,"onUpdate:modelValue":t[2]||(t[2]=i=>u.value.name=i),placeholder:"请输入类别名称"},null,8,["modelValue"])]),f("div",Ee,[t[17]||(t[17]=f("span",null,"颜色",-1)),v(C,{modelValue:u.value.color,"onUpdate:modelValue":t[3]||(t[3]=i=>u.value.color=i),predefine:V.value,onChange:_,onActiveChange:R},null,8,["modelValue","predefine"])])])]),_:1},8,["modelValue"]),v(U,{modelValue:p.value,"onUpdate:modelValue":t[8]||(t[8]=i=>p.value=i),title:"合并类别"},{default:b(()=>[v(oe,{inline:!0},{default:b(()=>[v($,{label:"类别"},{default:b(()=>[v(X,{style:{width:"150px"},modelValue:M.value,"onUpdate:modelValue":t[6]||(t[6]=i=>M.value=i)},{default:b(()=>[(A(!0),D(z,null,O(S.value,i=>(A(),G(Q,{label:i.name,value:i.name,key:i.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),v($,{"label-width":"0"},{default:b(()=>t[20]||(t[20]=[f("span",null,"合并为",-1)])),_:1}),v($,null,{default:b(()=>[v(X,{style:{width:"150px"},modelValue:x.value,"onUpdate:modelValue":t[7]||(t[7]=i=>x.value=i)},{default:b(()=>[(A(!0),D(z,null,O(S.value,i=>(A(),G(Q,{label:i.name,value:i.name,key:i.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),v($,null,{default:b(()=>[v(F,{type:"primary",style:{"background-color":"#555fff",color:"#fff"},onClick:K},{default:b(()=>t[21]||(t[21]=[j("确定")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}}),Ke=Le(Ue,[["__scopeId","data-v-2c05d5f0"]]);export{Ke as L,He as a,qe as b,Oe as c,We as m,q as r,ye as u};
//# sourceMappingURL=LabelManage-BqTi3OIn.js.map
