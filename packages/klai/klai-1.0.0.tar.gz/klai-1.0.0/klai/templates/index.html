<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>klai - AI Terminal Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .chat-scroll::-webkit-scrollbar { width: 8px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 4px; }
        body { font-family: 'Inter', sans-serif; }
        #settings-panel { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 antialiased h-screen flex flex-col overflow-hidden">

    <div class="flex flex-1 overflow-hidden">
        <!-- CONVERSATION LIST SIDEBAR -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 lg:static lg:w-80 w-full transition-transform duration-300 ease-in-out z-40 bg-slate-900 border-r border-slate-700 flex flex-col">
            <header class="p-4 border-b border-slate-700 flex justify-between items-center">
                <h1 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-500">klai</h1>
                <button id="new-chat-button" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-3 rounded-lg transition-colors duration-200" title="New Chat">+</button>
            </header>
            <div class="p-2">
                <input id="search-input" type="text" placeholder="Search..." class="w-full bg-slate-800 text-slate-100 border border-slate-700 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <nav id="conversation-list" class="flex-1 overflow-y-auto chat-scroll px-2 py-2 space-y-1">
                <!-- Conversation items are rendered here -->
            </nav>
        </aside>

        <!-- MAIN CHAT CONTENT -->
        <main class="flex-1 flex flex-col bg-slate-950 relative">
            <header id="chat-header" class="p-4 border-b border-slate-700 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button id="sidebar-toggle" class="p-2 rounded-md hover:bg-slate-800 transition lg:hidden">
                        <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h2 id="current-chat-title" class="text-lg font-semibold text-slate-400 truncate">Select a Conversation</h2>
                </div>
                <button id="settings-toggle" class="p-2 rounded-md hover:bg-slate-800 transition hidden">
                    <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
            </header>

            <div id="chat-messages" class="flex-1 overflow-y-auto chat-scroll p-4 space-y-6">
                <div id="initial-message" class="flex items-center justify-center h-full text-center text-slate-500 flex-col">
                    <svg class="w-16 h-16 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2a3 3 0 0 0-3 3v7c0 1.66 1.34 3 3 3s3-1.34 3-3V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>
                    <p class="text-lg font-medium">klai is ready.</p>
                    <p class="text-sm">Select or create a conversation to begin.</p>
                </div>
            </div>

            <div id="message-input-area" class="p-4 border-t border-slate-700 bg-slate-950 hidden">
                <form id="chat-form" class="flex items-center space-x-2">
                    <input id="new-message-input" type="text" placeholder="Send a message..." class="flex-1 bg-slate-800 text-slate-100 border border-slate-700 rounded-lg py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" autocomplete="off">
                    <button id="send-button" type="submit" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg p-3 transition-colors duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                    </button>
                </form>
            </div>

            <!-- SETTINGS PANEL -->
            <div id="settings-panel" class="absolute inset-y-0 right-0 w-96 bg-slate-900 border-l border-slate-700 transform translate-x-full z-30 flex flex-col">
                <header class="p-4 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Settings</h3>
                    <button id="settings-close" class="p-2 rounded-md hover:bg-slate-800 transition">&times;</button>
                </header>
                <div class="flex-1 overflow-y-auto p-4">
                    <form id="settings-form" class="space-y-4">
                        <div>
                            <label for="title" class="block text-sm font-medium text-slate-300">Title</label>
                            <input type="text" id="title" name="title" class="mt-1 block w-full bg-slate-800 border-slate-700 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="provider" class="block text-sm font-medium text-slate-300">Provider</label>
                            <select id="provider" name="provider" class="mt-1 block w-full bg-slate-800 border-slate-700 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                        <div>
                            <label for="model" class="block text-sm font-medium text-slate-300">Model</label>
                            <select id="model" name="model" class="mt-1 block w-full bg-slate-800 border-slate-700 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
                        </div>
                        <div>
                            <label for="system_prompt" class="block text-sm font-medium text-slate-300">System Prompt</label>
                            <textarea id="system_prompt" name="system_prompt" rows="5" class="mt-1 block w-full bg-slate-800 border-slate-700 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="temperature" class="block text-sm font-medium text-slate-300">Temperature</label>
                            <input type="number" step="0.1" id="temperature" name="temperature" class="mt-1 block w-full bg-slate-800 border-slate-700 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="top_p" class="block text-sm font-medium text-slate-300">Top P</label>
                            <input type="number" step="0.1" id="top_p" name="top_p" class="mt-1 block w-full bg-slate-800 border-slate-700 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const conversationList = document.getElementById('conversation-list');
        const searchInput = document.getElementById('search-input');
        const chatMessages = document.getElementById('chat-messages');
        const initialMessage = document.getElementById('initial-message');
        const messageInputArea = document.getElementById('message-input-area');
        const chatForm = document.getElementById('chat-form');
        const newMessageInput = document.getElementById('new-message-input');
        const currentChatTitle = document.getElementById('current-chat-title');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsClose = document.getElementById('settings-close');
        const settingsForm = document.getElementById('settings-form');
        const newChatButton = document.getElementById('new-chat-button');

        // --- State ---
        let currentConversationId = null;
        let eventSource = null;
        let conversations = [];
        let currentMessages = new Map();
        let providerConfig = {};
        let searchTimeout;

        // --- API Functions ---
        const api = {
            getProviders: () => fetch('/api/providers').then(res => res.json()),
            getConversations: (query = '') => fetch(`/api/conversations?q=${encodeURIComponent(query)}`).then(res => res.json()),
            getConversation: (id) => fetch(`/api/conversation/${id}`).then(res => res.json()),
            getMessages: (id) => fetch(`/api/conversation/${id}/messages`).then(res => res.json()),
            postMessage: (id, prompt) => fetch(`/api/conversation/${id}/message`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            }),
            saveSettings: (id, settings) => fetch(`/api/conversation/${id}/settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            }),
            newConversation: () => fetch('/new').then(res => res.json())
        };

        // --- Core Functions ---
        async function initializeApp() {
            providerConfig = await api.getProviders();
            populateProviderDropdown();
            await loadConversations();
            handleUrlChange();
        }

        async function loadConversations(query = '') {
            conversations = await api.getConversations(query);
            renderConversationList();
        }

        function renderConversationList() {
            conversationList.innerHTML = '';
            if (conversations.length === 0) {
                conversationList.innerHTML = '<p class="text-slate-500 text-center text-sm p-4">No conversations found.</p>';
                return;
            }
            conversations.forEach(conv => {
                const convDate = new Date(conv.start_time);
                const item = document.createElement('a');
                item.href = `#/conversation/${conv.id}`;
                item.className = `block p-3 rounded-lg hover:bg-slate-800 transition-colors duration-200 ${conv.id === currentConversationId ? 'bg-slate-800' : ''}`;
                item.dataset.id = conv.id;
                item.innerHTML = `<h3 class="font-semibold truncate text-slate-200">${conv.title}</h3><p class="text-sm text-slate-400">${convDate.toLocaleDateString()}</p>`;
                item.onclick = (e) => { e.preventDefault(); selectConversation(conv.id); };
                conversationList.appendChild(item);
            });
        }

        async function selectConversation(id) {
            if (currentConversationId === id) return;
            currentConversationId = id;
            
            const [details, messages] = await Promise.all([api.getConversation(id), api.getMessages(id)]);

            initialMessage.classList.add('hidden');
            messageInputArea.classList.remove('hidden');
            settingsToggle.classList.remove('hidden');
            
            currentChatTitle.textContent = details.title;
            updateSettingsForm(details);
            renderMessages(messages);
            setupEventSource();
            
            renderConversationList();
            window.history.pushState(null, '', `#/conversation/${id}`);
            if (window.innerWidth < 1024) sidebar.classList.add('-translate-x-full');
        }

        function renderMessages(messages) {
            chatMessages.innerHTML = '';
            currentMessages.clear();
            messages.forEach(msg => {
                currentMessages.set(msg.id, msg);
                appendMessage(msg);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendMessage(msg) {
            const { id, role, content } = msg;
            const messageEl = document.createElement('div');
            messageEl.dataset.messageId = id;
            const roleClass = role === 'user' ? 'bg-blue-600 self-end' : 'bg-slate-700 self-start';
            
            messageEl.innerHTML = `
                <div class="flex flex-col ${role === 'user' ? 'items-end' : 'items-start'}">
                    <div class="max-w-2xl p-4 rounded-2xl ${roleClass}">
                        <div class="prose prose-invert max-w-none text-white">${marked.parse(content)}</div>
                    </div>
                </div>`;
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageEl;
        }
        
        function populateProviderDropdown() {
            const providerSelect = settingsForm.provider;
            providerSelect.innerHTML = '';
            for (const [name, provider] of Object.entries(providerConfig.providers)) {
                const option = new Option(provider.label, name);
                providerSelect.add(option);
            }
        }

        function populateModelDropdown(providerName) {
            const modelSelect = settingsForm.model;
            modelSelect.innerHTML = '';
            const models = providerConfig.providers[providerName]?.models || [];
            models.forEach(modelName => {
                const option = new Option(modelName, modelName);
                modelSelect.add(option);
            });
        }

        function updateSettingsForm(conv) {
            const modelHandle = conv.model || '';
            const [providerName, modelName] = modelHandle.split('/', 2);

            settingsForm.title.value = conv.title;
            if (providerConfig.providers[providerName]) {
                settingsForm.provider.value = providerName;
                populateModelDropdown(providerName);
                settingsForm.model.value = modelName;
            }
            settingsForm.system_prompt.value = conv.system_prompt;
            settingsForm.temperature.value = conv.temperature;
            settingsForm.top_p.value = conv.top_p;
        }

        function setupEventSource() {
            if (eventSource) eventSource.close();
            if (!currentConversationId) return;

            eventSource = new EventSource(`/api/conversation/${currentConversationId}/stream`);
            eventSource.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                
                const existingEl = chatMessages.querySelector(`[data-message-id='${msg.id}']`);
                if (existingEl) {
                    existingEl.querySelector('.prose').innerHTML = marked.parse(msg.content);
                } else {
                    appendMessage(msg);
                }
                currentMessages.set(msg.id, msg);
            };
        }

        function handleUrlChange() {
            const hash = window.location.hash;
            const match = hash.match(/^#\/conversation\/(\d+)$/);
            if (match) {
                selectConversation(parseInt(match[1], 10));
            }
        }

        // --- Event Listeners ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = newMessageInput.value.trim();
            if (!prompt || !currentConversationId) return;

            newMessageInput.value = '';
            newMessageInput.disabled = true;
            
            await api.postMessage(currentConversationId, prompt);
            newMessageInput.disabled = false;
            newMessageInput.focus();
        });

        newChatButton.addEventListener('click', async (e) => {
            e.preventDefault();
            const newConvData = await api.newConversation();
            await loadConversations();
            selectConversation(newConvData.id);
        });

        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadConversations(searchInput.value), 300);
        });

        settingsForm.provider.addEventListener('change', (e) => {
            populateModelDropdown(e.target.value);
        });

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(settingsForm);
            const settings = Object.fromEntries(formData.entries());
            
            // Reconstruct the model handle before sending
            const provider = formData.get('provider');
            const model = formData.get('model');
            settings.model = `${provider}/${model}`;

            await api.saveSettings(currentConversationId, settings);
            
            currentChatTitle.textContent = settings.title;
            settingsPanel.classList.add('translate-x-full');
            
            const convLink = conversationList.querySelector(`[data-id='${currentConversationId}'] h3`);
            if (convLink) convLink.textContent = settings.title;
        });

        sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));
        settingsToggle.addEventListener('click', () => settingsPanel.classList.remove('translate-x-full'));
        settingsClose.addEventListener('click', () => settingsPanel.classList.add('translate-x-full'));
        window.addEventListener('hashchange', handleUrlChange);

        // --- Initial Load ---
        initializeApp();
    });
    </script>
</body>
</html>