<!-- Template Selection for Chat-based Issue Creation -->
<div class="template-selection-container p-4 border rounded bg-light">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">
            <i class="bi bi-chat-dots-fill text-primary me-2"></i>
            Create Issue with AI Assistant
        </h4>
        <button type="button" class="btn-close" onclick="closeIssueForm()"></button>
    </div>

    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <p class="text-muted mb-4">
        Choose how you'd like to create your issue:
    </p>

    <!-- Mode Selection Buttons -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100 border-primary">
                <div class="card-body text-center">
                    <i class="bi bi-chat-left-text-fill text-primary fs-1 mb-3"></i>
                    <h5 class="card-title">ðŸ’¬ Chat with AI</h5>
                    <p class="card-text">
                        Have a conversation with AI to explore complex issues and create comprehensive tickets.
                        <strong>Best for:</strong> Complex bugs, feature requests needing clarification.
                    </p>
                    <button type="button"
                            class="btn btn-primary"
                            onclick="showChatForm()">
                        Start Conversation
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100 border-secondary">
                <div class="card-body text-center">
                    <i class="bi bi-lightning-fill text-warning fs-1 mb-3"></i>
                    <h5 class="card-title">âš¡ Quick Enhancement</h5>
                    <p class="card-text">
                        Provide a title and description, get instant AI enhancement.
                        <strong>Best for:</strong> Simple issues with clear requirements.
                    </p>
                    <button type="button"
                            class="btn btn-secondary"
                            onclick="showQuickForm()">
                        Quick Create
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Form (Initially Hidden) -->
    <div id="chat-form" style="display: none;">
        <form hx-post="{% url 'django_issue_capture:chat_create' %}"
              hx-target="#issue-capture-container"
              hx-swap="innerHTML">
            {% csrf_token %}

            <div class="mb-3">
                <label for="template" class="form-label">Issue Type</label>
                <select class="form-select" name="template" required>
                    {% for template in templates %}
                    <option value="{{ template.name }}">
                        {{ template.display_name }} - {{ template.description }}
                    </option>
                    {% endfor %}
                </select>
                <div class="form-text">Choose the type that best matches your issue.</div>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Tell me about the issue <span class="text-danger">*</span></label>
                <textarea class="form-control"
                          name="description"
                          rows="4"
                          placeholder="Describe what's happening, what you expected, or what you need..."
                          required></textarea>
                <div class="form-text">Start with whatever details you have - I'll ask questions to get more information.</div>
            </div>

            <input type="hidden" name="reported_url" value="{{ request.META.HTTP_REFERER|default:'' }}">

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-chat-left-text me-1"></i>
                    Start Conversation
                </button>
                <button type="button" class="btn btn-secondary" onclick="showModeSelection()">
                    <i class="bi bi-arrow-left me-1"></i>
                    Back
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="closeIssueForm()">
                    Cancel
                </button>
            </div>
        </form>
    </div>

    <!-- Quick Form (Initially Hidden) -->
    <div id="quick-form" style="display: none;">
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Provide basic information and I'll enhance it with AI to create a comprehensive issue.
        </div>

        <form hx-post="{% url 'django_issue_capture:quick_enhance' %}"
              hx-target="#enhancement-result"
              hx-swap="innerHTML"
              hx-indicator="#enhancing-spinner">
            {% csrf_token %}

            <div class="mb-3">
                <label for="quick-template" class="form-label">Issue Type</label>
                <select class="form-select" name="template" required>
                    {% for template in templates %}
                    <option value="{{ template.name }}">{{ template.display_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="quick-title" class="form-label">Title <span class="text-danger">*</span></label>
                <input type="text"
                       class="form-control"
                       name="title"
                       placeholder="Brief description of the issue"
                       required>
            </div>

            <div class="mb-3">
                <label for="quick-description" class="form-label">Description <span class="text-danger">*</span></label>
                <textarea class="form-control"
                          name="description"
                          rows="4"
                          placeholder="Provide as much detail as you can..."
                          required></textarea>
            </div>

            <div class="d-flex gap-2 mb-3">
                <button type="submit" class="btn btn-warning">
                    <i class="bi bi-lightning-fill me-1"></i>
                    Enhance with AI
                </button>
                <button type="button" class="btn btn-secondary" onclick="showModeSelection()">
                    <i class="bi bi-arrow-left me-1"></i>
                    Back
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="closeIssueForm()">
                    Cancel
                </button>
            </div>

            <div id="enhancing-spinner" class="htmx-indicator text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Enhancing...</span>
                </div>
                <div class="mt-2 text-muted">AI is enhancing your issue...</div>
            </div>
        </form>

        <div id="enhancement-result"></div>
    </div>
</div>

<script>
function showChatForm() {
    document.getElementById('chat-form').style.display = 'block';
    document.querySelector('.row').style.display = 'none';
}

function showQuickForm() {
    document.getElementById('quick-form').style.display = 'block';
    document.querySelector('.row').style.display = 'none';
}

function showModeSelection() {
    document.getElementById('chat-form').style.display = 'none';
    document.getElementById('quick-form').style.display = 'none';
    document.querySelector('.row').style.display = 'flex';
}

function closeIssueForm() {
    document.getElementById('issue-capture-container').innerHTML = '';
}
</script>
